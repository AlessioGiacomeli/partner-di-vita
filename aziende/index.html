<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partner di Vita Aziende - Metodo Rosso Generali</title>
    <style>
        :root {
            --generali-blue: #003366;
            --generali-red: #E31E24;
            --generali-light-blue: #0066CC;
            --generali-orange: #FF6B35;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-900: #111827;
            --green: #10B981;
            --yellow: #F59E0B;
            --orange: #F97316;
            --red: #EF4444;
            --purple: #8B5CF6;
            --cyan: #06B6D4;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            line-height: 1.6;
        }

        #loginScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--generali-blue) 0%, #004080 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .login-box {
            background: white;
            padding: 50px;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            max-width: 500px;
            width: 90%;
            text-align: center;
        }

        .login-box h1 {
            color: var(--generali-blue);
            margin-bottom: 10px;
            font-size: 32px;
            font-weight: 700;
        }

        .login-box .subtitle {
            color: var(--gray-600);
            margin-bottom: 10px;
            font-size: 16px;
            font-weight: 600;
        }

        .login-box .business-badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--generali-orange), var(--generali-red));
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 30px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .login-box input {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .login-box input:focus {
            outline: none;
            border-color: var(--generali-blue);
            box-shadow: 0 0 0 4px rgba(0, 51, 102, 0.1);
        }

        .login-box button {
            width: 100%;
            padding: 16px;
            background: var(--generali-red);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .login-box button:hover {
            background: #C01A1F;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(227, 30, 36, 0.4);
        }

        .header {
            background: linear-gradient(135deg, var(--generali-blue) 0%, var(--generali-light-blue) 100%);
            color: white;
            padding: 35px 20px;
            text-align: center;
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .header h1 {
            font-size: 36px;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .header .business-label {
            display: inline-block;
            background: var(--generali-orange);
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .header .tagline {
            font-size: 16px;
            opacity: 0.95;
            font-weight: 500;
        }

        .container {
            max-width: 1400px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 35px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-top: 4px solid var(--generali-blue);
        }

        .card-title {
            font-size: 26px;
            color: var(--generali-blue);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--generali-red);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card-title .icon {
            font-size: 32px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 8px;
            font-size: 15px;
        }

        .form-group label .required {
            color: var(--red);
            margin-left: 4px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--generali-blue);
            box-shadow: 0 0 0 4px rgba(0, 51, 102, 0.08);
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 18px;
            margin-top: 15px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--gray-50);
            border-radius: 8px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .checkbox-item:hover {
            background: #E0F2FE;
            transform: translateX(3px);
        }

        .checkbox-item input[type="checkbox"] {
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: var(--generali-blue);
        }

        .checkbox-item label {
            cursor: pointer;
            font-weight: 500;
            margin: 0;
            flex: 1;
        }

        .polizza-fields {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: var(--gray-50);
            border-radius: 8px;
            border-left: 4px solid var(--generali-blue);
        }

        .polizza-fields.active {
            display: block;
        }

        .polizza-fields h4 {
            color: var(--generali-blue);
            margin-bottom: 15px;
            font-size: 18px;
        }

        .info-box {
            background: #DBEAFE;
            border-left: 4px solid #3B82F6;
            padding: 15px 20px;
            border-radius: 8px;
            margin: 20px 0;
            color: #1E40AF;
        }

        .info-box strong {
            display: block;
            margin-bottom: 5px;
            font-size: 16px;
        }

        .warning-box {
            background: #FEF3C7;
            border-left: 4px solid #F59E0B;
            padding: 15px 20px;
            border-radius: 8px;
            margin: 20px 0;
            color: #92400E;
        }

        .warning-box strong {
            display: block;
            margin-bottom: 5px;
            font-size: 16px;
        }

        .btn {
            padding: 14px 32px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: var(--generali-red);
            color: white;
        }

        .btn-primary:hover {
            background: #C01A1F;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(227, 30, 36, 0.3);
        }

        .btn-secondary {
            background: var(--generali-blue);
            color: white;
        }

        .btn-secondary:hover {
            background: #00509E;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 51, 102, 0.3);
        }

        .btn-block {
            width: 100%;
        }

        .badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-info {
            background: #DBEAFE;
            color: #1E40AF;
        }

        .badge-warning {
            background: #FEF3C7;
            color: #92400E;
        }

        .badge-success {
            background: #D1FAE5;
            color: #065F46;
        }

        .badge-danger {
            background: #FEE2E2;
            color: #991B1B;
        }

        #questionario {
            display: none;
        }

        #risultati {
            display: none;
        }

        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--generali-blue);
            color: white;
            padding: 16px 24px;
            border-radius: 10px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
            z-index: 9999;
            animation: slideUp 0.4s ease;
            font-weight: 600;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .toast.success {
            background: var(--green);
        }

        .toast.error {
            background: var(--red);
        }

        .toast.warning {
            background: var(--orange);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 26px;
            }

            .card {
                padding: 25px;
            }

            .form-row,
            .form-row-3 {
                grid-template-columns: 1fr;
            }

            .checkbox-group {
                grid-template-columns: 1fr;
            }

            .login-box {
                padding: 30px 20px;
            }
        }

        @media print {
            .header,
            .btn,
            #loginScreen {
                display: none !important;
            }

            body {
                background: white;
            }

            .card {
                box-shadow: none;
                border: 1px solid var(--gray-300);
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>

    <!-- LOGIN SCREEN -->
    <div id="loginScreen">
        <div class="login-box">
            <h1>üè¢ Partner di Vita</h1>
            <p class="subtitle">Metodo Rosso Generali</p>
            <span class="business-badge">BUSINESS EDITION</span>
            <p style="color: var(--gray-600); font-size: 14px; margin-bottom: 25px;">
                Sistema di Analisi Rischi e Bisogni Assicurativi Aziendali v1.0
            </p>
            <input type="password" id="passwordInput" placeholder="Inserisci password aziendale" autocomplete="off">
            <button onclick="checkPassword()">Accedi al Sistema</button>
        </div>
    </div>

    <!-- HEADER -->
    <div class="header">
        <span class="business-label">üè¢ Business Edition</span>
        <h1>Partner di Vita Aziende</h1>
        <p class="tagline">Sistema Integrato di Analisi Rischi e Bisogni Assicurativi per Imprese - Metodo Rosso Generali</p>
    </div>

    <!-- CONTAINER -->
    <div class="container">

        <!-- ANAGRAFICA AZIENDALE -->
        <div class="card" id="anagraficaSection">
            <h2 class="card-title">
                <span class="icon">üè≠</span>
                Anagrafica Aziendale
            </h2>

            <div class="info-box">
                <strong>‚ÑπÔ∏è Informazioni</strong>
                I dati inseriti sono trattati secondo GDPR. Tutte le informazioni rimangono sul tuo dispositivo (localStorage).
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="ragioneSociale">Ragione Sociale <span class="required">*</span></label>
                    <input type="text" id="ragioneSociale" placeholder="Es: Acme S.r.l." required>
                </div>
                <div class="form-group">
                    <label for="partitaIVA">Partita IVA <span class="required">*</span></label>
                    <input type="text" id="partitaIVA" maxlength="11" placeholder="Es: 12345678901" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="codiceFiscaleAzienda">Codice Fiscale Azienda</label>
                    <input type="text" id="codiceFiscaleAzienda" maxlength="16" style="text-transform: uppercase;" placeholder="Se diverso da P.IVA">
                </div>
                <div class="form-group">
                    <label for="formaGiuridica">Forma Giuridica <span class="required">*</span></label>
                    <select id="formaGiuridica" required>
                        <option value="">Seleziona forma giuridica</option>
                        <option value="ditta_individuale">Ditta Individuale</option>
                        <option value="snc">SNC - Societ√† in Nome Collettivo</option>
                        <option value="sas">SAS - Societ√† in Accomandita Semplice</option>
                        <option value="srl">SRL - Societ√† a Responsabilit√† Limitata</option>
                        <option value="srls">SRLS - Societ√† a Responsabilit√† Limitata Semplificata</option>
                        <option value="spa">SPA - Societ√† per Azioni</option>
                        <option value="sapa">SAPA - Societ√† in Accomandita per Azioni</option>
                        <option value="cooperativa">Cooperativa</option>
                        <option value="consorzio">Consorzio</option>
                        <option value="societa_benefit">Societ√† Benefit</option>
                        <option value="startup_innovativa">Startup Innovativa</option>
                        <option value="pmi_innovativa">PMI Innovativa</option>
                        <option value="ente_non_profit">Ente Non Profit / Associazione</option>
                        <option value="altro">Altro</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="annoCostituzione">Anno Costituzione <span class="required">*</span></label>
                    <input type="number" id="annoCostituzione" min="1900" max="2025" placeholder="Es: 2010" required>
                </div>
                <div class="form-group">
                    <label for="settoreATECO">Settore ATECO <span class="required">*</span></label>
                    <select id="settoreATECO" required>
                        <option value="">Seleziona settore</option>
                        <optgroup label="A - Agricoltura, Silvicoltura, Pesca">
                            <option value="A01">Coltivazioni agricole e produzione di prodotti animali</option>
                            <option value="A02">Silvicoltura ed utilizzo aree forestali</option>
                            <option value="A03">Pesca e acquacoltura</option>
                        </optgroup>
                        <optgroup label="B - Estrazione di minerali">
                            <option value="B">Estrazione di minerali da cave e miniere</option>
                        </optgroup>
                        <optgroup label="C - Attivit√† manifatturiere">
                            <option value="C10">Industrie alimentari</option>
                            <option value="C11">Industria delle bevande</option>
                            <option value="C13">Industrie tessili</option>
                            <option value="C14">Confezione di articoli di abbigliamento</option>
                            <option value="C15">Fabbricazione di articoli in pelle</option>
                            <option value="C16">Industria del legno</option>
                            <option value="C17">Fabbricazione di carta</option>
                            <option value="C18">Stampa ed editoria</option>
                            <option value="C20">Fabbricazione prodotti chimici</option>
                            <option value="C21">Fabbricazione prodotti farmaceutici</option>
                            <option value="C22">Fabbricazione articoli in gomma e plastica</option>
                            <option value="C23">Fabbricazione prodotti da minerali non metalliferi</option>
                            <option value="C24">Metallurgia</option>
                            <option value="C25">Fabbricazione prodotti in metallo</option>
                            <option value="C26">Fabbricazione computer, elettronica, ottica</option>
                            <option value="C27">Fabbricazione apparecchiature elettriche</option>
                            <option value="C28">Fabbricazione macchinari</option>
                            <option value="C29">Fabbricazione autoveicoli</option>
                            <option value="C30">Fabbricazione altri mezzi di trasporto</option>
                            <option value="C31">Fabbricazione mobili</option>
                            <option value="C32">Altre industrie manifatturiere</option>
                        </optgroup>
                        <optgroup label="D - Energia">
                            <option value="D35">Fornitura energia elettrica, gas, vapore</option>
                        </optgroup>
                        <optgroup label="E - Acqua e Ambiente">
                            <option value="E36">Raccolta, trattamento e fornitura acqua</option>
                            <option value="E37">Gestione reti fognarie</option>
                            <option value="E38">Attivit√† di raccolta, trattamento rifiuti</option>
                            <option value="E39">Attivit√† di risanamento</option>
                        </optgroup>
                        <optgroup label="F - Costruzioni">
                            <option value="F41">Costruzione edifici</option>
                            <option value="F42">Ingegneria civile</option>
                            <option value="F43">Lavori di costruzione specializzati</option>
                        </optgroup>
                        <optgroup label="G - Commercio">
                            <option value="G45">Commercio ingrosso e dettaglio autoveicoli</option>
                            <option value="G46">Commercio all'ingrosso</option>
                            <option value="G47">Commercio al dettaglio</option>
                        </optgroup>
                        <optgroup label="H - Trasporto e Magazzinaggio">
                            <option value="H49">Trasporto terrestre</option>
                            <option value="H50">Trasporto marittimo e per vie d'acqua</option>
                            <option value="H51">Trasporto aereo</option>
                            <option value="H52">Magazzinaggio e supporto trasporti</option>
                            <option value="H53">Servizi postali e attivit√† di corriere</option>
                        </optgroup>
                        <optgroup label="I - Alloggio e Ristorazione">
                            <option value="I55">Alloggio</option>
                            <option value="I56">Attivit√† di servizi ristorazione</option>
                        </optgroup>
                        <optgroup label="J - Informazione e Comunicazione">
                            <option value="J58">Attivit√† editoriali</option>
                            <option value="J59">Attivit√† cinematografiche, video, programmi TV</option>
                            <option value="J60">Attivit√† di programmazione e trasmissione</option>
                            <option value="J61">Telecomunicazioni</option>
                            <option value="J62">Programmazione, consulenza informatica</option>
                            <option value="J63">Attivit√† servizi di informazione</option>
                        </optgroup>
                        <optgroup label="K - Attivit√† Finanziarie e Assicurative">
                            <option value="K64">Attivit√† di servizi finanziari</option>
                            <option value="K65">Assicurazioni</option>
                            <option value="K66">Attivit√† ausiliarie servizi finanziari</option>
                        </optgroup>
                        <optgroup label="L - Attivit√† Immobiliari">
                            <option value="L68">Attivit√† immobiliari</option>
                        </optgroup>
                        <optgroup label="M - Attivit√† Professionali, Scientifiche, Tecniche">
                            <option value="M69">Attivit√† legali e contabilit√†</option>
                            <option value="M70">Attivit√† direzione aziendale e consulenza gestionale</option>
                            <option value="M71">Attivit√† degli studi di architettura e ingegneria</option>
                            <option value="M72">Ricerca scientifica e sviluppo</option>
                            <option value="M73">Pubblicit√† e ricerche di mercato</option>
                            <option value="M74">Altre attivit√† professionali, scientifiche</option>
                            <option value="M75">Servizi veterinari</option>
                        </optgroup>
                        <optgroup label="N - Noleggio, Agenzie Viaggio, Servizi Supporto">
                            <option value="N77">Attivit√† di noleggio</option>
                            <option value="N78">Attivit√† di ricerca, selezione, fornitura personale</option>
                            <option value="N79">Attivit√† dei servizi delle agenzie di viaggio</option>
                            <option value="N80">Servizi di vigilanza e investigazione</option>
                            <option value="N81">Attivit√† di servizi per edifici e paesaggio</option>
                            <option value="N82">Attivit√† di supporto per le funzioni d'ufficio</option>
                        </optgroup>
                        <optgroup label="P - Istruzione">
                            <option value="P85">Istruzione</option>
                        </optgroup>
                        <optgroup label="Q - Sanit√† e Assistenza Sociale">
                            <option value="Q86">Assistenza sanitaria</option>
                            <option value="Q87">Servizi di assistenza sociale residenziale</option>
                            <option value="Q88">Assistenza sociale non residenziale</option>
                        </optgroup>
                        <optgroup label="R - Attivit√† Artistiche, Sportive, Intrattenimento">
                            <option value="R90">Attivit√† creative, artistiche e di intrattenimento</option>
                            <option value="R91">Attivit√† di biblioteche, archivi, musei</option>
                            <option value="R92">Attivit√† riguardanti lotterie, scommesse</option>
                            <option value="R93">Attivit√† sportive, di intrattenimento e divertimento</option>
                        </optgroup>
                        <optgroup label="S - Altre Attivit√† di Servizi">
                            <option value="S94">Attivit√† di organizzazioni associative</option>
                            <option value="S95">Riparazione computer e beni per uso personale</option>
                            <option value="S96">Altre attivit√† di servizi per la persona</option>
                        </optgroup>
                    </select>
                </div>
            </div>

            <div class="form-row-3">
                <div class="form-group">
                    <label for="numeroDipendenti">Numero Dipendenti <span class="required">*</span></label>
                    <input type="number" id="numeroDipendenti" min="0" max="10000" placeholder="Es: 15" required>
                </div>
                <div class="form-group">
                    <label for="fatturatoAnnuo">Fatturato Annuo (‚Ç¨) <span class="required">*</span></label>
                    <input type="number" id="fatturatoAnnuo" min="0" step="10000" placeholder="Es: 1500000" required>
                </div>
                <div class="form-group">
                    <label for="patrimonioNetto">Patrimonio Netto (‚Ç¨)</label>
                    <input type="number" id="patrimonioNetto" min="0" step="5000" placeholder="Es: 250000">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="provinciaSedeOperativa">Provincia Sede Operativa <span class="required">*</span></label>
                    <select id="provinciaSedeOperativa" required>
                        <option value="">Seleziona provincia</option>
                        <option value="AG">Agrigento</option>
                        <option value="AL">Alessandria</option>
                        <option value="AN">Ancona</option>
                        <option value="AO">Aosta</option>
                        <option value="AP">Ascoli Piceno</option>
                        <option value="AQ">L'Aquila</option>
                        <option value="AR">Arezzo</option>
                        <option value="AT">Asti</option>
                        <option value="AV">Avellino</option>
                        <option value="BA">Bari</option>
                        <option value="BG">Bergamo</option>
                        <option value="BI">Biella</option>
                        <option value="BL">Belluno</option>
                        <option value="BN">Benevento</option>
                        <option value="BO">Bologna</option>
                        <option value="BR">Brindisi</option>
                        <option value="BS">Brescia</option>
                        <option value="BT">Barletta-Andria-Trani</option>
                        <option value="BZ">Bolzano</option>
                        <option value="CA">Cagliari</option>
                        <option value="CB">Campobasso</option>
                        <option value="CE">Caserta</option>
                        <option value="CH">Chieti</option>
                        <option value="CL">Caltanissetta</option>
                        <option value="CN">Cuneo</option>
                        <option value="CO">Como</option>
                        <option value="CR">Cremona</option>
                        <option value="CS">Cosenza</option>
                        <option value="CT">Catania</option>
                        <option value="CZ">Catanzaro</option>
                        <option value="EN">Enna</option>
                        <option value="FC">Forl√¨-Cesena</option>
                        <option value="FE">Ferrara</option>
                        <option value="FG">Foggia</option>
                        <option value="FI">Firenze</option>
                        <option value="FM">Fermo</option>
                        <option value="FR">Frosinone</option>
                        <option value="GE">Genova</option>
                        <option value="GO">Gorizia</option>
                        <option value="GR">Grosseto</option>
                        <option value="IM">Imperia</option>
                        <option value="IS">Isernia</option>
                        <option value="KR">Crotone</option>
                        <option value="LC">Lecco</option>
                        <option value="LE">Lecce</option>
                        <option value="LI">Livorno</option>
                        <option value="LO">Lodi</option>
                        <option value="LT">Latina</option>
                        <option value="LU">Lucca</option>
                        <option value="MB">Monza e Brianza</option>
                        <option value="MC">Macerata</option>
                        <option value="ME">Messina</option>
                        <option value="MI">Milano</option>
                        <option value="MN">Mantova</option>
                        <option value="MO">Modena</option>
                        <option value="MS">Massa-Carrara</option>
                        <option value="MT">Matera</option>
                        <option value="NA">Napoli</option>
                        <option value="NO">Novara</option>
                        <option value="NU">Nuoro</option>
                        <option value="OR">Oristano</option>
                        <option value="PA">Palermo</option>
                        <option value="PC">Piacenza</option>
                        <option value="PD">Padova</option>
                        <option value="PE">Pescara</option>
                        <option value="PG">Perugia</option>
                        <option value="PI">Pisa</option>
                        <option value="PN">Pordenone</option>
                        <option value="PO">Prato</option>
                        <option value="PR">Parma</option>
                        <option value="PT">Pistoia</option>
                        <option value="PU">Pesaro e Urbino</option>
                        <option value="PV">Pavia</option>
                        <option value="PZ">Potenza</option>
                        <option value="RA">Ravenna</option>
                        <option value="RC">Reggio Calabria</option>
                        <option value="RE">Reggio Emilia</option>
                        <option value="RG">Ragusa</option>
                        <option value="RI">Rieti</option>
                        <option value="RM">Roma</option>
                        <option value="RN">Rimini</option>
                        <option value="RO">Rovigo</option>
                        <option value="SA">Salerno</option>
                        <option value="SI">Siena</option>
                        <option value="SO">Sondrio</option>
                        <option value="SP">La Spezia</option>
                        <option value="SR">Siracusa</option>
                        <option value="SS">Sassari</option>
                        <option value="SU">Sud Sardegna</option>
                        <option value="SV">Savona</option>
                        <option value="TA">Taranto</option>
                        <option value="TE">Teramo</option>
                        <option value="TN">Trento</option>
                        <option value="TO">Torino</option>
                        <option value="TP">Trapani</option>
                        <option value="TR">Terni</option>
                        <option value="TS">Trieste</option>
                        <option value="TV">Treviso</option>
                        <option value="UD">Udine</option>
                        <option value="VA">Varese</option>
                        <option value="VB">Verbano-Cusio-Ossola</option>
                        <option value="VC">Vercelli</option>
                        <option value="VE">Venezia</option>
                        <option value="VI">Vicenza</option>
                        <option value="VR">Verona</option>
                        <option value="VT">Viterbo</option>
                        <option value="VV">Vibo Valentia</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="numeroSediOperative">Numero Sedi Operative</label>
                    <input type="number" id="numeroSediOperative" min="1" max="1000" value="1" placeholder="Es: 1">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="emailAzienda">Email Aziendale <span class="required">*</span></label>
                    <input type="email" id="emailAzienda" placeholder="info@azienda.it" required>
                </div>
                <div class="form-group">
                    <label for="telefonoAzienda">Telefono Aziendale <span class="required">*</span></label>
                    <input type="tel" id="telefonoAzienda" placeholder="+39 02 12345678" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="sitoWeb">Sito Web</label>
                    <input type="url" id="sitoWeb" placeholder="https://www.azienda.it">
                </div>
                <div class="form-group">
                    <label for="percentualeExport">% Fatturato Export</label>
                    <input type="number" id="percentualeExport" min="0" max="100" step="5" value="0" placeholder="Es: 30">
                </div>
            </div>

            <h3 style="color: var(--generali-blue); margin: 30px 0 20px 0; font-size: 22px; border-bottom: 2px solid var(--gray-200); padding-bottom: 10px;">
                üë• Key Persons & Management
            </h3>

            <div class="form-row">
                <div class="form-group">
                    <label for="numeroKeyPersons">Numero Key Persons <span class="required">*</span></label>
                    <input type="number" id="numeroKeyPersons" min="1" max="50" value="1" required onchange="generaKeyPersonsFields()">
                    <small style="color: var(--gray-600); display: block; margin-top: 5px;">
                        Figure chiave: amministratori, soci operativi, direttori
                    </small>
                </div>
                <div class="form-group">
                    <label for="etaMediaManagement">Et√† Media Management</label>
                    <input type="number" id="etaMediaManagement" min="18" max="90" placeholder="Es: 52">
                </div>
            </div>

            <div id="keyPersonsContainer" style="margin-top: 20px;"></div>

            <h3 style="color: var(--generali-blue); margin: 30px 0 20px 0; font-size: 22px; border-bottom: 2px solid var(--gray-200); padding-bottom: 10px;">
                üìä Dati Economico-Finanziari
            </h3>

            <div class="form-row">
                <div class="form-group">
                    <label for="debitiTotali">Debiti Totali (‚Ç¨)</label>
                    <input type="number" id="debitiTotali" min="0" step="10000" placeholder="Es: 300000">
                </div>
                <div class="form-group">
                    <label for="creditiCommerciali">Crediti Commerciali (‚Ç¨)</label>
                    <input type="number" id="creditiCommerciali" min="0" step="10000" placeholder="Es: 450000">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="immobiliProprieta">Immobili di Propriet√†</label>
                    <select id="immobiliProprieta">
                        <option value="">Seleziona</option>
                        <option value="nessuno">Nessuno (tutto in affitto)</option>
                        <option value="parziale">Parziale (mix propriet√†/affitto)</option>
                        <option value="totale">Totale (tutto di propriet√†)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="valoreImmobili">Valore Immobili/Asset (‚Ç¨)</label>
                    <input type="number" id="valoreImmobili" min="0" step="10000" placeholder="Es: 800000">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="concentrazioneClienti">Concentrazione Top 3 Clienti (% su fatturato)</label>
                    <input type="number" id="concentrazioneClienti" min="0" max="100" step="5" placeholder="Es: 45">
                    <small style="color: var(--gray-600); display: block; margin-top: 5px;">
                        % fatturato dipendente dai 3 clienti principali
                    </small>
                </div>
                <div class="form-group">
                    <label for="certificazioni">Certificazioni Aziendali</label>
                    <select id="certificazioni" multiple style="height: 100px;">
                        <option value="ISO9001">ISO 9001 (Qualit√†)</option>
                        <option value="ISO14001">ISO 14001 (Ambiente)</option>
                        <option value="ISO45001">ISO 45001 (Salute e Sicurezza)</option>
                        <option value="ISO27001">ISO 27001 (Sicurezza Informazioni)</option>
                        <option value="SA8000">SA 8000 (Responsabilit√† Sociale)</option>
                        <option value="OHSAS18001">OHSAS 18001</option>
                        <option value="CE">Certificazione CE</option>
                        <option value="BIO">Certificazione Biologica</option>
                        <option value="HACCP">HACCP</option>
                        <option value="altro">Altre certificazioni</option>
                    </select>
                    <small style="color: var(--gray-600); display: block; margin-top: 5px;">
                        Tieni premuto CTRL/CMD per selezioni multiple
                    </small>
                </div>
            </div>

            <div class="form-group">
                <label for="sinistralitaStorica">Sinistri Ultimi 5 Anni</label>
                <textarea id="sinistralitaStorica" placeholder="Descrivi eventuali sinistri significativi (tipo, anno, importo)"></textarea>
            </div>

            <div class="form-group">
                <label for="consulenteSelect">Consulente Assegnato</label>
                <select id="consulenteSelect">
                    <option value="">Seleziona consulente</option>
                    <option value="Alessandro Rossi">Alessandro Rossi</option>
                    <option value="Marco Bianchi">Marco Bianchi</option>
                    <option value="Luca Verdi">Luca Verdi</option>
                    <option value="Giuseppe Neri">Giuseppe Neri</option>
                    <option value="Francesco Romano">Francesco Romano</option>
                    <option value="Antonio Colombo">Antonio Colombo</option>
                    <option value="Giovanni Ferrari">Giovanni Ferrari</option>
                    <option value="Roberto Ricci">Roberto Ricci</option>
                    <option value="Paolo Russo">Paolo Russo</option>
                    <option value="Stefano Marino">Stefano Marino</option>
                    <option value="Andrea Greco">Andrea Greco</option>
                    <option value="Diego Bruno">Diego Bruno</option>
                    <option value="Matteo Gallo">Matteo Gallo</option>
                    <option value="Davide Costa">Davide Costa</option>
                    <option value="Simone Fontana">Simone Fontana</option>
                    <option value="Federico Barbieri">Federico Barbieri</option>
                    <option value="Lorenzo Vitale">Lorenzo Vitale</option>
                    <option value="Gabriele Leone">Gabriele Leone</option>
                    <option value="Riccardo Lombardi">Riccardo Lombardi</option>
                    <option value="Altro">Altro (specificare)</option>
                </select>
            </div>

            <div class="form-group" id="altroConsulenteGroup" style="display: none;">
                <label for="altroConsulente">Nome Altro Consulente</label>
                <input type="text" id="altroConsulente" placeholder="Inserisci nome consulente">
            </div>
        </div>

        <!-- POLIZZE ASSICURATIVE AZIENDALI ESISTENTI -->
        <div class="card">
            <h2 class="card-title">
                <span class="icon">üõ°Ô∏è</span>
                Coperture Assicurative Aziendali Esistenti
            </h2>

            <div class="info-box">
                <strong>‚ÑπÔ∏è Informazioni</strong>
                Indica le coperture assicurative gi√† attive per l'azienda. Questo permetter√† di identificare i gap di protezione.
            </div>

            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="pol_rc_generale" onchange="togglePolizzaFields('rc_generale')">
                    <label for="pol_rc_generale">RC Generale / Verso Terzi</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="pol_rc_professionale" onchange="togglePolizzaFields('rc_professionale')">
                    <label for="pol_rc_professionale">RC Professionale</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="pol_rc_prodotti" onchange="togglePolizzaFields('rc_prodotti')">
                    <label for="pol_rc_prodotti">RC Prodotti</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="pol_do" onchange="togglePolizzaFields('do')">
                    <label for="pol_do">D&O (Directors & Officers)</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="pol_key_man" onchange="togglePolizzaFields('key_man')">
                    <label for="pol_key_man">Key Man Insurance</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="pol_cyber" onchange="togglePolizzaFields('cyber')">
                    <label for="pol_cyber">Cyber Risk</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="pol_property" onchange="togglePolizzaFields('property')">
                    <label for="pol_property">Property / All Risks</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="pol_business_interruption" onchange="togglePolizzaFields('business_interruption')">
                    <label for="pol_business_interruption">Business Interruption</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="pol_tutela_legale" onchange="togglePolizzaFields('tutela_legale')">
                    <label for="pol_tutela_legale">Tutela Legale Aziendale</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="pol_infortuni_dipendenti" onchange="togglePolizzaFields('infortuni_dipendenti')">
                    <label for="pol_infortuni_dipendenti">Infortuni Dipendenti (oltre INAIL)</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="pol_flotta" onchange="togglePolizzaFields('flotta')">
                    <label for="pol_flotta">Flotta Auto Aziendali</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="pol_trasporto_merci" onchange="togglePolizzaFields('trasporto_merci')">
                    <label for="pol_trasporto_merci">Trasporto Merci</label>
                </div>
            </div>

            <!-- RC GENERALE -->
            <div id="pol_rc_generale_fields" class="polizza-fields">
                <h4>üõ°Ô∏è RC Generale / Verso Terzi</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_rc_generale_compagnia">Compagnia</label>
                        <select id="pol_rc_generale_compagnia" onchange="handleCompagniaChange('rc_generale')">
                            <option value="">Seleziona</option>
                            <option value="Generali">Generali</option>
                            <option value="Allianz">Allianz</option>
                            <option value="AXA">AXA</option>
                            <option value="UnipolSai">UnipolSai</option>
                            <option value="Zurich">Zurich</option>
                            <option value="Reale Mutua">Reale Mutua</option>
                            <option value="Cattolica">Cattolica</option>
                            <option value="HDI">HDI</option>
                            <option value="Chubb">Chubb</option>
                            <option value="Altro (specificare)">Altro (specificare)</option>
                        </select>
                    </div>
                    <div class="form-group" id="pol_rc_generale_altro_group" style="display: none;">
                        <label for="pol_rc_generale_altra">Altra Compagnia</label>
                        <input type="text" id="pol_rc_generale_altra" placeholder="Specifica compagnia">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_rc_generale_massimale">Massimale per Sinistro (‚Ç¨)</label>
                        <input type="number" id="pol_rc_generale_massimale" min="0" step="100000" placeholder="Es: 1000000">
                    </div>
                    <div class="form-group">
                        <label for="pol_rc_generale_premio">Premio Annuo (‚Ç¨)</label>
                        <input type="number" id="pol_rc_generale_premio" min="0" step="100" placeholder="Es: 5000">
                    </div>
                </div>
            </div>

            <!-- RC PROFESSIONALE -->
            <div id="pol_rc_professionale_fields" class="polizza-fields">
                <h4>‚öñÔ∏è RC Professionale</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_rc_professionale_compagnia">Compagnia</label>
                        <select id="pol_rc_professionale_compagnia" onchange="handleCompagniaChange('rc_professionale')">
                            <option value="">Seleziona</option>
                            <option value="Generali">Generali</option>
                            <option value="Allianz">Allianz</option>
                            <option value="AXA">AXA</option>
                            <option value="UnipolSai">UnipolSai</option>
                            <option value="Zurich">Zurich</option>
                            <option value="Lloyd's">Lloyd's</option>
                            <option value="Altro (specificare)">Altro (specificare)</option>
                        </select>
                    </div>
                    <div class="form-group" id="pol_rc_professionale_altro_group" style="display: none;">
                        <label for="pol_rc_professionale_altra">Altra Compagnia</label>
                        <input type="text" id="pol_rc_professionale_altra" placeholder="Specifica compagnia">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_rc_professionale_massimale">Massimale per Sinistro (‚Ç¨)</label>
                        <input type="number" id="pol_rc_professionale_massimale" min="0" step="100000" placeholder="Es: 2000000">
                    </div>
                    <div class="form-group">
                        <label for="pol_rc_professionale_premio">Premio Annuo (‚Ç¨)</label>
                        <input type="number" id="pol_rc_professionale_premio" min="0" step="100" placeholder="Es: 8000">
                    </div>
                </div>
            </div>

            <!-- RC PRODOTTI -->
            <div id="pol_rc_prodotti_fields" class="polizza-fields">
                <h4>üì¶ RC Prodotti</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_rc_prodotti_compagnia">Compagnia</label>
                        <select id="pol_rc_prodotti_compagnia" onchange="handleCompagniaChange('rc_prodotti')">
                            <option value="">Seleziona</option>
                            <option value="Generali">Generali</option>
                            <option value="Allianz">Allianz</option>
                            <option value="AXA">AXA</option>
                            <option value="UnipolSai">UnipolSai</option>
                            <option value="Zurich">Zurich</option>
                            <option value="Altro (specificare)">Altro (specificare)</option>
                        </select>
                    </div>
                    <div class="form-group" id="pol_rc_prodotti_altro_group" style="display: none;">
                        <label for="pol_rc_prodotti_altra">Altra Compagnia</label>
                        <input type="text" id="pol_rc_prodotti_altra" placeholder="Specifica compagnia">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_rc_prodotti_massimale">Massimale Aggregato Annuo (‚Ç¨)</label>
                        <input type="number" id="pol_rc_prodotti_massimale" min="0" step="100000" placeholder="Es: 5000000">
                    </div>
                    <div class="form-group">
                        <label for="pol_rc_prodotti_premio">Premio Annuo (‚Ç¨)</label>
                        <input type="number" id="pol_rc_prodotti_premio" min="0" step="100" placeholder="Es: 12000">
                    </div>
                </div>
            </div>

            <!-- D&O -->
            <div id="pol_do_fields" class="polizza-fields">
                <h4>üëî D&O (Directors & Officers Liability)</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_do_compagnia">Compagnia</label>
                        <select id="pol_do_compagnia" onchange="handleCompagniaChange('do')">
                            <option value="">Seleziona</option>
                            <option value="Generali">Generali</option>
                            <option value="Allianz">Allianz</option>
                            <option value="AXA">AXA</option>
                            <option value="Zurich">Zurich</option>
                            <option value="Chubb">Chubb</option>
                            <option value="AIG">AIG</option>
                            <option value="Altro (specificare)">Altro (specificare)</option>
                        </select>
                    </div>
                    <div class="form-group" id="pol_do_altro_group" style="display: none;">
                        <label for="pol_do_altra">Altra Compagnia</label>
                        <input type="text" id="pol_do_altra" placeholder="Specifica compagnia">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_do_massimale">Massimale Aggregato (‚Ç¨)</label>
                        <input type="number" id="pol_do_massimale" min="0" step="100000" placeholder="Es: 3000000">
                    </div>
                    <div class="form-group">
                        <label for="pol_do_premio">Premio Annuo (‚Ç¨)</label>
                        <input type="number" id="pol_do_premio" min="0" step="100" placeholder="Es: 15000">
                    </div>
                </div>
            </div>

            <!-- KEY MAN -->
            <div id="pol_key_man_fields" class="polizza-fields">
                <h4>üîë Key Man Insurance</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_key_man_compagnia">Compagnia</label>
                        <select id="pol_key_man_compagnia" onchange="handleCompagniaChange('key_man')">
                            <option value="">Seleziona</option>
                            <option value="Generali">Generali</option>
                            <option value="Allianz">Allianz</option>
                            <option value="AXA">AXA</option>
                            <option value="UnipolSai">UnipolSai</option>
                            <option value="Zurich">Zurich</option>
                            <option value="Altro (specificare)">Altro (specificare)</option>
                        </select>
                    </div>
                    <div class="form-group" id="pol_key_man_altro_group" style="display: none;">
                        <label for="pol_key_man_altra">Altra Compagnia</label>
                        <input type="text" id="pol_key_man_altra" placeholder="Specifica compagnia">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_key_man_capitale">Capitale Assicurato (‚Ç¨)</label>
                        <input type="number" id="pol_key_man_capitale" min="0" step="50000" placeholder="Es: 500000">
                    </div>
                    <div class="form-group">
                        <label for="pol_key_man_premio">Premio Annuo (‚Ç¨)</label>
                        <input type="number" id="pol_key_man_premio" min="0" step="100" placeholder="Es: 3000">
                    </div>
                </div>
                <div class="form-group">
                    <label for="pol_key_man_persone">Figure Coperte</label>
                    <input type="text" id="pol_key_man_persone" placeholder="Es: Amministratore Unico, Direttore Commerciale">
                </div>
            </div>

            <!-- CYBER RISK -->
            <div id="pol_cyber_fields" class="polizza-fields">
                <h4>üîí Cyber Risk</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_cyber_compagnia">Compagnia</label>
                        <select id="pol_cyber_compagnia" onchange="handleCompagniaChange('cyber')">
                            <option value="">Seleziona</option>
                            <option value="Generali">Generali</option>
                            <option value="Allianz">Allianz</option>
                            <option value="AXA">AXA</option>
                            <option value="Zurich">Zurich</option>
                            <option value="Chubb">Chubb</option>
                            <option value="AIG">AIG</option>
                            <option value="Altro (specificare)">Altro (specificare)</option>
                        </select>
                    </div>
                    <div class="form-group" id="pol_cyber_altro_group" style="display: none;">
                        <label for="pol_cyber_altra">Altra Compagnia</label>
                        <input type="text" id="pol_cyber_altra" placeholder="Specifica compagnia">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_cyber_massimale">Massimale Aggregato (‚Ç¨)</label>
                        <input type="number" id="pol_cyber_massimale" min="0" step="50000" placeholder="Es: 500000">
                    </div>
                    <div class="form-group">
                        <label for="pol_cyber_premio">Premio Annuo (‚Ç¨)</label>
                        <input type="number" id="pol_cyber_premio" min="0" step="100" placeholder="Es: 6000">
                    </div>
                </div>
            </div>

            <!-- PROPERTY / ALL RISKS -->
            <div id="pol_property_fields" class="polizza-fields">
                <h4>üè≠ Property / All Risks</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_property_compagnia">Compagnia</label>
                        <select id="pol_property_compagnia" onchange="handleCompagniaChange('property')">
                            <option value="">Seleziona</option>
                            <option value="Generali">Generali</option>
                            <option value="Allianz">Allianz</option>
                            <option value="AXA">AXA</option>
                            <option value="UnipolSai">UnipolSai</option>
                            <option value="Zurich">Zurich</option>
                            <option value="Reale Mutua">Reale Mutua</option>
                            <option value="Altro (specificare)">Altro (specificare)</option>
                        </select>
                    </div>
                    <div class="form-group" id="pol_property_altro_group" style="display: none;">
                        <label for="pol_property_altra">Altra Compagnia</label>
                        <input type="text" id="pol_property_altra" placeholder="Specifica compagnia">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_property_valore">Valore Assicurato (‚Ç¨)</label>
                        <input type="number" id="pol_property_valore" min="0" step="50000" placeholder="Es: 2000000">
                    </div>
                    <div class="form-group">
                        <label for="pol_property_premio">Premio Annuo (‚Ç¨)</label>
                        <input type="number" id="pol_property_premio" min="0" step="100" placeholder="Es: 8000">
                    </div>
                </div>
            </div>

            <!-- BUSINESS INTERRUPTION -->
            <div id="pol_business_interruption_fields" class="polizza-fields">
                <h4>‚è∏Ô∏è Business Interruption</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_business_interruption_compagnia">Compagnia</label>
                        <select id="pol_business_interruption_compagnia" onchange="handleCompagniaChange('business_interruption')">
                            <option value="">Seleziona</option>
                            <option value="Generali">Generali</option>
                            <option value="Allianz">Allianz</option>
                            <option value="AXA">AXA</option>
                            <option value="UnipolSai">UnipolSai</option>
                            <option value="Zurich">Zurich</option>
                            <option value="Altro (specificare)">Altro (specificare)</option>
                        </select>
                    </div>
                    <div class="form-group" id="pol_business_interruption_altro_group" style="display: none;">
                        <label for="pol_business_interruption_altra">Altra Compagnia</label>
                        <input type="text" id="pol_business_interruption_altra" placeholder="Specifica compagnia">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_business_interruption_indennizzo">Indennizzo Massimo (‚Ç¨)</label>
                        <input type="number" id="pol_business_interruption_indennizzo" min="0" step="50000" placeholder="Es: 500000">
                    </div>
                    <div class="form-group">
                        <label for="pol_business_interruption_premio">Premio Annuo (‚Ç¨)</label>
                        <input type="number" id="pol_business_interruption_premio" min="0" step="100" placeholder="Es: 4000">
                    </div>
                </div>
                <div class="form-group">
                    <label for="pol_business_interruption_periodo">Periodo Indennizzo (mesi)</label>
                    <input type="number" id="pol_business_interruption_periodo" min="1" max="24" placeholder="Es: 12">
                </div>
            </div>

            <!-- TUTELA LEGALE -->
            <div id="pol_tutela_legale_fields" class="polizza-fields">
                <h4>‚öñÔ∏è Tutela Legale Aziendale</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_tutela_legale_compagnia">Compagnia</label>
                        <select id="pol_tutela_legale_compagnia" onchange="handleCompagniaChange('tutela_legale')">
                            <option value="">Seleziona</option>
                            <option value="Generali">Generali</option>
                            <option value="DAS">DAS</option>
                            <option value="ARAG">ARAG</option>
                            <option value="UnipolSai">UnipolSai</option>
                            <option value="Altro (specificare)">Altro (specificare)</option>
                        </select>
                    </div>
                    <div class="form-group" id="pol_tutela_legale_altro_group" style="display: none;">
                        <label for="pol_tutela_legale_altra">Altra Compagnia</label>
                        <input type="text" id="pol_tutela_legale_altra" placeholder="Specifica compagnia">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_tutela_legale_massimale">Massimale per Sinistro (‚Ç¨)</label>
                        <input type="number" id="pol_tutela_legale_massimale" min="0" step="10000" placeholder="Es: 100000">
                    </div>
                    <div class="form-group">
                        <label for="pol_tutela_legale_premio">Premio Annuo (‚Ç¨)</label>
                        <input type="number" id="pol_tutela_legale_premio" min="0" step="100" placeholder="Es: 2000">
                    </div>
                </div>
            </div>

            <!-- INFORTUNI DIPENDENTI -->
            <div id="pol_infortuni_dipendenti_fields" class="polizza-fields">
                <h4>üë∑ Infortuni Dipendenti (oltre INAIL)</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_infortuni_dipendenti_compagnia">Compagnia</label>
                        <select id="pol_infortuni_dipendenti_compagnia" onchange="handleCompagniaChange('infortuni_dipendenti')">
                            <option value="">Seleziona</option>
                            <option value="Generali">Generali</option>
                            <option value="Allianz">Allianz</option>
                            <option value="UnipolSai">UnipolSai</option>
                            <option value="Zurich">Zurich</option>
                            <option value="Reale Mutua">Reale Mutua</option>
                            <option value="Altro (specificare)">Altro (specificare)</option>
                        </select>
                    </div>
                    <div class="form-group" id="pol_infortuni_dipendenti_altro_group" style="display: none;">
                        <label for="pol_infortuni_dipendenti_altra">Altra Compagnia</label>
                        <input type="text" id="pol_infortuni_dipendenti_altra" placeholder="Specifica compagnia">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_infortuni_dipendenti_capitale">Capitale per Dipendente (‚Ç¨)</label>
                        <input type="number" id="pol_infortuni_dipendenti_capitale" min="0" step="10000" placeholder="Es: 200000">
                    </div>
                    <div class="form-group">
                        <label for="pol_infortuni_dipendenti_premio">Premio Annuo Totale (‚Ç¨)</label>
                        <input type="number" id="pol_infortuni_dipendenti_premio" min="0" step="100" placeholder="Es: 5000">
                    </div>
                </div>
            </div>

            <!-- FLOTTA AUTO -->
            <div id="pol_flotta_fields" class="polizza-fields">
                <h4>üöó Flotta Auto Aziendali</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_flotta_compagnia">Compagnia</label>
                        <select id="pol_flotta_compagnia" onchange="handleCompagniaChange('flotta')">
                            <option value="">Seleziona</option>
                            <option value="Generali">Generali</option>
                            <option value="Allianz">Allianz</option>
                            <option value="UnipolSai">UnipolSai</option>
                            <option value="Zurich">Zurich</option>
                            <option value="Reale Mutua">Reale Mutua</option>
                            <option value="Altro (specificare)">Altro (specificare)</option>
                        </select>
                    </div>
                    <div class="form-group" id="pol_flotta_altro_group" style="display: none;">
                        <label for="pol_flotta_altra">Altra Compagnia</label>
                        <input type="text" id="pol_flotta_altra" placeholder="Specifica compagnia">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_flotta_numero">Numero Veicoli</label>
                        <input type="number" id="pol_flotta_numero" min="1" placeholder="Es: 8">
                    </div>
                    <div class="form-group">
                        <label for="pol_flotta_premio">Premio Annuo Totale (‚Ç¨)</label>
                        <input type="number" id="pol_flotta_premio" min="0" step="100" placeholder="Es: 12000">
                    </div>
                </div>
            </div>

            <!-- TRASPORTO MERCI -->
            <div id="pol_trasporto_merci_fields" class="polizza-fields">
                <h4>üì¶ Trasporto Merci</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_trasporto_merci_compagnia">Compagnia</label>
                        <select id="pol_trasporto_merci_compagnia" onchange="handleCompagniaChange('trasporto_merci')">
                            <option value="">Seleziona</option>
                            <option value="Generali">Generali</option>
                            <option value="Allianz">Allianz</option>
                            <option value="UnipolSai">UnipolSai</option>
                            <option value="Zurich">Zurich</option>
                            <option value="Altro (specificare)">Altro (specificare)</option>
                        </select>
                    </div>
                    <div class="form-group" id="pol_trasporto_merci_altro_group" style="display: none;">
                        <label for="pol_trasporto_merci_altra">Altra Compagnia</label>
                        <input type="text" id="pol_trasporto_merci_altra" placeholder="Specifica compagnia">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_trasporto_merci_massimale">Massimale per Spedizione (‚Ç¨)</label>
                        <input type="number" id="pol_trasporto_merci_massimale" min="0" step="10000" placeholder="Es: 100000">
                    </div>
                    <div class="form-group">
                        <label for="pol_trasporto_merci_premio">Premio Annuo (‚Ç¨)</label>
                        <input type="number" id="pol_trasporto_merci_premio" min="0" step="100" placeholder="Es: 3000">
                    </div>
                </div>
            </div>

            <button class="btn btn-primary btn-block" onclick="iniziaQuestionarioAziendale()" style="margin-top: 30px;">
                üöÄ Avvia Questionario Aziendale
            </button>
        </div>

        <!-- SALVATAGGIO E CARICAMENTO -->
        <div class="card">
            <h2 class="card-title">
                <span class="icon">üíæ</span>
                Gestione Analisi Aziendali
            </h2>

            <div class="form-row">
                <div class="form-group">
                    <label for="nomeAnalisi">Nome Analisi da Salvare</label>
                    <input type="text" id="nomeAnalisi" placeholder="Es: Acme SRL - Gennaio 2025">
                </div>
                <div class="form-group">
                    <button class="btn btn-secondary btn-block" onclick="salvaAnalisiAziendale()">
                        üíæ Salva Analisi
                    </button>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="analisiSalvateSelect">Carica Analisi Salvata</label>
                    <select id="analisiSalvateSelect">
                        <option value="">Seleziona analisi salvata</option>
                    </select>
                </div>
                <div class="form-group">
                    <button class="btn btn-secondary btn-block" onclick="caricaAnalisiAziendale()">
                        üìÇ Carica Analisi
                    </button>
                </div>
            </div>
        </div>
<!-- QUESTIONARIO AZIENDALE -->
        <div id="questionario">
            <div class="card">
                <div class="progress-container" style="background: var(--gray-200); height: 10px; border-radius: 5px; margin-bottom: 30px; overflow: hidden;">
                    <div class="progress-bar" id="progressBar" style="height: 100%; background: linear-gradient(90deg, var(--generali-blue), var(--generali-light-blue)); width: 0%; transition: width 0.4s ease;"></div>
                </div>

                <div id="questionContainer"></div>

                <div style="display: flex; gap: 15px; margin-top: 25px;">
                    <button class="btn btn-secondary" id="prevBtn" onclick="prevQuestion()" style="display: none;">
                        ‚Üê Precedente
                    </button>
                    <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()" style="flex: 1;">
                        Successiva ‚Üí
                    </button>
                    <button class="btn btn-primary" id="finishBtn" onclick="finalizzaQuestionarioAziendale()" style="display: none; flex: 1;">
                        üéØ Genera Analisi Completa
                    </button>
                </div>
            </div>
        </div>

        <!-- RISULTATI -->
        <div id="risultati">
            <div class="card">
                <h2 class="card-title">
                    <span class="icon">üìä</span>
                    Analisi Rischi e Bisogni Completata
                </h2>
                <div id="risultatiContent"></div>

                <div style="margin-top: 40px; display: flex; gap: 15px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="window.print()">
                        üñ®Ô∏è Stampa Report
                    </button>
                    <button class="btn btn-secondary" onclick="location.reload()">
                        üîÑ Nuova Analisi
                    </button>
                    <button class="btn btn-secondary" onclick="esportaPDFAziendale()">
                        üìÑ Esporta PDF
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- JAVASCRIPT -->
    <script>
        // ========================================
        // CONFIGURAZIONE GLOBALE
        // ========================================

        const PASSWORD = 'GeneraliB2B2025!';

        // ========================================
        // AUTENTICAZIONE
        // ========================================

        function checkPassword() {
            const input = document.getElementById('passwordInput');
            if (input.value === PASSWORD) {
                document.getElementById('loginScreen').style.display = 'none';
                showToast('‚úÖ Accesso consentito - Benvenuto!', 'success');
            } else {
                input.value = '';
                input.style.borderColor = 'var(--red)';
                showToast('‚ùå Password errata', 'error');
                setTimeout(() => {
                    input.style.borderColor = '';
                }, 1000);
            }
        }

        document.getElementById('passwordInput')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================

        function calculateCompanyAge(annoCostituzione) {
            if (!annoCostituzione) return 0;
            const currentYear = new Date().getFullYear();
            return currentYear - parseInt(annoCostituzione);
        }

        function showToast(message, type = 'info', duration = 3500) {
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideUp 0.4s ease reverse';
                setTimeout(() => toast.remove(), 400);
            }, duration);
        }

        function showWarningBadge(message) {
            const existingBadge = document.querySelector('.warning-badge');
            if (existingBadge) {
                existingBadge.remove();
            }

            const badge = document.createElement('div');
            badge.className = 'warning-badge';
            badge.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #FEF3C7; color: #92400E; padding: 18px 24px; border-radius: 10px; border-left: 5px solid #F59E0B; box-shadow: 0 6px 20px rgba(0,0,0,0.2); z-index: 9999; max-width: 450px; animation: slideIn 0.3s ease;';
            badge.innerHTML = `<strong>‚ö†Ô∏è Attenzione:</strong><br>${message}`;
            document.body.appendChild(badge);

            setTimeout(() => {
                badge.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => badge.remove(), 300);
            }, 6000);
        }

        // ========================================
        // GESTIONE ANAGRAFICA
        // ========================================

        function togglePolizzaFields(tipo) {
            const checkbox = document.getElementById(`pol_${tipo}`);
            const fields = document.getElementById(`pol_${tipo}_fields`);

            if (checkbox.checked) {
                fields.classList.add('active');
            } else {
                fields.classList.remove('active');
            }
        }

        function handleCompagniaChange(tipo) {
            const select = document.getElementById(`pol_${tipo}_compagnia`);
            const altroGroup = document.getElementById(`pol_${tipo}_altro_group`);

            if (select.value === 'Altro (specificare)') {
                altroGroup.style.display = 'block';
            } else {
                altroGroup.style.display = 'none';
            }
        }

        document.getElementById('consulenteSelect')?.addEventListener('change', function() {
            const altroGroup = document.getElementById('altroConsulenteGroup');
            if (this.value === 'Altro') {
                altroGroup.style.display = 'block';
            } else {
                altroGroup.style.display = 'none';
            }
        });

        function generaKeyPersonsFields() {
            const numero = parseInt(document.getElementById('numeroKeyPersons').value) || 0;
            const container = document.getElementById('keyPersonsContainer');
            
            if (numero === 0) {
                container.innerHTML = '';
                return;
            }

            let html = '<div style="background: var(--gray-50); padding: 20px; border-radius: 8px; border-left: 4px solid var(--generali-blue);">';
            html += '<h4 style="color: var(--generali-blue); margin-bottom: 15px;">Dettagli Key Persons</h4>';

            for (let i = 1; i <= numero; i++) {
                html += '<div style="background: white; padding: 15px; margin-bottom: 15px; border-radius: 6px; border: 1px solid var(--gray-200);">';
                html += `<h5 style="color: var(--gray-700); margin-bottom: 12px;">Key Person ${i}</h5>`;
                html += '<div class="form-row">';
                html += '<div class="form-group">';
                html += `<label for="kp_${i}_ruolo">Ruolo</label>`;
                html += `<input type="text" id="kp_${i}_ruolo" placeholder="Es: Amministratore Unico">`;
                html += '</div>';
                html += '<div class="form-group">';
                html += `<label for="kp_${i}_eta">Et√†</label>`;
                html += `<input type="number" id="kp_${i}_eta" min="18" max="90" placeholder="Es: 52">`;
                html += '</div>';
                html += '</div>';
                html += '</div>';
            }

            html += '</div>';
            container.innerHTML = html;
        }

        // ========================================
        // QUESTIONARIO - DOMANDE AZIENDALI
        // ========================================

        const questionsAziendali = [
            // SEZIONE A: GOVERNANCE & CONTINUIT√Ä (6 domande)
            {
                id: 'A1',
                section: 'A',
                text: 'Quanto l\'azienda dipende da figure chiave specifiche (amministratori, soci operativi)?',
                options: [
                    { value: 1, label: '1 - Dipendenza totale da 1 persona (tutto si ferma senza di lei)' },
                    { value: 2, label: '2 - Dipendenza elevata (2-3 persone critiche)' },
                    { value: 3, label: '3 - Dipendenza moderata (management snello ma essenziale)' },
                    { value: 4, label: '4 - Dipendenza limitata (team management strutturato)' },
                    { value: 5, label: '5 - Nessuna dipendenza critica (organizzazione scalabile)' }
                ]
            },
            {
                id: 'A2',
                section: 'A',
                text: 'Esiste un piano di successione/continuit√† aziendale documentato?',
                options: [
                    { value: 1, label: '1 - Non esiste alcun piano' },
                    { value: 2, label: '2 - Solo idee informali, nulla di scritto' },
                    { value: 3, label: '3 - Piano parziale, in fase di definizione' },
                    { value: 4, label: '4 - Piano definito ma non testato' },
                    { value: 5, label: '5 - Piano completo, documentato e testato' }
                ]
            },
            {
                id: 'A3',
                section: 'A',
                text: 'Il know-how aziendale √® documentato o dipende dalla conoscenza tacita di pochi?',
                options: [
                    { value: 1, label: '1 - Tutto nella testa del titolare/poche persone' },
                    { value: 2, label: '2 - Parzialmente documentato, molte lacune' },
                    { value: 3, label: '3 - Documentazione base presente' },
                    { value: 4, label: '4 - Buona documentazione processi chiave' },
                    { value: 5, label: '5 - Completa documentazione e knowledge management' }
                ]
            },
            {
                id: 'A4',
                section: 'A',
                text: 'In caso di assenza improvvisa dell\'amministratore per 6 mesi, l\'azienda potrebbe continuare?',
                options: [
                    { value: 1, label: '1 - No, si fermerebbe tutto immediatamente' },
                    { value: 2, label: '2 - Sopravvivenza max 1 mese' },
                    { value: 3, label: '3 - Potrebbe andare avanti 3-6 mesi con difficolt√†' },
                    { value: 4, label: '4 - S√¨, con qualche rallentamento' },
                    { value: 5, label: '5 - S√¨, nessun impatto significativo' }
                ]
            },
            {
                id: 'A5',
                section: 'A',
                text: 'Quante persone hanno accesso a informazioni finanziarie critiche (conti, fornitori, clienti)?',
                options: [
                    { value: 1, label: '1 - Solo 1 persona' },
                    { value: 2, label: '2 - 2 persone' },
                    { value: 3, label: '3 - 3 persone' },
                    { value: 4, label: '4 - 4-5 persone' },
                    { value: 5, label: '5 - Pi√π di 5 persone (accesso distribuito)' }
                ]
            },
            {
                id: 'A6',
                section: 'A',
                text: 'Con quale frequenza vengono aggiornati/rivisti i piani strategici e operativi?',
                options: [
                    { value: 1, label: '1 - Mai, si va avanti a vista' },
                    { value: 2, label: '2 - Sporadicamente, quando ci sono problemi' },
                    { value: 3, label: '3 - Annualmente' },
                    { value: 4, label: '4 - Ogni 6 mesi' },
                    { value: 5, label: '5 - Trimestralmente con KPI monitorati' }
                ]
            },

            // SEZIONE B: OPERATIVIT√Ä & RISCHI (8 domande)
            {
                id: 'B1',
                section: 'B',
                text: 'Quanto √® esposta l\'azienda a rischi operativi (danni a macchinari, interruzione produzione, etc.)?',
                options: [
                    { value: 1, label: '1 - Rischio minimo (servizi senza asset fisici critici)' },
                    { value: 2, label: '2 - Rischio basso (pochi asset critici)' },
                    { value: 3, label: '3 - Rischio medio (alcuni asset importanti)' },
                    { value: 4, label: '4 - Rischio elevato (molti asset critici)' },
                    { value: 5, label: '5 - Rischio altissimo (un guasto ferma tutto)' }
                ]
            },
            {
                id: 'B2',
                section: 'B',
                text: 'Negli ultimi 5 anni, quanti sinistri/incidenti significativi ha subito l\'azienda?',
                options: [
                    { value: 1, label: '1 - Nessuno' },
                    { value: 2, label: '2 - 1 sinistro' },
                    { value: 3, label: '3 - 2-3 sinistri' },
                    { value: 4, label: '4 - 4-5 sinistri' },
                    { value: 5, label: '5 - Oltre 5 sinistri' }
                ]
            },
            {
                id: 'B3',
                section: 'B',
                text: 'Qual √® lo stato di manutenzione di impianti, macchinari, edifici?',
                options: [
                    { value: 1, label: '1 - Trascurato, manutenzione solo emergenze' },
                    { value: 2, label: '2 - Manutenzione reattiva (quando si rompe)' },
                    { value: 3, label: '3 - Manutenzione ordinaria periodica' },
                    { value: 4, label: '4 - Manutenzione preventiva pianificata' },
                    { value: 5, label: '5 - Manutenzione predittiva con monitoraggio' }
                ]
            },
            {
                id: 'B4',
                section: 'B',
                text: 'Come valuti il livello di sicurezza informatica aziendale?',
                options: [
                    { value: 1, label: '1 - Nessuna protezione (password deboli, nessun backup)' },
                    { value: 2, label: '2 - Protezione minima (antivirus base)' },
                    { value: 3, label: '3 - Protezione standard (firewall, backup occasionali)' },
                    { value: 4, label: '4 - Buona protezione (backup automatici, policy sicurezza)' },
                    { value: 5, label: '5 - Protezione avanzata (SOC, pen test, DR plan)' }
                ]
            },
            {
                id: 'B5',
                section: 'B',
                text: 'Quanti fornitori critici ha l\'azienda (senza cui non pu√≤ operare)?',
                options: [
                    { value: 1, label: '1 - Oltre 10 fornitori critici' },
                    { value: 2, label: '2 - 5-10 fornitori critici' },
                    { value: 3, label: '3 - 3-4 fornitori critici' },
                    { value: 4, label: '4 - 1-2 fornitori critici' },
                    { value: 5, label: '5 - Nessun fornitore veramente critico (sostituibili)' }
                ]
            },
            {
                id: 'B6',
                section: 'B',
                text: 'Quanto √® concentrato il fatturato sui top 3 clienti?',
                options: [
                    { value: 1, label: '1 - Oltre 70% su top 3 (dipendenza critica)' },
                    { value: 2, label: '2 - 50-70% su top 3 (dipendenza alta)' },
                    { value: 3, label: '3 - 30-50% su top 3 (dipendenza moderata)' },
                    { value: 4, label: '4 - 15-30% su top 3 (buona diversificazione)' },
                    { value: 5, label: '5 - Meno del 15% su top 3 (ottima diversificazione)' }
                ]
            },
            {
                id: 'B7',
                section: 'B',
                text: 'Quanti contenziosi legali/vertenze ha attualmente l\'azienda?',
                options: [
                    { value: 1, label: '1 - Oltre 5 contenziosi aperti' },
                    { value: 2, label: '2 - 3-5 contenziosi' },
                    { value: 3, label: '3 - 1-2 contenziosi' },
                    { value: 4, label: '4 - Nessun contenzioso attivo' },
                    { value: 5, label: '5 - Mai avuto contenziosi significativi' }
                ]
            },
            {
                id: 'B8',
                section: 'B',
                text: 'Valuta i rischi specifici del tuo settore (es: normative, infortuni, ambiente)',
                options: [
                    { value: 1, label: '1 - Settore ad altissimo rischio (es: edilizia, chimico)' },
                    { value: 2, label: '2 - Settore alto rischio (es: trasporti, sanit√†)' },
                    { value: 3, label: '3 - Settore rischio medio (es: manifatturiero)' },
                    { value: 4, label: '4 - Settore basso rischio (es: commercio)' },
                    { value: 5, label: '5 - Settore minimo rischio (es: servizi digitali)' }
                ]
            },

            // SEZIONE C: FINANZA & STRATEGIA (10 domande)
            {
                id: 'C1',
                section: 'C',
                text: 'Come definiresti la solidit√† patrimoniale dell\'azienda?',
                options: [
                    { value: 1, label: '1 - Patrimonio netto negativo o quasi' },
                    { value: 2, label: '2 - Patrimonio netto basso, alta leva finanziaria' },
                    { value: 3, label: '3 - Patrimonio netto adeguato' },
                    { value: 4, label: '4 - Patrimonio netto solido' },
                    { value: 5, label: '5 - Patrimonio netto molto elevato, basso debito' }
                ]
            },
            {
                id: 'C2',
                section: 'C',
                text: 'Capacit√† di autofinanziamento: quanto cash genera l\'azienda?',
                options: [
                    { value: 1, label: '1 - Sempre in difficolt√† liquidit√†' },
                    { value: 2, label: '2 - Liquidit√† giusta per sopravvivere' },
                    { value: 3, label: '3 - Genera cassa sufficiente per operare' },
                    { value: 4, label: '4 - Buona generazione cassa, pu√≤ investire' },
                    { value: 5, label: '5 - Eccellente generazione cassa, alta liquidit√†' }
                ]
            },
            {
                id: 'C3',
                section: 'C',
                text: 'L\'azienda ha un piano strategico 3-5 anni documentato?',
                options: [
                    { value: 1, label: '1 - No, nessun piano' },
                    { value: 2, label: '2 - Idee vaghe, nulla di scritto' },
                    { value: 3, label: '3 - Piano informale ma non documentato' },
                    { value: 4, label: '4 - Piano scritto ma non dettagliato' },
                    { value: 5, label: '5 - Piano strategico completo e monitorato' }
                ]
            },
            {
                id: 'C4',
                section: 'C',
                text: 'Investimenti pianificati nei prossimi 2 anni?',
                options: [
                    { value: 1, label: '1 - Nessun investimento previsto' },
                    { value: 2, label: '2 - Investimenti minimi manutenzione' },
                    { value: 3, label: '3 - Investimenti moderati in efficienza' },
                    { value: 4, label: '4 - Investimenti significativi in crescita' },
                    { value: 5, label: '5 - Piano investimenti ambizioso per scalare' }
                ]
            },
            {
                id: 'C5',
                section: 'C',
                text: 'Rapporto Debiti/Patrimonio (leva finanziaria)?',
                options: [
                    { value: 1, label: '1 - Oltre 5x (debiti >> patrimonio)' },
                    { value: 2, label: '2 - 3-5x (alta leva)' },
                    { value: 3, label: '3 - 1.5-3x (leva moderata)' },
                    { value: 4, label: '4 - 0.5-1.5x (bassa leva)' },
                    { value: 5, label: '5 - Meno di 0.5x (quasi nessun debito)' }
                ]
            },
            {
                id: 'C6',
                section: 'C',
                text: 'Diversificazione dei ricavi (prodotti/servizi/mercati)?',
                options: [
                    { value: 1, label: '1 - Mono-prodotto/mono-mercato' },
                    { value: 2, label: '2 - 2-3 prodotti/mercati' },
                    { value: 3, label: '3 - Discreta diversificazione' },
                    { value: 4, label: '4 - Buona diversificazione' },
                    { value: 5, label: '5 - Ottima diversificazione multi-prodotto/mercato' }
                ]
            },
            {
                id: 'C7',
                section: 'C',
                text: 'Propensione al rischio imprenditoriale?',
                options: [
                    { value: 1, label: '1 - Molto conservativo, evito ogni rischio' },
                    { value: 2, label: '2 - Conservativo, preferisco stabilit√†' },
                    { value: 3, label: '3 - Equilibrato, valuto caso per caso' },
                    { value: 4, label: '4 - Dinamico, accetto rischi calcolati' },
                    { value: 5, label: '5 - Aggressivo, punto a crescita rapida' }
                ]
            },
            {
                id: 'C8',
                section: 'C',
                text: 'Come vedi l\'evoluzione del fatturato nei prossimi 3 anni?',
                options: [
                    { value: 1, label: '1 - Prevedo contrazione' },
                    { value: 2, label: '2 - Stabile o lieve contrazione' },
                    { value: 3, label: '3 - Stabile' },
                    { value: 4, label: '4 - Crescita moderata (+5-15% anno)' },
                    { value: 5, label: '5 - Crescita forte (oltre +15% anno)' }
                ]
            },
            {
                id: 'C9',
                section: 'C',
                text: 'Separazione patrimonio personale da patrimonio aziendale?',
                options: [
                    { value: 1, label: '1 - Nessuna separazione, tutto misto' },
                    { value: 2, label: '2 - Parziale ma confusa' },
                    { value: 3, label: '3 - Separazione discreta' },
                    { value: 4, label: '4 - Buona separazione' },
                    { value: 5, label: '5 - Totale separazione e protezione' }
                ]
            },
            {
                id: 'C10',
                section: 'C',
                text: 'Hai pensato a una exit strategy (vendita, passaggio generazionale, quotazione)?',
                options: [
                    { value: 1, label: '1 - Mai pensato' },
                    { value: 2, label: '2 - Ci penso ma √® lontano' },
                    { value: 3, label: '3 - Ho qualche idea vaga' },
                    { value: 4, label: '4 - Sto pianificando' },
                    { value: 5, label: '5 - Piano exit chiaro e documentato' }
                ]
            }
        ];

        // ========================================
        // STATE MANAGEMENT
        // ========================================

        const appStateAzienda = {
            company: {
                anagrafica: {},
                polizze: {},
                keyPersons: []
            },
            currentQuestion: 0,
            answers: {},
            results: null
        };

        // ========================================
        // INIZIA QUESTIONARIO
        // ========================================

        function iniziaQuestionarioAziendale() {
            // Valida campi obbligatori
            const requiredFields = [
                'ragioneSociale', 'partitaIVA', 'formaGiuridica', 'annoCostituzione',
                'settoreATECO', 'numeroDipendenti', 'fatturatoAnnuo',
                'provinciaSedeOperativa', 'emailAzienda', 'telefonoAzienda', 'numeroKeyPersons'
            ];

            for (const field of requiredFields) {
                const element = document.getElementById(field);
                if (!element || !element.value) {
                    element?.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    element?.focus();
                    showToast(`‚ö†Ô∏è Compila il campo: ${element?.previousElementSibling?.textContent || field}`, 'error', 4000);
                    return;
                }
            }

            // Salva anagrafica
            collectAnagraficaAziendale();

            // Mostra questionario
            document.getElementById('anagraficaSection').style.display = 'none';
            document.getElementById('questionario').style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Render prima domanda
            renderQuestionAzienda();
        }

        function collectAnagraficaAziendale() {
            const annoCostituzione = document.getElementById('annoCostituzione').value;

            appStateAzienda.company.anagrafica = {
                ragioneSociale: document.getElementById('ragioneSociale').value,
                partitaIVA: document.getElementById('partitaIVA').value,
                codiceFiscale: document.getElementById('codiceFiscaleAzienda').value,
                formaGiuridica: document.getElementById('formaGiuridica').value,
                annoCostituzione: annoCostituzione,
                companyAge: calculateCompanyAge(annoCostituzione),
                settoreATECO: document.getElementById('settoreATECO').value,
                numeroDipendenti: parseInt(document.getElementById('numeroDipendenti').value) || 0,
                fatturatoAnnuo: parseFloat(document.getElementById('fatturatoAnnuo').value) || 0,
                patrimonioNetto: parseFloat(document.getElementById('patrimonioNetto').value) || 0,
                provinciaSedeOperativa: document.getElementById('provinciaSedeOperativa').value,
                numeroSediOperative: parseInt(document.getElementById('numeroSediOperative').value) || 1,
                emailAzienda: document.getElementById('emailAzienda').value,
                telefonoAzienda: document.getElementById('telefonoAzienda').value,
                sitoWeb: document.getElementById('sitoWeb').value,
                percentualeExport: parseFloat(document.getElementById('percentualeExport').value) || 0,
                numeroKeyPersons: parseInt(document.getElementById('numeroKeyPersons').value) || 1,
                etaMediaManagement: parseInt(document.getElementById('etaMediaManagement').value) || 0,
                debitiTotali: parseFloat(document.getElementById('debitiTotali').value) || 0,
                creditiCommerciali: parseFloat(document.getElementById('creditiCommerciali').value) || 0,
                immobiliProprieta: document.getElementById('immobiliProprieta').value,
                valoreImmobili: parseFloat(document.getElementById('valoreImmobili').value) || 0,
                concentrazioneClienti: parseFloat(document.getElementById('concentrazioneClienti').value) || 0,
                certificazioni: Array.from(document.getElementById('certificazioni').selectedOptions).map(opt => opt.value),
                sinistralitaStorica: document.getElementById('sinistralitaStorica').value,
                consulente: document.getElementById('consulenteSelect').value === 'Altro' ?
                    document.getElementById('altroConsulente').value :
                    document.getElementById('consulenteSelect').value
            };

            // Key Persons
            const numeroKeyPersons = appStateAzienda.company.anagrafica.numeroKeyPersons;
            appStateAzienda.company.keyPersons = [];
            for (let i = 1; i <= numeroKeyPersons; i++) {
                const ruolo = document.getElementById(`kp_${i}_ruolo`)?.value || '';
                const eta = parseInt(document.getElementById(`kp_${i}_eta`)?.value) || 0;
                appStateAzienda.company.keyPersons.push({ ruolo, eta });
            }

            // Polizze
            const tipiPolizze = ['rc_generale', 'rc_professionale', 'rc_prodotti', 'do', 'key_man', 'cyber', 'property', 'business_interruption', 'tutela_legale', 'infortuni_dipendenti', 'flotta', 'trasporto_merci'];
            appStateAzienda.company.polizze = {};

            tipiPolizze.forEach(tipo => {
                const checkbox = document.getElementById(`pol_${tipo}`);
                if (checkbox && checkbox.checked) {
                    const compagniaSelect = document.getElementById(`pol_${tipo}_compagnia`);
                    const compagnia = compagniaSelect.value === 'Altro (specificare)' ?
                        document.getElementById(`pol_${tipo}_altra`).value :
                        compagniaSelect.value;

                    appStateAzienda.company.polizze[tipo] = {
                        compagnia: compagnia,
                        massimale: parseFloat(document.getElementById(`pol_${tipo}_massimale`)?.value) || 0,
                        premio: parseFloat(document.getElementById(`pol_${tipo}_premio`)?.value) || 0,
                        capitale: parseFloat(document.getElementById(`pol_${tipo}_capitale`)?.value) || 0,
                        valore: parseFloat(document.getElementById(`pol_${tipo}_valore`)?.value) || 0,
                        indennizzo: parseFloat(document.getElementById(`pol_${tipo}_indennizzo`)?.value) || 0,
                        periodo: parseInt(document.getElementById(`pol_${tipo}_periodo`)?.value) || 0,
                        numero: parseInt(document.getElementById(`pol_${tipo}_numero`)?.value) || 0,
                        persone: document.getElementById(`pol_${tipo}_persone`)?.value || ''
                    };
                }
            });
        }

        // ========================================
        // RENDERING QUESTIONARIO
        // ========================================

        function renderQuestionAzienda() {
            const question = questionsAziendali[appStateAzienda.currentQuestion];
            const container = document.getElementById('questionContainer');

            let html = '<div class="question-card" style="background: white; border-radius: 12px; padding: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-left: 4px solid var(--generali-blue);">';
            html += `<div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px;">`;
            html += `<h3 style="color: var(--generali-blue); margin: 0;">Domanda ${appStateAzienda.currentQuestion + 1} di ${questionsAziendali.length}</h3>`;
            html += `<span class="badge badge-info">Sezione ${question.section}</span>`;
            html += `</div>`;
            html += `<p style="font-size: 18px; margin: 20px 0; color: var(--gray-700); font-weight: 500; line-height: 1.6;">${question.text}</p>`;
            html += '<div class="options" style="display: flex; flex-direction: column; gap: 12px;">';

            question.options.forEach(opt => {
                const selected = appStateAzienda.answers[question.id] === opt.value ? 'selected' : '';
                html += `<div class="option ${selected}" onclick="selectOptionAzienda('${question.id}', ${opt.value})" style="padding: 16px 20px; border: 2px solid var(--gray-200); border-radius: 8px; cursor: pointer; transition: all 0.2s; background: white;">`;
                html += opt.label;
                html += '</div>';
            });

            html += '</div>';
            html += '</div>';

            container.innerHTML = html;

            updateProgressAzienda();
            updateButtonsAzienda();
        }

        function selectOptionAzienda(questionId, value) {
            appStateAzienda.answers[questionId] = value;
            renderQuestionAzienda();
        }

        function updateProgressAzienda() {
            const progress = ((appStateAzienda.currentQuestion + 1) / questionsAziendali.length) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
        }

        function updateButtonsAzienda() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const finishBtn = document.getElementById('finishBtn');

            prevBtn.style.display = appStateAzienda.currentQuestion > 0 ? 'block' : 'none';

            const isLastQuestion = appStateAzienda.currentQuestion === questionsAziendali.length - 1;
            nextBtn.style.display = isLastQuestion ? 'none' : 'block';
            finishBtn.style.display = isLastQuestion ? 'block' : 'none';
        }

        function nextQuestion() {
            const currentQ = questionsAziendali[appStateAzienda.currentQuestion];
            if (!appStateAzienda.answers[currentQ.id]) {
                showToast('‚ö†Ô∏è Seleziona una risposta prima di continuare', 'error');
                return;
            }

            if (appStateAzienda.currentQuestion < questionsAziendali.length - 1) {
                appStateAzienda.currentQuestion++;
                renderQuestionAzienda();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function prevQuestion() {
            if (appStateAzienda.currentQuestion > 0) {
                appStateAzienda.currentQuestion--;
                renderQuestionAzienda();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function finalizzaQuestionarioAziendale() {
            const currentQ = questionsAziendali[appStateAzienda.currentQuestion];
            if (!appStateAzienda.answers[currentQ.id]) {
                showToast('‚ö†Ô∏è Seleziona una risposta prima di continuare', 'error');
                return;
            }

            showToast('üîÑ Analisi in corso...', 'info', 2000);

            setTimeout(() => {
                generaRisultatiAziendali();
            }, 1500);
        }

        // ========================================
        // PLACEHOLDER FUNZIONI (da implementare nelle prossime parti)
        // ========================================

        function generaRisultatiAziendali() {
            // Implementato nelle prossime parti
            showToast('‚úÖ Analisi completata!', 'success');
            
            document.getElementById('questionario').style.display = 'none';
            document.getElementById('risultati').style.display = 'block';
            
            document.getElementById('risultatiContent').innerHTML = '<h3 style="color: var(--generali-blue);">Risultati in fase di elaborazione...</h3><p>Funzionalit√† complete nelle prossime parti.</p>';
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function salvaAnalisiAziendale() {
            showToast('Funzione salvataggio - Parte successiva', 'info');
        }

        function caricaAnalisiAziendale() {
            showToast('Funzione caricamento - Parte successiva', 'info');
        }

        function esportaPDFAziendale() {
            showToast('Funzione export PDF - Parte successiva', 'info');
        }
    </script>
<script>
        // ========================================
        // CALCOLO GAP AZIENDALI
        // ========================================

        function calcolaGapAziendali(companyData, answers) {
            const gaps = {
                continuita: {},
                rc_contenzioso: {},
                cyber: {},
                property_interruption: {},
                successione: {}
            };

            const fatturato = companyData.fatturatoAnnuo || 0;
            const dipendenti = companyData.numeroDipendenti || 0;
            const numKeyPersons = companyData.numeroKeyPersons || 1;
            const settore = companyData.settoreATECO || '';
            const valoreImmobili = companyData.valoreImmobili || 0;
            const polizze = companyData.polizze || {};

            // ========================================
            // GAP 1: CONTINUIT√Ä AZIENDALE
            // ========================================

            const dipendenzaKeyPerson = answers.A1 || 3;
            const continuita = answers.A4 || 3;

            // Calcolo perdita fatturato per assenza key person
            let percentualePerdita = 0;
            if (dipendenzaKeyPerson === 1) percentualePerdita = 1.0; // 100% - totale dipendenza
            else if (dipendenzaKeyPerson === 2) percentualePerdita = 0.7; // 70%
            else if (dipendenzaKeyPerson === 3) percentualePerdita = 0.4; // 40%
            else if (dipendenzaKeyPerson === 4) percentualePerdita = 0.2; // 20%
            else percentualePerdita = 0.05; // 5%

            const perdita6Mesi = (fatturato / 12) * 6 * percentualePerdita;
            const costiStruttura6Mesi = (fatturato * 0.6 / 12) * 6; // 60% del fatturato = costi fissi

            const copterturaKeyMan = polizze.key_man?.capitale || 0;
            const scoperturaLorda = Math.max(0, perdita6Mesi + costiStruttura6Mesi - copterturaKeyMan);

            gaps.continuita = {
                dipendenzaKeyPerson: dipendenzaKeyPerson,
                perdita6Mesi: Math.round(perdita6Mesi),
                costiStruttura6Mesi: Math.round(costiStruttura6Mesi),
                impattoTotale: Math.round(perdita6Mesi + costiStruttura6Mesi),
                copterturaKeyMan: copterturaKeyMan,
                scoperturaLorda: Math.round(scoperturaLorda),
                gravita: scoperturaLorda > (fatturato * 0.5) ? 'critica' :
                         scoperturaLorda > (fatturato * 0.25) ? 'alta' :
                         scoperturaLorda > 0 ? 'media' : 'coperta',
                messaggio: scoperturaLorda > (fatturato * 0.5) ?
                    `CRITICO: Perdita stimata ‚Ç¨${scoperturaLorda.toLocaleString()} (oltre 50% fatturato) in caso assenza key person 6 mesi` :
                    scoperturaLorda > 0 ?
                    `Gap da coprire: ‚Ç¨${scoperturaLorda.toLocaleString()}` :
                    'Continuit√† aziendale adeguatamente protetta'
            };

            // ========================================
            // GAP 2: RC / CONTENZIOSO
            // ========================================

            const contenziosi = 5 - (answers.B7 || 3); // Invertito: molti contenziosi = alto rischio
            const rischiSettore = answers.B8 || 3;

            // Massimale consigliato basato su fatturato e settore
            let fattoreMoltiplicatore = 2; // Default
            if (rischiSettore >= 4) fattoreMoltiplicatore = 4; // Settore alto rischio
            else if (rischiSettore <= 2) fattoreMoltiplicatore = 1; // Settore basso rischio

            const massimaleConsigliato = fatturato * fattoreMoltiplicatore;

            const massimaleRCGenerale = polizze.rc_generale?.massimale || 0;
            const massimaleRCProfessionale = polizze.rc_professionale?.massimale || 0;
            const massimaleRCProdotti = polizze.rc_prodotti?.massimale || 0;
            const coperturaTotaleRC = massimaleRCGenerale + massimaleRCProfessionale + massimaleRCProdotti;

            const gapRC = Math.max(0, massimaleConsigliato - coperturaTotaleRC);

            gaps.rc_contenzioso = {
                contenziosi: contenziosi,
                rischiSettore: rischiSettore,
                massimaleConsigliato: Math.round(massimaleConsigliato),
                coperturaTotaleRC: coperturaTotaleRC,
                gapRC: Math.round(gapRC),
                gravita: gapRC > massimaleConsigliato * 0.7 ? 'critica' :
                         gapRC > massimaleConsigliato * 0.4 ? 'alta' :
                         gapRC > 0 ? 'media' : 'coperta',
                messaggio: gapRC > massimaleConsigliato * 0.7 ?
                    `CRITICO: Massimale RC insufficiente di ‚Ç¨${gapRC.toLocaleString()} (consigliato ${fattoreMoltiplicatore}x fatturato)` :
                    gapRC > 0 ?
                    `Gap RC da coprire: ‚Ç¨${gapRC.toLocaleString()}` :
                    'Coperture RC adeguate'
            };

            // ========================================
            // GAP 3: CYBER RISK
            // ========================================

            const sicurezzaInformatica = answers.B4 || 3;
            const esposizioneDigitale = companyData.settoreATECO.startsWith('J') || 
                                       companyData.settoreATECO.startsWith('M62') ? 'alta' : 'media';

            // Costo medio data breach basato su dimensione azienda
            let costoMedioDataBreach = 0;
            if (dipendenti <= 10) costoMedioDataBreach = 50000;
            else if (dipendenti <= 50) costoMedioDataBreach = 150000;
            else if (dipendenti <= 250) costoMedioDataBreach = 500000;
            else costoMedioDataBreach = 1000000;

            // Aumenta se settore IT
            if (esposizioneDigitale === 'alta') costoMedioDataBreach *= 2;

            // Costi interruzione business
            const costoInterruzioneGiorno = fatturato / 365;
            const giorniMediInterruzione = sicurezzaInformatica <= 2 ? 30 : sicurezzaInformatica === 3 ? 15 : 7;
            const costoInterruzioneTotale = costoInterruzioneGiorno * giorniMediInterruzione;

            const costoTotaleCyber = costoMedioDataBreach + costoInterruzioneTotale;

            const coperturaCyber = polizze.cyber?.massimale || 0;
            const gapCyber = Math.max(0, costoTotaleCyber - coperturaCyber);

            gaps.cyber = {
                sicurezzaInformatica: sicurezzaInformatica,
                esposizioneDigitale: esposizioneDigitale,
                costoMedioDataBreach: Math.round(costoMedioDataBreach),
                costoInterruzioneGiorni: giorniMediInterruzione,
                costoInterruzioneTotale: Math.round(costoInterruzioneTotale),
                costoTotaleCyber: Math.round(costoTotaleCyber),
                coperturaCyber: coperturaCyber,
                gapCyber: Math.round(gapCyber),
                gravita: sicurezzaInformatica <= 2 ? 'critica' :
                         gapCyber > costoTotaleCyber * 0.5 ? 'alta' :
                         gapCyber > 0 ? 'media' : 'coperta',
                messaggio: sicurezzaInformatica <= 2 ?
                    `CRITICO: Scarsa sicurezza informatica + gap ‚Ç¨${gapCyber.toLocaleString()}. Rischio cyber elevato!` :
                    gapCyber > 0 ?
                    `Gap cyber da coprire: ‚Ç¨${gapCyber.toLocaleString()}` :
                    'Protezione cyber adeguata'
            };

            // ========================================
            // GAP 4: PROPERTY & BUSINESS INTERRUPTION
            // ========================================

            const rischiOperativi = answers.B1 || 3;
            const manutenzione = 5 - (answers.B3 || 3); // Invertito: scarsa manutenzione = alto rischio

            const valoreAssetTotale = valoreImmobili > 0 ? valoreImmobili : fatturato * 0.5; // Stima 50% fatturato
            const coperturaProperty = polizze.property?.valore || 0;

            const gapProperty = Math.max(0, valoreAssetTotale - coperturaProperty);

            // Business Interruption
            const costiMensiliAzienda = (fatturato * 0.7) / 12; // 70% = costi fissi
            const mesiCritici = rischiOperativi >= 4 ? 12 : rischiOperativi === 3 ? 6 : 3;
            const costoInterruzioneMax = costiMensiliAzienda * mesiCritici;

            const coperturaBI = polizze.business_interruption?.indennizzo || 0;
            const gapBI = Math.max(0, costoInterruzioneMax - coperturaBI);

            gaps.property_interruption = {
                rischiOperativi: rischiOperativi,
                valoreAssetTotale: Math.round(valoreAssetTotale),
                coperturaProperty: coperturaProperty,
                gapProperty: Math.round(gapProperty),
                mesiCritici: mesiCritici,
                costoInterruzioneMax: Math.round(costoInterruzioneMax),
                coperturaBI: coperturaBI,
                gapBI: Math.round(gapBI),
                gapTotale: Math.round(gapProperty + gapBI),
                gravita: (gapProperty + gapBI) > fatturato * 0.5 ? 'critica' :
                         (gapProperty + gapBI) > fatturato * 0.25 ? 'alta' :
                         (gapProperty + gapBI) > 0 ? 'media' : 'coperta',
                messaggio: (gapProperty + gapBI) > fatturato * 0.5 ?
                    `CRITICO: Gap totale property+BI ‚Ç¨${(gapProperty + gapBI).toLocaleString()} (>50% fatturato)` :
                    (gapProperty + gapBI) > 0 ?
                    `Gap da coprire: Property ‚Ç¨${gapProperty.toLocaleString()} + BI ‚Ç¨${gapBI.toLocaleString()}` :
                    'Asset e continuit√† adeguatamente protetti'
            };

            // ========================================
            // GAP 5: SUCCESSIONE / PASSAGGIO GENERAZIONALE
            // ========================================

            const pianoSuccessione = answers.A2 || 3;
            const exitStrategy = answers.C10 || 3;
            const separazionePatrimoni = answers.C9 || 3;

            const companyAge = companyData.companyAge || 0;
            const etaMediaManagement = companyData.etaMediaManagement || 50;

            // Liquidit√† necessaria per buy-out eredi o passaggio generazionale
            const valoreAziendaStimato = fatturato * 1.5; // Multiplo semplificato
            const liquiditaNecessaria = companyAge > 10 && etaMediaManagement > 55 ? 
                                       valoreAziendaStimato * 0.5 : // 50% per buy-out
                                       valoreAziendaStimato * 0.3;  // 30% per liquidit√†

            const liquiditaDisponibile = (companyData.patrimonioNetto || 0) * 0.5; // 50% patrimonio liquidabile
            const gapSuccessione = Math.max(0, liquiditaNecessaria - liquiditaDisponibile);

            gaps.successione = {
                companyAge: companyAge,
                etaMediaManagement: etaMediaManagement,
                pianoSuccessione: pianoSuccessione,
                exitStrategy: exitStrategy,
                separazionePatrimoni: separazionePatrimoni,
                valoreAziendaStimato: Math.round(valoreAziendaStimato),
                liquiditaNecessaria: Math.round(liquiditaNecessaria),
                liquiditaDisponibile: Math.round(liquiditaDisponibile),
                gapSuccessione: Math.round(gapSuccessione),
                urgenza: (companyAge > 15 && etaMediaManagement > 60) ? 'alta' :
                         (companyAge > 10 && etaMediaManagement > 55) ? 'media' : 'bassa',
                gravita: gapSuccessione > liquiditaNecessaria * 0.7 ? 'critica' :
                         gapSuccessione > liquiditaNecessaria * 0.4 ? 'alta' :
                         gapSuccessione > 0 ? 'media' : 'coperta',
                messaggio: (companyAge > 15 && etaMediaManagement > 60) ?
                    `URGENTE: Et√† media management ${etaMediaManagement} anni, azienda ${companyAge} anni. Gap liquidit√† successione ‚Ç¨${gapSuccessione.toLocaleString()}` :
                    gapSuccessione > 0 ?
                    `Gap liquidit√† successione: ‚Ç¨${gapSuccessione.toLocaleString()}` :
                    'Liquidit√† successione adeguata'
            };

            return gaps;
        }

        // ========================================
        // ANALISI NORMOTIPO AZIENDALE
        // ========================================

        function analizzaNormotipoAziendale(companyData, answers) {
            const fatturato = companyData.fatturatoAnnuo || 0;
            const dipendenti = companyData.numeroDipendenti || 0;
            const companyAge = companyData.companyAge || 0;
            const settore = companyData.settoreATECO || '';
            const formaGiuridica = companyData.formaGiuridica || '';

            let normotipo = {
                profilo: 'PMI Standard',
                caratteristiche: [],
                priorita: {
                    rc_generale: 80,
                    rc_professionale: 60,
                    rc_prodotti: 60,
                    do: 50,
                    key_man: 70,
                    cyber: 65,
                    property: 75,
                    business_interruption: 70,
                    tutela_legale: 60,
                    infortuni_dipendenti: 70,
                    flotta: 50,
                    trasporto_merci: 40
                },
                esclusioni: []
            };

            // MICROIMPRESA
            if (dipendenti <= 9 && fatturato <= 2000000) {
                normotipo.profilo = 'MICROIMPRESA';
                normotipo.caratteristiche = [
                    'Dimensione ridotta',
                    'Struttura snella',
                    'Alta dipendenza titolare',
                    'Budget limitato per assicurazioni'
                ];
                normotipo.priorita = {
                    rc_generale: 85,
                    rc_professionale: 70,
                    rc_prodotti: 65,
                    do: 30,
                    key_man: 95,
                    cyber: 60,
                    property: 80,
                    business_interruption: 75,
                    tutela_legale: 65,
                    infortuni_dipendenti: 75,
                    flotta: 50,
                    trasporto_merci: 40
                };
            }

            // PICCOLA IMPRESA
            else if (dipendenti <= 49 && fatturato <= 10000000) {
                normotipo.profilo = 'PICCOLA IMPRESA IN CRESCITA';
                normotipo.caratteristiche = [
                    'Fase di consolidamento',
                    'Inizio strutturazione',
                    'Management in formazione',
                    'Focus su crescita'
                ];
                normotipo.priorita = {
                    rc_generale: 85,
                    rc_professionale: 75,
                    rc_prodotti: 70,
                    do: 50,
                    key_man: 90,
                    cyber: 75,
                    property: 80,
                    business_interruption: 80,
                    tutela_legale: 70,
                    infortuni_dipendenti: 80,
                    flotta: 60,
                    trasporto_merci: 50
                };
            }

            // MEDIA IMPRESA
            else if (dipendenti <= 249 && fatturato <= 50000000) {
                normotipo.profilo = 'MEDIA IMPRESA STRUTTURATA';
                normotipo.caratteristiche = [
                    'Organizzazione articolata',
                    'Management strutturato',
                    'Rischi pi√π complessi',
                    'Necessit√† protezioni avanzate'
                ];
                normotipo.priorita = {
                    rc_generale: 90,
                    rc_professionale: 80,
                    rc_prodotti: 80,
                    do: 75,
                    key_man: 85,
                    cyber: 85,
                    property: 85,
                    business_interruption: 85,
                    tutela_legale: 75,
                    infortuni_dipendenti: 85,
                    flotta: 70,
                    trasporto_merci: 60
                };
            }

            // GRANDE IMPRESA
            else {
                normotipo.profilo = 'GRANDE IMPRESA';
                normotipo.caratteristiche = [
                    'Struttura complessa',
                    'Rischi enterprise',
                    'Governance avanzata',
                    'Portfolio protezioni completo'
                ];
                normotipo.priorita = {
                    rc_generale: 95,
                    rc_professionale: 85,
                    rc_prodotti: 90,
                    do: 90,
                    key_man: 80,
                    cyber: 95,
                    property: 90,
                    business_interruption: 90,
                    tutela_legale: 85,
                    infortuni_dipendenti: 90,
                    flotta: 80,
                    trasporto_merci: 70
                };
            }

            // OVERRIDE PER SETTORI SPECIFICI
            if (settore.startsWith('F4')) { // EDILIZIA
                normotipo.profilo += ' - SETTORE EDILIZIA';
                normotipo.caratteristiche.push('Settore ad alto rischio infortuni');
                normotipo.priorita.rc_generale = 95;
                normotipo.priorita.infortuni_dipendenti = 95;
                normotipo.priorita.tutela_legale = 85;
            }

            if (settore.startsWith('J62') || settore.startsWith('M62')) { // IT
                normotipo.profilo += ' - SETTORE IT';
                normotipo.caratteristiche.push('Alto rischio cyber');
                normotipo.priorita.cyber = 95;
                normotipo.priorita.rc_professionale = 90;
            }

            if (settore.startsWith('Q86') || settore.startsWith('Q87')) { // SANIT√Ä
                normotipo.profilo += ' - SETTORE SANIT√Ä';
                normotipo.caratteristiche.push('Rischio RC professionale elevato');
                normotipo.priorita.rc_professionale = 95;
                normotipo.priorita.tutela_legale = 90;
            }

            if (settore.startsWith('C')) { // MANIFATTURIERO
                normotipo.profilo += ' - MANIFATTURIERO';
                normotipo.caratteristiche.push('Rischio operativo e prodotti');
                normotipo.priorita.rc_prodotti = 90;
                normotipo.priorita.property = 90;
                normotipo.priorita.business_interruption = 90;
            }

            // STARTUP
            if (companyAge <= 3 && formaGiuridica.includes('startup')) {
                normotipo.profilo = 'STARTUP INNOVATIVA';
                normotipo.caratteristiche = [
                    'Fase early stage',
                    'Alto rischio imprenditoriale',
                    'Budget limitato',
                    'Focus su crescita rapida'
                ];
                normotipo.priorita.key_man = 100;
                normotipo.priorita.cyber = 85;
                normotipo.priorita.rc_professionale = 80;
            }

            // FAMIGLIA
            if (companyAge > 10 && dipendenti > 5) {
                normotipo.caratteristiche.push('Possibile passaggio generazionale da pianificare');
            }

            return normotipo;
        }

        // ========================================
        // CALCOLO SEMAFORO PRODOTTI
        // ========================================

        function calcolaSemaforoAziendale(companyData, answers, normotipo, gaps) {
            const fatturato = companyData.fatturatoAnnuo || 0;
            const dipendenti = companyData.numeroDipendenti || 0;
            const polizze = companyData.polizze || {};
            const companyAge = companyData.companyAge || 0;

            const semaforo = {
                rc_generale: 'yellow',
                rc_professionale: 'yellow',
                rc_prodotti: 'yellow',
                do: 'yellow',
                key_man: 'yellow',
                cyber: 'yellow',
                property: 'yellow',
                business_interruption: 'yellow',
                tutela_legale: 'yellow',
                infortuni_dipendenti: 'yellow',
                flotta: 'gray',
                trasporto_merci: 'gray'
            };

            // RC GENERALE
            if (polizze.rc_generale && gaps.rc_contenzioso.gapRC < gaps.rc_contenzioso.massimaleConsigliato * 0.2) {
                semaforo.rc_generale = 'green';
                semaforo.rc_generale_motivo = 'RC generale adeguata';
            } else if (!polizze.rc_generale) {
                semaforo.rc_generale = 'red';
                semaforo.rc_generale_motivo = 'OBBLIGATORIA: RC generale mancante';
            } else if (gaps.rc_contenzioso.gapRC > gaps.rc_contenzioso.massimaleConsigliato * 0.5) {
                semaforo.rc_generale = 'orange';
                semaforo.rc_generale_motivo = 'Massimale insufficiente, incrementare';
            } else {
                semaforo.rc_generale = 'yellow';
                semaforo.rc_generale_motivo = 'Da rivedere massimale';
            }

            // RC PROFESSIONALE
            const settoriProfessionali = ['M69', 'M70', 'M71', 'M72', 'Q86', 'J62'];
            const richiedeRCProf = settoriProfessionali.some(s => companyData.settoreATECO.startsWith(s));

            if (richiedeRCProf && !polizze.rc_professionale) {
                semaforo.rc_professionale = 'red';
                semaforo.rc_professionale_motivo = 'OBBLIGATORIA per il settore';
            } else if (polizze.rc_professionale) {
                semaforo.rc_professionale = 'green';
                semaforo.rc_professionale_motivo = 'Adeguata per settore';
            } else if (richiedeRCProf) {
                semaforo.rc_professionale = 'orange';
                semaforo.rc_professionale_motivo = 'Fortemente consigliata per settore';
            } else {
                semaforo.rc_professionale = 'gray';
                semaforo.rc_professionale_motivo = 'Non necessaria per settore';
            }

            // RC PRODOTTI
            const settoriProduzione = companyData.settoreATECO.startsWith('C') || companyData.settoreATECO.startsWith('G');
            if (settoriProduzione && !polizze.rc_prodotti) {
                semaforo.rc_prodotti = 'orange';
                semaforo.rc_prodotti_motivo = 'Consigliata per settore produzione/commercio';
            } else if (polizze.rc_prodotti) {
                semaforo.rc_prodotti = 'green';
                semaforo.rc_prodotti_motivo = 'Presente';
            } else {
                semaforo.rc_prodotti = 'gray';
                semaforo.rc_prodotti_motivo = 'Non applicabile';
            }

            // D&O
            const richiedeTO = (companyData.formaGiuridica === 'spa' || fatturato > 5000000 || dipendenti > 50);
            if (richiedeTO && !polizze.do) {
                semaforo.do = 'orange';
                semaforo.do_motivo = 'Consigliata: dimensione significativa';
            } else if (polizze.do) {
                semaforo.do = 'green';
                semaforo.do_motivo = 'Presente';
            } else {
                semaforo.do = 'gray';
                semaforo.do_motivo = 'Non prioritaria per dimensione';
            }

            // KEY MAN
            const dipendenzaKeyPerson = answers.A1 || 3;
            if (dipendenzaKeyPerson <= 2 && !polizze.key_man) {
                semaforo.key_man = 'red';
                semaforo.key_man_motivo = 'CRITICO: Alta dipendenza da figure chiave';
            } else if (polizze.key_man) {
                semaforo.key_man = 'green';
                semaforo.key_man_motivo = 'Presente';
            } else if (dipendenzaKeyPerson === 3) {
                semaforo.key_man = 'orange';
                semaforo.key_man_motivo = 'Consigliata';
            } else {
                semaforo.key_man = 'yellow';
                semaforo.key_man_motivo = 'Da valutare';
            }

            // CYBER
            const sicurezzaIT = answers.B4 || 3;
            if (sicurezzaIT <= 2 && !polizze.cyber) {
                semaforo.cyber = 'red';
                semaforo.cyber_motivo = 'URGENTE: Scarsa sicurezza IT + nessuna copertura';
            } else if (polizze.cyber) {
                semaforo.cyber = 'green';
                semaforo.cyber_motivo = 'Presente';
            } else if (sicurezzaIT === 3 || companyData.settoreATECO.startsWith('J')) {
                semaforo.cyber = 'orange';
                semaforo.cyber_motivo = 'Fortemente consigliata';
            } else {
                semaforo.cyber = 'yellow';
                semaforo.cyber_motivo = 'Consigliata (rischio crescente)';
            }

            // PROPERTY
            if (companyData.immobiliProprieta === 'totale' || companyData.valoreImmobili > 500000) {
                if (!polizze.property) {
                    semaforo.property = 'orange';
                    semaforo.property_motivo = 'Consigliata: asset significativi';
                } else {
                    semaforo.property = 'green';
                    semaforo.property_motivo = 'Presente';
                }
            } else {
                semaforo.property = polizze.property ? 'green' : 'yellow';
                semaforo.property_motivo = polizze.property ? 'Presente' : 'Da valutare';
            }

            // BUSINESS INTERRUPTION
            const rischiOperativi = answers.B1 || 3;
            if (rischiOperativi >= 4 && !polizze.business_interruption) {
                semaforo.business_interruption = 'orange';
                semaforo.business_interruption_motivo = 'Consigliata: elevati rischi operativi';
            } else if (polizze.business_interruption) {
                semaforo.business_interruption = 'green';
                semaforo.business_interruption_motivo = 'Presente';
            } else {
                semaforo.business_interruption = 'yellow';
                semaforo.business_interruption_motivo = 'Da valutare';
            }

            // TUTELA LEGALE
            semaforo.tutela_legale = polizze.tutela_legale ? 'green' : 'yellow';
            semaforo.tutela_legale_motivo = polizze.tutela_legale ? 'Presente' : 'Consigliata per tutte le aziende';

            // INFORTUNI DIPENDENTI
            if (dipendenti > 0) {
                const settoreRischioso = answers.B8 >= 4;
                if (settoreRischioso && !polizze.infortuni_dipendenti) {
                    semaforo.infortuni_dipendenti = 'orange';
                    semaforo.infortuni_dipendenti_motivo = 'Consigliata: settore ad alto rischio';
                } else if (polizze.infortuni_dipendenti) {
                    semaforo.infortuni_dipendenti = 'green';
                    semaforo.infortuni_dipendenti_motivo = 'Presente (integrazione INAIL)';
                } else {
                    semaforo.infortuni_dipendenti = 'yellow';
                    semaforo.infortuni_dipendenti_motivo = 'Da valutare come integrazione INAIL';
                }
            } else {
                semaforo.infortuni_dipendenti = 'gray';
                semaforo.infortuni_dipendenti_motivo = 'Non applicabile (nessun dipendente)';
            }

            // FLOTTA
            semaforo.flotta = polizze.flotta ? 'green' : 'gray';
            semaforo.flotta_motivo = polizze.flotta ? 'Presente' : 'Solo se veicoli aziendali';

            // TRASPORTO MERCI
            const settoriTrasporti = ['H49', 'H50', 'H51', 'G46', 'G47'];
            const richiedeTrasporti = settoriTrasporti.some(s => companyData.settoreATECO.startsWith(s));
            if (richiedeTrasporti && !polizze.trasporto_merci) {
                semaforo.trasporto_merci = 'orange';
                semaforo.trasporto_merci_motivo = 'Consigliata per settore';
            } else if (polizze.trasporto_merci) {
                semaforo.trasporto_merci = 'green';
                semaforo.trasporto_merci_motivo = 'Presente';
            } else {
                semaforo.trasporto_merci = 'gray';
                semaforo.trasporto_merci_motivo = 'Non applicabile';
            }

            return semaforo;
        }

        // ========================================
        // DETECT INCOERENZE AZIENDALI
        // ========================================

        function detectIncoherenzeAziendali(companyData, answers) {
            const incoherenze = [];
            const fatturato = companyData.fatturatoAnnuo || 0;
            const dipendenti = companyData.numeroDipendenti || 0;

            // Incoerenza 1: Alta dipendenza key person ma nessun piano
            if ((answers.A1 || 3) <= 2 && (answers.A2 || 3) <= 2) {
                incoherenze.push({
                    type: 'governance_gap',
                    severity: 'high',
                    message: 'Alta dipendenza da key person ma nessun piano successione'
                });
            }

            // Incoerenza 2: Sicurezza IT bassa ma settore digitale
            if ((answers.B4 || 3) <= 2 && companyData.settoreATECO.startsWith('J')) {
                incoherenze.push({
                    type: 'cyber_risk',
                    severity: 'critical',
                    message: 'Settore IT/digitale con sicurezza informatica scarsa'
                });
            }

            // Incoerenza 3: Fatturato alto ma patrimonio netto basso
            if (fatturato > 1000000 && (companyData.patrimonioNetto || 0) < fatturato * 0.1) {
                incoherenze.push({
                    type: 'financial_weakness',
                    severity: 'high',
                    message: 'Patrimonio netto < 10% fatturato: sottocapitalizzazione'
                });
            }

            // Incoerenza 4: Crescita prevista ma debiti alti
            if ((answers.C8 || 3) >= 4 && (answers.C5 || 3) >= 4) {
                incoherenze.push({
                    type: 'growth_debt',
                    severity: 'medium',
                    message: 'Previsioni crescita ma alta leva finanziaria'
                });
            }

            // Incoerenza 5: Nessun piano strategico ma investimenti
            if ((answers.C3 || 3) <= 2 && (answers.C4 || 3) >= 4) {
                incoherenze.push({
                    type: 'planning_gap',
                    severity: 'medium',
                    message: 'Investimenti previsti senza piano strategico documentato'
                });
            }

            const coherenceScore = Math.max(30, 100 - (incoherenze.length * 12));

            return { incoherenze, coherenceScore };
        }

        // ========================================
        // GENERA RISULTATI AZIENDALI
        // ========================================

        async function generaRisultatiAziendali() {
            const companyData = appStateAzienda.company.anagrafica;
            const answers = appStateAzienda.answers;

            // Calcoli
            const gaps = calcolaGapAziendali(companyData, answers);
            const normotipo = analizzaNormotipoAziendale(companyData, answers);
            const semaforo = calcolaSemaforoAziendale(companyData, answers, normotipo, gaps);
            const coherence = detectIncoherenzeAziendali(companyData, answers);

            appStateAzienda.results = {
                gaps,
                normotipo,
                semaforo,
                coherence,
                timestamp: new Date().toISOString()
            };

            renderResultsAziendali();
        }

        function renderResultsAziendali() {
            document.getElementById('questionario').style.display = 'none';
            document.getElementById('risultati').style.display = 'block';

            const container = document.getElementById('risultatiContent');
            const r = appStateAzienda.results;
            const companyData = appStateAzienda.company.anagrafica;

            let html = '';

            // HEADER
            html += '<div style="background: linear-gradient(135deg, var(--generali-blue), var(--generali-light-blue)); color: white; padding: 35px; border-radius: 12px; margin-bottom: 30px;">';
            html += `<h2 style="margin: 0 0 12px 0; font-size: 32px;">${companyData.ragioneSociale}</h2>`;
            html += `<p style="margin: 0; opacity: 0.95; font-size: 16px;">`;
            html += `${companyData.formaGiuridica.toUpperCase()} | ${companyData.numeroDipendenti} dipendenti | `;
            html += `Fatturato: ‚Ç¨${companyData.fatturatoAnnuo.toLocaleString()} | `;
            html += `Et√† azienda: ${companyData.companyAge} anni`;
            html += `</p>`;
            html += '</div>';

            // NORMOTIPO
            html += '<div class="card" style="background: linear-gradient(135deg, #F0F9FF 0%, #E0F2FE 100%); border-left: 5px solid var(--generali-blue);">';
            html += `<h3 class="card-title" style="color: #0C4A6E;">üè≠ Profilo Aziendale: ${r.normotipo.profilo}</h3>`;
            html += '<ul style="margin-left: 20px; line-height: 1.8;">';
            r.normotipo.caratteristiche.forEach(c => {
                html += `<li style="margin-bottom: 8px;">${c}</li>`;
            });
            html += '</ul>';
            if (r.normotipo.esclusioni.length > 0) {
                html += '<div style="background: #FEF3C7; padding: 18px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #F59E0B;">';
                html += '<strong style="color: #92400E;">‚ö†Ô∏è Note Importanti:</strong>';
                html += '<ul style="margin: 10px 0 0 20px; color: #78350F;">';
                r.normotipo.esclusioni.forEach(e => {
                    html += `<li style="margin-bottom: 6px;">${e}</li>`;
                });
                html += '</ul></div>';
            }
            html += '</div>';

            // COHERENCE SCORE (implementato nelle prossime parti con dettagli)
            html += '<div class="card">';
            html += '<h3 class="card-title">üìä Coerenza Dati Aziendali</h3>';
            const coherenceColor = r.coherence.coherenceScore >= 80 ? 'var(--green)' : 
                                   r.coherence.coherenceScore >= 60 ? 'var(--yellow)' : 'var(--red)';
            html += `<div style="text-align: center; padding: 25px;">`;
            html += `<div style="font-size: 56px; font-weight: bold; color: ${coherenceColor};">${r.coherence.coherenceScore}%</div>`;
            html += `<p style="color: var(--gray-600); font-size: 16px; margin-top: 10px;">Indice di coerenza dati e risposte</p>`;
            html += '</div>';
            if (r.coherence.incoherenze.length > 0) {
                html += '<div style="background: #FEE2E2; padding: 18px; border-radius: 8px; border-left: 4px solid #DC2626;">';
                html += '<strong style="color: #991B1B; font-size: 16px;">‚ö†Ô∏è Incoerenze Rilevate:</strong>';
                html += '<ul style="margin: 12px 0 0 20px; color: #7F1D1D;">';
                r.coherence.incoherenze.forEach(inc => {
                    html += `<li style="margin-bottom: 8px;">${inc.message}</li>`;
                });
                html += '</ul></div>';
            }
            html += '</div>';

            container.innerHTML = html;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
<script>
        // ========================================
        // RENDERING COMPLETO RISULTATI - CONTINUAZIONE
        // ========================================

        function renderResultsAziendali() {
            document.getElementById('questionario').style.display = 'none';
            document.getElementById('risultati').style.display = 'block';

            const container = document.getElementById('risultatiContent');
            const r = appStateAzienda.results;
            const companyData = appStateAzienda.company.anagrafica;

            let html = '';

            // HEADER
            html += '<div style="background: linear-gradient(135deg, var(--generali-blue), var(--generali-light-blue)); color: white; padding: 35px; border-radius: 12px; margin-bottom: 30px;">';
            html += `<h2 style="margin: 0 0 12px 0; font-size: 32px;">${companyData.ragioneSociale}</h2>`;
            html += `<p style="margin: 0; opacity: 0.95; font-size: 16px;">`;
            html += `${companyData.formaGiuridica.toUpperCase()} | ${companyData.numeroDipendenti} dipendenti | `;
            html += `Fatturato: ‚Ç¨${companyData.fatturatoAnnuo.toLocaleString()} | `;
            html += `Et√† azienda: ${companyData.companyAge} anni`;
            html += `</p>`;
            html += '</div>';

            // NORMOTIPO
            html += '<div class="card" style="background: linear-gradient(135deg, #F0F9FF 0%, #E0F2FE 100%); border-left: 5px solid var(--generali-blue);">';
            html += `<h3 class="card-title" style="color: #0C4A6E;">üè≠ Profilo Aziendale: ${r.normotipo.profilo}</h3>`;
            html += '<ul style="margin-left: 20px; line-height: 1.8; color: var(--gray-700);">';
            r.normotipo.caratteristiche.forEach(c => {
                html += `<li style="margin-bottom: 8px;"><strong>${c}</strong></li>`;
            });
            html += '</ul>';
            if (r.normotipo.esclusioni.length > 0) {
                html += '<div style="background: #FEF3C7; padding: 18px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #F59E0B;">';
                html += '<strong style="color: #92400E;">‚ö†Ô∏è Note Importanti:</strong>';
                html += '<ul style="margin: 10px 0 0 20px; color: #78350F;">';
                r.normotipo.esclusioni.forEach(e => {
                    html += `<li style="margin-bottom: 6px;">${e}</li>`;
                });
                html += '</ul></div>';
            }
            html += '</div>';

            // COHERENCE SCORE
            html += '<div class="card">';
            html += '<h3 class="card-title">üìä Coerenza Dati Aziendali</h3>';
            const coherenceColor = r.coherence.coherenceScore >= 80 ? 'var(--green)' : 
                                   r.coherence.coherenceScore >= 60 ? 'var(--yellow)' : 'var(--red)';
            html += `<div style="text-align: center; padding: 25px;">`;
            html += `<div style="font-size: 56px; font-weight: bold; color: ${coherenceColor};">${r.coherence.coherenceScore}%</div>`;
            html += `<p style="color: var(--gray-600); font-size: 16px; margin-top: 10px;">Indice di coerenza dati e risposte</p>`;
            html += '</div>';
            if (r.coherence.incoherenze.length > 0) {
                html += '<div style="background: #FEE2E2; padding: 18px; border-radius: 8px; border-left: 4px solid #DC2626;">';
                html += '<strong style="color: #991B1B; font-size: 16px;">‚ö†Ô∏è Incoerenze Rilevate:</strong>';
                html += '<ul style="margin: 12px 0 0 20px; color: #7F1D1D;">';
                r.coherence.incoherenze.forEach(inc => {
                    html += `<li style="margin-bottom: 8px;">${inc.message}</li>`;
                });
                html += '</ul></div>';
            }
            html += '</div>';

            // GAP ANALYSIS - 5 AREE
            html += '<div class="card">';
            html += '<h3 class="card-title">üéØ Analisi GAP Protezioni Aziendali</h3>';
            html += '<p style="color: var(--gray-600); margin-bottom: 25px;">Identificazione delle scoperture assicurative critiche rispetto ai rischi effettivi</p>';

            // GAP 1: CONTINUIT√Ä
            html += renderGapCard('Continuit√† Aziendale', r.gaps.continuita, 'üîë', [
                { label: 'Impatto perdita key person (6 mesi)', value: `‚Ç¨${r.gaps.continuita.perdita6Mesi.toLocaleString()}` },
                { label: 'Costi struttura (6 mesi)', value: `‚Ç¨${r.gaps.continuita.costiStruttura6Mesi.toLocaleString()}` },
                { label: 'Impatto totale stimato', value: `‚Ç¨${r.gaps.continuita.impattoTotale.toLocaleString()}`, bold: true },
                { label: 'Copertura Key Man attuale', value: `‚Ç¨${r.gaps.continuita.copterturaKeyMan.toLocaleString()}` },
                { label: 'Scoperta lorda', value: `‚Ç¨${r.gaps.continuita.scoperturaLorda.toLocaleString()}`, bold: true, color: r.gaps.continuita.gravita === 'critica' ? 'var(--red)' : r.gaps.continuita.gravita === 'alta' ? 'var(--orange)' : 'var(--green)' }
            ]);

            // GAP 2: RC/CONTENZIOSO
            html += renderGapCard('RC & Contenzioso', r.gaps.rc_contenzioso, '‚öñÔ∏è', [
                { label: 'Massimale RC consigliato (settore)', value: `‚Ç¨${r.gaps.rc_contenzioso.massimaleConsigliato.toLocaleString()}` },
                { label: 'Copertura RC totale attuale', value: `‚Ç¨${r.gaps.rc_contenzioso.coperturaTotaleRC.toLocaleString()}` },
                { label: 'GAP da coprire', value: `‚Ç¨${r.gaps.rc_contenzioso.gapRC.toLocaleString()}`, bold: true, color: r.gaps.rc_contenzioso.gravita === 'critica' ? 'var(--red)' : r.gaps.rc_contenzioso.gravita === 'alta' ? 'var(--orange)' : 'var(--green)' }
            ]);

            // GAP 3: CYBER
            html += renderGapCard('Cyber Risk', r.gaps.cyber, 'üîí', [
                { label: 'Costo medio data breach (stimato)', value: `‚Ç¨${r.gaps.cyber.costoMedioDataBreach.toLocaleString()}` },
                { label: 'Giorni interruzione stimati', value: `${r.gaps.cyber.costoInterruzioneGiorni} giorni` },
                { label: 'Costo interruzione business', value: `‚Ç¨${r.gaps.cyber.costoInterruzioneTotale.toLocaleString()}` },
                { label: 'Esposizione totale cyber', value: `‚Ç¨${r.gaps.cyber.costoTotaleCyber.toLocaleString()}`, bold: true },
                { label: 'Copertura cyber attuale', value: `‚Ç¨${r.gaps.cyber.coperturaCyber.toLocaleString()}` },
                { label: 'GAP da coprire', value: `‚Ç¨${r.gaps.cyber.gapCyber.toLocaleString()}`, bold: true, color: r.gaps.cyber.gravita === 'critica' ? 'var(--red)' : r.gaps.cyber.gravita === 'alta' ? 'var(--orange)' : 'var(--green)' }
            ]);

            // GAP 4: PROPERTY & BUSINESS INTERRUPTION
            html += renderGapCard('Property & Interruzione Attivit√†', r.gaps.property_interruption, 'üè≠', [
                { label: 'Valore asset totale', value: `‚Ç¨${r.gaps.property_interruption.valoreAssetTotale.toLocaleString()}` },
                { label: 'Copertura property attuale', value: `‚Ç¨${r.gaps.property_interruption.coperturaProperty.toLocaleString()}` },
                { label: 'GAP property', value: `‚Ç¨${r.gaps.property_interruption.gapProperty.toLocaleString()}`, bold: true },
                { label: 'Mesi critici senza operativit√†', value: `${r.gaps.property_interruption.mesiCritici} mesi` },
                { label: 'Costo interruzione massimo', value: `‚Ç¨${r.gaps.property_interruption.costoInterruzioneMax.toLocaleString()}` },
                { label: 'Copertura BI attuale', value: `‚Ç¨${r.gaps.property_interruption.coperturaBI.toLocaleString()}` },
                { label: 'GAP business interruption', value: `‚Ç¨${r.gaps.property_interruption.gapBI.toLocaleString()}`, bold: true },
                { label: 'GAP TOTALE', value: `‚Ç¨${r.gaps.property_interruption.gapTotale.toLocaleString()}`, bold: true, color: r.gaps.property_interruption.gravita === 'critica' ? 'var(--red)' : r.gaps.property_interruption.gravita === 'alta' ? 'var(--orange)' : 'var(--green)' }
            ]);

            // GAP 5: SUCCESSIONE
            html += renderGapCard('Successione & Passaggio Generazionale', r.gaps.successione, 'üë•', [
                { label: 'Et√† azienda', value: `${r.gaps.successione.companyAge} anni` },
                { label: 'Et√† media management', value: `${r.gaps.successione.etaMediaManagement} anni` },
                { label: 'Valore azienda stimato', value: `‚Ç¨${r.gaps.successione.valoreAziendaStimato.toLocaleString()}` },
                { label: 'Liquidit√† necessaria buy-out/exit', value: `‚Ç¨${r.gaps.successione.liquiditaNecessaria.toLocaleString()}`, bold: true },
                { label: 'Liquidit√† disponibile', value: `‚Ç¨${r.gaps.successione.liquiditaDisponibile.toLocaleString()}` },
                { label: 'GAP liquidit√† successione', value: `‚Ç¨${r.gaps.successione.gapSuccessione.toLocaleString()}`, bold: true, color: r.gaps.successione.gravita === 'critica' ? 'var(--red)' : r.gaps.successione.gravita === 'alta' ? 'var(--orange)' : 'var(--green)' }
            ]);

            html += '</div>';

            // SEMAFORO PRODOTTI
            html += '<div class="card">';
            html += '<h3 class="card-title">üö¶ Semaforo Coperture Assicurative</h3>';
            html += '<p style="color: var(--gray-600); margin-bottom: 25px;">Valutazione priorit√† e adeguatezza delle coperture per la tua azienda</p>';

            const prodotti = [
                { key: 'rc_generale', nome: 'RC Generale', icon: 'üõ°Ô∏è' },
                { key: 'rc_professionale', nome: 'RC Professionale', icon: '‚öñÔ∏è' },
                { key: 'rc_prodotti', nome: 'RC Prodotti', icon: 'üì¶' },
                { key: 'do', nome: 'D&O', icon: 'üëî' },
                { key: 'key_man', nome: 'Key Man Insurance', icon: 'üîë' },
                { key: 'cyber', nome: 'Cyber Risk', icon: 'üîí' },
                { key: 'property', nome: 'Property/All Risks', icon: 'üè≠' },
                { key: 'business_interruption', nome: 'Business Interruption', icon: '‚è∏Ô∏è' },
                { key: 'tutela_legale', nome: 'Tutela Legale', icon: '‚öñÔ∏è' },
                { key: 'infortuni_dipendenti', nome: 'Infortuni Dipendenti', icon: 'üë∑' },
                { key: 'flotta', nome: 'Flotta Auto', icon: 'üöó' },
                { key: 'trasporto_merci', nome: 'Trasporto Merci', icon: 'üì¶' }
            ];

            html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 18px;">';
            prodotti.forEach(prod => {
                const color = r.semaforo[prod.key];
                const motivo = r.semaforo[`${prod.key}_motivo`] || '';
                const priorita = r.normotipo.priorita[prod.key] || 50;

                let bgColor, borderColor, textColor;
                switch(color) {
                    case 'red':
                        bgColor = '#FEE2E2';
                        borderColor = '#DC2626';
                        textColor = '#991B1B';
                        break;
                    case 'orange':
                        bgColor = '#FED7AA';
                        borderColor = '#F97316';
                        textColor = '#9A3412';
                        break;
                    case 'yellow':
                        bgColor = '#FEF3C7';
                        borderColor = '#F59E0B';
                        textColor = '#92400E';
                        break;
                    case 'green':
                        bgColor = '#D1FAE5';
                        borderColor = '#10B981';
                        textColor = '#065F46';
                        break;
                    default: // gray
                        bgColor = '#F3F4F6';
                        borderColor = '#9CA3AF';
                        textColor = '#4B5563';
                }

                html += `<div style="background: ${bgColor}; padding: 18px; border-radius: 8px; border-left: 4px solid ${borderColor};">`;
                html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">`;
                html += `<strong style="color: ${textColor}; font-size: 16px;">${prod.icon} ${prod.nome}</strong>`;
                html += `<span style="background: ${borderColor}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700;">Priorit√†: ${priorita}%</span>`;
                html += `</div>`;
                html += `<p style="margin: 0; color: ${textColor}; font-size: 14px;">${motivo}</p>`;
                html += `</div>`;
            });
            html += '</div>';
            html += '</div>';

            container.innerHTML = html;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function renderGapCard(title, gapData, icon, rows) {
            const gravitaColors = {
                critica: 'var(--red)',
                alta: 'var(--orange)',
                media: 'var(--yellow)',
                coperta: 'var(--green)'
            };

            const gravitaLabels = {
                critica: 'CRITICA',
                alta: 'ALTA',
                media: 'MEDIA',
                coperta: 'COPERTA'
            };

            const bgColors = {
                critica: '#FEE2E2',
                alta: '#FED7AA',
                media: '#FEF3C7',
                coperta: '#D1FAE5'
            };

            let html = '<div style="background: white; padding: 25px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid var(--generali-blue); box-shadow: 0 2px 8px rgba(0,0,0,0.08);">';
            
            html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">';
            html += `<h4 style="color: var(--generali-blue); margin: 0; font-size: 20px;">${icon} ${title}</h4>`;
            html += `<span style="background: ${bgColors[gapData.gravita]}; color: ${gravitaColors[gapData.gravita]}; padding: 6px 16px; border-radius: 20px; font-size: 13px; font-weight: 700;">${gravitaLabels[gapData.gravita]}</span>`;
            html += '</div>';

            html += '<table style="width: 100%; border-collapse: collapse;">';
            rows.forEach(row => {
                const color = row.color || 'var(--gray-700)';
                const weight = row.bold ? 'bold' : 'normal';
                html += `<tr style="border-bottom: 1px solid var(--gray-200);">`;
                html += `<td style="padding: 12px 8px; color: var(--gray-600);">${row.label}</td>`;
                html += `<td style="padding: 12px 8px; text-align: right; color: ${color}; font-weight: ${weight}; font-size: 16px;">${row.value}</td>`;
                html += `</tr>`;
            });
            html += '</table>';

            if (gapData.messaggio) {
                const msgBgColor = gapData.gravita === 'critica' ? '#FEE2E2' :
                                   gapData.gravita === 'alta' ? '#FED7AA' :
                                   gapData.gravita === 'media' ? '#FEF3C7' : '#D1FAE5';
                const msgColor = gapData.gravita === 'critica' ? '#991B1B' :
                                gapData.gravita === 'alta' ? '#9A3412' :
                                gapData.gravita === 'media' ? '#92400E' : '#065F46';
                html += `<div style="background: ${msgBgColor}; padding: 14px 18px; border-radius: 8px; margin-top: 15px; color: ${msgColor}; font-weight: 500;">`;
                html += `üí° ${gapData.messaggio}`;
                html += '</div>';
            }

            html += '</div>';
            return html;
        }

        // ========================================
        // BEHAVIORAL GAP AZIENDALE V2.0
        // ========================================

        function calcolaBehavioralGapAziendale(companyData, answers) {
            const gaps = {
                governance: {},
                risk_management: {},
                financial: {},
                operational: {},
                strategic: {}
            };

            // ========================================
            // GAP 1: GOVERNANCE
            // ========================================

            const dipendenzaKeyPerson = answers.A1 || 3;
            const pianoSuccessione = answers.A2 || 3;
            const knowHow = answers.A3 || 3;
            const continuita = answers.A4 || 3;
            const accesso = answers.A5 || 3;

            const percezioneContinuita = continuita; // Quanto pensa di poter continuare
            const vulnerabilitaReale = dipendenzaKeyPerson; // Quanto √® realmente vulnerabile

            // Se pensa di poter continuare bene (4-5) ma ha alta dipendenza (1-2), c'√® gap
            const gapGovernance = Math.abs(percezioneContinuita - (5 - dipendenzaKeyPerson + 1));

            gaps.governance = {
                percezioneContinuita: percezioneContinuita,
                vulnerabilitaReale: vulnerabilitaReale,
                gapScore: Math.round((gapGovernance / 5) * 100),
                gravita: gapGovernance >= 3 ? 'alta' : gapGovernance >= 2 ? 'media' : 'bassa',
                dettagli: [
                    `Percezione continuit√†: ${percezioneContinuita}/5`,
                    `Dipendenza key persons: ${dipendenzaKeyPerson}/5`,
                    `Piano successione: ${pianoSuccessione}/5`,
                    `Know-how documentato: ${knowHow}/5`
                ],
                messaggio: gapGovernance >= 3 ?
                    'ALERT: Percezione continuit√† aziendale non allineata con vulnerabilit√† reali governance' :
                    gapGovernance >= 2 ?
                    'Attenzione: Discreta discrepanza tra percezione stabilit√† e realt√† dipendenze' :
                    'Governance: percezione allineata alla realt√†'
            };

            // ========================================
            // GAP 2: RISK MANAGEMENT
            // ========================================

            const rischiOperativi = answers.B1 || 3;
            const sinistralita = answers.B2 || 3;
            const manutenzione = answers.B3 || 3;
            const rischiSettore = answers.B8 || 3;

            const polizze = companyData.polizze || {};
            const numPolizzeAttive = Object.keys(polizze).length;

            // Calcolo esposizione reale
            const esposizioneReale = Math.round((rischiOperativi + sinistralita + (5 - manutenzione) + rischiSettore) / 4);

            // Protezione dichiarata basata su polizze
            const protezioneDichiarata = numPolizzeAttive >= 6 ? 5 : numPolizzeAttive >= 4 ? 4 : numPolizzeAttive >= 2 ? 3 : numPolizzeAttive >= 1 ? 2 : 1;

            const gapRisk = Math.abs(esposizioneReale - protezioneDichiarata);

            gaps.risk_management = {
                esposizioneReale: esposizioneReale,
                protezioneDichiarata: protezioneDichiarata,
                numPolizze: numPolizzeAttive,
                gapScore: Math.round((gapRisk / 5) * 100),
                gravita: gapRisk >= 3 ? 'alta' : gapRisk >= 2 ? 'media' : 'bassa',
                dettagli: [
                    `Rischi operativi: ${rischiOperativi}/5`,
                    `Sinistralit√† storica: ${sinistralita}/5`,
                    `Stato manutenzione: ${manutenzione}/5`,
                    `Polizze attive: ${numPolizzeAttive}`
                ],
                messaggio: gapRisk >= 3 ?
                    `CRITICO: Alta esposizione rischi (${esposizioneReale}/5) ma bassa protezione (${numPolizzeAttive} polizze)` :
                    gapRisk >= 2 ?
                    `Attenzione: Coperture non completamente allineate ai rischi effettivi` :
                    'Risk management: protezioni allineate ai rischi'
            };

            // ========================================
            // GAP 3: FINANCIAL
            // ========================================

            const soliditaPatrimoniale = answers.C1 || 3;
            const autofinanziamento = answers.C2 || 3;
            const levaFinanziaria = 5 - (answers.C5 || 3); // Invertito: alta leva = basso score

            const fatturato = companyData.fatturatoAnnuo || 0;
            const patrimonioNetto = companyData.patrimonioNetto || 0;
            const debiti = companyData.debitiTotali || 0;

            // Calcolo reale leva finanziaria
            const levaReale = patrimonioNetto > 0 ? debiti / patrimonioNetto : 5;
            let scoreLevaReale = 5;
            if (levaReale > 5) scoreLevaReale = 1;
            else if (levaReale > 3) scoreLevaReale = 2;
            else if (levaReale > 1.5) scoreLevaReale = 3;
            else if (levaReale > 0.5) scoreLevaReale = 4;

            // Gap tra percezione solidit√† e realt√† bilancio
            const percezioneSolidita = Math.round((soliditaPatrimoniale + autofinanziamento) / 2);
            const soliditaReale = Math.round((scoreLevaReale + (patrimonioNetto > fatturato * 0.2 ? 5 : 3)) / 2);

            const gapFinancial = Math.abs(percezioneSolidita - soliditaReale);

            gaps.financial = {
                percezioneSolidita: percezioneSolidita,
                soliditaReale: soliditaReale,
                levaFinanziaria: levaReale.toFixed(2),
                gapScore: Math.round((gapFinancial / 5) * 100),
                gravita: gapFinancial >= 3 ? 'alta' : gapFinancial >= 2 ? 'media' : 'bassa',
                dettagli: [
                    `Patrimonio netto: ‚Ç¨${patrimonioNetto.toLocaleString()}`,
                    `Debiti totali: ‚Ç¨${debiti.toLocaleString()}`,
                    `Leva finanziaria: ${levaReale.toFixed(2)}x`,
                    `Percezione solidit√†: ${percezioneSolidita}/5`,
                    `Solidit√† reale (bilancio): ${soliditaReale}/5`
                ],
                messaggio: gapFinancial >= 3 ?
                    `ALERT: Percezione solidit√† non allineata a dati di bilancio (leva ${levaReale.toFixed(2)}x)` :
                    gapFinancial >= 2 ?
                    `Attenzione: Piccola discrepanza tra percezione e solidit√† reale` :
                    'Financial: percezione allineata ai dati di bilancio'
            };

            // ========================================
            // GAP 4: OPERATIONAL
            // ========================================

            const dichiaratoContinuita = answers.A4 || 3; // Quanto pensa di poter continuare
            const fornitoriCritici = 5 - (answers.B5 || 3); // Invertito: molti fornitori = alta vulnerabilit√†
            const concentrazioneClienti = answers.B6 || 3;

            const resilenzaDichiarata = dichiaratoContinuita;
            const dipendenzaOperativa = Math.round((fornitoriCritici + concentrazioneClienti) / 2);

            const gapOperational = Math.abs(resilenzaDichiarata - (5 - dipendenzaOperativa + 1));

            gaps.operational = {
                resilenzaDichiarata: resilenzaDichiarata,
                dipendenzaOperativa: dipendenzaOperativa,
                gapScore: Math.round((gapOperational / 5) * 100),
                gravita: gapOperational >= 3 ? 'alta' : gapOperational >= 2 ? 'media' : 'bassa',
                dettagli: [
                    `Resilienza dichiarata: ${resilenzaDichiarata}/5`,
                    `Fornitori critici: score ${fornitoriCritici}/5`,
                    `Concentrazione clienti: ${concentrazioneClienti}/5`
                ],
                messaggio: gapOperational >= 3 ?
                    'ALERT: Resilienza percepita non allineata a dipendenze operative critiche' :
                    gapOperational >= 2 ?
                    'Attenzione: Dipendenze operative superiori a resilienza percepita' :
                    'Operational: resilienza allineata a dipendenze reali'
            };

            // ========================================
            // GAP 5: STRATEGIC
            // ========================================

            const pianoStrategico = answers.C3 || 3;
            const investimenti = answers.C4 || 3;
            const visioneCrescita = answers.C8 || 3;
            const exitStrategy = answers.C10 || 3;

            const visioneStrategica = Math.round((visioneCrescita + investimenti + exitStrategy) / 3);
            const pianificazioneConcreta = Math.round((pianoStrategico + (answers.A6 || 3)) / 2);

            const gapStrategic = Math.abs(visioneStrategica - pianificazioneConcreta);

            gaps.strategic = {
                visioneStrategica: visioneStrategica,
                pianificazioneConcreta: pianificazioneConcreta,
                gapScore: Math.round((gapStrategic / 5) * 100),
                gravita: gapStrategic >= 3 ? 'alta' : gapStrategic >= 2 ? 'media' : 'bassa',
                dettagli: [
                    `Visione crescita: ${visioneCrescita}/5`,
                    `Investimenti previsti: ${investimenti}/5`,
                    `Piano strategico: ${pianoStrategico}/5`,
                    `Exit strategy: ${exitStrategy}/5`
                ],
                messaggio: gapStrategic >= 3 ?
                    'ALERT: Visione ambiziosa ma pianificazione strategica insufficiente' :
                    gapStrategic >= 2 ?
                    'Attenzione: Visione non completamente supportata da pianificazione' :
                    'Strategic: visione allineata a pianificazione concreta'
            };

            return gaps;
        }

        // ========================================
        // SALVATAGGIO E CARICAMENTO
        // ========================================

        function salvaAnalisiAziendale() {
            const nomeAnalisi = document.getElementById('nomeAnalisi').value.trim();
            if (!nomeAnalisi) {
                showToast('‚ö†Ô∏è Inserisci un nome per l\'analisi', 'error');
                return;
            }

            const analisi = {
                nome: nomeAnalisi,
                timestamp: new Date().toISOString(),
                data: appStateAzienda
            };

            const analisiSalvate = JSON.parse(localStorage.getItem('analisiAziendali') || '[]');
            analisiSalvate.push(analisi);
            localStorage.setItem('analisiAziendali', JSON.stringify(analisiSalvate));

            aggiornaListaAnalisi();
            showToast('‚úÖ Analisi salvata con successo!', 'success');
        }

        function caricaAnalisiAziendale() {
            const select = document.getElementById('analisiSalvateSelect');
            const index = select.value;

            if (!index) {
                showToast('‚ö†Ô∏è Seleziona un\'analisi da caricare', 'error');
                return;
            }

            const analisiSalvate = JSON.parse(localStorage.getItem('analisiAziendali') || '[]');
            const analisi = analisiSalvate[index];

            if (!analisi) {
                showToast('‚ùå Analisi non trovata', 'error');
                return;
            }

            Object.assign(appStateAzienda, analisi.data);

            // Ripopola form
            ripopolaFormAziendale();

            showToast('‚úÖ Analisi caricata!', 'success');
        }

        function aggiornaListaAnalisi() {
            const select = document.getElementById('analisiSalvateSelect');
            const analisiSalvate = JSON.parse(localStorage.getItem('analisiAziendali') || '[]');

            select.innerHTML = '<option value="">Seleziona analisi salvata</option>';
            analisiSalvate.forEach((analisi, index) => {
                const date = new Date(analisi.timestamp).toLocaleString('it-IT');
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${analisi.nome} (${date})`;
                select.appendChild(option);
            });
        }

        function ripopolaFormAziendale() {
            const ana = appStateAzienda.company.anagrafica;
            
            document.getElementById('ragioneSociale').value = ana.ragioneSociale || '';
            document.getElementById('partitaIVA').value = ana.partitaIVA || '';
            document.getElementById('codiceFiscaleAzienda').value = ana.codiceFiscale || '';
            document.getElementById('formaGiuridica').value = ana.formaGiuridica || '';
            document.getElementById('annoCostituzione').value = ana.annoCostituzione || '';
            document.getElementById('settoreATECO').value = ana.settoreATECO || '';
            document.getElementById('numeroDipendenti').value = ana.numeroDipendenti || '';
            document.getElementById('fatturatoAnnuo').value = ana.fatturatoAnnuo || '';
            document.getElementById('patrimonioNetto').value = ana.patrimonioNetto || '';
            document.getElementById('provinciaSedeOperativa').value = ana.provinciaSedeOperativa || '';
            document.getElementById('numeroSediOperative').value = ana.numeroSediOperative || '';
            document.getElementById('emailAzienda').value = ana.emailAzienda || '';
            document.getElementById('telefonoAzienda').value = ana.telefonoAzienda || '';
            document.getElementById('sitoWeb').value = ana.sitoWeb || '';
            document.getElementById('percentualeExport').value = ana.percentualeExport || '';
            document.getElementById('numeroKeyPersons').value = ana.numeroKeyPersons || '';
            document.getElementById('etaMediaManagement').value = ana.etaMediaManagement || '';
            document.getElementById('debitiTotali').value = ana.debitiTotali || '';
            document.getElementById('creditiCommerciali').value = ana.creditiCommerciali || '';
            document.getElementById('immobiliProprieta').value = ana.immobiliProprieta || '';
            document.getElementById('valoreImmobili').value = ana.valoreImmobili || '';
            document.getElementById('concentrazioneClienti').value = ana.concentrazioneClienti || '';
            document.getElementById('sinistralitaStorica').value = ana.sinistralitaStorica || '';
            document.getElementById('consulenteSelect').value = ana.consulente || '';

            generaKeyPersonsFields();

            showToast('üìÇ Form ripopolato', 'info');
        }

        function esportaPDFAziendale() {
            showToast('üìÑ Funzione export PDF disponibile con integrazione esterna', 'info');
            window.print();
        }

        // ========================================
        // INIT
        // ========================================

        document.addEventListener('DOMContentLoaded', function() {
            aggiornaListaAnalisi();
        });

    </script>
<script>
        // ========================================
        // SCENARI STRESS AZIENDALI V2.0
        // ========================================

        function simulaScenariStressAziendali(companyData, answers, gaps) {
            const scenari = [];

            const fatturato = companyData.fatturatoAnnuo || 0;
            const dipendenti = companyData.numeroDipendenti || 0;
            const patrimonioNetto = companyData.patrimonioNetto || 0;
            const valoreImmobili = companyData.valoreImmobili || 0;
            const debiti = companyData.debitiTotali || 0;
            const polizze = companyData.polizze || {};

            // ========================================
            // SCENARIO 1: PERDITA KEY PERSON
            // ========================================

            const dipendenzaKeyPerson = answers.A1 || 3;
            let impattoPerdita = 0;

            if (dipendenzaKeyPerson === 1) {
                impattoPerdita = fatturato * 1.0; // 100% - totale blocco
            } else if (dipendenzaKeyPerson === 2) {
                impattoPerdita = fatturato * 0.7; // 70%
            } else if (dipendenzaKeyPerson === 3) {
                impattoPerdita = fatturato * 0.4; // 40%
            } else if (dipendenzaKeyPerson === 4) {
                impattoPerdita = fatturato * 0.2; // 20%
            } else {
                impattoPerdita = fatturato * 0.05; // 5%
            }

            const costiStruttura = fatturato * 0.6; // 60% costi fissi
            const impattoPrimoAnno = impattoPerdita * 0.5 + costiStruttura * 0.5;

            const coperturaKeyMan = polizze.key_man?.capitale || 0;
            const scoperturaKeyPerson = Math.max(0, impattoPrimoAnno - coperturaKeyMan);

            scenari.push({
                id: 'key_person_loss',
                titolo: 'Perdita improvvisa Key Person (amministratore/socio operativo)',
                icon: 'üîë',
                probabilita: dipendenzaKeyPerson <= 2 ? 'media' : 'bassa',
                impatto: impattoPrimoAnno,
                copertura: coperturaKeyMan,
                scoperta: scoperturaKeyPerson,
                gravita: scoperturaKeyPerson > fatturato * 0.5 ? 'catastrofica' :
                         scoperturaKeyPerson > fatturato * 0.25 ? 'critica' :
                         scoperturaKeyPerson > 0 ? 'significativa' : 'gestibile',
                dettagli: [
                    `Dipendenza da key person: ${dipendenzaKeyPerson}/5`,
                    `Perdita fatturato stimata 12 mesi: ‚Ç¨${impattoPerdita.toLocaleString()}`,
                    `Costi struttura non coperti: ‚Ç¨${costiStruttura.toLocaleString()}`,
                    `Impatto economico totale: ‚Ç¨${impattoPrimoAnno.toLocaleString()}`,
                    `Copertura Key Man: ‚Ç¨${coperturaKeyMan.toLocaleString()}`,
                    `Esposizione netta: ‚Ç¨${scoperturaKeyPerson.toLocaleString()}`
                ],
                raccomandazioni: scoperturaKeyPerson > 0 ? [
                    'Attivare/incrementare Key Man Insurance',
                    'Documentare processi critici',
                    'Formare sostituti/backup per ruoli chiave',
                    'Sviluppare piano continuit√† aziendale'
                ] : [
                    'Mantenere copertura Key Man adeguata',
                    'Monitorare evoluzione dipendenze'
                ]
            });

            // ========================================
            // SCENARIO 2: INCENDIO/CALAMIT√Ä SEDE
            // ========================================

            const valoreAsset = valoreImmobili > 0 ? valoreImmobili : fatturato * 0.5;
            const giorniRicostruzione = 180; // 6 mesi
            const perditaGiornaliera = fatturato / 365;
            const costiRicostruzione = valoreAsset * 0.7; // 70% del valore
            const perditaRicavi = perditaGiornaliera * giorniRicostruzione;
            const impattoCatastrofe = costiRicostruzione + perditaRicavi;

            const coperturaProperty = polizze.property?.valore || 0;
            const coperturaBI = polizze.business_interruption?.indennizzo || 0;
            const coperturaTotale = coperturaProperty + coperturaBI;
            const scoperturaCatastrofe = Math.max(0, impattoCatastrofe - coperturaTotale);

            scenari.push({
                id: 'catastrophe',
                titolo: 'Incendio/Calamit√† naturale sede operativa',
                icon: 'üî•',
                probabilita: 'bassa',
                impatto: impattoCatastrofe,
                copertura: coperturaTotale,
                scoperta: scoperturaCatastrofe,
                gravita: scoperturaCatastrofe > fatturato * 0.5 ? 'catastrofica' :
                         scoperturaCatastrofe > fatturato * 0.25 ? 'critica' :
                         scoperturaCatastrofe > 0 ? 'significativa' : 'gestibile',
                dettagli: [
                    `Valore asset da ricostruire: ‚Ç¨${valoreAsset.toLocaleString()}`,
                    `Costi ricostruzione stimati: ‚Ç¨${costiRicostruzione.toLocaleString()}`,
                    `Giorni stop operativit√†: ${giorniRicostruzione}`,
                    `Perdita ricavi: ‚Ç¨${perditaRicavi.toLocaleString()}`,
                    `Impatto totale: ‚Ç¨${impattoCatastrofe.toLocaleString()}`,
                    `Copertura Property: ‚Ç¨${coperturaProperty.toLocaleString()}`,
                    `Copertura Business Interruption: ‚Ç¨${coperturaBI.toLocaleString()}`,
                    `Esposizione netta: ‚Ç¨${scoperturaCatastrofe.toLocaleString()}`
                ],
                raccomandazioni: scoperturaCatastrofe > 0 ? [
                    'Attivare/incrementare Property Insurance',
                    'Attivare Business Interruption adeguata',
                    'Implementare piano disaster recovery',
                    'Valutare sede backup/operativit√† remota'
                ] : [
                    'Mantenere coperture adeguate',
                    'Testare piano disaster recovery'
                ]
            });

            // ========================================
            // SCENARIO 3: CYBER ATTACK / RANSOMWARE
            // ========================================

            const sicurezzaIT = answers.B4 || 3;
            
            let costoCyber = 0;
            if (dipendenti <= 10) costoCyber = 50000;
            else if (dipendenti <= 50) costoCyber = 150000;
            else if (dipendenti <= 250) costoCyber = 500000;
            else costoCyber = 1000000;

            if (companyData.settoreATECO.startsWith('J') || companyData.settoreATECO.startsWith('M62')) {
                costoCyber *= 2; // Settore IT
            }

            const giorniDownCyber = sicurezzaIT <= 2 ? 30 : sicurezzaIT === 3 ? 15 : 7;
            const perditaRicaviCyber = (fatturato / 365) * giorniDownCyber;
            const costoRansomware = costoCyber * 0.3; // 30% per riscatto medio
            const costoRecupero = costoCyber * 0.5; // 50% per recupero dati
            const impattoCyber = perditaRicaviCyber + costoRansomware + costoRecupero;

            const coperturaCyber = polizze.cyber?.massimale || 0;
            const scoperturaCyber = Math.max(0, impattoCyber - coperturaCyber);

            scenari.push({
                id: 'cyber_attack',
                titolo: 'Cyber Attack / Ransomware / Data Breach',
                icon: 'üîí',
                probabilita: sicurezzaIT <= 2 ? 'alta' : sicurezzaIT === 3 ? 'media' : 'bassa',
                impatto: impattoCyber,
                copertura: coperturaCyber,
                scoperta: scoperturaCyber,
                gravita: sicurezzaIT <= 2 ? 'critica' :
                         scoperturaCyber > fatturato * 0.2 ? 'significativa' : 'gestibile',
                dettagli: [
                    `Livello sicurezza IT: ${sicurezzaIT}/5`,
                    `Giorni downtime stimati: ${giorniDownCyber}`,
                    `Perdita ricavi: ‚Ç¨${perditaRicaviCyber.toLocaleString()}`,
                    `Costo ransomware: ‚Ç¨${costoRansomware.toLocaleString()}`,
                    `Costo recupero dati: ‚Ç¨${costoRecupero.toLocaleString()}`,
                    `Impatto totale: ‚Ç¨${impattoCyber.toLocaleString()}`,
                    `Copertura Cyber: ‚Ç¨${coperturaCyber.toLocaleString()}`,
                    `Esposizione netta: ‚Ç¨${scoperturaCyber.toLocaleString()}`
                ],
                raccomandazioni: sicurezzaIT <= 2 || scoperturaCyber > 0 ? [
                    'URGENTE: Rafforzare sicurezza IT',
                    'Implementare backup automatici offsite',
                    'Attivare Cyber Risk Insurance',
                    'Formare dipendenti su phishing',
                    'Implementare autenticazione multi-fattore'
                ] : [
                    'Mantenere protezione cyber adeguata',
                    'Aggiornare policy sicurezza'
                ]
            });

            // ========================================
            // SCENARIO 4: CAUSA LEGALE RC
            // ========================================

            const rischiSettore = answers.B8 || 3;
            let costoMedioContenzioso = 0;

            if (rischiSettore >= 4) costoMedioContenzioso = fatturato * 0.5;
            else if (rischiSettore === 3) costoMedioContenzioso = fatturato * 0.3;
            else costoMedioContenzioso = fatturato * 0.1;

            const costiLegali = costoMedioContenzioso * 0.2; // 20% spese legali
            const dannoReputazionale = fatturato * 0.1; // 10% perdita clienti
            const impattoCausa = costoMedioContenzioso + costiLegali + dannoReputazionale;

            const massimaleRC = (polizze.rc_generale?.massimale || 0) + 
                               (polizze.rc_professionale?.massimale || 0) + 
                               (polizze.rc_prodotti?.massimale || 0);
            const coperturaTutelaLegale = polizze.tutela_legale?.massimale || 0;
            const coperturaTotaleRC = massimaleRC + coperturaTutelaLegale;

            const scoperturaCausa = Math.max(0, impattoCausa - coperturaTotaleRC);

            scenari.push({
                id: 'legal_liability',
                titolo: 'Causa legale RC / Contenzioso importante',
                icon: '‚öñÔ∏è',
                probabilita: rischiSettore >= 4 ? 'media' : 'bassa',
                impatto: impattoCausa,
                copertura: coperturaTotaleRC,
                scoperta: scoperturaCausa,
                gravita: scoperturaCausa > fatturato * 0.3 ? 'critica' :
                         scoperturaCausa > 0 ? 'significativa' : 'gestibile',
                dettagli: [
                    `Rischio settore: ${rischiSettore}/5`,
                    `Costo contenzioso stimato: ‚Ç¨${costoMedioContenzioso.toLocaleString()}`,
                    `Spese legali: ‚Ç¨${costiLegali.toLocaleString()}`,
                    `Danno reputazionale: ‚Ç¨${dannoReputazionale.toLocaleString()}`,
                    `Impatto totale: ‚Ç¨${impattoCausa.toLocaleString()}`,
                    `Massimali RC: ‚Ç¨${massimaleRC.toLocaleString()}`,
                    `Tutela legale: ‚Ç¨${coperturaTutelaLegale.toLocaleString()}`,
                    `Esposizione netta: ‚Ç¨${scoperturaCausa.toLocaleString()}`
                ],
                raccomandazioni: scoperturaCausa > 0 ? [
                    'Incrementare massimali RC',
                    'Attivare Tutela Legale aziendale',
                    'Rivedere contratti con clausole limitazione responsabilit√†',
                    'Implementare procedure qualit√†/conformit√†'
                ] : [
                    'Mantenere coperture RC adeguate',
                    'Monitorare evoluzione normative settore'
                ]
            });

            // ========================================
            // SCENARIO 5: INTERRUZIONE ATTIVIT√Ä 3 MESI
            // ========================================

            const costiMensiliAzienda = (fatturato * 0.7) / 12; // 70% costi fissi
            const mesiInterruzione = 3;
            const costiFissiNonCoperti = costiMensiliAzienda * mesiInterruzione;
            const perditaMargine = (fatturato * 0.3 / 12) * mesiInterruzione; // 30% margine perso
            const impatto3Mesi = costiFissiNonCoperti + perditaMargine;

            const coperturaBI3M = polizze.business_interruption?.indennizzo || 0;
            const scoperturaBI = Math.max(0, impatto3Mesi - coperturaBI3M);

            scenari.push({
                id: 'business_interruption',
                titolo: 'Interruzione attivit√† 3 mesi (guasto, blocco autorizzazioni, etc.)',
                icon: '‚è∏Ô∏è',
                probabilita: 'media',
                impatto: impatto3Mesi,
                copertura: coperturaBI3M,
                scoperta: scoperturaBI,
                gravita: scoperturaBI > fatturato * 0.2 ? 'critica' :
                         scoperturaBI > 0 ? 'significativa' : 'gestibile',
                dettagli: [
                    `Costi fissi mensili: ‚Ç¨${costiMensiliAzienda.toLocaleString()}`,
                    `Mesi interruzione: ${mesiInterruzione}`,
                    `Costi fissi 3 mesi: ‚Ç¨${costiFissiNonCoperti.toLocaleString()}`,
                    `Perdita margine: ‚Ç¨${perditaMargine.toLocaleString()}`,
                    `Impatto totale: ‚Ç¨${impatto3Mesi.toLocaleString()}`,
                    `Copertura BI: ‚Ç¨${coperturaBI3M.toLocaleString()}`,
                    `Esposizione netta: ‚Ç¨${scoperturaBI.toLocaleString()}`
                ],
                raccomandazioni: scoperturaBI > 0 ? [
                    'Attivare Business Interruption adeguata',
                    'Creare riserva liquidit√† emergenza (3-6 mesi costi)',
                    'Diversificare fornitori critici',
                    'Piano contingency operativo'
                ] : [
                    'Mantenere copertura BI',
                    'Testare piano continuit√†'
                ]
            });

            // ========================================
            // SCENARIO 6: INFEDELT√Ä DIPENDENTE / FRODE
            // ========================================

            const accesso = 5 - (answers.A5 || 3); // Invertito: pochi con accesso = alto rischio
            const percentualeRischio = accesso >= 4 ? 0.15 : accesso === 3 ? 0.10 : 0.05;
            const dannoFrode = fatturato * percentualeRischio;
            const costiInvestigazione = 50000;
            const impattoFrode = dannoFrode + costiInvestigazione;

            const coperturaFidelity = 0; // Non implementata nelle polizze base
            const scoperturaFrode = impattoFrode;

            scenari.push({
                id: 'employee_fraud',
                titolo: 'Infedelt√† dipendente / Appropriazione indebita / Frode',
                icon: 'üí∞',
                probabilita: accesso >= 4 ? 'media' : 'bassa',
                impatto: impattoFrode,
                copertura: coperturaFidelity,
                scoperta: scoperturaFrode,
                gravita: scoperturaFrode > fatturato * 0.1 ? 'significativa' : 'gestibile',
                dettagli: [
                    `Persone con accesso info critiche: ${5 - accesso}`,
                    `Danno frode stimato: ‚Ç¨${dannoFrode.toLocaleString()}`,
                    `Costi investigazione: ‚Ç¨${costiInvestigazione.toLocaleString()}`,
                    `Impatto totale: ‚Ç¨${impattoFrode.toLocaleString()}`,
                    `Copertura Fidelity: ‚Ç¨${coperturaFidelity.toLocaleString()}`,
                    `Esposizione netta: ‚Ç¨${scoperturaFrode.toLocaleString()}`
                ],
                raccomandazioni: [
                    'Implementare controlli interni segregazione compiti',
                    'Sistema doppia firma oltre soglia',
                    'Audit periodici sorpresa',
                    'Valutare Fidelity Insurance',
                    'Background check assunzioni ruoli finanziari'
                ]
            });

            // ========================================
            // SCENARIO 7: PERDITA CLIENTE PRINCIPALE
            // ========================================

            const concentrazione = companyData.concentrazioneClienti || 30;
            const fatturatoPerso = fatturato * (concentrazione / 100);
            const marginePerso = fatturatoPerso * 0.3; // 30% margine medio
            const costiRistrutturazione = fatturato * 0.05; // 5% per ristrutturazione
            const impattoCliente = marginePerso + costiRistrutturazione;

            scenari.push({
                id: 'key_client_loss',
                titolo: 'Perdita cliente principale',
                icon: 'üë•',
                probabilita: concentrazione > 50 ? 'media' : 'bassa',
                impatto: impattoCliente,
                copertura: 0,
                scoperta: impattoCliente,
                gravita: concentrazione > 50 ? 'critica' :
                         concentrazione > 30 ? 'significativa' : 'gestibile',
                dettagli: [
                    `Concentrazione top 3 clienti: ${concentrazione}%`,
                    `Fatturato a rischio: ‚Ç¨${fatturatoPerso.toLocaleString()}`,
                    `Margine perso: ‚Ç¨${marginePerso.toLocaleString()}`,
                    `Costi ristrutturazione: ‚Ç¨${costiRistrutturazione.toLocaleString()}`,
                    `Impatto totale: ‚Ç¨${impattoCliente.toLocaleString()}`,
                    `Esposizione netta: ‚Ç¨${impattoCliente.toLocaleString()}`
                ],
                raccomandazioni: concentrazione > 50 ? [
                    'URGENTE: Diversificare portafoglio clienti',
                    'Implementare CRM e pipeline sviluppo',
                    'Valutare Credito Commerciale Insurance',
                    'Contratti pluriennali con clienti top'
                ] : [
                    'Continuare diversificazione clienti',
                    'Monitorare concentrazione'
                ]
            });

            // ========================================
            // SCENARIO 8: DANNO AMBIENTALE
            // ========================================

            const settoriRischio = ['C', 'E', 'F', 'H']; // Manifatturiero, Acqua, Edilizia, Trasporti
            const settoreRischioso = settoriRischio.some(s => companyData.settoreATECO.startsWith(s));
            
            const costoMediaRemissione = settoreRischioso ? 500000 : 100000;
            const sanzioniAmministrative = settoreRischioso ? 200000 : 50000;
            const dannoReputazione = fatturato * 0.05;
            const impattoAmbientale = costoMediaRemissione + sanzioniAmministrative + dannoReputazione;

            scenari.push({
                id: 'environmental_damage',
                titolo: 'Danno ambientale / Inquinamento',
                icon: 'üåç',
                probabilita: settoreRischioso ? 'media' : 'molto bassa',
                impatto: impattoAmbientale,
                copertura: 0,
                scoperta: impattoAmbientale,
                gravita: settoreRischioso && impattoAmbientale > fatturato * 0.3 ? 'critica' : 'significativa',
                dettagli: [
                    `Settore a rischio: ${settoreRischioso ? 'S√å' : 'NO'}`,
                    `Costo bonifica/remissione: ‚Ç¨${costoMediaRemissione.toLocaleString()}`,
                    `Sanzioni amministrative: ‚Ç¨${sanzioniAmministrative.toLocaleString()}`,
                    `Danno reputazione: ‚Ç¨${dannoReputazione.toLocaleString()}`,
                    `Impatto totale: ‚Ç¨${impattoAmbientale.toLocaleString()}`,
                    `Esposizione netta: ‚Ç¨${impattoAmbientale.toLocaleString()}`
                ],
                raccomandazioni: settoreRischioso ? [
                    'Valutare RC Inquinamento',
                    'Audit conformit√† ambientale',
                    'Certificazione ISO 14001',
                    'Procedure gestione rifiuti/sostanze pericolose'
                ] : [
                    'Monitorare conformit√† normative ambientali'
                ]
            });

            // ========================================
            // SCENARIO 9: CRISI REPUTAZIONALE
            // ========================================

            const presenzaWeb = companyData.sitoWeb ? true : false;
            const impattoReputazione = fatturato * 0.15; // 15% perdita fatturato
            const costiGestioneCrisi = 100000;
            const impattoTotaleCrisi = impattoReputazione + costiGestioneCrisi;

            scenari.push({
                id: 'reputational_crisis',
                titolo: 'Crisi reputazionale / Danni brand',
                icon: 'üì¢',
                probabilita: 'bassa',
                impatto: impattoTotaleCrisi,
                copertura: 0,
                scoperta: impattoTotaleCrisi,
                gravita: 'significativa',
                dettagli: [
                    `Presenza web: ${presenzaWeb ? 'S√å' : 'NO'}`,
                    `Perdita fatturato stimata: ‚Ç¨${impattoReputazione.toLocaleString()}`,
                    `Costi gestione crisi: ‚Ç¨${costiGestioneCrisi.toLocaleString()}`,
                    `Impatto totale: ‚Ç¨${impattoTotaleCrisi.toLocaleString()}`,
                    `Esposizione netta: ‚Ç¨${impattoTotaleCrisi.toLocaleString()}`
                ],
                raccomandazioni: [
                    'Implementare social media policy',
                    'Piano comunicazione crisi',
                    'Monitoraggio reputazione online',
                    'Formazione dipendenti su comunicazione'
                ]
            });

            // ========================================
            // SCENARIO 10: FALLIMENTO FORNITORE STRATEGICO
            // ========================================

            const fornitoriCritici = 5 - (answers.B5 || 3); // Invertito
            const costoFornitoreAlternativo = fatturato * 0.1; // 10% maggior costo
            const ritardoConsegne = fatturato * 0.05; // 5% perdita da ritardi
            const impattoFornitore = costoFornitoreAlternativo + ritardoConsegne;

            scenari.push({
                id: 'supplier_failure',
                titolo: 'Fallimento fornitore strategico',
                icon: 'üöö',
                probabilita: fornitoriCritici >= 4 ? 'media' : 'bassa',
                impatto: impattoFornitore,
                copertura: 0,
                scoperta: impattoFornitore,
                gravita: fornitoriCritici >= 4 ? 'significativa' : 'gestibile',
                dettagli: [
                    `Fornitori critici: score ${fornitoriCritici}/5`,
                    `Maggiori costi fornitori alternativi: ‚Ç¨${costoFornitoreAlternativo.toLocaleString()}`,
                    `Perdita da ritardi consegne: ‚Ç¨${ritardoConsegne.toLocaleString()}`,
                    `Impatto totale: ‚Ç¨${impattoFornitore.toLocaleString()}`,
                    `Esposizione netta: ‚Ç¨${impattoFornitore.toLocaleString()}`
                ],
                raccomandazioni: fornitoriCritici >= 4 ? [
                    'Diversificare fornitori critici (dual sourcing)',
                    'Scorte sicurezza materiali chiave',
                    'Valutare solidit√† finanziaria fornitori',
                    'Contratti pluriennali con clausole garanzia'
                ] : [
                    'Mantenere diversificazione fornitori'
                ]
            });

            return scenari;
        }

        // ========================================
        // SUGGERIMENTI INTELLIGENTI PRIORITIZZATI
        // ========================================

        function generaSuggerimentiIntelligentiAziendali(companyData, answers, gaps, semaforo, scenari) {
            const suggerimenti = [];

            const fatturato = companyData.fatturatoAnnuo || 0;
            const dipendenti = companyData.numeroDipendenti || 0;
            const polizze = companyData.polizze || {};

            // ========================================
            // SUGGERIMENTO 1: KEY MAN INSURANCE
            // ========================================

            const dipendenzaKeyPerson = answers.A1 || 3;
            if (dipendenzaKeyPerson <= 3 && !polizze.key_man) {
                const urgenza = dipendenzaKeyPerson <= 2 ? 100 : dipendenzaKeyPerson === 3 ? 80 : 60;
                const capitaleConsigliato = gaps.continuita.impattoTotale;

                suggerimenti.push({
                    id: 'key_man',
                    categoria: 'Continuit√† Aziendale',
                    titolo: 'Key Man Insurance',
                    priorita: urgenza,
                    motivazione: dipendenzaKeyPerson <= 2 ?
                        'URGENTE: Alta dipendenza da figure chiave senza protezione' :
                        'Proteggere continuit√† aziendale in caso perdita figure chiave',
                    dettagli: [
                        `Capitale consigliato: ‚Ç¨${capitaleConsigliato.toLocaleString()}`,
                        `Figure da assicurare: ${companyData.numeroKeyPersons}`,
                        `Copertura: morte, invalidit√† permanente`,
                        `Beneficiario: azienda (liquidit√† immediata)`
                    ],
                    benefici: [
                        'Liquidit√† immediata per affrontare transizione',
                        'Tempo per trovare/formare sostituti',
                        'Coprire perdita fatturato temporanea',
                        'Rassicurare banche e fornitori'
                    ],
                    costoStimato: Math.round(capitaleConsigliato * 0.003 * companyData.numeroKeyPersons), // 0.3% capitale
                    risparmioFiscale: 'Premio deducibile integralmente'
                });
            }

            // ========================================
            // SUGGERIMENTO 2: CYBER RISK
            // ========================================

            const sicurezzaIT = answers.B4 || 3;
            if (sicurezzaIT <= 3 || !polizze.cyber) {
                const urgenza = sicurezzaIT <= 2 ? 95 : sicurezzaIT === 3 ? 75 : 60;
                const massimaleConsigliato = gaps.cyber.costoTotaleCyber;

                suggerimenti.push({
                    id: 'cyber',
                    categoria: 'Sicurezza Digitale',
                    titolo: 'Cyber Risk Insurance',
                    priorita: urgenza,
                    motivazione: sicurezzaIT <= 2 ?
                        'CRITICO: Scarsa sicurezza IT espone a rischi cyber elevati' :
                        'Protezione contro data breach, ransomware, interruzione business',
                    dettagli: [
                        `Massimale consigliato: ‚Ç¨${massimaleConsigliato.toLocaleString()}`,
                        `Copertura: ransomware, data breach, business interruption cyber`,
                        `Servizi inclusi: assistenza IT emergenza, forensics, PR crisis`,
                        `Giorni downtime stimati senza copertura: ${gaps.cyber.costoInterruzioneGiorni}`
                    ],
                    benefici: [
                        'Copertura costi recupero dati',
                        'Assistenza esperti cyber 24/7',
                        'Copertura perdite economiche',
                        'Supporto legale e comunicazione'
                    ],
                    costoStimato: Math.round(fatturato * 0.004), // 0.4% fatturato
                    risparmioFiscale: 'Premio deducibile'
                });
            }

            // ========================================
            // SUGGERIMENTO 3: RC GENERALE/PROFESSIONALE
            // ========================================

            if (gaps.rc_contenzioso.gapRC > 0) {
                const urgenza = gaps.rc_contenzioso.gapRC > gaps.rc_contenzioso.massimaleConsigliato * 0.5 ? 90 : 70;

                suggerimenti.push({
                    id: 'rc_increment',
                    categoria: 'Responsabilit√† Civile',
                    titolo: 'Incremento Massimali RC',
                    priorita: urgenza,
                    motivazione: 'Massimali attuali insufficienti rispetto al rischio effettivo del settore',
                    dettagli: [
                        `Massimale attuale: ‚Ç¨${gaps.rc_contenzioso.coperturaTotaleRC.toLocaleString()}`,
                        `Massimale consigliato: ‚Ç¨${gaps.rc_contenzioso.massimaleConsigliato.toLocaleString()}`,
                        `Gap da coprire: ‚Ç¨${gaps.rc_contenzioso.gapRC.toLocaleString()}`,
                        `Moltiplicatore settore: ${(gaps.rc_contenzioso.massimaleConsigliato / fatturato).toFixed(1)}x fatturato`
                    ],
                    benefici: [
                        'Protezione patrimonio aziendale e personale',
                        'Copertura spese legali',
                        'Tranquillit√† operativa',
                        'Requisito contratti importanti'
                    ],
                    costoStimato: Math.round(gaps.rc_contenzioso.gapRC * 0.002), // 0.2% del gap
                    risparmioFiscale: 'Premio deducibile'
                });
            }

            // ========================================
            // SUGGERIMENTO 4: BUSINESS INTERRUPTION
            // ========================================

            const rischiOperativi = answers.B1 || 3;
            if (rischiOperativi >= 3 && gaps.property_interruption.gapBI > 0) {
                const urgenza = rischiOperativi >= 4 ? 85 : 70;

                suggerimenti.push({
                    id: 'business_interruption',
                    categoria: 'Continuit√† Operativa',
                    titolo: 'Business Interruption Insurance',
                    priorita: urgenza,
                    motivazione: 'Protezione perdite economiche durante interruzioni operative forzate',
                    dettagli: [
                        `Copertura attuale: ‚Ç¨${gaps.property_interruption.coperturaBI.toLocaleString()}`,
                        `Fabbisogno stimato: ‚Ç¨${gaps.property_interruption.costoInterruzioneMax.toLocaleString()}`,
                        `Gap: ‚Ç¨${gaps.property_interruption.gapBI.toLocaleString()}`,
                        `Periodo consigliato: ${gaps.property_interruption.mesiCritici} mesi`
                    ],
                    benefici: [
                        'Copertura costi fissi durante stop',
                        'Indennizzo perdita fatturato',
                        'Liquidit√† per mantenere dipendenti',
                        'Tempo per ripristino senza pressione finanziaria'
                    ],
                    costoStimato: Math.round(fatturato * 0.003), // 0.3% fatturato
                    risparmioFiscale: 'Premio deducibile'
                });
            }

            // ========================================
            // SUGGERIMENTO 5: PROPERTY / ALL RISKS
            // ========================================

            if (gaps.property_interruption.gapProperty > 0 && 
                (companyData.immobiliProprieta === 'totale' || companyData.valoreImmobili > 500000)) {
                const urgenza = 75;

                suggerimenti.push({
                    id: 'property',
                    categoria: 'Protezione Asset',
                    titolo: 'Property / All Risks',
                    priorita: urgenza,
                    motivazione: 'Asset significativi non adeguatamente protetti contro danni',
                    dettagli: [
                        `Valore asset: ‚Ç¨${gaps.property_interruption.valoreAssetTotale.toLocaleString()}`,
                        `Copertura attuale: ‚Ç¨${gaps.property_interruption.coperturaProperty.toLocaleString()}`,
                        `Gap: ‚Ç¨${gaps.property_interruption.gapProperty.toLocaleString()}`,
                        `Copertura: incendio, furto, eventi naturali, danni elettrici`
                    ],
                    benefici: [
                        'Protezione investimenti aziendali',
                        'Ricostruzione senza impatto liquidit√†',
                        'Copertura anche attrezzature/macchinari',
                        'Spesso richiesta da banche per finanziamenti'
                    ],
                    costoStimato: Math.round(gaps.property_interruption.valoreAssetTotale * 0.002), // 0.2% valore
                    risparmioFiscale: 'Premio deducibile'
                });
            }

            // ========================================
            // SUGGERIMENTO 6: D&O
            // ========================================

            const richiedeDO = (companyData.formaGiuridica === 'spa' || fatturato > 5000000 || dipendenti > 50);
            if (richiedeDO && !polizze.do) {
                const urgenza = companyData.formaGiuridica === 'spa' ? 80 : 65;

                suggerimenti.push({
                    id: 'do',
                    categoria: 'Protezione Management',
                    titolo: 'D&O (Directors & Officers Liability)',
                    priorita: urgenza,
                    motivazione: 'Protezione patrimonio personale amministratori da responsabilit√† gestionali',
                    dettagli: [
                        `Massimale consigliato: ‚Ç¨${(fatturato * 0.5).toLocaleString()}`,
                        `Copertura: decisioni gestionali, violazioni normative, contenziosi soci`,
                        `Protezione: patrimonio personale amministratori`,
                        `Difesa: spese legali anche in caso assoluzione`
                    ],
                    benefici: [
                        'Protezione patrimonio personale',
                        'Attrazione manager qualificati',
                        'Serenit√† decisionale',
                        'Copertura spese legali difesa'
                    ],
                    costoStimato: Math.round(fatturato * 0.0025), // 0.25% fatturato
                    risparmioFiscale: 'Premio deducibile'
                });
            }

            // ========================================
            // SUGGERIMENTO 7: TUTELA LEGALE
            // ========================================

            if (!polizze.tutela_legale) {
                const urgenza = 60;

                suggerimenti.push({
                    id: 'tutela_legale',
                    categoria: 'Assistenza Legale',
                    titolo: 'Tutela Legale Aziendale',
                    priorita: urgenza,
                    motivazione: 'Copertura spese legali per controversie civili, fiscali, amministrative',
                    dettagli: [
                        `Massimale consigliato: ‚Ç¨100.000`,
                        `Copertura: vertenze civili, fiscali, amministrative, penali`,
                        `Servizi: consulenza telefonica illimitata, assistenza stragiudiziale`,
                        `Nessuna franchigia su consulenze preventive`
                    ],
                    benefici: [
                        'Consulenza legale preventiva',
                        'Assistenza in ogni controversia',
                        'Nessun anticipo spese',
                        'Libera scelta avvocato'
                    ],
                    costoStimato: 2000, // Costo fisso medio
                    risparmioFiscale: 'Premio deducibile'
                });
            }

            // ========================================
            // SUGGERIMENTO 8: INFORTUNI DIPENDENTI
            // ========================================

            const settoreRischioso = (answers.B8 || 3) >= 4;
            if (dipendenti > 0 && settoreRischioso && !polizze.infortuni_dipendenti) {
                const urgenza = 70;

                suggerimenti.push({
                    id: 'infortuni_dipendenti',
                    categoria: 'Welfare Dipendenti',
                    titolo: 'Infortuni Dipendenti (integrazione INAIL)',
                    priorita: urgenza,
                    motivazione: 'Settore ad alto rischio: integrare INAIL per maggior protezione dipendenti',
                    dettagli: [
                        `Numero dipendenti: ${dipendenti}`,
                        `Capitale consigliato per dipendente: ‚Ç¨200.000`,
                        `Copertura: 24h/24, anche extra-lavoro`,
                        `Prestazioni: maggiori di INAIL, liquidazione rapida`
                    ],
                    benefici: [
                        'Welfare apprezzato dai dipendenti',
                        'Riduzione assenteismo',
                        'Maggiore attrattivit√† azienda',
                        'Supporto economico reale in caso infortunio'
                    ],
                    costoStimato: dipendenti * 250, // ‚Ç¨250/dipendente
                    risparmioFiscale: 'Premio deducibile + non concorre reddito dipendenti'
                });
            }

            // ========================================
            // SUGGERIMENTO 9: FLOTTA AUTO
            // ========================================

            if (!polizze.flotta && dipendenti > 5) {
                const urgenza = 50;

                suggerimenti.push({
                    id: 'flotta',
                    categoria: 'Mobilit√† Aziendale',
                    titolo: 'Gestione Flotta Auto Aziendali',
                    priorita: urgenza,
                    motivazione: 'Gestione centralizzata polizze auto con risparmio e semplificazione',
                    dettagli: [
                        `Veicoli aziendali stimati: ${Math.round(dipendenti * 0.3)}`,
                        `Copertura: RCA, Kasko, furto/incendio, assistenza stradale`,
                        `Gestione: unica polizza flotta, semplificazione amministrativa`,
                        `Benefit: carta carburante, manutenzione programmata`
                    ],
                    benefici: [
                        'Risparmio fino 20% vs singole polizze',
                        'Semplificazione gestionale',
                        'Nessun malus su singoli sinistri',
                        'Assistenza 24h dedicata'
                    ],
                    costoStimato: Math.round(dipendenti * 0.3 * 1500), // ‚Ç¨1.500/veicolo anno
                    risparmioFiscale: 'Premio deducibile'
                });
            }

            // ========================================
            // SUGGERIMENTO 10: PIANO CONTINUIT√Ä + DOCUMENTAZIONE
            // ========================================

            const pianificazione = (answers.A2 || 3) + (answers.A3 || 3);
            if (pianificazione <= 5) { // Somma <= 5 = scarsa pianificazione
                const urgenza = 80;

                suggerimenti.push({
                    id: 'business_continuity_plan',
                    categoria: 'Governance',
                    titolo: 'Piano Continuit√† Aziendale + Documentazione Know-How',
                    priorita: urgenza,
                    motivazione: 'Scarsa pianificazione continuit√† e documentazione processi critici',
                    dettagli: [
                        `Stato piano successione: ${answers.A2}/5`,
                        `Documentazione know-how: ${answers.A3}/5`,
                        `Accesso informazioni critiche: ${answers.A5}/5`,
                        `Azioni: BCP, procedure operative, knowledge base`
                    ],
                    benefici: [
                        'Riduzione dipendenza da persone',
                        'Formazione rapida nuovi ingressi',
                        'Continuit√† operativa garantita',
                        'Valore azienda incrementato (exit)',
                        'Bancabilit√† migliorata'
                    ],
                    costoStimato: 15000, // Consulenza BCP
                    risparmioFiscale: 'Costo deducibile come consulenza'
                });
            }

            // Ordina per priorit√† decrescente
            suggerimenti.sort((a, b) => b.priorita - a.priorita);

            return suggerimenti;
        }

    </script>
<script>
        // ========================================
        // RENDERING COMPLETO RISULTATI - INTEGRAZIONE MODULI AVANZATI
        // ========================================

        function renderResultsAziendali() {
            document.getElementById('questionario').style.display = 'none';
            document.getElementById('risultati').style.display = 'block';

            const container = document.getElementById('risultatiContent');
            const companyData = appStateAzienda.company.anagrafica;
            const answers = appStateAzienda.answers;

            // Calcoli completi
            const gaps = calcolaGapAziendali(companyData, answers);
            const normotipo = analizzaNormotipoAziendale(companyData, answers);
            const semaforo = calcolaSemaforoAziendale(companyData, answers, normotipo, gaps);
            const coherence = detectIncoherenzeAziendali(companyData, answers);
            const behavioralGap = calcolaBehavioralGapAziendale(companyData, answers);
            const scenari = simulaScenariStressAziendali(companyData, answers, gaps);
            const suggerimenti = generaSuggerimentiIntelligentiAziendali(companyData, answers, gaps, semaforo, scenari);

            appStateAzienda.results = {
                gaps,
                normotipo,
                semaforo,
                coherence,
                behavioralGap,
                scenari,
                suggerimenti,
                timestamp: new Date().toISOString()
            };

            let html = '';

            // HEADER
            html += '<div style="background: linear-gradient(135deg, var(--generali-blue), var(--generali-light-blue)); color: white; padding: 35px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 6px 16px rgba(0,0,0,0.15);">';
            html += `<h2 style="margin: 0 0 12px 0; font-size: 32px;">${companyData.ragioneSociale}</h2>`;
            html += `<p style="margin: 0; opacity: 0.95; font-size: 16px;">`;
            html += `${companyData.formaGiuridica.toUpperCase()} | ${companyData.numeroDipendenti} dipendenti | `;
            html += `Fatturato: ‚Ç¨${companyData.fatturatoAnnuo.toLocaleString()} | `;
            html += `Et√† azienda: ${companyData.companyAge} anni`;
            html += `</p>`;
            html += '</div>';

            // NORMOTIPO
            html += '<div class="card" style="background: linear-gradient(135deg, #F0F9FF 0%, #E0F2FE 100%); border-left: 5px solid var(--generali-blue);">';
            html += `<h3 class="card-title" style="color: #0C4A6E;">üè≠ Profilo Aziendale: ${normotipo.profilo}</h3>`;
            html += '<ul style="margin-left: 20px; line-height: 1.8; color: var(--gray-700);">';
            normotipo.caratteristiche.forEach(c => {
                html += `<li style="margin-bottom: 8px;"><strong>${c}</strong></li>`;
            });
            html += '</ul>';
            if (normotipo.esclusioni && normotipo.esclusioni.length > 0) {
                html += '<div style="background: #FEF3C7; padding: 18px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #F59E0B;">';
                html += '<strong style="color: #92400E;">‚ö†Ô∏è Note Importanti:</strong>';
                html += '<ul style="margin: 10px 0 0 20px; color: #78350F;">';
                normotipo.esclusioni.forEach(e => {
                    html += `<li style="margin-bottom: 6px;">${e}</li>`;
                });
                html += '</ul></div>';
            }
            html += '</div>';

            // COHERENCE SCORE
            html += '<div class="card">';
            html += '<h3 class="card-title">üìä Coerenza Dati Aziendali</h3>';
            const coherenceColor = coherence.coherenceScore >= 80 ? 'var(--green)' : 
                                   coherence.coherenceScore >= 60 ? 'var(--yellow)' : 'var(--red)';
            html += `<div style="text-align: center; padding: 25px;">`;
            html += `<div style="font-size: 56px; font-weight: bold; color: ${coherenceColor};">${coherence.coherenceScore}%</div>`;
            html += `<p style="color: var(--gray-600); font-size: 16px; margin-top: 10px;">Indice di coerenza dati e risposte</p>`;
            html += '</div>';
            if (coherence.incoherenze.length > 0) {
                html += '<div style="background: #FEE2E2; padding: 18px; border-radius: 8px; border-left: 4px solid #DC2626;">';
                html += '<strong style="color: #991B1B; font-size: 16px;">‚ö†Ô∏è Incoerenze Rilevate:</strong>';
                html += '<ul style="margin: 12px 0 0 20px; color: #7F1D1D;">';
                coherence.incoherenze.forEach(inc => {
                    html += `<li style="margin-bottom: 8px;">${inc.message}</li>`;
                });
                html += '</ul></div>';
            }
            html += '</div>';

            // GAP ANALYSIS - 5 AREE
            html += '<div class="card">';
            html += '<h3 class="card-title">üéØ Analisi GAP Protezioni Aziendali</h3>';
            html += '<p style="color: var(--gray-600); margin-bottom: 25px;">Identificazione delle scoperture assicurative critiche rispetto ai rischi effettivi</p>';

            // GAP 1: CONTINUIT√Ä
            html += renderGapCard('Continuit√† Aziendale', gaps.continuita, 'üîë', [
                { label: 'Impatto perdita key person (6 mesi)', value: `‚Ç¨${gaps.continuita.perdita6Mesi.toLocaleString()}` },
                { label: 'Costi struttura (6 mesi)', value: `‚Ç¨${gaps.continuita.costiStruttura6Mesi.toLocaleString()}` },
                { label: 'Impatto totale stimato', value: `‚Ç¨${gaps.continuita.impattoTotale.toLocaleString()}`, bold: true },
                { label: 'Copertura Key Man attuale', value: `‚Ç¨${gaps.continuita.copterturaKeyMan.toLocaleString()}` },
                { label: 'Scoperta lorda', value: `‚Ç¨${gaps.continuita.scoperturaLorda.toLocaleString()}`, bold: true, color: gaps.continuita.gravita === 'critica' ? 'var(--red)' : gaps.continuita.gravita === 'alta' ? 'var(--orange)' : 'var(--green)' }
            ]);

            // GAP 2: RC/CONTENZIOSO
            html += renderGapCard('RC & Contenzioso', gaps.rc_contenzioso, '‚öñÔ∏è', [
                { label: 'Massimale RC consigliato (settore)', value: `‚Ç¨${gaps.rc_contenzioso.massimaleConsigliato.toLocaleString()}` },
                { label: 'Copertura RC totale attuale', value: `‚Ç¨${gaps.rc_contenzioso.coperturaTotaleRC.toLocaleString()}` },
                { label: 'GAP da coprire', value: `‚Ç¨${gaps.rc_contenzioso.gapRC.toLocaleString()}`, bold: true, color: gaps.rc_contenzioso.gravita === 'critica' ? 'var(--red)' : gaps.rc_contenzioso.gravita === 'alta' ? 'var(--orange)' : 'var(--green)' }
            ]);

            // GAP 3: CYBER
            html += renderGapCard('Cyber Risk', gaps.cyber, 'üîí', [
                { label: 'Costo medio data breach (stimato)', value: `‚Ç¨${gaps.cyber.costoMedioDataBreach.toLocaleString()}` },
                { label: 'Giorni interruzione stimati', value: `${gaps.cyber.costoInterruzioneGiorni} giorni` },
                { label: 'Costo interruzione business', value: `‚Ç¨${gaps.cyber.costoInterruzioneTotale.toLocaleString()}` },
                { label: 'Esposizione totale cyber', value: `‚Ç¨${gaps.cyber.costoTotaleCyber.toLocaleString()}`, bold: true },
                { label: 'Copertura cyber attuale', value: `‚Ç¨${gaps.cyber.coperturaCyber.toLocaleString()}` },
                { label: 'GAP da coprire', value: `‚Ç¨${gaps.cyber.gapCyber.toLocaleString()}`, bold: true, color: gaps.cyber.gravita === 'critica' ? 'var(--red)' : gaps.cyber.gravita === 'alta' ? 'var(--orange)' : 'var(--green)' }
            ]);

            // GAP 4: PROPERTY & BUSINESS INTERRUPTION
            html += renderGapCard('Property & Interruzione Attivit√†', gaps.property_interruption, 'üè≠', [
                { label: 'Valore asset totale', value: `‚Ç¨${gaps.property_interruption.valoreAssetTotale.toLocaleString()}` },
                { label: 'Copertura property attuale', value: `‚Ç¨${gaps.property_interruption.coperturaProperty.toLocaleString()}` },
                { label: 'GAP property', value: `‚Ç¨${gaps.property_interruption.gapProperty.toLocaleString()}`, bold: true },
                { label: 'Mesi critici senza operativit√†', value: `${gaps.property_interruption.mesiCritici} mesi` },
                { label: 'Costo interruzione massimo', value: `‚Ç¨${gaps.property_interruption.costoInterruzioneMax.toLocaleString()}` },
                { label: 'Copertura BI attuale', value: `‚Ç¨${gaps.property_interruption.coperturaBI.toLocaleString()}` },
                { label: 'GAP business interruption', value: `‚Ç¨${gaps.property_interruption.gapBI.toLocaleString()}`, bold: true },
                { label: 'GAP TOTALE', value: `‚Ç¨${gaps.property_interruption.gapTotale.toLocaleString()}`, bold: true, color: gaps.property_interruption.gravita === 'critica' ? 'var(--red)' : gaps.property_interruption.gravita === 'alta' ? 'var(--orange)' : 'var(--green)' }
            ]);

            // GAP 5: SUCCESSIONE
            html += renderGapCard('Successione & Passaggio Generazionale', gaps.successione, 'üë•', [
                { label: 'Et√† azienda', value: `${gaps.successione.companyAge} anni` },
                { label: 'Et√† media management', value: `${gaps.successione.etaMediaManagement} anni` },
                { label: 'Valore azienda stimato', value: `‚Ç¨${gaps.successione.valoreAziendaStimato.toLocaleString()}` },
                { label: 'Liquidit√† necessaria buy-out/exit', value: `‚Ç¨${gaps.successione.liquiditaNecessaria.toLocaleString()}`, bold: true },
                { label: 'Liquidit√† disponibile', value: `‚Ç¨${gaps.successione.liquiditaDisponibile.toLocaleString()}` },
                { label: 'GAP liquidit√† successione', value: `‚Ç¨${gaps.successione.gapSuccessione.toLocaleString()}`, bold: true, color: gaps.successione.gravita === 'critica' ? 'var(--red)' : gaps.successione.gravita === 'alta' ? 'var(--orange)' : 'var(--green)' }
            ]);

            html += '</div>';

            // BEHAVIORAL GAP AZIENDALE
            html += '<div class="card">';
            html += '<h3 class="card-title">üß† Behavioral Gap Analysis Aziendale</h3>';
            html += '<p style="color: var(--gray-600); margin-bottom: 25px;">Analisi discrepanze tra percezioni/dichiarazioni e realt√† oggettiva aziendale</p>';

            const behavioralAreas = [
                { key: 'governance', nome: 'Governance Gap', icon: 'üëî', descrizione: 'Percezione stabilit√† vs vulnerabilit√† reale' },
                { key: 'risk_management', nome: 'Risk Management Gap', icon: 'üõ°Ô∏è', descrizione: 'Rischi dichiarati vs coperture effettive' },
                { key: 'financial', nome: 'Financial Gap', icon: 'üí∞', descrizione: 'Solidit√† percepita vs dati bilancio' },
                { key: 'operational', nome: 'Operational Gap', icon: '‚öôÔ∏è', descrizione: 'Resilienza dichiarata vs dipendenze operative' },
                { key: 'strategic', nome: 'Strategic Gap', icon: 'üéØ', descrizione: 'Visione ambiziosa vs pianificazione concreta' }
            ];

            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">';
            behavioralAreas.forEach(area => {
                const data = behavioralGap[area.key];
                const gravitaColor = data.gravita === 'alta' ? 'var(--red)' : 
                                    data.gravita === 'media' ? 'var(--orange)' : 'var(--green)';
                const bgColor = data.gravita === 'alta' ? '#FEE2E2' : 
                               data.gravita === 'media' ? '#FED7AA' : '#D1FAE5';

                html += `<div style="background: white; padding: 25px; border-radius: 10px; border-left: 4px solid ${gravitaColor}; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">`;
                html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">`;
                html += `<h4 style="color: var(--generali-blue); margin: 0; font-size: 18px;">${area.icon} ${area.nome}</h4>`;
                html += `<span style="background: ${bgColor}; color: ${gravitaColor}; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 700; text-transform: uppercase;">${data.gravita}</span>`;
                html += `</div>`;
                html += `<p style="color: var(--gray-600); font-size: 14px; margin-bottom: 12px;">${area.descrizione}</p>`;
                html += `<div style="text-align: center; padding: 15px; background: var(--gray-50); border-radius: 8px; margin-bottom: 15px;">`;
                html += `<div style="font-size: 36px; font-weight: bold; color: ${gravitaColor};">${data.gapScore}%</div>`;
                html += `<div style="font-size: 12px; color: var(--gray-600); margin-top: 5px;">Gap Score</div>`;
                html += `</div>`;
                html += '<ul style="margin: 0 0 15px 20px; font-size: 14px; color: var(--gray-700);">';
                data.dettagli.forEach(det => {
                    html += `<li style="margin-bottom: 6px;">${det}</li>`;
                });
                html += '</ul>';
                html += `<div style="background: ${bgColor}; padding: 12px; border-radius: 6px; font-size: 14px; color: ${gravitaColor}; font-weight: 500;">`;
                html += `üí° ${data.messaggio}`;
                html += '</div>';
                html += '</div>';
            });
            html += '</div>';
            html += '</div>';

            // SCENARI STRESS
            html += '<div class="card">';
            html += '<h3 class="card-title">‚ö†Ô∏è Simulazione Scenari Stress</h3>';
            html += '<p style="color: var(--gray-600); margin-bottom: 25px;">Impatto economico e finanziario di 10 scenari critici con calcolo esposizione netta</p>';

            scenari.forEach(scenario => {
                const gravitaColor = scenario.gravita === 'catastrofica' ? '#7F1D1D' :
                                    scenario.gravita === 'critica' ? '#991B1B' :
                                    scenario.gravita === 'significativa' ? '#9A3412' : '#065F46';
                const bgColor = scenario.gravita === 'catastrofica' ? '#FEE2E2' :
                               scenario.gravita === 'critica' ? '#FED7AA' :
                               scenario.gravita === 'significativa' ? '#FEF3C7' : '#D1FAE5';
                const borderColor = scenario.gravita === 'catastrofica' ? '#DC2626' :
                                   scenario.gravita === 'critica' ? '#F97316' :
                                   scenario.gravita === 'significativa' ? '#F59E0B' : '#10B981';

                const probColor = scenario.probabilita === 'alta' ? '#DC2626' :
                                 scenario.probabilita === 'media' ? '#F59E0B' : '#6B7280';

                html += `<div style="background: white; padding: 25px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid ${borderColor}; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">`;
                
                // Header scenario
                html += '<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">';
                html += `<h4 style="color: var(--generali-blue); margin: 0; font-size: 18px; flex: 1;">${scenario.icon} ${scenario.titolo}</h4>`;
                html += '<div style="display: flex; gap: 10px;">';
                html += `<span style="background: ${bgColor}; color: ${gravitaColor}; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 700; text-transform: uppercase; white-space: nowrap;">GRAVIT√Ä: ${scenario.gravita}</span>`;
                html += `<span style="background: #F3F4F6; color: ${probColor}; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 700; text-transform: uppercase; white-space: nowrap;">PROB: ${scenario.probabilita}</span>`;
                html += '</div>';
                html += '</div>';

                // Dati finanziari
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">';
                html += `<div style="background: var(--gray-50); padding: 15px; border-radius: 8px; text-align: center;">`;
                html += `<div style="font-size: 12px; color: var(--gray-600); margin-bottom: 5px;">IMPATTO</div>`;
                html += `<div style="font-size: 20px; font-weight: bold; color: var(--gray-900);">‚Ç¨${scenario.impatto.toLocaleString()}</div>`;
                html += `</div>`;
                html += `<div style="background: var(--gray-50); padding: 15px; border-radius: 8px; text-align: center;">`;
                html += `<div style="font-size: 12px; color: var(--gray-600); margin-bottom: 5px;">COPERTURA</div>`;
                html += `<div style="font-size: 20px; font-weight: bold; color: #10B981;">‚Ç¨${scenario.copertura.toLocaleString()}</div>`;
                html += `</div>`;
                html += `<div style="background: ${bgColor}; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid ${borderColor};">`;
                html += `<div style="font-size: 12px; color: ${gravitaColor}; margin-bottom: 5px; font-weight: 700;">ESPOSIZIONE NETTA</div>`;
                html += `<div style="font-size: 20px; font-weight: bold; color: ${gravitaColor};">‚Ç¨${scenario.scoperta.toLocaleString()}</div>`;
                html += `</div>`;
                html += '</div>';

                // Dettagli
                html += '<div style="background: var(--gray-50); padding: 18px; border-radius: 8px; margin-bottom: 15px;">';
                html += '<strong style="color: var(--gray-700); font-size: 14px; display: block; margin-bottom: 10px;">üìã Dettagli Scenario:</strong>';
                html += '<ul style="margin: 0 0 0 20px; font-size: 14px; color: var(--gray-700);">';
                scenario.dettagli.forEach(det => {
                    html += `<li style="margin-bottom: 6px;">${det}</li>`;
                });
                html += '</ul>';
                html += '</div>';

                // Raccomandazioni
                html += '<div style="background: #EFF6FF; padding: 18px; border-radius: 8px; border-left: 4px solid #3B82F6;">';
                html += '<strong style="color: #1E40AF; font-size: 14px; display: block; margin-bottom: 10px;">üí° Raccomandazioni:</strong>';
                html += '<ul style="margin: 0 0 0 20px; font-size: 14px; color: #1E3A8A;">';
                scenario.raccomandazioni.forEach(racc => {
                    html += `<li style="margin-bottom: 6px;">${racc}</li>`;
                });
                html += '</ul>';
                html += '</div>';

                html += '</div>';
            });

            html += '</div>';

            // SUGGERIMENTI INTELLIGENTI PRIORITIZZATI
            html += '<div class="card">';
            html += '<h3 class="card-title">üéØ Suggerimenti Intelligenti Prioritizzati</h3>';
            html += '<p style="color: var(--gray-600); margin-bottom: 25px;">Azioni concrete ordinate per priorit√† con costo stimato e benefici</p>';

            suggerimenti.forEach((sug, index) => {
                const prioritaColor = sug.priorita >= 90 ? '#DC2626' :
                                     sug.priorita >= 75 ? '#F97316' :
                                     sug.priorita >= 60 ? '#F59E0B' : '#10B981';
                const bgColor = sug.priorita >= 90 ? '#FEE2E2' :
                               sug.priorita >= 75 ? '#FED7AA' :
                               sug.priorita >= 60 ? '#FEF3C7' : '#D1FAE5';
                const borderColor = sug.priorita >= 90 ? '#DC2626' :
                                   sug.priorita >= 75 ? '#F97316' :
                                   sug.priorita >= 60 ? '#F59E0B' : '#10B981';

                html += `<div style="background: white; padding: 25px; border-radius: 10px; margin-bottom: 20px; border-left: 5px solid ${borderColor}; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">`;
                
                // Header
                html += '<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">';
                html += `<div style="flex: 1;">`;
                html += `<div style="font-size: 12px; color: var(--gray-500); margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px;">Priorit√† #${index + 1} ‚Ä¢ ${sug.categoria}</div>`;
                html += `<h4 style="color: var(--generali-blue); margin: 0; font-size: 20px; font-weight: 700;">${sug.titolo}</h4>`;
                html += `</div>`;
                html += `<div style="text-align: center; background: ${bgColor}; padding: 12px 20px; border-radius: 12px; border: 2px solid ${borderColor};">`;
                html += `<div style="font-size: 28px; font-weight: bold; color: ${prioritaColor}; line-height: 1;">${sug.priorita}</div>`;
                html += `<div style="font-size: 11px; color: ${prioritaColor}; font-weight: 600; margin-top: 2px;">PRIORIT√Ä</div>`;
                html += `</div>`;
                html += '</div>';

                // Motivazione
                html += `<div style="background: ${bgColor}; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 3px solid ${borderColor};">`;
                html += `<strong style="color: ${prioritaColor};">üéØ Motivazione:</strong> ${sug.motivazione}`;
                html += `</div>`;

                // Dettagli tecnici
                html += '<div style="background: var(--gray-50); padding: 18px; border-radius: 8px; margin-bottom: 15px;">';
                html += '<strong style="color: var(--gray-700); font-size: 14px; display: block; margin-bottom: 10px;">üìã Dettagli Tecnici:</strong>';
                html += '<ul style="margin: 0 0 0 20px; font-size: 14px; color: var(--gray-700); line-height: 1.7;">';
                sug.dettagli.forEach(det => {
                    html += `<li style="margin-bottom: 6px;">${det}</li>`;
                });
                html += '</ul>';
                html += '</div>';

                // Benefici
                html += '<div style="background: #D1FAE5; padding: 18px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #10B981;">';
                html += '<strong style="color: #065F46; font-size: 14px; display: block; margin-bottom: 10px;">‚úÖ Benefici:</strong>';
                html += '<ul style="margin: 0 0 0 20px; font-size: 14px; color: #047857; line-height: 1.7;">';
                sug.benefici.forEach(ben => {
                    html += `<li style="margin-bottom: 6px;">${ben}</li>`;
                });
                html += '</ul>';
                html += '</div>';

                // Costi e fiscalit√†
                html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">';
                html += '<div style="background: #EFF6FF; padding: 15px; border-radius: 8px; border-left: 3px solid #3B82F6;">';
                html += '<div style="font-size: 12px; color: #1E40AF; margin-bottom: 5px; font-weight: 600;">üí∞ Costo Stimato Annuo</div>';
                html += `<div style="font-size: 22px; font-weight: bold; color: #1E3A8A;">‚Ç¨${sug.costoStimato.toLocaleString()}</div>`;
                html += '</div>';
                html += '<div style="background: #F0FDF4; padding: 15px; border-radius: 8px; border-left: 3px solid #10B981;">';
                html += '<div style="font-size: 12px; color: #065F46; margin-bottom: 5px; font-weight: 600;">üè¶ Fiscalit√†</div>';
                html += `<div style="font-size: 14px; font-weight: 600; color: #047857;">${sug.risparmioFiscale}</div>`;
                html += '</div>';
                html += '</div>';

                html += '</div>';
            });

            html += '</div>';

            // SEMAFORO PRODOTTI
            html += '<div class="card">';
            html += '<h3 class="card-title">üö¶ Semaforo Coperture Assicurative</h3>';
            html += '<p style="color: var(--gray-600); margin-bottom: 25px;">Valutazione priorit√† e adeguatezza delle coperture per la tua azienda</p>';

            const prodotti = [
                { key: 'rc_generale', nome: 'RC Generale', icon: 'üõ°Ô∏è' },
                { key: 'rc_professionale', nome: 'RC Professionale', icon: '‚öñÔ∏è' },
                { key: 'rc_prodotti', nome: 'RC Prodotti', icon: 'üì¶' },
                { key: 'do', nome: 'D&O', icon: 'üëî' },
                { key: 'key_man', nome: 'Key Man Insurance', icon: 'üîë' },
                { key: 'cyber', nome: 'Cyber Risk', icon: 'üîí' },
                { key: 'property', nome: 'Property/All Risks', icon: 'üè≠' },
                { key: 'business_interruption', nome: 'Business Interruption', icon: '‚è∏Ô∏è' },
                { key: 'tutela_legale', nome: 'Tutela Legale', icon: '‚öñÔ∏è' },
                { key: 'infortuni_dipendenti', nome: 'Infortuni Dipendenti', icon: 'üë∑' },
                { key: 'flotta', nome: 'Flotta Auto', icon: 'üöó' },
                { key: 'trasporto_merci', nome: 'Trasporto Merci', icon: 'üì¶' }
            ];

            html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 18px;">';
            prodotti.forEach(prod => {
                const color = semaforo[prod.key];
                const motivo = semaforo[`${prod.key}_motivo`] || '';
                const priorita = normotipo.priorita[prod.key] || 50;

                let bgColor, borderColor, textColor;
                switch(color) {
                    case 'red':
                        bgColor = '#FEE2E2';
                        borderColor = '#DC2626';
                        textColor = '#991B1B';
                        break;
                    case 'orange':
                        bgColor = '#FED7AA';
                        borderColor = '#F97316';
                        textColor = '#9A3412';
                        break;
                    case 'yellow':
                        bgColor = '#FEF3C7';
                        borderColor = '#F59E0B';
                        textColor = '#92400E';
                        break;
                    case 'green':
                        bgColor = '#D1FAE5';
                        borderColor = '#10B981';
                        textColor = '#065F46';
                        break;
                    default: // gray
                        bgColor = '#F3F4F6';
                        borderColor = '#9CA3AF';
                        textColor = '#4B5563';
                }

                html += `<div style="background: ${bgColor}; padding: 18px; border-radius: 8px; border-left: 4px solid ${borderColor};">`;
                html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">`;
                html += `<strong style="color: ${textColor}; font-size: 16px;">${prod.icon} ${prod.nome}</strong>`;
                html += `<span style="background: ${borderColor}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700;">Priorit√†: ${priorita}%</span>`;
                html += `</div>`;
                html += `<p style="margin: 0; color: ${textColor}; font-size: 14px;">${motivo}</p>`;
                html += `</div>`;
            });
            html += '</div>';
            html += '</div>';

            container.innerHTML = html;
            window.scrollTo({ top: 0, behavior: 'smooth' });

            showToast('‚úÖ Analisi completata con successo!', 'success');
        }

    </script>
<script>
        // ========================================
        // NORMOTIPI AZIENDALI ESTESI V2.0 - 20 PROFILI
        // ========================================

        function analizzaNormotipoAziendaleEsteso(companyData, answers) {
            const fatturato = companyData.fatturatoAnnuo || 0;
            const dipendenti = companyData.numeroDipendenti || 0;
            const companyAge = companyData.companyAge || 0;
            const settore = companyData.settoreATECO || '';
            const formaGiuridica = companyData.formaGiuridica || '';
            const export_perc = companyData.percentualeExport || 0;
            const crescitaPrevista = answers.C8 || 3;
            const pianificazione = answers.C3 || 3;
            const dipendenzaKeyPerson = answers.A1 || 3;
            const innovazione = formaGiuridica.includes('innovativa') || formaGiuridica.includes('startup');

            let normotipo = {
                profilo: 'PMI Standard',
                sottotipo: '',
                caratteristiche: [],
                priorita: {},
                raccomandazioni: [],
                esclusioni: []
            };

            // ========================================
            // PROFILO 1: STARTUP INNOVATIVA
            // ========================================
            if (companyAge <= 3 && innovazione) {
                normotipo.profilo = 'Startup Innovativa';
                normotipo.sottotipo = 'Early Stage Tech';
                normotipo.caratteristiche = [
                    'Fase early stage con alta volatilit√†',
                    'Focus su crescita rapida e scalabilit√†',
                    'Dipendenza critica da fondatori/key persons',
                    'Budget limitato per protezioni',
                    'Alto rischio imprenditoriale',
                    'Necessit√† flessibilit√† massima'
                ];
                normotipo.priorita = {
                    rc_generale: 75,
                    rc_professionale: 80,
                    rc_prodotti: 50,
                    do: 40,
                    key_man: 100,
                    cyber: 90,
                    property: 50,
                    business_interruption: 60,
                    tutela_legale: 70,
                    infortuni_dipendenti: 65,
                    flotta: 40,
                    trasporto_merci: 30
                };
                normotipo.raccomandazioni = [
                    'Key Man Insurance priorit√† assoluta',
                    'Cyber Risk essenziale per proteggere IP',
                    'RC Professionale per rapporti con clienti',
                    'Soluzioni scalabili con premio variabile'
                ];
            }

            // ========================================
            // PROFILO 2: MICROIMPRESA ARTIGIANA
            // ========================================
            else if (dipendenti <= 5 && fatturato <= 500000 && 
                    (settore.startsWith('C') || settore.startsWith('F') || settore === 'altro')) {
                normotipo.profilo = 'Microimpresa Artigiana';
                normotipo.sottotipo = 'Ditta Individuale o SNC';
                normotipo.caratteristiche = [
                    'Titolare + 2-5 collaboratori',
                    'Produzione/lavorazione manuale',
                    'Clientela locale/regionale',
                    'Dipendenza totale da titolare',
                    'Margini ridotti, budget limitato',
                    'Rischio infortuni medio-alto'
                ];
                normotipo.priorita = {
                    rc_generale: 85,
                    rc_professionale: 60,
                    rc_prodotti: 70,
                    do: 20,
                    key_man: 95,
                    cyber: 50,
                    property: 80,
                    business_interruption: 70,
                    tutela_legale: 65,
                    infortuni_dipendenti: 85,
                    flotta: 50,
                    trasporto_merci: 40
                };
                normotipo.raccomandazioni = [
                    'RC Generale obbligatoria',
                    'Key Man per proteggere famiglia',
                    'Infortuni dipendenti + titolare',
                    'Property per laboratorio/magazzino'
                ];
            }

            // ========================================
            // PROFILO 3: STUDIO PROFESSIONALE PICCOLO
            // ========================================
            else if (dipendenti <= 5 && (settore.startsWith('M69') || settore.startsWith('M70') || 
                    settore.startsWith('M71') || settore.startsWith('M74'))) {
                normotipo.profilo = 'Studio Professionale Piccolo';
                normotipo.sottotipo = '1-5 Professionisti';
                normotipo.caratteristiche = [
                    'Studio avvocati/commercialisti/architetti/ingegneri',
                    '1-5 professionisti + segreteria',
                    'Responsabilit√† professionale elevata',
                    'Clientela B2B e B2C',
                    'Ricavi da prestazioni intellettuali',
                    'Basso rischio operativo, alto rischio legale'
                ];
                normotipo.priorita = {
                    rc_generale: 70,
                    rc_professionale: 95,
                    rc_prodotti: 30,
                    do: 40,
                    key_man: 90,
                    cyber: 75,
                    property: 60,
                    business_interruption: 65,
                    tutela_legale: 85,
                    infortuni_dipendenti: 60,
                    flotta: 45,
                    trasporto_merci: 20
                };
                normotipo.raccomandazioni = [
                    'RC Professionale OBBLIGATORIA',
                    'Key Man per soci operativi',
                    'Cyber per dati clienti (GDPR)',
                    'Tutela Legale per controversie'
                ];
            }

            // ========================================
            // PROFILO 4: STUDIO PROFESSIONALE STRUTTURATO
            // ========================================
            else if (dipendenti >= 6 && dipendenti <= 20 && 
                    (settore.startsWith('M69') || settore.startsWith('M70') || settore.startsWith('M71'))) {
                normotipo.profilo = 'Studio Professionale Strutturato';
                normotipo.sottotipo = '6-20 Professionisti';
                normotipo.caratteristiche = [
                    'Studio strutturato con partner',
                    'Clientela corporate importante',
                    'Esposizione RC professionale significativa',
                    'Team diversificato per competenze',
                    'Investimenti in tecnologia',
                    'Brand e reputazione critici'
                ];
                normotipo.priorita = {
                    rc_generale: 75,
                    rc_professionale: 100,
                    rc_prodotti: 30,
                    do: 70,
                    key_man: 85,
                    cyber: 85,
                    property: 65,
                    business_interruption: 70,
                    tutela_legale: 90,
                    infortuni_dipendenti: 65,
                    flotta: 50,
                    trasporto_merci: 20
                };
                normotipo.raccomandazioni = [
                    'RC Professionale massimali elevati',
                    'D&O per partner',
                    'Cyber Risk con protezione reputazione',
                    'Key Man per partner chiave'
                ];
            }

            // ========================================
            // PROFILO 5: PMI FAMILIARE GENERAZIONALE
            // ========================================
            else if (companyAge > 20 && dipendenti >= 10) {
                normotipo.profilo = 'PMI Familiare Generazionale';
                normotipo.sottotipo = '2a/3a Generazione';
                normotipo.caratteristiche = [
                    'Azienda familiare storica',
                    '2a o 3a generazione al comando',
                    'Necessit√† passaggio generazionale',
                    'Patrimonio aziendale significativo',
                    'Cultura aziendale consolidata',
                    'Clientela storica fidelizzata'
                ];
                normotipo.priorita = {
                    rc_generale: 85,
                    rc_professionale: 75,
                    rc_prodotti: 80,
                    do: 70,
                    key_man: 90,
                    cyber: 70,
                    property: 90,
                    business_interruption: 85,
                    tutela_legale: 75,
                    infortuni_dipendenti: 80,
                    flotta: 65,
                    trasporto_merci: 55
                };
                normotipo.raccomandazioni = [
                    'Piano successorio strutturato',
                    'Protezione patrimonio famiglia vs azienda',
                    'Key Man su figure chiave famiglia',
                    'Patto di famiglia + polizze liquidit√†'
                ];
                normotipo.esclusioni = [
                    'URGENTE: Et√† media management elevata richiede pianificazione successione immediata'
                ];
            }

            // ========================================
            // PROFILO 6: PMI FAMILIARE PRIMA GENERAZIONE
            // ========================================
            else if (companyAge >= 5 && companyAge <= 20 && dipendenti >= 5 && dipendenzaKeyPerson <= 2) {
                normotipo.profilo = 'PMI Familiare Prima Generazione';
                normotipo.sottotipo = 'Fondatore ancora operativo';
                normotipo.caratteristiche = [
                    'Fondatore/titolare ancora molto presente',
                    'Fase consolidamento post-startup',
                    'Dipendenza critica da fondatore',
                    'Possibile ingresso familiari/soci',
                    'Crescita organica sostenibile',
                    'Pianificazione futuro da definire'
                ];
                normotipo.priorita = {
                    rc_generale: 85,
                    rc_professionale: 70,
                    rc_prodotti: 75,
                    do: 55,
                    key_man: 100,
                    cyber: 75,
                    property: 85,
                    business_interruption: 80,
                    tutela_legale: 70,
                    infortuni_dipendenti: 80,
                    flotta: 60,
                    trasporto_merci: 50
                };
                normotipo.raccomandazioni = [
                    'Key Man URGENTE (dipendenza critica)',
                    'Documentare processi aziendali',
                    'Formare seconda linea management',
                    'Pianificare exit/passaggio generazionale'
                ];
            }

            // ========================================
            // PROFILO 7: PMI IN CRESCITA RAPIDA
            // ========================================
            else if (crescitaPrevista >= 4 && fatturato > 1000000) {
                normotipo.profilo = 'PMI in Crescita Rapida';
                normotipo.sottotipo = 'Scale-up Phase';
                normotipo.caratteristiche = [
                    'Crescita >15% anno',
                    'Fase espansione accelerata',
                    'Assunzioni frequenti',
                    'Investimenti significativi',
                    'Rischio esecuzione elevato',
                    'Necessit√† cash flow importante'
                ];
                normotipo.priorita = {
                    rc_generale: 90,
                    rc_professionale: 80,
                    rc_prodotti: 85,
                    do: 75,
                    key_man: 85,
                    cyber: 85,
                    property: 80,
                    business_interruption: 90,
                    tutela_legale: 75,
                    infortuni_dipendenti: 80,
                    flotta: 70,
                    trasporto_merci: 60
                };
                normotipo.raccomandazioni = [
                    'Business Interruption essenziale',
                    'D&O per attrarre manager',
                    'Coperture scalabili con crescita',
                    'Cyber Risk (aumento superficie attacco)'
                ];
            }

            // ========================================
            // PROFILO 8: PMI CONSOLIDATA STABILE
            // ========================================
            else if (companyAge > 10 && crescitaPrevista === 3 && fatturato > 2000000) {
                normotipo.profilo = 'PMI Consolidata Stabile';
                normotipo.sottotipo = 'Mercato Maturo';
                normotipo.caratteristiche = [
                    'Mercato maturo, fatturato stabile',
                    'Posizione consolidata',
                    'Management rodato',
                    'Processi strutturati',
                    'Focus efficienza e margini',
                    'Crescita organica lenta'
                ];
                normotipo.priorita = {
                    rc_generale: 85,
                    rc_professionale: 75,
                    rc_prodotti: 80,
                    do: 65,
                    key_man: 75,
                    cyber: 75,
                    property: 85,
                    business_interruption: 80,
                    tutela_legale: 75,
                    infortuni_dipendenti: 80,
                    flotta: 65,
                    trasporto_merci: 55
                };
                normotipo.raccomandazioni = [
                    'Mantenere coperture adeguate',
                    'Rivedere periodicamente massimali',
                    'Ottimizzare costi polizze',
                    'Valutare nuovi rischi emergenti'
                ];
            }

            // ========================================
            // PROFILO 9: PMI IN DIFFICOLT√Ä
            // ========================================
            else if (crescitaPrevista <= 2 || (answers.C5 || 3) >= 4) {
                normotipo.profilo = 'PMI in Difficolt√†';
                normotipo.sottotipo = 'Fase Turnaround';
                normotipo.caratteristiche = [
                    'Calo fatturato o perdite',
                    'Alta leva finanziaria',
                    'Necessit√† ristrutturazione',
                    'Budget assicurativo limitato',
                    'Rischio discontinuit√† aziendale',
                    'Focus su liquidit√† e sopravvivenza'
                ];
                normotipo.priorita = {
                    rc_generale: 80,
                    rc_professionale: 65,
                    rc_prodotti: 70,
                    do: 50,
                    key_man: 85,
                    cyber: 60,
                    property: 75,
                    business_interruption: 80,
                    tutela_legale: 70,
                    infortuni_dipendenti: 70,
                    flotta: 50,
                    trasporto_merci: 40
                };
                normotipo.raccomandazioni = [
                    'Priorit√† assoluta: protezioni obbligatorie',
                    'Key Man per garantire continuit√†',
                    'Business Interruption (rischio elevato)',
                    'Negoziare premi con compagnie'
                ];
                normotipo.esclusioni = [
                    'ATTENZIONE: Situazione finanziaria critica richiede piano turnaround urgente'
                ];
            }

            // ========================================
            // PROFILO 10: AZIENDA EXPORT-ORIENTED
            // ========================================
            else if (export_perc > 50) {
                normotipo.profilo = 'Azienda Export-Oriented';
                normotipo.sottotipo = 'Internazionalizzata';
                normotipo.caratteristiche = [
                    'Oltre 50% fatturato estero',
                    'Esposizione rischio cambio',
                    'Complessit√† normative internazionali',
                    'Logistica complessa',
                    'Rischio credito commerciale',
                    'Necessit√† coperture internazionali'
                ];
                normotipo.priorita = {
                    rc_generale: 90,
                    rc_professionale: 80,
                    rc_prodotti: 90,
                    do: 75,
                    key_man: 80,
                    cyber: 80,
                    property: 80,
                    business_interruption: 85,
                    tutela_legale: 85,
                    infortuni_dipendenti: 75,
                    flotta: 60,
                    trasporto_merci: 90
                };
                normotipo.raccomandazioni = [
                    'RC Prodotti internazionale',
                    'Trasporto merci con copertura globale',
                    'Credito commerciale per esportazioni',
                    'Tutela legale internazionale'
                ];
            }

            // ========================================
            // PROFILO 11: RETAIL MULTI-SEDE
            // ========================================
            else if (settore.startsWith('G47') && companyData.numeroSediOperative > 3) {
                normotipo.profilo = 'Retail Multi-Sede';
                normotipo.sottotipo = 'Catena Negozi';
                normotipo.caratteristiche = [
                    'Catena retail con pi√π punti vendita',
                    'Esposizione RC verso clienti',
                    'Rischio furto elevato',
                    'Personale numeroso',
                    'Orari estesi',
                    'Cash management critico'
                ];
                normotipo.priorita = {
                    rc_generale: 95,
                    rc_professionale: 60,
                    rc_prodotti: 85,
                    do: 60,
                    key_man: 70,
                    cyber: 75,
                    property: 90,
                    business_interruption: 80,
                    tutela_legale: 75,
                    infortuni_dipendenti: 85,
                    flotta: 55,
                    trasporto_merci: 70
                };
                normotipo.raccomandazioni = [
                    'RC Generale con massimali elevati',
                    'Property All Risks multi-sede',
                    'Fidelity per dipendenti con accesso cassa',
                    'Cyber per sistemi POS/pagamenti'
                ];
            }

            // ========================================
            // PROFILO 12: MANIFATTURIERO TRADIZIONALE
            // ========================================
            else if (settore.startsWith('C') && !innovazione && companyAge > 10) {
                normotipo.profilo = 'Manifatturiero Tradizionale';
                normotipo.sottotipo = 'Produzione Standard';
                normotipo.caratteristiche = [
                    'Produzione beni tradizionali',
                    'Impianti e macchinari significativi',
                    'Rischio infortuni medio-alto',
                    'Magazzino materie prime/prodotti',
                    'Clientela B2B',
                    'Mercato competitivo'
                ];
                normotipo.priorita = {
                    rc_generale: 90,
                    rc_professionale: 65,
                    rc_prodotti: 90,
                    do: 60,
                    key_man: 75,
                    cyber: 70,
                    property: 95,
                    business_interruption: 90,
                    tutela_legale: 75,
                    infortuni_dipendenti: 90,
                    flotta: 60,
                    trasporto_merci: 75
                };
                normotipo.raccomandazioni = [
                    'Property per impianti/macchinari',
                    'Business Interruption essenziale',
                    'RC Prodotti adeguata',
                    'Infortuni dipendenti oltre INAIL'
                ];
            }

            // ========================================
            // PROFILO 13: MANIFATTURIERO INNOVATIVO 4.0
            // ========================================
            else if (settore.startsWith('C') && innovazione || 
                    (settore.startsWith('C26') || settore.startsWith('C27') || settore.startsWith('C28'))) {
                normotipo.profilo = 'Manifatturiero Innovativo 4.0';
                normotipo.sottotipo = 'Industria 4.0';
                normotipo.caratteristiche = [
                    'Automazione avanzata',
                    'IoT e sistemi connessi',
                    'R&D significativa',
                    'Competenze specializzate',
                    'IP e brevetti importanti',
                    'Alto valore aggiunto'
                ];
                normotipo.priorita = {
                    rc_generale: 90,
                    rc_professionale: 75,
                    rc_prodotti: 90,
                    do: 75,
                    key_man: 85,
                    cyber: 95,
                    property: 95,
                    business_interruption: 95,
                    tutela_legale: 80,
                    infortuni_dipendenti: 80,
                    flotta: 60,
                    trasporto_merci: 70
                };
                normotipo.raccomandazioni = [
                    'Cyber Risk ESSENZIALE (sistemi connessi)',
                    'Property per macchinari high-tech',
                    'Business Interruption critica',
                    'Key Man per competenze specializzate'
                ];
            }

            // ========================================
            // PROFILO 14: SOCIET√Ä SERVIZI IT
            // ========================================
            else if (settore.startsWith('J62') || settore.startsWith('M62')) {
                normotipo.profilo = 'Societ√† Servizi IT';
                normotipo.sottotipo = 'Software/Digital';
                normotipo.caratteristiche = [
                    'Servizi IT/software',
                    'Asset principalmente intangibili',
                    'Esposizione cyber critica',
                    'RC professionale importante',
                    'Team tecnico specializzato',
                    'SLA con clienti vincolanti'
                ];
                normotipo.priorita = {
                    rc_generale: 75,
                    rc_professionale: 95,
                    rc_prodotti: 70,
                    do: 70,
                    key_man: 90,
                    cyber: 100,
                    property: 50,
                    business_interruption: 85,
                    tutela_legale: 85,
                    infortuni_dipendenti: 60,
                    flotta: 40,
                    trasporto_merci: 30
                };
                normotipo.raccomandazioni = [
                    'Cyber Risk PRIORIT√Ä ASSOLUTA',
                    'RC Professionale per errori software',
                    'Key Man per sviluppatori chiave',
                    'Business Interruption per SLA'
                ];
            }

            // ========================================
            // PROFILO 15: CONSULENZA/SERVIZI PROFESSIONALI
            // ========================================
            else if (settore.startsWith('M70') || settore.startsWith('M73') || settore.startsWith('M74')) {
                normotipo.profilo = 'Societ√† Consulenza';
                normotipo.sottotipo = 'Servizi Professionali B2B';
                normotipo.caratteristiche = [
                    'Consulenza aziendale/gestionale',
                    'Clientela corporate',
                    'Responsabilit√† su decisioni strategiche',
                    'Asset intangibili (know-how)',
                    'Dipendenza da consulenti senior',
                    'Reputazione critica'
                ];
                normotipo.priorita = {
                    rc_generale: 75,
                    rc_professionale: 100,
                    rc_prodotti: 40,
                    do: 85,
                    key_man: 90,
                    cyber: 80,
                    property: 55,
                    business_interruption: 70,
                    tutela_legale: 90,
                    infortuni_dipendenti: 65,
                    flotta: 50,
                    trasporto_merci: 30
                };
                normotipo.raccomandazioni = [
                    'RC Professionale massimali molto elevati',
                    'D&O per partner',
                    'Key Man per consulenti senior',
                    'Cyber per dati clienti sensibili'
                ];
            }

            // ========================================
            // PROFILO 16: COOPERATIVA SOCIALE
            // ========================================
            else if (formaGiuridica === 'cooperativa') {
                normotipo.profilo = 'Cooperativa Sociale';
                normotipo.sottotipo = 'Terzo Settore';
                normotipo.caratteristiche = [
                    'Finalit√† sociale',
                    'Margini ridotti',
                    'Personale numeroso',
                    'Servizi alla persona',
                    'Responsabilit√† verso utenti fragili',
                    'Budget limitato'
                ];
                normotipo.priorita = {
                    rc_generale: 95,
                    rc_professionale: 85,
                    rc_prodotti: 60,
                    do: 55,
                    key_man: 70,
                    cyber: 65,
                    property: 70,
                    business_interruption: 75,
                    tutela_legale: 80,
                    infortuni_dipendenti: 90,
                    flotta: 70,
                    trasporto_merci: 40
                };
                normotipo.raccomandazioni = [
                    'RC Generale priorit√† (utenti fragili)',
                    'Infortuni dipendenti essenziale',
                    'Soluzioni a premio contenuto',
                    'Valutare convenzioni settoriali'
                ];
            }

            // ========================================
            // PROFILO 17: IMPRESA EDILE/COSTRUZIONI
            // ========================================
            else if (settore.startsWith('F41') || settore.startsWith('F42') || settore.startsWith('F43')) {
                normotipo.profilo = 'Impresa Edile/Costruzioni';
                normotipo.sottotipo = 'Settore Alto Rischio';
                normotipo.caratteristiche = [
                    'Cantieri e lavori in quota',
                    'Rischio infortuni altissimo',
                    'RC verso terzi critica',
                    'Subappalti frequenti',
                    'Contenzioso frequente',
                    'Garanzie CAR'
                ];
                normotipo.priorita = {
                    rc_generale: 100,
                    rc_professionale: 80,
                    rc_prodotti: 75,
                    do: 65,
                    key_man: 75,
                    cyber: 60,
                    property: 85,
                    business_interruption: 75,
                    tutela_legale: 90,
                    infortuni_dipendenti: 100,
                    flotta: 75,
                    trasporto_merci: 60
                };
                normotipo.raccomandazioni = [
                    'RC Generale con massimali elevatissimi',
                    'Infortuni dipendenti OBBLIGATORIA',
                    'CAR (Contractors All Risks)',
                    'Tutela Legale per contenziosi'
                ];
            }

            // ========================================
            // PROFILO 18: TRASPORTI/LOGISTICA
            // ========================================
            else if (settore.startsWith('H49') || settore.startsWith('H52')) {
                normotipo.profilo = 'Trasporti/Logistica';
                normotipo.sottotipo = 'Mobilit√† Merci';
                normotipo.caratteristiche = [
                    'Flotta veicoli significativa',
                    'Trasporto merci terzi',
                    'Rischio incidenti stradali',
                    'Responsabilit√† su merce',
                    'Magazzini/hub logistici',
                    'Orari H24'
                ];
                normotipo.priorita = {
                    rc_generale: 90,
                    rc_professionale: 70,
                    rc_prodotti: 75,
                    do: 60,
                    key_man: 70,
                    cyber: 70,
                    property: 85,
                    business_interruption: 85,
                    tutela_legale: 80,
                    infortuni_dipendenti: 90,
                    flotta: 100,
                    trasporto_merci: 100
                };
                normotipo.raccomandazioni = [
                    'Flotta auto ESSENZIALE',
                    'Trasporto merci con massimali adeguati',
                    'Property per magazzini/hub',
                    'Infortuni autisti'
                ];
            }

            // ========================================
            // PROFILO 19: CLINICA/SANITARIO PRIVATO
            // ========================================
            else if (settore.startsWith('Q86') || settore.startsWith('Q87')) {
                normotipo.profilo = 'Struttura Sanitaria Privata';
                normotipo.sottotipo = 'Clinica/RSA';
                normotipo.caratteristiche = [
                    'Servizi sanitari/assistenziali',
                    'RC professionale critica',
                    'Pazienti/ospiti fragili',
                    'Normative stringenti',
                    'Contenzioso frequente',
                    'Reputazione fondamentale'
                ];
                normotipo.priorita = {
                    rc_generale: 95,
                    rc_professionale: 100,
                    rc_prodotti: 70,
                    do: 85,
                    key_man: 80,
                    cyber: 85,
                    property: 85,
                    business_interruption: 90,
                    tutela_legale: 95,
                    infortuni_dipendenti: 85,
                    flotta: 60,
                    trasporto_merci: 40
                };
                normotipo.raccomandazioni = [
                    'RC Professionale sanitaria OBBLIGATORIA',
                    'Massimali elevatissimi',
                    'Cyber per dati sanitari (GDPR)',
                    'Tutela Legale per malasanit√†'
                ];
            }

            // ========================================
            // PROFILO 20: HOLDING/GRUPPO
            // ========================================
            else if (formaGiuridica === 'spa' && fatturato > 10000000) {
                normotipo.profilo = 'Holding/Gruppo Multi-Societ√†';
                normotipo.sottotipo = 'Struttura Complessa';
                normotipo.caratteristiche = [
                    'Gruppo con pi√π societ√†',
                    'Governance articolata',
                    'CDA e assemblee',
                    'Rischi enterprise',
                    'Consolidato di gruppo',
                    'Complessit√† normativa elevata'
                ];
                normotipo.priorita = {
                    rc_generale: 95,
                    rc_professionale: 85,
                    rc_prodotti: 85,
                    do: 100,
                    key_man: 80,
                    cyber: 95,
                    property: 90,
                    business_interruption: 90,
                    tutela_legale: 90,
                    infortuni_dipendenti: 85,
                    flotta: 75,
                    trasporto_merci: 65
                };
                normotipo.raccomandazioni = [
                    'D&O PRIORIT√Ä (amministratori/CDA)',
                    'Coperture consolidate gruppo',
                    'Cyber Risk enterprise',
                    'Advisory specialistico risk management'
                ];
            }

            // ========================================
            // DEFAULT: PMI STANDARD (se nessun match)
            // ========================================
            else {
                normotipo.profilo = 'PMI Standard';
                normotipo.sottotipo = 'Profilo Generico';
                normotipo.caratteristiche = [
                    `${dipendenti} dipendenti`,
                    `Fatturato ‚Ç¨${fatturato.toLocaleString()}`,
                    `Et√† azienda: ${companyAge} anni`,
                    'Necessit√† valutazione personalizzata'
                ];
                normotipo.priorita = {
                    rc_generale: 80,
                    rc_professionale: 70,
                    rc_prodotti: 70,
                    do: 60,
                    key_man: 75,
                    cyber: 75,
                    property: 80,
                    business_interruption: 75,
                    tutela_legale: 70,
                    infortuni_dipendenti: 75,
                    flotta: 55,
                    trasporto_merci: 50
                };
                normotipo.raccomandazioni = [
                    'Valutazione personalizzata necessaria',
                    'Analisi rischi specifica settore',
                    'Consulenza dedicata'
                ];
            }

            return normotipo;
        }

        // Override funzione precedente con versione estesa
        function analizzaNormotipoAziendale(companyData, answers) {
            return analizzaNormotipoAziendaleEsteso(companyData, answers);
        }

        // ========================================
        // MODULI UX AVANZATI
        // ========================================

        // Tracking modifiche questionario
        let questionarioSnapshot = null;

        function salvaSnapshotQuestionario() {
            questionarioSnapshot = JSON.parse(JSON.stringify(appStateAzienda.answers));
        }

        function confrontaConSnapshot() {
            if (!questionarioSnapshot) return [];
            
            const modifiche = [];
            Object.keys(questionarioSnapshot).forEach(key => {
                if (appStateAzienda.answers[key] !== questionarioSnapshot[key]) {
                    modifiche.push({
                        domanda: key,
                        vecchio: questionarioSnapshot[key],
                        nuovo: appStateAzienda.answers[key]
                    });
                }
            });
            
            return modifiche;
        }

        // Badge warning per incoerenze in real-time
        function mostraWarningIncoerenza(messaggio) {
            const existingWarning = document.querySelector('.warning-inline');
            if (existingWarning) {
                existingWarning.remove();
            }

            const container = document.getElementById('questionContainer');
            const warning = document.createElement('div');
            warning.className = 'warning-inline';
            warning.style.cssText = 'background: #FEF3C7; border-left: 4px solid #F59E0B; padding: 15px 20px; border-radius: 8px; margin-top: 20px; color: #92400E; font-weight: 500; animation: slideDown 0.3s ease;';
            warning.innerHTML = `‚ö†Ô∏è ${messaggio}`;
            container.appendChild(warning);
        }

        // Validazione P.IVA italiana
        function validaPartitaIVA(piva) {
            if (!piva || piva.length !== 11) return false;
            if (!/^[0-9]{11}$/.test(piva)) return false;
            
            // Algoritmo Luhn per P.IVA italiana
            let sum = 0;
            for (let i = 0; i < 10; i++) {
                let digit = parseInt(piva[i]);
                if (i % 2 === 1) {
                    digit *= 2;
                    if (digit > 9) digit -= 9;
                }
                sum += digit;
            }
            const checkDigit = (10 - (sum % 10)) % 10;
            return checkDigit === parseInt(piva[10]);
        }

        // Validazione Codice Fiscale
        function validaCodiceFiscale(cf) {
            if (!cf || cf.length !== 16) return false;
            return /^[A-Z]{6}[0-9]{2}[A-Z][0-9]{2}[A-Z][0-9]{3}[A-Z]$/.test(cf.toUpperCase());
        }

        // Aggiungi validazioni real-time
        document.getElementById('partitaIVA')?.addEventListener('blur', function() {
            if (this.value && !validaPartitaIVA(this.value)) {
                this.style.borderColor = 'var(--red)';
                showToast('‚ö†Ô∏è Partita IVA non valida', 'error', 3000);
            } else {
                this.style.borderColor = '';
            }
        });

        document.getElementById('codiceFiscaleAzienda')?.addEventListener('blur', function() {
            if (this.value && !validaCodiceFiscale(this.value)) {
                this.style.borderColor = 'var(--red)';
                showToast('‚ö†Ô∏è Codice Fiscale non valido', 'error', 3000);
            } else {
                this.style.borderColor = '';
            }
        });

        // Auto-capitalizza CF
        document.getElementById('codiceFiscaleAzienda')?.addEventListener('input', function() {
            this.value = this.value.toUpperCase();
        });

        // Calcolo automatico et√† azienda
        document.getElementById('annoCostituzione')?.addEventListener('change', function() {
            const anno = parseInt(this.value);
            const currentYear = new Date().getFullYear();
            if (anno && anno <= currentYear && anno >= 1900) {
                const eta = currentYear - anno;
                showToast(`‚ÑπÔ∏è Et√† azienda: ${eta} anni`, 'info', 2000);
            }
        });

    </script>
<script>
        // ========================================
        // MODULO NEURO-VALIDATION AZIENDALE V3.0
        // ========================================

        console.log('%cüß† NEURO-VALIDATION AZIENDALE V3.0 - ATTIVO', 'color: #7C3AED; font-weight: bold');

        function calcolaProfiloNeuroscientificoAziendale(companyData, answers) {
            const profilo = {
                cluster: 'Pragmatico-Equilibrato',
                coerenzaRisposte: 75,
                profiloDecisionale: 'Analitico-Moderato',
                tendenzaRischio: 'Calcolato',
                biasRilevati: [],
                insights: [],
                contraddizioni: []
            };

            const fatturato = companyData.fatturatoAnnuo || 0;
            const dipendenti = companyData.numeroDipendenti || 0;
            const companyAge = companyData.companyAge || 0;
            const polizze = companyData.polizze || {};
            const numPolizze = Object.keys(polizze).length;

            // ========================================
            // 1. CALCOLO COERENZA RISPOSTE
            // ========================================

            let incoerenze = 0;
            let contraddizioni = [];

            // Incoerenza 1: Continuit√† percepita vs dipendenza reale
            const percezioneContinuita = answers.A4 || 3;
            const dipendenzaKeyPerson = answers.A1 || 3;

            if (percezioneContinuita >= 4 && dipendenzaKeyPerson <= 2) {
                incoerenze++;
                contraddizioni.push('Alta dipendenza da key person ma percezione continuit√† ottimistica');
            }

            // Incoerenza 2: Piano successione vs et√† azienda/management
            const pianoSuccessione = answers.A2 || 3;
            const etaManagement = companyData.etaMediaManagement || 0;

            if (companyAge > 15 && etaManagement > 55 && pianoSuccessione <= 2) {
                incoerenze++;
                contraddizioni.push('Azienda matura con management senior ma nessun piano successione');
            }

            // Incoerenza 3: Sicurezza IT bassa ma settore digitale
            const sicurezzaIT = answers.B4 || 3;
            const settoreDigitale = companyData.settoreATECO.startsWith('J') || companyData.settoreATECO.startsWith('M62');

            if (sicurezzaIT <= 2 && settoreDigitale) {
                incoerenze++;
                contraddizioni.push('Settore IT/digitale ma sicurezza informatica scarsa');
            }

            // Incoerenza 4: Investimenti previsti ma nessun piano strategico
            const investimenti = answers.C4 || 3;
            const pianoStrategico = answers.C3 || 3;

            if (investimenti >= 4 && pianoStrategico <= 2) {
                incoerenze++;
                contraddizioni.push('Investimenti significativi previsti senza piano strategico');
            }

            // Incoerenza 5: Crescita prevista ma alta leva finanziaria
            const crescita = answers.C8 || 3;
            const leva = answers.C5 || 3;

            if (crescita >= 4 && leva >= 4) {
                incoerenze++;
                contraddizioni.push('Previsioni crescita ambiziose con debito gi√† elevato');
            }

            // Incoerenza 6: Rischi operativi alti ma scarsa protezione
            const rischiOperativi = answers.B1 || 3;
            
            if (rischiOperativi >= 4 && numPolizze <= 2) {
                incoerenze++;
                contraddizioni.push('Elevati rischi operativi ma poche coperture assicurative');
            }

            // Incoerenza 7: Sinistralit√† alta ma manutenzione scarsa
            const sinistralita = answers.B2 || 3;
            const manutenzione = answers.B3 || 3;

            if (sinistralita >= 4 && manutenzione <= 2) {
                incoerenze++;
                contraddizioni.push('Sinistri frequenti ma manutenzione trascurata');
            }

            // Incoerenza 8: Concentrazione clienti alta ma nessuna diversificazione
            const concentrazione = companyData.concentrazioneClienti || 0;
            const diversificazione = answers.C6 || 3;

            if (concentrazione > 50 && diversificazione <= 2) {
                incoerenze++;
                contraddizioni.push('Alta dipendenza da pochi clienti senza strategia diversificazione');
            }

            // Calcolo coerenza finale
            const penalita = incoerenze * 12;
            profilo.coerenzaRisposte = Math.max(20, 100 - penalita);
            profilo.contraddizioni = contraddizioni;

            // ========================================
            // 2. PROFILO DECISIONALE
            // ========================================

            const pianificazioneScore = (answers.C3 || 3) + (answers.A2 || 3) + (answers.A6 || 3);
            const propensioneRischio = answers.C7 || 3;
            const visioneCrescita = answers.C8 || 3;

            const scoreAnalitico = pianificazioneScore / 15 * 100;
            const scoreVisionario = ((visioneCrescita + propensioneRischio) / 10) * 100;

            if (scoreAnalitico >= 70 && propensioneRischio <= 2) {
                profilo.profiloDecisionale = 'Analitico-Conservativo';
                profilo.insights.push('‚úÖ Approccio molto strutturato e prudente alle decisioni aziendali');
            } else if (scoreAnalitico >= 70) {
                profilo.profiloDecisionale = 'Analitico-Strategico';
                profilo.insights.push('‚úÖ Decisioni basate su pianificazione rigorosa e analisi dati');
            } else if (scoreVisionario >= 70 && scoreAnalitico < 50) {
                profilo.profiloDecisionale = 'Visionario-Impulsivo';
                profilo.insights.push('‚ö†Ô∏è Visione ambiziosa ma pianificazione insufficiente: rischio esecuzione');
            } else if (propensioneRischio >= 4 && pianificazioneScore <= 6) {
                profilo.profiloDecisionale = 'Risk-Taker-Spontaneo';
                profilo.insights.push('‚ö†Ô∏è Alta propensione rischio senza adeguata pianificazione: volatile');
            } else if (scoreAnalitico >= 50 && propensioneRischio === 3) {
                profilo.profiloDecisionale = 'Pragmatico-Equilibrato';
                profilo.insights.push('üìä Equilibrio tra analisi e azione: decisioni ponderate');
            } else {
                profilo.profiloDecisionale = 'Reattivo-Situazionale';
                profilo.insights.push('‚ö†Ô∏è Decisioni spesso reattive: sviluppare approccio pi√π proattivo');
            }

            // ========================================
            // 3. TENDENZA RISCHIO
            // ========================================

            const rischioDichiarato = answers.C7 || 3;
            const rischioReale = (answers.B1 || 3) + (answers.B8 || 3) + (5 - (answers.B3 || 3));
            const protezioneMisure = numPolizze * 8; // 8 punti per polizza
            
            const gapRischio = Math.abs((rischioDichiarato * 20) - protezioneMisure);

            if (rischioDichiarato >= 4 && numPolizze <= 2) {
                profilo.tendenzaRischio = 'Risk-Seeker Esposto';
                profilo.insights.push('‚ö†Ô∏è Alta tolleranza rischio ma protezioni insufficienti');
            } else if (rischioDichiarato <= 2 && numPolizze >= 6) {
                profilo.tendenzaRischio = 'Risk-Averse Protetto';
                profilo.insights.push('‚úÖ Bassa tolleranza rischio con protezioni adeguate');
            } else if (gapRischio > 40) {
                profilo.tendenzaRischio = 'Incoerente';
                profilo.insights.push('‚ö†Ô∏è Discrepanza tra propensione rischio dichiarata e protezioni');
            } else if (rischioDichiarato === 3) {
                profilo.tendenzaRischio = 'Calcolato-Equilibrato';
                profilo.insights.push('‚úÖ Approccio equilibrato al rischio');
            } else {
                profilo.tendenzaRischio = 'Moderato';
                profilo.insights.push('üìä Gestione rischio standard');
            }

            // ========================================
            // 4. BIAS COGNITIVI AZIENDALI
            // ========================================

            // BIAS 1: OVERCONFIDENCE (troppo sicuri)
            if (percezioneContinuita >= 4 && dipendenzaKeyPerson <= 2 && !polizze.key_man) {
                profilo.biasRilevati.push({
                    tipo: 'Overconfidence Bias',
                    descrizione: 'Percezione continuit√† aziendale sovrastimata rispetto a vulnerabilit√† reali',
                    gravita: 'alta',
                    impatto: 'Sottovalutazione rischi discontinuit√†',
                    raccomandazione: 'Rivedere analisi rischi con dati oggettivi e stress test'
                });
            }

            // BIAS 2: STATUS QUO BIAS (resistenza al cambiamento)
            const evoluzioneSituazione = answers.C2 || 3;
            const strategia = answers.C3 || 3;
            
            if (evoluzioneSituazione <= 2 && strategia <= 2 && numPolizze === 0 && companyAge > 5) {
                profilo.biasRilevati.push({
                    tipo: 'Status Quo Bias',
                    descrizione: 'Tendenza a mantenere situazione attuale anche se inadeguata',
                    gravita: 'media',
                    impatto: 'Inerzia decisionale pericolosa, mancata evoluzione',
                    raccomandazione: 'Forzare revisione periodica strategia e coperture'
                });
            }

            // BIAS 3: OPTIMISM BIAS (ottimismo irrealistico)
            if (crescita >= 4 && leva >= 4 && (answers.C1 || 3) >= 4) {
                profilo.biasRilevati.push({
                    tipo: 'Optimism Bias',
                    descrizione: '"Andr√† tutto bene": previsioni crescita ottimistiche nonostante debito elevato',
                    gravita: 'alta',
                    impatto: 'Sottovalutazione probabilit√† scenari negativi',
                    raccomandazione: 'Scenario planning pessimistico e stress test finanziari'
                });
            }

            // BIAS 4: AVAILABILITY HEURISTIC (ancoraggio a esperienza recente)
            if (sinistralita <= 2 && numPolizze <= 2 && rischiOperativi >= 3) {
                profilo.biasRilevati.push({
                    tipo: 'Availability Heuristic',
                    descrizione: 'Pochi sinistri recenti portano a sottovalutare rischi futuri',
                    gravita: 'media',
                    impatto: 'Esposizione a eventi rari ma catastrofici (tail risk)',
                    raccomandazione: 'Analisi probabilistica rischi basata su dati statistici settore'
                });
            }

            // BIAS 5: PLANNING FALLACY (sottostima complessit√†)
            if (investimenti >= 4 && pianoStrategico <= 2 && crescita >= 4) {
                profilo.biasRilevati.push({
                    tipo: 'Planning Fallacy',
                    descrizione: 'Investimenti e crescita pianificati senza piano dettagliato',
                    gravita: 'alta',
                    impatto: 'Sottostima tempi, costi e complessit√† esecuzione',
                    raccomandazione: 'Sviluppare business plan dettagliato con contingency'
                });
            }

            // BIAS 6: ILLUSION OF CONTROL
            const knowHow = answers.A3 || 3;
            const accesso = answers.A5 || 3;
            
            if (dipendenzaKeyPerson <= 2 && knowHow <= 2 && accesso <= 2) {
                profilo.biasRilevati.push({
                    tipo: 'Illusion of Control',
                    descrizione: 'Convinzione che tutto sia sotto controllo del titolare/fondatore',
                    gravita: 'critica',
                    impatto: 'Key person risk estremo, nessuna ridondanza',
                    raccomandazione: 'Documentare processi, creare backup per ruoli critici'
                });
            }

            // BIAS 7: CONFIRMATION BIAS
            const fornitoriCritici = answers.B5 || 3;
            const concentrazioneClienti = answers.B6 || 3;
            
            if (concentrazioneClienti <= 2 && diversificazione <= 2) {
                profilo.biasRilevati.push({
                    tipo: 'Confirmation Bias',
                    descrizione: 'Focus su relazioni consolidate ignora necessit√† diversificazione',
                    gravita: 'media',
                    impatto: 'Concentrazione rischio su pochi clienti/fornitori',
                    raccomandazione: 'KPI diversificazione e piano espansione portafoglio'
                });
            }

            // BIAS 8: SUNK COST FALLACY
            const patrimonio = companyData.patrimonioNetto || 0;
            const debiti = companyData.debitiTotali || 0;
            
            if (crescita <= 2 && debiti > patrimonio * 2 && (answers.C10 || 3) <= 2) {
                profilo.biasRilevati.push({
                    tipo: 'Sunk Cost Fallacy',
                    descrizione: 'Continuare attivit√† in perdita per investimenti passati',
                    gravita: 'alta',
                    impatto: 'Prolungare situazione insostenibile invece di pivot/exit',
                    raccomandazione: 'Valutazione oggettiva ROI futuro senza peso passato'
                });
            }

            // ========================================
            // 5. CLUSTER COMPORTAMENTALE FINALE
            // ========================================

            if (profilo.coerenzaRisposte >= 80 && scoreAnalitico >= 70 && profilo.biasRilevati.length === 0) {
                profilo.cluster = 'Analitico-Coerente Ottimale';
            } else if (profilo.coerenzaRisposte >= 70 && propensioneRischio <= 2) {
                profilo.cluster = 'Conservativo-Prudente';
            } else if (propensioneRischio >= 4 && scoreAnalitico < 50) {
                profilo.cluster = 'Risk-Taker Impulsivo';
            } else if (profilo.biasRilevati.length >= 4) {
                profilo.cluster = 'Multi-Bias Critico';
            } else if (companyAge <= 5 && propensioneRischio >= 4) {
                profilo.cluster = 'Entrepreneur Visionario';
            } else if (companyAge > 20 && pianoSuccessione <= 2) {
                profilo.cluster = 'Senior Resistente-Cambiamento';
            } else {
                profilo.cluster = 'Pragmatico-Equilibrato';
            }

            return profilo;
        }

        // ========================================
        // RENDERING PROFILO NEUROSCIENTIFICO
        // ========================================

        function renderProfiloNeuroscientificoAziendale(profilo) {
            let html = '<div class="card" style="background: linear-gradient(135deg, #EDE9FE 0%, #DDD6FE 100%); border-left: 4px solid #7C3AED; margin-top: 30px;">';
            html += '<h3 class="card-title" style="color: #5B21B6;">üß† Profilo Neuroscientifico Decisionale</h3>';
            html += '<p style="color: #6D28D9; margin-bottom: 20px;">Analisi avanzata pattern decisionali, bias cognitivi e coerenza strategica aziendale</p>';

            // Cluster principale
            html += '<div style="background: white; padding: 25px; border-radius: 8px; margin-bottom: 20px; text-align: center;">';
            html += '<div style="font-size: 14px; color: var(--gray-600); margin-bottom: 10px;">CLUSTER COMPORTAMENTALE AZIENDALE</div>';
            html += '<div style="font-size: 32px; font-weight: bold; color: #7C3AED; margin-bottom: 15px;">' + profilo.cluster + '</div>';
            
            // Metriche principali
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">';
            
            // Coerenza
            const coerenzaColor = profilo.coerenzaRisposte >= 80 ? '#10B981' : 
                                 profilo.coerenzaRisposte >= 60 ? '#F59E0B' : '#EF4444';
            html += '<div style="background: var(--gray-50); padding: 20px; border-radius: 8px;">';
            html += '<div style="font-size: 12px; color: var(--gray-600); margin-bottom: 8px;">Coerenza Strategica</div>';
            html += '<div style="font-size: 36px; font-weight: bold; color: ' + coerenzaColor + ';">' + profilo.coerenzaRisposte + '%</div>';
            html += '<div style="background: #E5E7EB; height: 8px; border-radius: 4px; margin-top: 12px; overflow: hidden;">';
            html += '<div style="background: ' + coerenzaColor + '; height: 100%; width: ' + profilo.coerenzaRisposte + '%;"></div>';
            html += '</div>';
            html += '</div>';

            // Profilo Decisionale
            html += '<div style="background: var(--gray-50); padding: 20px; border-radius: 8px;">';
            html += '<div style="font-size: 12px; color: var(--gray-600); margin-bottom: 8px;">Profilo Decisionale</div>';
            html += '<div style="font-size: 18px; font-weight: bold; color: #7C3AED; line-height: 1.3;">' + profilo.profiloDecisionale + '</div>';
            html += '</div>';

            // Tendenza Rischio
            html += '<div style="background: var(--gray-50); padding: 20px; border-radius: 8px;">';
            html += '<div style="font-size: 12px; color: var(--gray-600); margin-bottom: 8px;">Tendenza Rischio</div>';
            html += '<div style="font-size: 18px; font-weight: bold; color: #7C3AED; line-height: 1.3;">' + profilo.tendenzaRischio + '</div>';
            html += '</div>';

            html += '</div>';
            html += '</div>';

            // Insights
            if (profilo.insights && profilo.insights.length > 0) {
                html += '<div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">';
                html += '<h4 style="color: #7C3AED; margin-bottom: 15px;">üí° Insights Comportamentali</h4>';
                html += '<ul style="margin: 0; padding-left: 20px; color: var(--gray-700);">';
                profilo.insights.forEach(insight => {
                    html += '<li style="margin-bottom: 10px; line-height: 1.5;">' + insight + '</li>';
                });
                html += '</ul>';
                html += '</div>';
            }

            // Contraddizioni
            if (profilo.contraddizioni && profilo.contraddizioni.length > 0) {
                html += '<div style="background: #FEE2E2; padding: 20px; border-radius: 8px; border-left: 4px solid #EF4444; margin-bottom: 20px;">';
                html += '<h4 style="color: #991B1B; margin-bottom: 15px;">‚ö†Ô∏è Contraddizioni Strategiche Rilevate</h4>';
                html += '<ul style="margin: 0; padding-left: 20px; color: #7F1D1D;">';
                profilo.contraddizioni.forEach(contr => {
                    html += '<li style="margin-bottom: 10px;">' + contr + '</li>';
                });
                html += '</ul>';
                html += '</div>';
            }

            // Bias Cognitivi
            if (profilo.biasRilevati && profilo.biasRilevati.length > 0) {
                html += '<div style="background: white; padding: 20px; border-radius: 8px;">';
                html += '<h4 style="color: #7C3AED; margin-bottom: 15px;">üéØ Bias Cognitivi Decisionali Rilevati</h4>';
                html += '<p style="color: var(--gray-600); margin-bottom: 20px; font-size: 14px;">Distorsioni cognitive che possono influenzare negativamente le decisioni aziendali</p>';
                
                profilo.biasRilevati.forEach(bias => {
                    const gravitaColor = bias.gravita === 'critica' ? '#DC2626' :
                                        bias.gravita === 'alta' ? '#EF4444' : 
                                        bias.gravita === 'media' ? '#F59E0B' : '#3B82F6';
                    const bgColor = bias.gravita === 'critica' ? '#FEE2E2' :
                                   bias.gravita === 'alta' ? '#FED7AA' :
                                   bias.gravita === 'media' ? '#FEF3C7' : '#DBEAFE';
                    
                    html += '<div style="background: ' + bgColor + '; padding: 18px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid ' + gravitaColor + ';">';
                    html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">';
                    html += '<strong style="color: var(--generali-blue); font-size: 16px;">' + bias.tipo + '</strong>';
                    html += '<span style="background: ' + gravitaColor + '; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase;">Gravit√†: ' + bias.gravita + '</span>';
                    html += '</div>';
                    html += '<p style="margin: 0 0 8px 0; color: var(--gray-700); font-weight: 500;">' + bias.descrizione + '</p>';
                    html += '<p style="margin: 0 0 8px 0; color: var(--gray-600); font-size: 13px;"><strong>Impatto:</strong> ' + bias.impatto + '</p>';
                    html += '<div style="background: white; padding: 12px; border-radius: 6px; margin-top: 10px; border-left: 3px solid #10B981;">';
                    html += '<strong style="color: #065F46; font-size: 13px;">üí° Raccomandazione:</strong> ';
                    html += '<span style="color: #047857; font-size: 13px;">' + bias.raccomandazione + '</span>';
                    html += '</div>';
                    html += '</div>';
                });

                html += '</div>';
            } else {
                html += '<div style="background: #D1FAE5; padding: 20px; border-radius: 8px; border-left: 4px solid #10B981; margin-bottom: 20px;">';
                html += '<strong style="color: #065F46; font-size: 16px;">‚úÖ Eccellente!</strong>';
                html += '<p style="margin: 8px 0 0 0; color: #047857;">Nessun bias cognitivo critico rilevato. Decisioni aziendali appaiono razionali e ben ponderate.</p>';
                html += '</div>';
            }

            html += '</div>';

            return html;
        }

        // ========================================
        // INTEGRAZIONE CON GENERA RISULTATI
        // ========================================

        const originalGeneraRisultatiAziendali = window.generaRisultatiAziendali;

        window.generaRisultatiAziendali = async function() {
            const companyData = appStateAzienda.company.anagrafica;
            const answers = appStateAzienda.answers;

            // Calcoli completi
            const gaps = calcolaGapAziendali(companyData, answers);
            const normotipo = analizzaNormotipoAziendale(companyData, answers);
            const semaforo = calcolaSemaforoAziendale(companyData, answers, normotipo, gaps);
            const coherence = detectIncoherenzeAziendali(companyData, answers);
            const behavioralGap = calcolaBehavioralGapAziendale(companyData, answers);
            const scenari = simulaScenariStressAziendali(companyData, answers, gaps);
            const suggerimenti = generaSuggerimentiIntelligentiAziendali(companyData, answers, gaps, semaforo, scenari);
            const profiloNeuro = calcolaProfiloNeuroscientificoAziendale(companyData, answers);

            appStateAzienda.results = {
                gaps,
                normotipo,
                semaforo,
                coherence,
                behavioralGap,
                scenari,
                suggerimenti,
                profiloNeuroscientifico: profiloNeuro,
                timestamp: new Date().toISOString()
            };

            // Chiama rendering originale
            await originalGeneraRisultatiAziendali.call(this);

            // Aggiungi profilo neuroscientifico alla fine
            setTimeout(() => {
                const container = document.getElementById('risultatiContent');
                const neuroHTML = renderProfiloNeuroscientificoAziendale(profiloNeuro);
                container.insertAdjacentHTML('beforeend', neuroHTML);

                console.log('‚úÖ Profilo Neuroscientifico Aziendale completato');
                console.log('   Cluster:', profiloNeuro.cluster);
                console.log('   Coerenza:', profiloNeuro.coerenzaRisposte + '%');
                console.log('   Bias rilevati:', profiloNeuro.biasRilevati.length);

            }, 500);
        };

        // Override rendering risultati con versione completa finale
        window.generaRisultatiAziendali = async function() {
            const companyData = appStateAzienda.company.anagrafica;
            const answers = appStateAzienda.answers;

            showToast('üîÑ Analisi in corso...', 'info', 2000);

            setTimeout(() => {
                // Calcoli completi
                const gaps = calcolaGapAziendali(companyData, answers);
                const normotipo = analizzaNormotipoAziendale(companyData, answers);
                const semaforo = calcolaSemaforoAziendale(companyData, answers, normotipo, gaps);
                const coherence = detectIncoherenzeAziendali(companyData, answers);
                const behavioralGap = calcolaBehavioralGapAziendale(companyData, answers);
                const scenari = simulaScenariStressAziendali(companyData, answers, gaps);
                const suggerimenti = generaSuggerimentiIntelligentiAziendali(companyData, answers, gaps, semaforo, scenari);
                const profiloNeuro = calcolaProfiloNeuroscientificoAziendale(companyData, answers);

                appStateAzienda.results = {
                    gaps,
                    normotipo,
                    semaforo,
                    coherence,
                    behavioralGap,
                    scenari,
                    suggerimenti,
                    profiloNeuroscientifico: profiloNeuro,
                    timestamp: new Date().toISOString()
                };

                renderResultsAziendali();

                // Aggiungi profilo neuroscientifico
                setTimeout(() => {
                    const container = document.getElementById('risultatiContent');
                    const neuroHTML = renderProfiloNeuroscientificoAziendale(profiloNeuro);
                    container.insertAdjacentHTML('beforeend', neuroHTML);

                    showToast('‚úÖ Analisi completata con successo!', 'success');
                    console.log('‚úÖ ANALISI COMPLETA AZIENDE');
                    console.log('   Normotipo:', normotipo.profilo);
                    console.log('   Cluster Neuro:', profiloNeuro.cluster);
                    console.log('   Coerenza:', coherence.coherenceScore + '%');
                    console.log('   Scenari simulati:', scenari.length);
                    console.log('   Suggerimenti:', suggerimenti.length);
                    console.log('   Bias rilevati:', profiloNeuro.biasRilevati.length);
                }, 500);

            }, 1500);
        };

        console.log('‚úÖ Neuro-Validation Aziendale: OPERATIVO');
        console.log('  ‚úì Calcolo coerenza strategica aziendale');
        console.log('  ‚úì Profilo decisionale imprenditoriale');
        console.log('  ‚úì Rilevamento 8 bias cognitivi aziendali');
        console.log('  ‚úì Insights comportamentali personalizzati');

    </script>
<script>
        // ========================================
        // MODULI SALVATAGGIO E CARICAMENTO AVANZATI
        // ========================================

        function salvaAnalisiAziendale() {
            const nomeAnalisi = document.getElementById('nomeAnalisi').value.trim();
            if (!nomeAnalisi) {
                showToast('‚ö†Ô∏è Inserisci un nome per l\'analisi', 'error');
                document.getElementById('nomeAnalisi').focus();
                return;
            }

            try {
                const analisi = {
                    nome: nomeAnalisi,
                    timestamp: new Date().toISOString(),
                    versione: '1.0',
                    data: {
                        company: appStateAzienda.company,
                        answers: appStateAzienda.answers,
                        results: appStateAzienda.results
                    },
                    metadata: {
                        ragioneSociale: appStateAzienda.company.anagrafica.ragioneSociale,
                        partitaIVA: appStateAzienda.company.anagrafica.partitaIVA,
                        fatturato: appStateAzienda.company.anagrafica.fatturatoAnnuo,
                        dipendenti: appStateAzienda.company.anagrafica.numeroDipendenti,
                        settore: appStateAzienda.company.anagrafica.settoreATECO,
                        consulente: appStateAzienda.company.anagrafica.consulente
                    }
                };

                const analisiSalvate = JSON.parse(localStorage.getItem('analisiAziendali') || '[]');
                
                // Verifica duplicati nome
                const esistente = analisiSalvate.findIndex(a => a.nome === nomeAnalisi);
                if (esistente !== -1) {
                    if (!confirm(`Esiste gi√† un'analisi con nome "${nomeAnalisi}". Sovrascrivere?`)) {
                        return;
                    }
                    analisiSalvate[esistente] = analisi;
                } else {
                    analisiSalvate.push(analisi);
                }

                localStorage.setItem('analisiAziendali', JSON.stringify(analisiSalvate));

                aggiornaListaAnalisi();
                showToast('‚úÖ Analisi salvata con successo!', 'success');
                
                console.log('üíæ Analisi salvata:', nomeAnalisi);

            } catch (error) {
                console.error('Errore salvataggio:', error);
                showToast('‚ùå Errore durante il salvataggio', 'error');
            }
        }

        function caricaAnalisiAziendale() {
            const select = document.getElementById('analisiSalvateSelect');
            const index = select.value;

            if (!index) {
                showToast('‚ö†Ô∏è Seleziona un\'analisi da caricare', 'error');
                return;
            }

            try {
                const analisiSalvate = JSON.parse(localStorage.getItem('analisiAziendali') || '[]');
                const analisi = analisiSalvate[index];

                if (!analisi) {
                    showToast('‚ùå Analisi non trovata', 'error');
                    return;
                }

                // Ripristina stato
                appStateAzienda.company = analisi.data.company;
                appStateAzienda.answers = analisi.data.answers;
                appStateAzienda.results = analisi.data.results;
                appStateAzienda.currentQuestion = 0;

                // Ripopola form
                ripopolaFormAziendale();

                // Se ci sono risultati, mostrarli
                if (analisi.data.results) {
                    document.getElementById('anagraficaSection').style.display = 'none';
                    document.getElementById('questionario').style.display = 'none';
                    document.getElementById('risultati').style.display = 'block';
                    
                    renderResultsAziendali();
                    
                    setTimeout(() => {
                        const container = document.getElementById('risultatiContent');
                        const neuroHTML = renderProfiloNeuroscientificoAziendale(appStateAzienda.results.profiloNeuroscientifico);
                        container.insertAdjacentHTML('beforeend', neuroHTML);
                    }, 500);
                }

                showToast('‚úÖ Analisi caricata!', 'success');
                console.log('üìÇ Analisi caricata:', analisi.nome);

            } catch (error) {
                console.error('Errore caricamento:', error);
                showToast('‚ùå Errore durante il caricamento', 'error');
            }
        }

        function aggiornaListaAnalisi() {
            const select = document.getElementById('analisiSalvateSelect');
            
            try {
                const analisiSalvate = JSON.parse(localStorage.getItem('analisiAziendali') || '[]');

                select.innerHTML = '<option value="">Seleziona analisi salvata</option>';
                
                // Ordina per timestamp decrescente (pi√π recenti prime)
                analisiSalvate.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                analisiSalvate.forEach((analisi, index) => {
                    const date = new Date(analisi.timestamp).toLocaleString('it-IT', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const ragioneSociale = analisi.metadata?.ragioneSociale || 'N/A';
                    
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${analisi.nome} - ${ragioneSociale} (${date})`;
                    select.appendChild(option);
                });

                console.log(`üìã Lista aggiornata: ${analisiSalvate.length} analisi trovate`);

            } catch (error) {
                console.error('Errore aggiornamento lista:', error);
            }
        }

        function eliminaAnalisiAziendale() {
            const select = document.getElementById('analisiSalvateSelect');
            const index = parseInt(select.value);

            if (isNaN(index)) {
                showToast('‚ö†Ô∏è Seleziona un\'analisi da eliminare', 'error');
                return;
            }

            try {
                const analisiSalvate = JSON.parse(localStorage.getItem('analisiAziendali') || '[]');
                const analisi = analisiSalvate[index];

                if (!confirm(`Eliminare l'analisi "${analisi.nome}"?`)) {
                    return;
                }

                analisiSalvate.splice(index, 1);
                localStorage.setItem('analisiAziendali', JSON.stringify(analisiSalvate));

                aggiornaListaAnalisi();
                showToast('‚úÖ Analisi eliminata', 'success');
                console.log('üóëÔ∏è Analisi eliminata');

            } catch (error) {
                console.error('Errore eliminazione:', error);
                showToast('‚ùå Errore durante l\'eliminazione', 'error');
            }
        }

        function ripopolaFormAziendale() {
            const ana = appStateAzienda.company.anagrafica;
            
            document.getElementById('ragioneSociale').value = ana.ragioneSociale || '';
            document.getElementById('partitaIVA').value = ana.partitaIVA || '';
            document.getElementById('codiceFiscaleAzienda').value = ana.codiceFiscale || '';
            document.getElementById('formaGiuridica').value = ana.formaGiuridica || '';
            document.getElementById('annoCostituzione').value = ana.annoCostituzione || '';
            document.getElementById('settoreATECO').value = ana.settoreATECO || '';
            document.getElementById('numeroDipendenti').value = ana.numeroDipendenti || '';
            document.getElementById('fatturatoAnnuo').value = ana.fatturatoAnnuo || '';
            document.getElementById('patrimonioNetto').value = ana.patrimonioNetto || '';
            document.getElementById('provinciaSedeOperativa').value = ana.provinciaSedeOperativa || '';
            document.getElementById('numeroSediOperative').value = ana.numeroSediOperative || 1;
            document.getElementById('emailAzienda').value = ana.emailAzienda || '';
            document.getElementById('telefonoAzienda').value = ana.telefonoAzienda || '';
            document.getElementById('sitoWeb').value = ana.sitoWeb || '';
            document.getElementById('percentualeExport').value = ana.percentualeExport || '';
            document.getElementById('numeroKeyPersons').value = ana.numeroKeyPersons || '';
            document.getElementById('etaMediaManagement').value = ana.etaMediaManagement || '';
            document.getElementById('debitiTotali').value = ana.debitiTotali || '';
            document.getElementById('creditiCommerciali').value = ana.creditiCommerciali || '';
            document.getElementById('immobiliProprieta').value = ana.immobiliProprieta || '';
            document.getElementById('valoreImmobili').value = ana.valoreImmobili || '';
            document.getElementById('concentrazioneClienti').value = ana.concentrazioneClienti || '';
            document.getElementById('sinistralitaStorica').value = ana.sinistralitaStorica || '';
            
            const consulenteSelect = document.getElementById('consulenteSelect');
            if (consulenteSelect) {
                consulenteSelect.value = ana.consulente || '';
            }

            // Rigenera key persons fields
            generaKeyPersonsFields();
            
            // Ripopola key persons
            if (appStateAzienda.company.keyPersons) {
                appStateAzienda.company.keyPersons.forEach((kp, i) => {
                    const ruoloEl = document.getElementById(`kp_${i+1}_ruolo`);
                    const etaEl = document.getElementById(`kp_${i+1}_eta`);
                    if (ruoloEl) ruoloEl.value = kp.ruolo || '';
                    if (etaEl) etaEl.value = kp.eta || '';
                });
            }

            // Ripopola polizze
            const polizze = appStateAzienda.company.polizze || {};
            Object.keys(polizze).forEach(tipo => {
                const checkbox = document.getElementById(`pol_${tipo}`);
                if (checkbox) {
                    checkbox.checked = true;
                    togglePolizzaFields(tipo);
                    
                    const pol = polizze[tipo];
                    const compagniaSelect = document.getElementById(`pol_${tipo}_compagnia`);
                    if (compagniaSelect) compagniaSelect.value = pol.compagnia || '';
                    
                    const massimaleEl = document.getElementById(`pol_${tipo}_massimale`);
                    if (massimaleEl) massimaleEl.value = pol.massimale || '';
                    
                    const premioEl = document.getElementById(`pol_${tipo}_premio`);
                    if (premioEl) premioEl.value = pol.premio || '';
                    
                    const capitaleEl = document.getElementById(`pol_${tipo}_capitale`);
                    if (capitaleEl) capitaleEl.value = pol.capitale || '';
                    
                    const valoreEl = document.getElementById(`pol_${tipo}_valore`);
                    if (valoreEl) valoreEl.value = pol.valore || '';
                    
                    const indennizzoEl = document.getElementById(`pol_${tipo}_indennizzo`);
                    if (indennizzoEl) indennizzoEl.value = pol.indennizzo || '';
                    
                    const periodoEl = document.getElementById(`pol_${tipo}_periodo`);
                    if (periodoEl) periodoEl.value = pol.periodo || '';
                    
                    const numeroEl = document.getElementById(`pol_${tipo}_numero`);
                    if (numeroEl) numeroEl.value = pol.numero || '';
                    
                    const personeEl = document.getElementById(`pol_${tipo}_persone`);
                    if (personeEl) personeEl.value = pol.persone || '';
                }
            });

            showToast('üìÇ Dati ripristinati', 'info');
        }

        // ========================================
        // EXPORT PDF / STAMPA
        // ========================================

        function esportaPDFAziendale() {
            showToast('üñ®Ô∏è Preparazione stampa...', 'info', 2000);
            
            setTimeout(() => {
                // Nascondi pulsanti prima di stampare
                const buttons = document.querySelectorAll('.btn');
                buttons.forEach(btn => btn.style.display = 'none');
                
                window.print();
                
                // Ripristina pulsanti dopo stampa
                setTimeout(() => {
                    buttons.forEach(btn => btn.style.display = '');
                }, 1000);
            }, 500);
        }

        // ========================================
        // ESPORTA JSON
        // ========================================

        function esportaJSONAziendale() {
            if (!appStateAzienda.results) {
                showToast('‚ö†Ô∏è Completa prima l\'analisi', 'error');
                return;
            }

            try {
                const dataStr = JSON.stringify(appStateAzienda, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                
                const ragioneSociale = appStateAzienda.company.anagrafica.ragioneSociale || 'Azienda';
                const timestamp = new Date().toISOString().split('T')[0];
                link.download = `Partner_di_Vita_${ragioneSociale.replace(/\s+/g, '_')}_${timestamp}.json`;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showToast('‚úÖ File JSON scaricato', 'success');
                console.log('üì• Export JSON completato');

            } catch (error) {
                console.error('Errore export JSON:', error);
                showToast('‚ùå Errore export JSON', 'error');
            }
        }

        // ========================================
        // RESET COMPLETO
        // ========================================

        function resetCompleto() {
            if (!confirm('‚ö†Ô∏è Vuoi resettare completamente l\'analisi? Tutti i dati non salvati andranno persi.')) {
                return;
            }

            // Reset state
            appStateAzienda.company = { anagrafica: {}, polizze: {}, keyPersons: [] };
            appStateAzienda.currentQuestion = 0;
            appStateAzienda.answers = {};
            appStateAzienda.results = null;

            // Pulisci form
            document.querySelectorAll('input, select, textarea').forEach(el => {
                if (el.type === 'checkbox') {
                    el.checked = false;
                } else if (el.type !== 'button' && el.type !== 'submit') {
                    el.value = '';
                }
            });

            // Nascondi sezioni
            document.getElementById('anagraficaSection').style.display = 'block';
            document.getElementById('questionario').style.display = 'none';
            document.getElementById('risultati').style.display = 'none';

            // Scroll top
            window.scrollTo({ top: 0, behavior: 'smooth' });

            showToast('‚úÖ Reset completato', 'success');
            console.log('üîÑ Reset completo eseguito');
        }

        // ========================================
        // ELIMINA TUTTE LE ANALISI
        // ========================================

        function eliminaTutteAnalisi() {
            if (!confirm('‚ö†Ô∏è ATTENZIONE: Eliminare TUTTE le analisi salvate? Questa azione √® irreversibile!')) {
                return;
            }

            if (!confirm('Sei davvero sicuro? Tutte le analisi salvate verranno eliminate definitivamente.')) {
                return;
            }

            try {
                localStorage.removeItem('analisiAziendali');
                aggiornaListaAnalisi();
                showToast('‚úÖ Tutte le analisi eliminate', 'success');
                console.log('üóëÔ∏è Tutte le analisi eliminate');

            } catch (error) {
                console.error('Errore eliminazione:', error);
                showToast('‚ùå Errore durante l\'eliminazione', 'error');
            }
        }

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================

        function formatCurrency(value) {
            return new Intl.NumberFormat('it-IT', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        function formatPercentage(value) {
            return `${value.toFixed(1)}%`;
        }

        function formatDate(isoString) {
            return new Date(isoString).toLocaleString('it-IT', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getCompanySize(dipendenti, fatturato) {
            if (dipendenti <= 9 && fatturato <= 2000000) return 'Microimpresa';
            if (dipendenti <= 49 && fatturato <= 10000000) return 'Piccola Impresa';
            if (dipendenti <= 249 && fatturato <= 50000000) return 'Media Impresa';
            return 'Grande Impresa';
        }

        function getSectorRiskLevel(settoreATECO) {
            const highRisk = ['F41', 'F42', 'F43', 'C', 'H49'];
            const mediumRisk = ['G', 'M', 'Q'];
            const lowRisk = ['J62', 'K', 'L'];

            if (highRisk.some(s => settoreATECO.startsWith(s))) return 'Alto';
            if (mediumRisk.some(s => settoreATECO.startsWith(s))) return 'Medio';
            if (lowRisk.some(s => settoreATECO.startsWith(s))) return 'Basso';
            return 'Medio';
        }

        // ========================================
        // STATISTICHE ANALISI
        // ========================================

        function mostraStatisticheAnalisi() {
            if (!appStateAzienda.results) {
                showToast('‚ö†Ô∏è Completa prima l\'analisi', 'error');
                return;
            }

            const stats = {
                gaps: appStateAzienda.results.gaps,
                scenari: appStateAzienda.results.scenari,
                suggerimenti: appStateAzienda.results.suggerimenti,
                biasRilevati: appStateAzienda.results.profiloNeuroscientifico.biasRilevati.length,
                coherence: appStateAzienda.results.coherence.coherenceScore
            };

            let html = '<div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">';
            html += '<div style="background: white; padding: 40px; border-radius: 12px; max-width: 600px; width: 90%;" onclick="event.stopPropagation()">';
            html += '<h2 style="color: var(--generali-blue); margin-bottom: 25px;">üìä Statistiche Analisi</h2>';
            
            html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">';
            
            html += '<div style="background: var(--gray-50); padding: 20px; border-radius: 8px; text-align: center;">';
            html += '<div style="font-size: 36px; font-weight: bold; color: var(--generali-blue);">5</div>';
            html += '<div style="color: var(--gray-600); margin-top: 8px;">GAP Analizzati</div>';
            html += '</div>';
            
            html += '<div style="background: var(--gray-50); padding: 20px; border-radius: 8px; text-align: center;">';
            html += '<div style="font-size: 36px; font-weight: bold; color: var(--generali-blue);">' + stats.scenari.length + '</div>';
            html += '<div style="color: var(--gray-600); margin-top: 8px;">Scenari Stress</div>';
            html += '</div>';
            
            html += '<div style="background: var(--gray-50); padding: 20px; border-radius: 8px; text-align: center;">';
            html += '<div style="font-size: 36px; font-weight: bold; color: var(--generali-blue);">' + stats.suggerimenti.length + '</div>';
            html += '<div style="color: var(--gray-600); margin-top: 8px;">Suggerimenti</div>';
            html += '</div>';
            
            html += '<div style="background: var(--gray-50); padding: 20px; border-radius: 8px; text-align: center;">';
            html += '<div style="font-size: 36px; font-weight: bold; color: var(--generali-blue);">' + stats.biasRilevati + '</div>';
            html += '<div style="color: var(--gray-600); margin-top: 8px;">Bias Rilevati</div>';
            html += '</div>';
            
            html += '</div>';
            
            html += '<div style="margin-top: 25px; text-align: center;">';
            html += '<button onclick="this.closest(\'div[style*=fixed]\').remove()" style="padding: 12px 30px; background: var(--generali-red); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Chiudi</button>';
            html += '</div>';
            
            html += '</div>';
            html += '</div>';

            document.body.insertAdjacentHTML('beforeend', html);
        }

        // ========================================
        // CONFRONTO ANALISI
        // ========================================

        function confrontaAnalisi() {
            showToast('‚ÑπÔ∏è Funzione confronto disponibile prossimamente', 'info');
        }

        // ========================================
        // ANIMAZIONI
        // ========================================

        // Aggiungi animazioni CSS dinamiche
        const styleSheet = document.createElement('style');
        styleSheet.textContent = `
            @keyframes slideDown {
                from {
                    opacity: 0;
                    transform: translateY(-20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }

            @keyframes pulse {
                0%, 100% {
                    transform: scale(1);
                }
                50% {
                    transform: scale(1.05);
                }
            }

            .option:hover {
                transform: translateX(5px);
                border-color: var(--generali-blue) !important;
                background: #F0F9FF !important;
            }

            .option.selected {
                background: linear-gradient(135deg, #DBEAFE 0%, #BFDBFE 100%) !important;
                border-color: var(--generali-blue) !important;
                font-weight: 600;
            }

            .card {
                animation: fadeIn 0.5s ease;
            }

            .badge {
                animation: pulse 2s infinite;
            }
        `;
        document.head.appendChild(styleSheet);

        // ========================================
        // KEYBOARD SHORTCUTS
        // ========================================

        document.addEventListener('keydown', function(e) {
            // CTRL+S per salvare
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                if (appStateAzienda.results) {
                    salvaAnalisiAziendale();
                }
            }

            // CTRL+P per stampare
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                if (appStateAzienda.results) {
                    esportaPDFAziendale();
                }
            }

            // ESC per chiudere modal
            if (e.key === 'Escape') {
                const modal = document.querySelector('div[style*="position: fixed"]');
                if (modal) modal.remove();
            }
        });

        // ========================================
        // AUTO-SAVE
        // ========================================

        let autoSaveInterval = null;

        function startAutoSave() {
            // Auto-save ogni 5 minuti
            autoSaveInterval = setInterval(() => {
                if (appStateAzienda.company.anagrafica.ragioneSociale) {
                    const autoSaveName = `AutoSave_${appStateAzienda.company.anagrafica.ragioneSociale}_${new Date().toISOString()}`;
                    localStorage.setItem('autoSaveAziendale', JSON.stringify({
                        nome: autoSaveName,
                        timestamp: new Date().toISOString(),
                        data: appStateAzienda
                    }));
                    console.log('üíæ Auto-save eseguito');
                }
            }, 300000); // 5 minuti
        }

        function recuperaAutoSave() {
            try {
                const autoSave = JSON.parse(localStorage.getItem('autoSaveAziendale'));
                if (autoSave) {
                    const minutes = Math.round((Date.now() - new Date(autoSave.timestamp)) / 60000);
                    if (confirm(`Trovato auto-save di ${minutes} minuti fa. Ripristinare?`)) {
                        Object.assign(appStateAzienda, autoSave.data);
                        ripopolaFormAziendale();
                        showToast('‚úÖ Auto-save ripristinato', 'success');
                    }
                }
            } catch (error) {
                console.error('Errore recupero auto-save:', error);
            }
        }

        // ========================================
        // INIT ON LOAD
        // ========================================

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Partner di Vita Aziende - Inizializzazione...');
            
            aggiornaListaAnalisi();
            recuperaAutoSave();
            startAutoSave();
            
            // Aggiungi pulsante elimina nel card salvataggio
            const saveCard = document.querySelector('.card h2:contains("Gestione")');
            if (saveCard && saveCard.closest('.card')) {
                const card = saveCard.closest('.card');
                const btnContainer = document.createElement('div');
                btnContainer.style.cssText = 'margin-top: 20px; display: flex; gap: 15px;';
                btnContainer.innerHTML = `
                    <button class="btn btn-secondary" onclick="eliminaAnalisiAziendale()" style="flex: 1;">
                        üóëÔ∏è Elimina Selezionata
                    </button>
                    <button class="btn btn-secondary" onclick="eliminaTutteAnalisi()" style="flex: 1;">
                        üóëÔ∏è Elimina Tutte
                    </button>
                    <button class="btn btn-secondary" onclick="esportaJSONAziendale()" style="flex: 1;">
                        üì• Export JSON
                    </button>
                `;
                card.querySelector('.form-row:last-of-type').after(btnContainer);
            }

            console.log('‚úÖ Inizializzazione completata');
        });

        // ========================================
        // VERSIONING
        // ========================================

        const APP_VERSION = '1.0.0';
        const APP_BUILD = '20250117';

        console.log(`%cüè¢ Partner di Vita Aziende v${APP_VERSION} (Build ${APP_BUILD})`, 'color: #003366; font-size: 16px; font-weight: bold');
        console.log('%cGenerali - Business Edition', 'color: #E31E24; font-weight: bold');
        console.log('%cSistema completo di analisi rischi e bisogni assicurativi aziendali', 'color: #666');

        // Esponi funzioni globali per debug
        window.debugAziende = {
            version: APP_VERSION,
            build: APP_BUILD,
            state: appStateAzienda,
            mostraStatistiche: mostraStatisticheAnalisi,
            resetCompleto: resetCompleto,
            eliminaTutte: eliminaTutteAnalisi
        };

        console.log('%cDebug console disponibile: window.debugAziende', 'color: #10B981; font-style: italic');

    </script>
<script>
        // ========================================
        // FIX E OTTIMIZZAZIONI FINALI
        // ========================================

        console.log('%cüîß MODULO FIX & OTTIMIZZAZIONI - ATTIVO', 'color: #F59E0B; font-weight: bold');

        // ========================================
        // GESTIONE ERRORI AVANZATA
        // ========================================

        window.addEventListener('error', function(event) {
            console.error('‚ùå Errore JavaScript:', event.error);
            showToast('‚ö†Ô∏è Si √® verificato un errore. Riprova.', 'error', 5000);
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('‚ùå Promise rejection:', event.reason);
            showToast('‚ö†Ô∏è Errore nell\'elaborazione. Riprova.', 'error', 5000);
        });

        // ========================================
        // OTTIMIZZAZIONE RENDERING OPTIONS
        // ========================================

        function renderQuestionAzienda() {
            const question = questionsAziendali[appStateAzienda.currentQuestion];
            if (!question) {
                console.error('Domanda non trovata:', appStateAzienda.currentQuestion);
                return;
            }

            const container = document.getElementById('questionContainer');
            if (!container) {
                console.error('Container questionario non trovato');
                return;
            }

            // Use DocumentFragment for better performance
            const fragment = document.createDocumentFragment();
            
            const questionCard = document.createElement('div');
            questionCard.className = 'question-card';
            questionCard.style.cssText = 'background: white; border-radius: 12px; padding: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-left: 4px solid var(--generali-blue);';

            // Header
            const header = document.createElement('div');
            header.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;';
            header.innerHTML = `
                <h3 style="color: var(--generali-blue); margin: 0;">Domanda ${appStateAzienda.currentQuestion + 1} di ${questionsAziendali.length}</h3>
                <span class="badge badge-info">Sezione ${question.section}</span>
            `;
            questionCard.appendChild(header);

            // Question text
            const questionText = document.createElement('p');
            questionText.style.cssText = 'font-size: 18px; margin: 20px 0; color: var(--gray-700); font-weight: 500; line-height: 1.6;';
            questionText.textContent = question.text;
            questionCard.appendChild(questionText);

            // Options container
            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'options';
            optionsContainer.style.cssText = 'display: flex; flex-direction: column; gap: 12px;';

            question.options.forEach(opt => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option';
                if (appStateAzienda.answers[question.id] === opt.value) {
                    optionDiv.classList.add('selected');
                }
                optionDiv.style.cssText = 'padding: 16px 20px; border: 2px solid var(--gray-200); border-radius: 8px; cursor: pointer; transition: all 0.2s; background: white;';
                optionDiv.textContent = opt.label;
                optionDiv.onclick = () => selectOptionAzienda(question.id, opt.value);
                optionsContainer.appendChild(optionDiv);
            });

            questionCard.appendChild(optionsContainer);
            fragment.appendChild(questionCard);

            // Clear and append
            container.innerHTML = '';
            container.appendChild(fragment);

            updateProgressAzienda();
            updateButtonsAzienda();
        }

        // ========================================
        // DEBOUNCE FUNCTION PER INPUT
        // ========================================

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ========================================
        // VALIDAZIONI AVANZATE REAL-TIME
        // ========================================

        // Validazione email
        function validaEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        // Validazione telefono italiano
        function validaTelefono(telefono) {
            const re = /^[\+]?[(]?[0-9]{2,3}[)]?[-\s\.]?[0-9]{2,4}[-\s\.]?[0-9]{4,6}$/;
            return re.test(telefono.replace(/\s/g, ''));
        }

        // Validazione URL
        function validaURL(url) {
            try {
                new URL(url);
                return true;
            } catch {
                return false;
            }
        }

        // Aggiungi validazioni email
        const emailInput = document.getElementById('emailAzienda');
        if (emailInput) {
            emailInput.addEventListener('blur', debounce(function() {
                if (this.value && !validaEmail(this.value)) {
                    this.style.borderColor = 'var(--red)';
                    showToast('‚ö†Ô∏è Email non valida', 'error', 2000);
                } else {
                    this.style.borderColor = '';
                }
            }, 300));
        }

        // Validazione telefono
        const telefonoInput = document.getElementById('telefonoAzienda');
        if (telefonoInput) {
            telefonoInput.addEventListener('blur', debounce(function() {
                if (this.value && !validaTelefono(this.value)) {
                    this.style.borderColor = 'var(--red)';
                    showToast('‚ö†Ô∏è Telefono non valido', 'error', 2000);
                } else {
                    this.style.borderColor = '';
                }
            }, 300));
        }

        // Validazione sito web
        const sitoWebInput = document.getElementById('sitoWeb');
        if (sitoWebInput) {
            sitoWebInput.addEventListener('blur', debounce(function() {
                if (this.value && !validaURL(this.value)) {
                    this.style.borderColor = 'var(--red)';
                    showToast('‚ö†Ô∏è URL non valido', 'error', 2000);
                } else {
                    this.style.borderColor = '';
                }
            }, 300));
        }

        // ========================================
        // PREVENZIONE PERDITA DATI
        // ========================================

        let formModificato = false;

        // Traccia modifiche form
        document.querySelectorAll('input, select, textarea').forEach(el => {
            el.addEventListener('change', () => {
                formModificato = true;
            });
        });

        // Conferma uscita se ci sono modifiche non salvate
        window.addEventListener('beforeunload', (e) => {
            if (formModificato && !appStateAzienda.results) {
                e.preventDefault();
                e.returnValue = 'Hai modifiche non salvate. Vuoi davvero uscire?';
                return e.returnValue;
            }
        });

        // ========================================
        // OTTIMIZZAZIONE MOBILE
        // ========================================

        function ottimizzaMobile() {
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                // Riduci padding su mobile
                document.querySelectorAll('.card').forEach(card => {
                    card.style.padding = '20px';
                });

                // Font size ridotto su mobile
                document.querySelectorAll('.card-title').forEach(title => {
                    title.style.fontSize = '20px';
                });

                // Options pi√π grandi per touch
                document.querySelectorAll('.option').forEach(opt => {
                    opt.style.padding = '18px';
                    opt.style.fontSize = '16px';
                });
            }
        }

        window.addEventListener('resize', debounce(ottimizzaMobile, 250));
        ottimizzaMobile();

        // ========================================
        // ACCESSIBILIT√Ä (A11Y)
        // ========================================

        // Aggiungi attributi ARIA
        function miglioraAccessibilita() {
            // Progress bar
            const progressBar = document.getElementById('progressBar');
            if (progressBar) {
                progressBar.setAttribute('role', 'progressbar');
                progressBar.setAttribute('aria-valuemin', '0');
                progressBar.setAttribute('aria-valuemax', '100');
            }

            // Options
            document.querySelectorAll('.option').forEach((opt, index) => {
                opt.setAttribute('role', 'button');
                opt.setAttribute('tabindex', '0');
                opt.setAttribute('aria-label', `Opzione ${index + 1}`);
                
                // Supporto tastiera
                opt.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        opt.click();
                    }
                });
            });

            // Form labels
            document.querySelectorAll('input, select, textarea').forEach(input => {
                if (input.id) {
                    const label = document.querySelector(`label[for="${input.id}"]`);
                    if (label) {
                        input.setAttribute('aria-labelledby', label.id || `label-${input.id}`);
                    }
                }
            });
        }

        // ========================================
        // FOCUS MANAGEMENT
        // ========================================

        function gestisciFocus() {
            // Focus primo elemento invalido su validazione
            const primoInvalido = document.querySelector('input:invalid, select:invalid');
            if (primoInvalido) {
                primoInvalido.focus();
                primoInvalido.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // ========================================
        // COMPATIBILIT√Ä BROWSER
        // ========================================

        function verificaCompatibilita() {
            // Check localStorage
            if (typeof(Storage) === "undefined") {
                alert('‚ö†Ô∏è Il tuo browser non supporta localStorage. Alcune funzionalit√† potrebbero non funzionare.');
                console.warn('localStorage non supportato');
            }

            // Check ES6 features
            try {
                eval('const test = () => {};');
            } catch (e) {
                alert('‚ö†Ô∏è Il tuo browser √® obsoleto. Aggiorna per utilizzare l\'applicazione.');
                console.error('ES6 non supportato');
            }

            // Check JSON
            if (typeof JSON === 'undefined') {
                alert('‚ö†Ô∏è JSON non supportato. Aggiorna il browser.');
                console.error('JSON non supportato');
            }
        }

        verificaCompatibilita();

        // ========================================
        // PERFORMANCE MONITORING
        // ========================================

        const performanceMetrics = {
            startTime: Date.now(),
            renderTimes: [],
            calculationTimes: []
        };

        function trackPerformance(metricName, duration) {
            console.log(`‚è±Ô∏è ${metricName}: ${duration}ms`);
            
            if (metricName.includes('render')) {
                performanceMetrics.renderTimes.push(duration);
            } else if (metricName.includes('calcol')) {
                performanceMetrics.calculationTimes.push(duration);
            }
        }

        function mostraPerformanceReport() {
            const avgRender = performanceMetrics.renderTimes.length > 0 ?
                performanceMetrics.renderTimes.reduce((a, b) => a + b, 0) / performanceMetrics.renderTimes.length : 0;
            
            const avgCalc = performanceMetrics.calculationTimes.length > 0 ?
                performanceMetrics.calculationTimes.reduce((a, b) => a + b, 0) / performanceMetrics.calculationTimes.length : 0;

            console.log('%cüìä PERFORMANCE REPORT', 'color: #10B981; font-weight: bold; font-size: 14px');
            console.log(`‚è±Ô∏è Tempo medio rendering: ${avgRender.toFixed(2)}ms`);
            console.log(`üßÆ Tempo medio calcoli: ${avgCalc.toFixed(2)}ms`);
            console.log(`üïê Uptime: ${Math.round((Date.now() - performanceMetrics.startTime) / 1000)}s`);
        }

        // ========================================
        // OTTIMIZZAZIONE CALCOLI
        // ========================================

        // Memoization per calcoli pesanti
        const memoCache = new Map();

        function memoize(fn) {
            return function(...args) {
                const key = JSON.stringify(args);
                if (memoCache.has(key)) {
                    return memoCache.get(key);
                }
                const result = fn.apply(this, args);
                memoCache.set(key);
                return result;
            };
        }

        // ========================================
        // LAZY LOADING RISULTATI
        // ========================================

        function renderResultsLazy() {
            const container = document.getElementById('risultatiContent');
            
            // Render iniziale veloce
            const startTime = performance.now();
            renderResultsAziendali();
            const renderTime = performance.now() - startTime;
            trackPerformance('render-results-initial', renderTime);

            // Render componenti pesanti in modo lazy
            setTimeout(() => {
                const calcStart = performance.now();
                
                // Aggiungi profilo neuroscientifico
                if (appStateAzienda.results && appStateAzienda.results.profiloNeuroscientifico) {
                    const neuroHTML = renderProfiloNeuroscientificoAziendale(appStateAzienda.results.profiloNeuroscientifico);
                    container.insertAdjacentHTML('beforeend', neuroHTML);
                }

                const calcTime = performance.now() - calcStart;
                trackPerformance('calcolo-profilo-neuro', calcTime);

                miglioraAccessibilita();
            }, 100);
        }

        // ========================================
        // TOOLTIP HELPER
        // ========================================

        function aggiungiTooltip(elemento, testo) {
            elemento.setAttribute('data-tooltip', testo);
            elemento.style.position = 'relative';
            elemento.style.cursor = 'help';

            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            tooltip.textContent = testo;
            tooltip.style.cssText = `
                position: absolute;
                bottom: 100%;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0,0,0,0.9);
                color: white;
                padding: 8px 12px;
                border-radius: 6px;
                font-size: 13px;
                white-space: nowrap;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.2s;
                margin-bottom: 5px;
                z-index: 1000;
            `;

            elemento.addEventListener('mouseenter', () => {
                elemento.appendChild(tooltip);
                setTimeout(() => tooltip.style.opacity = '1', 10);
            });

            elemento.addEventListener('mouseleave', () => {
                tooltip.style.opacity = '0';
                setTimeout(() => {
                    if (tooltip.parentNode) {
                        tooltip.parentNode.removeChild(tooltip);
                    }
                }, 200);
            });
        }

        // Aggiungi tooltip a campi complessi
        const tooltips = {
            'fatturatoAnnuo': 'Fatturato annuo lordo dell\'ultimo esercizio chiuso',
            'patrimonioNetto': 'Attivo - Passivo (dato da ultimo bilancio)',
            'concentrazioneClienti': 'Percentuale fatturato dipendente dai 3 clienti principali',
            'percentualeExport': 'Percentuale fatturato derivante da esportazioni',
            'numeroKeyPersons': 'Figure chiave senza cui l\'azienda √® in difficolt√†'
        };

        Object.keys(tooltips).forEach(id => {
            const elemento = document.getElementById(id);
            if (elemento) {
                const label = document.querySelector(`label[for="${id}"]`);
                if (label) {
                    const helpIcon = document.createElement('span');
                    helpIcon.textContent = ' ‚ÑπÔ∏è';
                    helpIcon.style.cursor = 'help';
                    aggiungiTooltip(helpIcon, tooltips[id]);
                    label.appendChild(helpIcon);
                }
            }
        });

        // ========================================
        // SMOOTH SCROLL ENHANCEMENTS
        // ========================================

        function smoothScrollTo(elementId, offset = 100) {
            const element = document.getElementById(elementId);
            if (element) {
                const y = element.getBoundingClientRect().top + window.pageYOffset - offset;
                window.scrollTo({ top: y, behavior: 'smooth' });
            }
        }

        // ========================================
        // PREVENZIONE DOUBLE SUBMIT
        // ========================================

        let isSubmitting = false;

        function preveniDoubleSubmit(fn) {
            return function(...args) {
                if (isSubmitting) {
                    console.warn('Operazione gi√† in corso...');
                    return;
                }
                
                isSubmitting = true;
                showToast('‚è≥ Elaborazione in corso...', 'info', 2000);

                try {
                    const result = fn.apply(this, args);
                    
                    // Se √® una Promise
                    if (result && typeof result.then === 'function') {
                        return result.finally(() => {
                            isSubmitting = false;
                        });
                    }
                    
                    isSubmitting = false;
                    return result;
                } catch (error) {
                    isSubmitting = false;
                    throw error;
                }
            };
        }

        // Wrappa funzioni critiche
        window.generaRisultatiAziendali = preveniDoubleSubmit(window.generaRisultatiAziendali);
        window.salvaAnalisiAziendale = preveniDoubleSubmit(window.salvaAnalisiAziendale);

        // ========================================
        // PRINT OPTIMIZATION
        // ========================================

        window.addEventListener('beforeprint', () => {
            console.log('üñ®Ô∏è Preparazione stampa...');
            
            // Espandi tutti i dettagli
            document.querySelectorAll('details').forEach(detail => {
                detail.setAttribute('open', '');
            });

            // Nascondi elementi non necessari
            document.querySelectorAll('.btn, .toast, .warning-badge').forEach(el => {
                el.style.display = 'none';
            });
        });

        window.addEventListener('afterprint', () => {
            console.log('‚úÖ Stampa completata');
            
            // Ripristina visibilit√†
            document.querySelectorAll('.btn, .toast, .warning-badge').forEach(el => {
                el.style.display = '';
            });
        });

        // ========================================
        // BACKUP AUTOMATICO LOCALE
        // ========================================

        function backupLocale() {
            try {
                const backup = {
                    version: APP_VERSION,
                    timestamp: new Date().toISOString(),
                    data: appStateAzienda
                };
                localStorage.setItem('backup_emergency', JSON.stringify(backup));
                console.log('üíæ Backup emergenza creato');
            } catch (error) {
                console.error('Errore backup:', error);
            }
        }

        // Backup ogni 10 minuti se c'√® attivit√†
        setInterval(() => {
            if (formModificato || appStateAzienda.answers) {
                backupLocale();
            }
        }, 600000); // 10 minuti

        // ========================================
        // DIAGNOSTICA SISTEMA
        // ========================================

        function diagnosticaSistema() {
            const diagnostica = {
                browser: navigator.userAgent,
                screen: `${window.screen.width}x${window.screen.height}`,
                viewport: `${window.innerWidth}x${window.innerHeight}`,
                localStorage: typeof(Storage) !== "undefined",
                localStorageSize: estimateLocalStorageSize(),
                online: navigator.onLine,
                language: navigator.language,
                timestamp: new Date().toISOString()
            };

            console.log('%cüîç DIAGNOSTICA SISTEMA', 'color: #3B82F6; font-weight: bold; font-size: 14px');
            console.table(diagnostica);

            return diagnostica;
        }

        function estimateLocalStorageSize() {
            let total = 0;
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    total += localStorage[key].length + key.length;
                }
            }
            return `${(total / 1024).toFixed(2)} KB`;
        }

        // ========================================
        // GESTIONE NETWORK STATUS
        // ========================================

        window.addEventListener('online', () => {
            showToast('‚úÖ Connessione ripristinata', 'success', 3000);
            console.log('üåê Online');
        });

        window.addEventListener('offline', () => {
            showToast('‚ö†Ô∏è Connessione persa - Lavoro offline', 'warning', 5000);
            console.warn('üîå Offline');
        });

        // ========================================
        // CONSOLE COMMANDS
        // ========================================

        window.helpAziende = function() {
            console.log('%cüìö COMANDI CONSOLE DISPONIBILI', 'color: #10B981; font-weight: bold; font-size: 16px');
            console.log('%chelp()', 'font-weight: bold', '- Mostra questo messaggio');
            console.log('%cdiagnostica()', 'font-weight: bold', '- Mostra diagnostica sistema');
            console.log('%cperformance()', 'font-weight: bold', '- Report performance');
            console.log('%cbackup()', 'font-weight: bold', '- Crea backup emergenza');
            console.log('%creset()', 'font-weight: bold', '- Reset completo applicazione');
            console.log('%cdebugAziende', 'font-weight: bold', '- Oggetto debug con metodi vari');
        };

        window.diagnostica = diagnosticaSistema;
        window.performance = mostraPerformanceReport;
        window.backup = backupLocale;
        window.reset = resetCompleto;

        // ========================================
        // FINALIZZAZIONE
        // ========================================

        console.log('‚úÖ Fix e ottimizzazioni: COMPLETATE');
        console.log('  ‚úì Gestione errori avanzata');
        console.log('  ‚úì Validazioni real-time');
        console.log('  ‚úì Ottimizzazione mobile');
        console.log('  ‚úì Accessibilit√† migliorata');
        console.log('  ‚úì Performance monitoring');
        console.log('  ‚úì Backup automatico');
        console.log('  ‚úì Diagnostica sistema');
        
        // Mostra help iniziale
        console.log('%cDigita help() per vedere i comandi disponibili', 'color: #F59E0B; font-style: italic');

    </script>
<script>
        // ========================================
        // MODULO PULSANTI AGGIUNTIVI E INTEGRAZIONI FINALI
        // ========================================

        console.log('%cüéÆ MODULO PULSANTI AGGIUNTIVI - ATTIVO', 'color: #8B5CF6; font-weight: bold');

        // ========================================
        // AGGIUNGI PULSANTI RISULTATI
        // ========================================

        function aggiungiPulsantiRisultati() {
            // Verifica se il container risultati esiste
            const risultatiDiv = document.getElementById('risultati');
            if (!risultatiDiv) return;

            // Cerca se esistono gi√† i pulsanti
            let btnContainer = risultatiDiv.querySelector('.btn-container-extra');
            if (btnContainer) return; // Gi√† aggiunti

            // Crea container pulsanti aggiuntivi
            btnContainer = document.createElement('div');
            btnContainer.className = 'btn-container-extra';
            btnContainer.style.cssText = 'margin-top: 20px; display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;';

            btnContainer.innerHTML = `
                <button class="btn btn-secondary" onclick="mostraStatisticheAnalisi()">
                    üìä Statistiche
                </button>
                <button class="btn btn-secondary" onclick="esportaJSONAziendale()">
                    üì• Export JSON
                </button>
                <button class="btn btn-secondary" onclick="condividiAnalisi()">
                    üì§ Condividi
                </button>
                <button class="btn btn-secondary" onclick="confrontaAnalisi()">
                    üîÑ Confronta
                </button>
                <button class="btn btn-secondary" onclick="generaReportExecutive()">
                    üìã Report Executive
                </button>
            `;

            // Inserisci dopo i pulsanti esistenti
            const existingBtns = risultatiDiv.querySelector('div[style*="margin-top: 40px"]');
            if (existingBtns) {
                existingBtns.appendChild(btnContainer);
            }
        }

        // ========================================
        // CONDIVIDI ANALISI
        // ========================================

        function condividiAnalisi() {
            if (!appStateAzienda.results) {
                showToast('‚ö†Ô∏è Completa prima l\'analisi', 'error');
                return;
            }

            const ragioneSociale = appStateAzienda.company.anagrafica.ragioneSociale || 'Azienda';
            const shareText = `Analisi Partner di Vita Aziende per ${ragioneSociale}`;
            const shareUrl = window.location.href;

            // Check Web Share API support
            if (navigator.share) {
                navigator.share({
                    title: shareText,
                    text: `Ho completato l'analisi rischi aziendali per ${ragioneSociale}`,
                    url: shareUrl
                })
                .then(() => {
                    showToast('‚úÖ Condiviso con successo', 'success');
                    console.log('üì§ Condivisione completata');
                })
                .catch((error) => {
                    if (error.name !== 'AbortError') {
                        console.error('Errore condivisione:', error);
                        fallbackShare(shareText, shareUrl);
                    }
                });
            } else {
                fallbackShare(shareText, shareUrl);
            }
        }

        function fallbackShare(text, url) {
            // Copia URL in clipboard
            const textArea = document.createElement('textarea');
            textArea.value = url;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            document.body.appendChild(textArea);
            textArea.select();
            
            try {
                document.execCommand('copy');
                showToast('‚úÖ Link copiato negli appunti', 'success');
                console.log('üìã Link copiato');
            } catch (err) {
                showToast('‚ö†Ô∏è Impossibile copiare il link', 'error');
                console.error('Errore copia:', err);
            }
            
            document.body.removeChild(textArea);
        }

        // ========================================
        // REPORT EXECUTIVE (sintesi 1 pagina)
        // ========================================

        function generaReportExecutive() {
            if (!appStateAzienda.results) {
                showToast('‚ö†Ô∏è Completa prima l\'analisi', 'error');
                return;
            }

            const r = appStateAzienda.results;
            const c = appStateAzienda.company.anagrafica;

            let html = '<div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; overflow-y: auto; padding: 20px;" onclick="this.remove()">';
            html += '<div style="background: white; max-width: 900px; margin: 0 auto; padding: 50px; border-radius: 12px;" onclick="event.stopPropagation()">';
            
            // Header
            html += '<div style="text-align: center; border-bottom: 3px solid var(--generali-blue); padding-bottom: 30px; margin-bottom: 30px;">';
            html += '<h1 style="color: var(--generali-blue); font-size: 28px; margin-bottom: 10px;">EXECUTIVE SUMMARY</h1>';
            html += '<h2 style="color: var(--generali-red); font-size: 24px; margin-bottom: 20px;">' + c.ragioneSociale + '</h2>';
            html += '<div style="display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; color: var(--gray-700);">';
            html += '<div><strong>Settore:</strong> ' + c.settoreATECO + '</div>';
            html += '<div><strong>Dipendenti:</strong> ' + c.numeroDipendenti + '</div>';
            html += '<div><strong>Fatturato:</strong> ‚Ç¨' + c.fatturatoAnnuo.toLocaleString() + '</div>';
            html += '</div>';
            html += '</div>';

            // Profilo e Coerenza
            html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">';
            html += '<div style="background: #F0F9FF; padding: 20px; border-radius: 8px; border-left: 4px solid #0284C7;">';
            html += '<h3 style="color: #0C4A6E; margin-bottom: 10px;">Profilo Aziendale</h3>';
            html += '<p style="font-size: 18px; font-weight: bold; color: var(--generali-blue);">' + r.normotipo.profilo + '</p>';
            html += '</div>';
            html += '<div style="background: #F0FDF4; padding: 20px; border-radius: 8px; border-left: 4px solid #10B981;">';
            html += '<h3 style="color: #065F46; margin-bottom: 10px;">Coerenza Strategica</h3>';
            html += '<p style="font-size: 36px; font-weight: bold; color: #10B981;">' + r.coherence.coherenceScore + '%</p>';
            html += '</div>';
            html += '</div>';

            // Top 5 GAP
            html += '<h3 style="color: var(--generali-blue); margin-bottom: 15px; font-size: 20px; border-bottom: 2px solid var(--gray-200); padding-bottom: 10px;">üéØ Top 5 Priorit√† Critiche</h3>';
            
            const topGaps = [];
            Object.keys(r.gaps).forEach(key => {
                const gap = r.gaps[key];
                if (gap.scoperturaLorda) {
                    topGaps.push({
                        nome: key.replace(/_/g, ' ').toUpperCase(),
                        scoperta: gap.scoperturaLorda,
                        gravita: gap.gravita
                    });
                } else if (gap.gapRC) {
                    topGaps.push({
                        nome: 'RC & Contenzioso',
                        scoperta: gap.gapRC,
                        gravita: gap.gravita
                    });
                } else if (gap.gapCyber) {
                    topGaps.push({
                        nome: 'Cyber Risk',
                        scoperta: gap.gapCyber,
                        gravita: gap.gravita
                    });
                }
            });

            topGaps.sort((a, b) => b.scoperta - a.scoperta).slice(0, 5).forEach((gap, i) => {
                const color = gap.gravita === 'critica' ? '#DC2626' : gap.gravita === 'alta' ? '#F97316' : '#F59E0B';
                html += '<div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--gray-50); margin-bottom: 10px; border-radius: 8px; border-left: 4px solid ' + color + ';">';
                html += '<div><strong>' + (i+1) + '. ' + gap.nome + '</strong></div>';
                html += '<div style="font-size: 18px; font-weight: bold; color: ' + color + ';">‚Ç¨' + gap.scoperta.toLocaleString() + '</div>';
                html += '</div>';
            });

            // Top 3 Suggerimenti
            html += '<h3 style="color: var(--generali-blue); margin: 30px 0 15px 0; font-size: 20px; border-bottom: 2px solid var(--gray-200); padding-bottom: 10px;">üí° Top 3 Azioni Immediate</h3>';
            
            r.suggerimenti.slice(0, 3).forEach((sug, i) => {
                html += '<div style="background: #EFF6FF; padding: 18px; margin-bottom: 12px; border-radius: 8px; border-left: 4px solid #3B82F6;">';
                html += '<div style="display: flex; justify-content: space-between; margin-bottom: 8px;">';
                html += '<strong style="color: var(--generali-blue);">' + (i+1) + '. ' + sug.titolo + '</strong>';
                html += '<span style="background: #DC2626; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: bold;">Priorit√†: ' + sug.priorita + '</span>';
                html += '</div>';
                html += '<p style="color: var(--gray-700); margin: 0; font-size: 14px;">' + sug.motivazione + '</p>';
                html += '</div>';
            });

            // Bias Critici
            if (r.profiloNeuroscientifico.biasRilevati.length > 0) {
                html += '<h3 style="color: var(--generali-blue); margin: 30px 0 15px 0; font-size: 20px; border-bottom: 2px solid var(--gray-200); padding-bottom: 10px;">‚ö†Ô∏è Alert: Bias Decisionali Rilevati</h3>';
                r.profiloNeuroscientifico.biasRilevati.forEach(bias => {
                    html += '<div style="background: #FEF3C7; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #F59E0B;">';
                    html += '<strong style="color: #92400E;">' + bias.tipo + '</strong>';
                    html += '<p style="margin: 5px 0 0 0; color: #78350F; font-size: 14px;">' + bias.descrizione + '</p>';
                    html += '</div>';
                });
            }

            // Footer
            html += '<div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid var(--gray-200); text-align: center; color: var(--gray-600);">';
            html += '<p style="margin: 0; font-size: 12px;">Report generato il ' + new Date().toLocaleString('it-IT') + '</p>';
            html += '<p style="margin: 5px 0 0 0; font-size: 12px;">Partner di Vita Aziende - Generali Business Edition v' + APP_VERSION + '</p>';
            html += '</div>';

            // Pulsanti
            html += '<div style="display: flex; gap: 15px; margin-top: 25px; justify-content: center;">';
            html += '<button onclick="window.print()" style="padding: 12px 24px; background: var(--generali-red); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">üñ®Ô∏è Stampa</button>';
            html += '<button onclick="this.closest(\'div[style*=fixed]\').remove()" style="padding: 12px 24px; background: var(--gray-600); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">‚úï Chiudi</button>';
            html += '</div>';

            html += '</div>';
            html += '</div>';

            document.body.insertAdjacentHTML('beforeend', html);
            
            console.log('üìã Report Executive generato');
        }

        // ========================================
        // CONFRONTO CON BENCHMARK SETTORE
        // ========================================

        function confrontaConBenchmark() {
            if (!appStateAzienda.results) {
                showToast('‚ö†Ô∏è Completa prima l\'analisi', 'error');
                return;
            }

            // Benchmark simulati per settore
            const benchmarks = {
                'C': { polizzeMedia: 6, coherenceMedia: 72, fatturatoMedio: 5000000 },
                'F': { polizzeMedia: 5, coherenceMedia: 68, fatturatoMedio: 3000000 },
                'G': { polizzeMedia: 4, coherenceMedia: 70, fatturatoMedio: 2000000 },
                'J': { polizzeMedia: 7, coherenceMedia: 78, fatturatoMedio: 4000000 },
                'M': { polizzeMedia: 6, coherenceMedia: 75, fatturatoMedio: 3500000 }
            };

            const settore = appStateAzienda.company.anagrafica.settoreATECO.charAt(0);
            const benchmark = benchmarks[settore] || { polizzeMedia: 5, coherenceMedia: 70, fatturatoMedio: 3000000 };

            const numPolizze = Object.keys(appStateAzienda.company.polizze || {}).length;
            const coherence = appStateAzienda.results.coherence.coherenceScore;
            const fatturato = appStateAzienda.company.anagrafica.fatturatoAnnuo;

            let html = '<div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;" onclick="this.remove()">';
            html += '<div style="background: white; max-width: 700px; width: 100%; padding: 40px; border-radius: 12px;" onclick="event.stopPropagation()">';
            html += '<h2 style="color: var(--generali-blue); margin-bottom: 25px;">üìä Confronto con Benchmark Settore</h2>';

            html += '<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; text-align: center;">';
            
            // Header
            html += '<div style="font-weight: bold; color: var(--gray-600);">Metrica</div>';
            html += '<div style="font-weight: bold; color: var(--gray-600);">Tua Azienda</div>';
            html += '<div style="font-weight: bold; color: var(--gray-600);">Media Settore</div>';

            // Polizze
            html += '<div style="padding: 15px; background: var(--gray-50); border-radius: 8px;">Polizze Attive</div>';
            html += '<div style="padding: 15px; background: var(--gray-50); border-radius: 8px; font-size: 24px; font-weight: bold; color: ' + (numPolizze >= benchmark.polizzeMedia ? 'var(--green)' : 'var(--red)') + ';">' + numPolizze + '</div>';
            html += '<div style="padding: 15px; background: var(--gray-50); border-radius: 8px; font-size: 24px; font-weight: bold;">' + benchmark.polizzeMedia + '</div>';

            // Coherence
            html += '<div style="padding: 15px; background: var(--gray-50); border-radius: 8px;">Coerenza Strategica</div>';
            html += '<div style="padding: 15px; background: var(--gray-50); border-radius: 8px; font-size: 24px; font-weight: bold; color: ' + (coherence >= benchmark.coherenceMedia ? 'var(--green)' : 'var(--red)') + ';">' + coherence + '%</div>';
            html += '<div style="padding: 15px; background: var(--gray-50); border-radius: 8px; font-size: 24px; font-weight: bold;">' + benchmark.coherenceMedia + '%</div>';

            // Fatturato
            html += '<div style="padding: 15px; background: var(--gray-50); border-radius: 8px;">Fatturato Annuo</div>';
            html += '<div style="padding: 15px; background: var(--gray-50); border-radius: 8px; font-size: 18px; font-weight: bold; color: ' + (fatturato >= benchmark.fatturatoMedio ? 'var(--green)' : 'var(--orange)') + ';">‚Ç¨' + (fatturato/1000000).toFixed(1) + 'M</div>';
            html += '<div style="padding: 15px; background: var(--gray-50); border-radius: 8px; font-size: 18px; font-weight: bold;">‚Ç¨' + (benchmark.fatturatoMedio/1000000).toFixed(1) + 'M</div>';

            html += '</div>';

            html += '<div style="margin-top: 30px; text-align: center;">';
            html += '<button onclick="this.closest(\'div[style*=fixed]\').remove()" style="padding: 12px 30px; background: var(--generali-red); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Chiudi</button>';
            html += '</div>';

            html += '</div>';
            html += '</div>';

            document.body.insertAdjacentHTML('beforeend', html);
            console.log('üìä Confronto benchmark mostrato');
        }

        // ========================================
        // ESPORTA ANALISI XLSX (simulato)
        // ========================================

        function esportaExcel() {
            showToast('‚ÑπÔ∏è Export Excel: funzione disponibile con integrazione SheetJS', 'info', 4000);
            console.log('üìä Export Excel richiesto (non implementato in versione base)');
        }

        // ========================================
        // INTEGRAZIONE FINALE RISULTATI
        // ========================================

        // Override finale generaRisultatiAziendali per aggiungere pulsanti
        const originalGeneraRisultatiAziendaliFinal = window.generaRisultatiAziendali;

        window.generaRisultatiAziendali = async function() {
            await originalGeneraRisultatiAziendaliFinal.call(this);
            
            setTimeout(() => {
                aggiungiPulsantiRisultati();
                mostraRiepilogoFinale();
            }, 1000);
        };

        // ========================================
        // RIEPILOGO FINALE
        // ========================================

        function mostraRiepilogoFinale() {
            if (!appStateAzienda.results) return;

            const r = appStateAzienda.results;
            
            console.log('%c‚úÖ ANALISI COMPLETATA CON SUCCESSO', 'color: #10B981; font-weight: bold; font-size: 16px');
            console.log('%c‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'color: #10B981');
            console.log('%cRiepilogo Analisi:', 'color: #3B82F6; font-weight: bold');
            console.log(`  üè≠ Azienda: ${appStateAzienda.company.anagrafica.ragioneSociale}`);
            console.log(`  üìä Profilo: ${r.normotipo.profilo}`);
            console.log(`  üéØ Coerenza: ${r.coherence.coherenceScore}%`);
            console.log(`  üß† Cluster Neuro: ${r.profiloNeuroscientifico.cluster}`);
            console.log(`  üìã GAP Analizzati: 5`);
            console.log(`  ‚ö†Ô∏è Scenari Stress: ${r.scenari.length}`);
            console.log(`  üí° Suggerimenti: ${r.suggerimenti.length}`);
            console.log(`  üéØ Bias Rilevati: ${r.profiloNeuroscientifico.biasRilevati.length}`);
            console.log(`  üïê Timestamp: ${new Date(r.timestamp).toLocaleString('it-IT')}`);
            console.log('%c‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'color: #10B981');
            
            // Toast finale
            showToast('üéâ Analisi completata! Scorri per vedere tutti i risultati.', 'success', 5000);
        }

        // ========================================
        // HELPER: SCARICA BACKUP
        // ========================================

        function scaricaBackupCompleto() {
            try {
                const analisiSalvate = localStorage.getItem('analisiAziendali') || '[]';
                const autoSave = localStorage.getItem('autoSaveAziendale') || 'null';
                const backupEmergency = localStorage.getItem('backup_emergency') || 'null';

                const fullBackup = {
                    version: APP_VERSION,
                    exportDate: new Date().toISOString(),
                    analisiSalvate: JSON.parse(analisiSalvate),
                    autoSave: JSON.parse(autoSave),
                    backupEmergency: JSON.parse(backupEmergency),
                    currentState: appStateAzienda
                };

                const dataStr = JSON.stringify(fullBackup, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `Backup_Completo_Partner_di_Vita_${new Date().toISOString().split('T')[0]}.json`;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showToast('‚úÖ Backup completo scaricato', 'success');
                console.log('üíæ Backup completo eseguito');

            } catch (error) {
                console.error('Errore backup completo:', error);
                showToast('‚ùå Errore creazione backup', 'error');
            }
        }

        // ========================================
        // RIPRISTINA DA BACKUP
        // ========================================

        function ripristinaDaBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const backup = JSON.parse(event.target.result);
                        
                        if (!backup.version || !backup.analisiSalvate) {
                            throw new Error('File backup non valido');
                        }

                        if (confirm('‚ö†Ô∏è Ripristinare il backup? I dati attuali verranno sovrascritti.')) {
                            // Ripristina localStorage
                            localStorage.setItem('analisiAziendali', JSON.stringify(backup.analisiSalvate));
                            if (backup.autoSave) {
                                localStorage.setItem('autoSaveAziendale', JSON.stringify(backup.autoSave));
                            }
                            if (backup.backupEmergency) {
                                localStorage.setItem('backup_emergency', JSON.stringify(backup.backupEmergency));
                            }

                            // Ripristina stato corrente se presente
                            if (backup.currentState) {
                                Object.assign(appStateAzienda, backup.currentState);
                            }

                            aggiornaListaAnalisi();
                            showToast('‚úÖ Backup ripristinato con successo', 'success');
                            console.log('üìÇ Backup ripristinato');
                            
                            setTimeout(() => location.reload(), 1500);
                        }

                    } catch (error) {
                        console.error('Errore ripristino backup:', error);
                        showToast('‚ùå File backup non valido', 'error');
                    }
                };
                reader.readAsText(file);
            };

            input.click();
        }

        // ========================================
        // AGGIUNGI MENU EXTRA NELLA CARD SALVATAGGIO
        // ========================================

        function aggiungiMenuExtra() {
            const saveCards = document.querySelectorAll('.card');
            let saveCard = null;

            saveCards.forEach(card => {
                const title = card.querySelector('h2');
                if (title && title.textContent.includes('Gestione')) {
                    saveCard = card;
                }
            });

            if (!saveCard) return;

            // Verifica se gi√† aggiunto
            if (saveCard.querySelector('.menu-extra')) return;

            const menuExtra = document.createElement('div');
            menuExtra.className = 'menu-extra';
            menuExtra.style.cssText = 'margin-top: 30px; padding-top: 30px; border-top: 2px solid var(--gray-200);';
            
            menuExtra.innerHTML = `
                <h3 style="color: var(--generali-blue); margin-bottom: 15px; font-size: 18px;">‚öôÔ∏è Strumenti Avanzati</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <button class="btn btn-secondary btn-block" onclick="scaricaBackupCompleto()">
                        üíæ Backup Completo
                    </button>
                    <button class="btn btn-secondary btn-block" onclick="ripristinaDaBackup()">
                        üìÇ Ripristina Backup
                    </button>
                    <button class="btn btn-secondary btn-block" onclick="confrontaConBenchmark()">
                        üìä Benchmark Settore
                    </button>
                    <button class="btn btn-secondary btn-block" onclick="esportaExcel()">
                        üìä Export Excel
                    </button>
                    <button class="btn btn-secondary btn-block" onclick="diagnosticaSistema()">
                        üîç Diagnostica
                    </button>
                    <button class="btn btn-secondary btn-block" onclick="mostraPerformanceReport()">
                        ‚è±Ô∏è Performance
                    </button>
                </div>
            `;

            saveCard.appendChild(menuExtra);
        }

        // Aggiungi menu al caricamento
        setTimeout(aggiungiMenuExtra, 1000);

        // ========================================
        // FINALIZZAZIONE MODULO
        // ========================================

        console.log('‚úÖ Pulsanti aggiuntivi: OPERATIVI');
        console.log('  ‚úì Statistiche analisi');
        console.log('  ‚úì Export JSON/Excel');
        console.log('  ‚úì Condivisione');
        console.log('  ‚úì Report Executive');
        console.log('  ‚úì Confronto benchmark');
        console.log('  ‚úì Backup completo');
        console.log('  ‚úì Diagnostica sistema');

        // Log finale sistema
        console.log('%cüéâ SISTEMA COMPLETO E OPERATIVO', 'color: #10B981; font-weight: bold; font-size: 18px; background: #D1FAE5; padding: 10px; border-radius: 5px;');
        console.log('%cPartner di Vita Aziende - Business Edition', 'color: #003366; font-weight: bold; font-size: 16px');
        console.log('%cTutti i moduli caricati e attivi', 'color: #059669; font-style: italic');
        console.log('%c‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'color: #10B981');
        console.log('%cFunzionalit√† disponibili:', 'color: #3B82F6; font-weight: bold');
        console.log('  ‚úÖ Anagrafica aziendale completa');
        console.log('  ‚úÖ 12 tipologie polizze aziendali');
        console.log('  ‚úÖ Questionario 24 domande (3 sezioni)');
        console.log('  ‚úÖ 5 GAP Analysis aziendali');
        console.log('  ‚úÖ 20 Normotipi comportamentali');
        console.log('  ‚úÖ 10 Scenari stress business');
        console.log('  ‚úÖ 10 Suggerimenti intelligenti prioritizzati');
        console.log('  ‚úÖ Behavioral Gap Analysis (5 aree)');
        console.log('  ‚úÖ Profilo neuroscientifico decisionale');
        console.log('  ‚úÖ 8 Bias cognitivi rilevabili');
        console.log('  ‚úÖ Semaforo prodotti 12 coperture');
        console.log('  ‚úÖ Salvataggio/caricamento analisi');
        console.log('  ‚úÖ Export JSON/PDF/Stampa');
        console.log('  ‚úÖ Report Executive');
        console.log('  ‚úÖ Benchmark settore');
        console.log('  ‚úÖ Backup/Restore completo');
        console.log('  ‚úÖ Diagnostica e performance');
        console.log('%c‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'color: #10B981');
        console.log('%cüí° Digita help() per comandi console', 'color: #F59E0B; font-style: italic');

    </script>

    </body>
    </html>
