<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partner di Vita Aziende - Ultimate Complete Edition v3.0 FINALE</title>
    
    <!-- Chart.js per grafici -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- SheetJS per export Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <style>
        /* ========================================
           VARIABILI CSS - BRAND GENERALI COMPLETE
        ======================================== */
        :root {
            --generali-blue: #003366;
            --generali-red: #E31E24;
            --generali-light-blue: #0066CC;
            --generali-orange: #FF6B35;
            --generali-gold: #C4A052;
            
            /* Grigi */
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --gray-900: #111827;
            
            /* Status colors */
            --green: #10B981;
            --green-light: #D1FAE5;
            --green-dark: #059669;
            --yellow: #F59E0B;
            --yellow-light: #FEF3C7;
            --yellow-dark: #D97706;
            --orange: #F97316;
            --orange-light: #FFEDD5;
            --orange-dark: #EA580C;
            --red: #EF4444;
            --red-light: #FEE2E2;
            --red-dark: #DC2626;
            --purple: #8B5CF6;
            --purple-light: #EDE9FE;
            --purple-dark: #7C3AED;
            --cyan: #06B6D4;
            --cyan-light: #CFFAFE;
            --cyan-dark: #0891B2;
            --blue: #3B82F6;
            --blue-light: #DBEAFE;
            --blue-dark: #2563EB;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 10px 30px rgba(0,0,0,0.12);
            --shadow-xl: 0 20px 60px rgba(0,0,0,0.25);
            
            /* Transitions */
            --transition-fast: 0.15s ease;
            --transition-base: 0.3s ease;
            --transition-slow: 0.5s ease;
        }

        /* Dark Mode Variables */
        body.dark-mode {
            --gray-50: #1F2937;
            --gray-100: #374151;
            --gray-200: #4B5563;
            --gray-300: #6B7280;
            --gray-900: #F9FAFB;
            --gray-800: #E5E7EB;
            --gray-700: #D1D5DB;
            --gray-600: #9CA3AF;
            background: #111827;
            color: #F9FAFB;
        }

        body.dark-mode .card {
            background: #1F2937;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        body.dark-mode input,
        body.dark-mode select,
        body.dark-mode textarea {
            background: #374151;
            color: #F9FAFB;
            border-color: #4B5563;
        }

        body.dark-mode .login-box {
            background: #1F2937;
            color: #F9FAFB;
        }

        body.dark-mode .question-card {
            background: #374151;
            border-color: #4B5563;
        }

        body.dark-mode .likert-option label {
            background: #374151;
            border-color: #4B5563;
        }

        /* ========================================
           RESET E BASE
        ======================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Inter', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            line-height: 1.6;
            transition: background var(--transition-base), color var(--transition-base);
        }

        /* ========================================
           ANIMAZIONI
        ======================================== */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-40px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(40px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* ========================================
           LOGIN SCREEN
        ======================================== */
        #loginScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--generali-blue) 0%, #004080 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.5s ease;
        }

        .login-box {
            background: white;
            padding: 50px;
            border-radius: 16px;
            box-shadow: var(--shadow-xl);
            max-width: 520px;
            width: 90%;
            text-align: center;
            animation: slideUp 0.6s ease;
        }

        .login-box h1 {
            color: var(--generali-blue);
            margin-bottom: 10px;
            font-size: 34px;
            font-weight: 700;
        }

        .login-box .subtitle {
            color: var(--gray-600);
            margin-bottom: 12px;
            font-size: 17px;
            font-weight: 600;
        }

        .login-box .version-badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--purple), var(--blue));
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .login-box .business-badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--generali-orange), var(--generali-red));
            color: white;
            padding: 10px 24px;
            border-radius: 25px;
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 35px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            box-shadow: 0 4px 15px rgba(227, 30, 36, 0.3);
        }

        .login-box input {
            width: 100%;
            padding: 18px;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 20px;
            transition: all var(--transition-base);
            font-family: inherit;
        }

        .login-box input:focus {
            outline: none;
            border-color: var(--generali-blue);
            box-shadow: 0 0 0 4px rgba(0, 51, 102, 0.1);
        }

        .login-box button {
            width: 100%;
            padding: 18px;
            background: var(--generali-red);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-base);
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .login-box button:hover {
            background: #C01A1F;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(227, 30, 36, 0.4);
        }

        /* ========================================
           HEADER
        ======================================== */
        .header {
            background: linear-gradient(135deg, var(--generali-blue) 0%, var(--generali-light-blue) 100%);
            color: white;
            padding: 40px 20px;
            text-align: center;
            box-shadow: var(--shadow-lg);
            position: relative;
        }

        .header h1 {
            font-size: 38px;
            margin-bottom: 10px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header .business-label {
            display: inline-block;
            background: var(--generali-orange);
            padding: 8px 18px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1.2px;
        }

        .header .version-label {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
            letter-spacing: 0.5px;
        }

        .header .tagline {
            font-size: 17px;
            opacity: 0.95;
            font-weight: 500;
            margin-top: 8px;
        }

        .header .dark-mode-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all var(--transition-base);
        }

        .header .dark-mode-toggle:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        /* ========================================
           CONTAINER E LAYOUT
        ======================================== */
        .container {
            max-width: 1400px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 35px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-md);
            border-top: 4px solid var(--generali-blue);
            transition: all var(--transition-base);
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .card-title {
            font-size: 26px;
            color: var(--generali-blue);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--generali-red);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card-title .icon {
            font-size: 32px;
        }

        .card-subtitle {
            font-size: 18px;
            color: var(--gray-700);
            margin-bottom: 20px;
            font-weight: 600;
        }

        /* ========================================
           FORM ELEMENTS
        ======================================== */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 8px;
            font-size: 15px;
        }

        .form-group label .required {
            color: var(--red);
            margin-left: 4px;
        }

        .form-group label .help-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            background: var(--gray-400);
            color: white;
            border-radius: 50%;
            font-size: 12px;
            line-height: 16px;
            text-align: center;
            margin-left: 5px;
            cursor: help;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 15px;
            transition: all var(--transition-base);
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--generali-blue);
            box-shadow: 0 0 0 4px rgba(0, 51, 102, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group input.valid {
            border-color: var(--green);
            background: var(--green-light);
        }

        .form-group input.invalid {
            border-color: var(--red);
            background: var(--red-light);
        }

        .form-group input:disabled,
        .form-group select:disabled,
        .form-group textarea:disabled {
            background: var(--gray-100);
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* ========================================
           BUTTONS
        ======================================== */
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-base);
            text-transform: uppercase;
            letter-spacing: 1px;
            display: inline-block;
            text-align: center;
            text-decoration: none;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--generali-red);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #C01A1F;
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(227, 30, 36, 0.4);
        }

        .btn-secondary {
            background: var(--generali-blue);
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #00458A;
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 51, 102, 0.4);
        }

        .btn-success {
            background: var(--green);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: var(--green-dark);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-warning {
            background: var(--orange);
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            background: var(--orange-dark);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(249, 115, 22, 0.4);
        }

        .btn-danger {
            background: var(--red);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: var(--red-dark);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        .btn-outline {
            background: transparent;
            color: var(--generali-blue);
            border: 2px solid var(--generali-blue);
        }

        .btn-outline:hover:not(:disabled) {
            background: var(--generali-blue);
            color: white;
        }

        .btn-block {
            width: 100%;
            display: block;
            margin-bottom: 12px;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 25px;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-lg {
            padding: 18px 36px;
            font-size: 18px;
        }

        /* ========================================
           TOAST NOTIFICATIONS
        ======================================== */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
        }

        .toast {
            background: white;
            padding: 16px 20px;
            border-radius: 10px;
            box-shadow: var(--shadow-lg);
            min-width: 300px;
            max-width: 400px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease;
            border-left: 4px solid var(--green);
        }

        .toast.success { border-left-color: var(--green); }
        .toast.error { border-left-color: var(--red); }
        .toast.warning { border-left-color: var(--orange); }
        .toast.info { border-left-color: var(--blue); }

        .toast-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .toast-message {
            flex: 1;
            font-weight: 600;
            font-size: 14px;
            line-height: 1.4;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--gray-500);
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all var(--transition-fast);
        }

        .toast-close:hover {
            background: var(--gray-100);
            color: var(--gray-900);
        }

        /* ========================================
           PROGRESS BAR
        ======================================== */
        .progress-container {
            background: var(--gray-200);
            border-radius: 10px;
            height: 30px;
            margin: 25px 0;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            background: linear-gradient(90deg, var(--generali-blue), var(--generali-light-blue));
            height: 100%;
            border-radius: 10px;
            transition: width var(--transition-slow);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 14px;
            min-width: 30px;
        }

        .progress-bar.animated {
            background: linear-gradient(90deg, 
                var(--generali-blue), 
                var(--generali-light-blue),
                var(--generali-blue)
            );
            background-size: 200% 100%;
            animation: progressShimmer 2s linear infinite;
        }

        @keyframes progressShimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* ========================================
           QUESTIONARIO ADATTIVO
        ======================================== */
        .question-card {
            background: var(--gray-50);
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 25px;
            transition: all var(--transition-base);
        }

        .question-card:hover {
            border-color: var(--generali-blue);
            box-shadow: var(--shadow-md);
            transform: translateX(5px);
        }

        .question-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .question-number {
            background: var(--generali-blue);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
            flex-shrink: 0;
        }

        .question-section {
            background: var(--generali-orange);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .question-peso {
            background: var(--purple-light);
            color: var(--purple);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
        }

        .question-text {
            font-size: 18px;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .question-help {
            font-size: 14px;
            color: var(--gray-600);
            font-style: italic;
            margin-bottom: 20px;
            padding: 10px;
            background: var(--yellow-light);
            border-left: 3px solid var(--yellow);
            border-radius: 4px;
        }

        /* ========================================
           LIKERT SCALE
        ======================================== */
        .likert-scale {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .likert-option {
            flex: 1;
            min-width: 120px;
        }

        .likert-option input[type="radio"] {
            display: none;
        }

        .likert-option label {
            display: block;
            padding: 15px 10px;
            border: 2px solid var(--gray-300);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-base);
            background: white;
        }

        .likert-option label:hover {
            border-color: var(--generali-blue);
            background: var(--gray-50);
            transform: translateY(-3px);
            box-shadow: var(--shadow-sm);
        }

        .likert-option input[type="radio"]:checked + label {
            background: var(--generali-blue);
            color: white;
            border-color: var(--generali-blue);
            box-shadow: var(--shadow-md);
            transform: scale(1.05);
        }

        .likert-number {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .likert-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            line-height: 1.3;
        }

        /* ========================================
           RISULTATI
        ======================================== */
        .risultati-summary {
            background: linear-gradient(135deg, var(--generali-blue), var(--generali-light-blue));
            color: white;
            padding: 40px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
        }

        .risultati-summary h2 {
            font-size: 32px;
            margin-bottom: 25px;
            font-weight: 700;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .summary-stat {
            background: rgba(255,255,255,0.15);
            padding: 25px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .summary-stat-value {
            font-size: 42px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .summary-stat-label {
            font-size: 14px;
            opacity: 0.9;
            font-weight: 500;
        }

        /* ========================================
           NORMOTIPI E PROFILI
        ======================================== */
        .normotipo-card {
            background: linear-gradient(135deg, var(--purple-light), white);
            border: 2px solid var(--purple);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 25px;
        }

        .normotipo-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--purple);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .normotipo-description {
            font-size: 16px;
            line-height: 1.6;
            color: var(--gray-700);
            margin-bottom: 15px;
        }

        .normotipo-traits {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .trait-badge {
            background: var(--purple);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .normotipo-priorita {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            border: 1px solid var(--purple-light);
        }

        .priorita-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--purple);
            margin-bottom: 15px;
        }

        .priorita-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--gray-200);
        }

        .priorita-item:last-child {
            border-bottom: none;
        }

        .priorita-nome {
            font-weight: 600;
            color: var(--gray-800);
        }

        .priorita-valore {
            font-weight: 700;
            font-size: 18px;
        }

        .priorita-alta { color: var(--red); }
        .priorita-media { color: var(--orange); }
        .priorita-bassa { color: var(--green); }

        /* ========================================
           BIAS COGNITIVI
        ======================================== */
        .bias-card {
            background: var(--orange-light);
            border-left: 4px solid var(--orange);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .bias-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .bias-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--orange);
        }

        .bias-intensita {
            background: var(--orange);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
        }

        .bias-description {
            font-size: 15px;
            color: var(--gray-700);
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .bias-info {
            font-size: 14px;
            color: var(--gray-600);
            margin-top: 8px;
        }

        .bias-info strong {
            color: var(--gray-800);
        }

        /* ========================================
           SCENARI STRESS
        ======================================== */
        .scenario-card {
            background: white;
            border: 2px solid var(--red-light);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            transition: all var(--transition-base);
        }

        .scenario-card:hover {
            border-color: var(--red);
            box-shadow: var(--shadow-md);
        }

        .scenario-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .scenario-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--red);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .scenario-probabilita {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 700;
            color: white;
        }

        .prob-alta { background: var(--red); }
        .prob-media { background: var(--orange); }
        .prob-bassa { background: var(--green); }

        .scenario-descrizione {
            font-size: 15px;
            color: var(--gray-700);
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .scenario-impatto {
            background: var(--red-light);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .impatto-economico {
            font-size: 24px;
            font-weight: 700;
            color: var(--red);
            margin-bottom: 5px;
        }

        .impatto-label {
            font-size: 13px;
            color: var(--gray-600);
            font-weight: 600;
        }

        .scenario-raccomandazione {
            background: var(--green-light);
            border-left: 3px solid var(--green);
            padding: 12px;
            border-radius: 4px;
        }

        .raccomandazione-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--green-dark);
            margin-bottom: 5px;
        }

        .raccomandazione-text {
            font-size: 14px;
            color: var(--gray-700);
        }

        /* ========================================
           GAP ANALYSIS
        ======================================== */
        .gap-card {
            background: white;
            border: 2px solid var(--cyan-light);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .gap-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .gap-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--cyan-dark);
        }

        .gap-score {
            font-size: 32px;
            font-weight: 700;
        }

        .gap-alto { color: var(--red); }
        .gap-medio { color: var(--orange); }
        .gap-basso { color: var(--green); }

        .gap-descrizione {
            font-size: 15px;
            color: var(--gray-700);
            margin-bottom: 15px;
        }

        .gap-raccomandazioni {
            list-style: none;
            padding: 0;
        }

        .gap-raccomandazioni li {
            padding: 8px 0 8px 25px;
            position: relative;
            font-size: 14px;
            color: var(--gray-700);
        }

        .gap-raccomandazioni li:before {
            content: "→";
            position: absolute;
            left: 0;
            color: var(--cyan-dark);
            font-weight: 700;
        }

        /* ========================================
           RACCOMANDAZIONI
        ======================================== */
        .raccomandazione-card {
            background: var(--gray-50);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .racc-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .racc-numero {
            background: var(--generali-blue);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            flex-shrink: 0;
        }

        .racc-priorita-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
            color: white;
        }

        .priorita-alta-badge { background: var(--red); }
        .priorita-media-badge { background: var(--orange); }
        .priorita-bassa-badge { background: var(--green); }

        .racc-titolo {
            font-size: 18px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 10px;
        }

        .racc-descrizione {
            font-size: 15px;
            color: var(--gray-700);
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .racc-prodotto {
            font-size: 13px;
            color: var(--generali-blue);
            font-weight: 600;
        }

        /* ========================================
           BENCHMARK
        ======================================== */
        .benchmark-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .benchmark-item {
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .benchmark-label {
            font-size: 14px;
            color: var(--gray-600);
            font-weight: 600;
            margin-bottom: 10px;
        }

        .benchmark-values {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
        }

        .benchmark-value {
            text-align: center;
        }

        .benchmark-numero {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .benchmark-sublabel {
            font-size: 12px;
            color: var(--gray-600);
            font-weight: 600;
        }

        .benchmark-vs {
            color: var(--gray-400);
            font-weight: 700;
        }

        /* ========================================
           UTILITIES
        ======================================== */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .text-left {
            text-align: left;
        }

        .text-right {
            text-align: right;
        }

        .mt-10 { margin-top: 10px; }
        .mt-20 { margin-top: 20px; }
        .mt-30 { margin-top: 30px; }
        .mb-10 { margin-bottom: 10px; }
        .mb-20 { margin-bottom: 20px; }
        .mb-30 { margin-bottom: 30px; }

        .fw-bold { font-weight: 700; }
        .fw-semibold { font-weight: 600; }
        .fw-normal { font-weight: 400; }

        .fs-small { font-size: 13px; }
        .fs-normal { font-size: 15px; }
        .fs-large { font-size: 18px; }

        /* ========================================
           RESPONSIVE
        ======================================== */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 28px;
            }
            
            .header .dark-mode-toggle {
                position: relative;
                top: auto;
                right: auto;
                margin: 15px auto 0;
                display: block;
                width: fit-content;
            }
            
            .login-box {
                padding: 30px;
            }
            
            .card {
                padding: 20px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .likert-scale {
                flex-direction: column;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }

            .benchmark-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ========================================
           PRINT STYLES
        ======================================== */
        @media print {
            .header .dark-mode-toggle,
            .btn,
            .toast-container {
                display: none !important;
            }
            
            .card {
                page-break-inside: avoid;
                box-shadow: none;
                border: 1px solid var(--gray-300);
            }

            body {
                background: white;
            }
        }

        /* ========================================
           LOADING SPINNER
        ======================================== */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--gray-200);
            border-top-color: var(--generali-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .spinner-container {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        /* ========================================
           BADGES E LABELS
        ======================================== */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
        }

        .badge-blue { background: var(--blue-light); color: var(--blue-dark); }
        .badge-red { background: var(--red-light); color: var(--red-dark); }
        .badge-green { background: var(--green-light); color: var(--green-dark); }
        .badge-orange { background: var(--orange-light); color: var(--orange-dark); }
        .badge-purple { background: var(--purple-light); color: var(--purple-dark); }
        .badge-yellow { background: var(--yellow-light); color: var(--yellow-dark); }

        /* ========================================
           ALERTS
        ======================================== */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .alert-success {
            background: var(--green-light);
            border-color: var(--green);
            color: var(--green-dark);
        }

        .alert-warning {
            background: var(--orange-light);
            border-color: var(--orange);
            color: var(--orange-dark);
        }

        .alert-error {
            background: var(--red-light);
            border-color: var(--red);
            color: var(--red-dark);
        }

        .alert-info {
            background: var(--blue-light);
            border-color: var(--blue);
            color: var(--blue-dark);
        }
    </style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen">
    <div class="login-box">
        <div class="version-badge">v3.0 COMPLETE</div>
        <h1>Partner di Vita</h1>
        <div class="subtitle">Metodo Rosso Generali</div>
        <div class="business-badge">🏢 ULTIMATE BUSINESS EDITION</div>
        <input type="text" id="loginUsername" placeholder="Nome Consulente" autocomplete="off">
        <input type="password" id="loginPassword" placeholder="Password" autocomplete="off">
        <button onclick="handleLogin()">ACCEDI</button>
    </div>
</div>

<!-- MAIN APP -->
<div id="mainApp" class="hidden">
    
    <!-- HEADER -->
    <div class="header">
        <button class="dark-mode-toggle" onclick="toggleDarkMode()">🌙 Dark Mode</button>
        <div class="business-label">AZIENDE</div>
        <span class="version-label">v3.0 FINALE</span>
        <h1>Partner di Vita Aziende</h1>
        <div class="tagline">Sistema Completo: Adattivo + Normotipi + Scenari + Benchmark + Diagnostica</div>
    </div>

    <!-- TOAST CONTAINER -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- CONTAINER PRINCIPALE -->
    <div class="container">

        <!-- SEZIONE ANAGRAFICA -->
        <div class="card" id="anagraficaSection">
            <h2 class="card-title">
                <span class="icon">🏢</span>
                Anagrafica Aziendale Completa
            </h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Ragione Sociale <span class="required">*</span></label>
                    <input type="text" id="ragioneSociale" placeholder="Es. Acme SRL">
                </div>
                
                <div class="form-group">
                    <label>Partita IVA <span class="required">*</span></label>
                    <input type="text" id="partitaIVA" placeholder="11 cifre" maxlength="11">
                </div>
                
                <div class="form-group">
                    <label>Email Aziendale <span class="required">*</span></label>
                    <input type="email" id="emailAzienda" placeholder="info@azienda.it">
                </div>
                
                <div class="form-group">
                    <label>Telefono</label>
                    <input type="tel" id="telefonoAzienda" placeholder="+39 ...">
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label>Indirizzo</label>
                    <input type="text" id="indirizzo" placeholder="Via/Piazza">
                </div>
                
                <div class="form-group">
                    <label>Città <span class="required">*</span></label>
                    <input type="text" id="citta" placeholder="Es. Milano">
                </div>
                
                <div class="form-group">
                    <label>CAP</label>
                    <input type="text" id="cap" placeholder="00000" maxlength="5">
                </div>
                
                <div class="form-group">
                    <label>Provincia</label>
                    <input type="text" id="provincia" placeholder="Es. MI" maxlength="2">
                </div>
            </div>

            <div class="form-group">
                <label>Sito Web</label>
                <input type="url" id="sitoWeb" placeholder="https://www.azienda.it">
            </div>

            <h3 class="card-subtitle mt-30">👤 Referente Aziendale</h3>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Nome Referente <span class="required">*</span></label>
                    <input type="text" id="nomeReferente" placeholder="Nome e Cognome">
                </div>
                
                <div class="form-group">
                    <label>Ruolo <span class="required">*</span></label>
                    <select id="ruoloReferente">
                        <option value="">Seleziona...</option>
                        <option value="Titolare">Titolare</option>
                        <option value="Amministratore Delegato">Amministratore Delegato</option>
                        <option value="Direttore Generale">Direttore Generale</option>
                        <option value="CFO">CFO - Direttore Finanziario</option>
                        <option value="HR Manager">HR Manager</option>
                        <option value="Responsabile Acquisti">Responsabile Acquisti</option>
                        <option value="Altro">Altro</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Email Referente</label>
                    <input type="email" id="emailReferente" placeholder="referente@azienda.it">
                </div>
                
                <div class="form-group">
                    <label>Telefono Referente</label>
                    <input type="tel" id="telefonoReferente" placeholder="+39 ...">
                </div>
            </div>

            <h3 class="card-subtitle mt-30">📊 Dati Societari (Cruciali per Sistema Adattivo)</h3>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Forma Giuridica <span class="required">*</span></label>
                    <select id="formaGiuridica">
                        <option value="">Seleziona...</option>
                        <option value="SRL">SRL - Società a Responsabilità Limitata</option>
                        <option value="SPA">SPA - Società per Azioni</option>
                        <option value="Ditta Individuale">Ditta Individuale</option>
                        <option value="SNC">SNC - Società in Nome Collettivo</option>
                        <option value="SAS">SAS - Società in Accomandita Semplice</option>
                        <option value="Cooperativa">Cooperativa</option>
                        <option value="Altra">Altra</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Settore <span class="required">*</span></label>
                    <select id="settore">
                        <option value="">Seleziona...</option>
                        <option value="Manifatturiero">Manifatturiero</option>
                        <option value="Commercio">Commercio</option>
                        <option value="Servizi">Servizi</option>
                        <option value="Tecnologia">Tecnologia / IT</option>
                        <option value="Edilizia">Edilizia / Costruzioni</option>
                        <option value="Ristorazione">Ristorazione / HoReCa</option>
                        <option value="Logistica">Logistica / Trasporti</option>
                        <option value="Agricoltura">Agricoltura</option>
                        <option value="Sanità">Sanità</option>
                        <option value="Altro">Altro</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Numero Dipendenti <span class="required">*</span></label>
                    <select id="numeroDipendenti">
                        <option value="">Seleziona...</option>
                        <option value="1-5">1-5 dipendenti</option>
                        <option value="6-20">6-20 dipendenti</option>
                        <option value="21-50">21-50 dipendenti</option>
                        <option value="51-100">51-100 dipendenti</option>
                        <option value="101-250">101-250 dipendenti</option>
                        <option value="251+">Oltre 250 dipendenti</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Fatturato Annuo <span class="required">*</span></label>
                    <select id="fatturatoAnnuo">
                        <option value="">Seleziona...</option>
                        <option value="< 100K">Meno di 100.000 €</option>
                        <option value="100K-500K">100.000 - 500.000 €</option>
                        <option value="500K-2M">500.000 - 2.000.000 €</option>
                        <option value="2M-10M">2 - 10 Milioni €</option>
                        <option value="10M-50M">10 - 50 Milioni €</option>
                        <option value="> 50M">Oltre 50 Milioni €</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Anno di Fondazione</label>
                <input type="number" id="annoFondazione" placeholder="Es. 1995" min="1800" max="2025">
            </div>

            <h3 class="card-subtitle mt-30">💼 Consulente Generali Assegnato</h3>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Consulente</label>
                    <select id="consulenteSelect" onchange="aggiornaEmailConsulente()">
                        <option value="">Seleziona consulente...</option>
                        <option value="MARIAPIA.ADINOLFI">MARIAPIA ADINOLFI</option>
                        <option value="GIANLUCA.AMENDOLA">GIANLUCA AMENDOLA</option>
                        <option value="MARCO.BAGNOLI">MARCO BAGNOLI</option>
                        <option value="MERZIA.BENEDETTI">MERZIA BENEDETTI</option>
                        <option value="ELISA.BERARDONO">ELISA BERARDONO</option>
                        <option value="FEDERICO.BOGANI">FEDERICO BOGANI</option>
                        <option value="ALESSANDRO.BORGHI">ALESSANDRO BORGHI</option>
                        <option value="MATTEO.BRUNELLI">MATTEO BRUNELLI</option>
                        <option value="FRANCESCO.BRUNI">FRANCESCO BRUNI</option>
                        <option value="ANTONIO.CAMA">ANTONIO CAMA</option>
                        <option value="LUCIA.CARDICCHI">LUCIA CARDICCHI</option>
                        <option value="FABIO.CARMIGNANI">FABIO CARMIGNANI</option>
                        <option value="MARCO.CAROSELLA">MARCO CAROSELLA</option>
                        <option value="MATTEO.CASSARA'">MATTEO CASSARA'</option>
                        <option value="MATTEO.CAVAGNA">MATTEO CAVAGNA</option>
                        <option value="STEFANIA.CECCARELLI">STEFANIA CECCARELLI</option>
                        <option value="ANTONELLO.DEIANA">ANTONELLO DEIANA</option>
                        <option value="FRANCESCO.ERBAGGIO">FRANCESCO ERBAGGIO</option>
                        <option value="GIORGIO.FABBRI">GIORGIO FABBRI</option>
                        <option value="ALESSANDRO.FINESCHI">ALESSANDRO FINESCHI</option>
                        <option value="EMANUELE.FRASCARO">EMANUELE FRASCARO</option>
                        <option value="OLIVIA.FRATONI">OLIVIA FRATONI</option>
                        <option value="EDOARDO.GABBIANI">EDOARDO GABBIANI</option>
                        <option value="ALESSIO.GIACOMELLI">ALESSIO GIACOMELLI</option>
                        <option value="ALICE.GIGLIOTTI">ALICE GIGLIOTTI</option>
                        <option value="MIRKO.GIOVACCHINI">MIRKO GIOVACCHINI</option>
                        <option value="SARA.GIUSTI">SARA GIUSTI</option>
                        <option value="DAVA.GJACI">DAVA GJACI</option>
                        <option value="GIOELE.GOTI">GIOELE GOTI</option>
                        <option value="GUIDO.GRIFONI">GUIDO GRIFONI</option>
                        <option value="STEFANO.MACCIONI">STEFANO MACCIONI</option>
                        <option value="LETIZIA.MAGGIO">LETIZIA MAGGIO</option>
                        <option value="SIMONE.MARMORINI">SIMONE MARMORINI</option>
                        <option value="MATTEO.NINCHERI">MATTEO NINCHERI</option>
                        <option value="VERONICA.PETRACCHI">VERONICA PETRACCHI</option>
                        <option value="SIMONE.PIAZZINI">SIMONE PIAZZINI</option>
                        <option value="NICOLA.PIERATTINI">NICOLA PIERATTINI</option>
                        <option value="ANDREA.PIPPA">ANDREA PIPPA</option>
                        <option value="ANDREA.PORRO">ANDREA PORRO</option>
                        <option value="CLAUDIO.PROVENZANO">CLAUDIO PROVENZANO</option>
                        <option value="CLAUDIA.ROSSI">CLAUDIA ROSSI</option>
                        <option value="CLAUDIO.SCIANNAME'">CLAUDIO SCIANNAME'</option>
                        <option value="LORENZO.SCURZONI">LORENZO SCURZONI</option>
                        <option value="SIMONE.SETTESOLDI">SIMONE SETTESOLDI</option>
                        <option value="PAMELA.TORRE">PAMELA TORRE</option>
                        <option value="ALBERTO.VAIANI">ALBERTO VAIANI</option>
                        <option value="SAMUELE.VALECCHI">SAMUELE VALECCHI</option>
                        <option value="FRANCESCO.VALLERINI">FRANCESCO VALLERINI</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Email Consulente</label>
                    <input type="email" id="consulenteEmail" placeholder="Seleziona consulente..." readonly>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary btn-block" onclick="salvaAnagraficaEProcedi()">
                    📝 SALVA E PROSEGUI AL QUESTIONARIO ADATTIVO
                </button>
            </div>
        </div>

        <!-- SEZIONE QUESTIONARIO ADATTIVO -->
        <div class="card hidden" id="questionarioSection">
            <h2 class="card-title">
                <span class="icon">📋</span>
                Questionario Adattivo Intelligente
            </h2>
            
            <div class="alert alert-info">
                <strong>🧠 Sistema Adattivo Attivo:</strong> Le domande mostrate sono personalizzate in base al profilo aziendale. 
                Vedrai solo le domande rilevanti per la tua situazione.
            </div>
            
            <div class="progress-container">
                <div class="progress-bar" id="progressBar" style="width: 0%">0%</div>
            </div>

            <div id="questionarioContainer">
                <!-- Le domande vengono generate dinamicamente qui -->
            </div>

            <div class="btn-group">
                <button class="btn btn-success btn-block" onclick="generaAnalisiCompleta()">
                    🎯 GENERA ANALISI COMPLETA
                </button>
            </div>
        </div>

        <!-- SEZIONE RISULTATI -->
        <div class="card hidden" id="risultatiContainer">
            <h2 class="card-title">
                <span class="icon">📊</span>
                Risultati Analisi Completa
            </h2>
            
            <div id="risultatiContenuto">
                <!-- I risultati vengono generati dinamicamente qui -->
            </div>
        </div>

    </div>

</div>

<script>
// ========================================
// STATO GLOBALE APPLICAZIONE COMPLETO
// ========================================

const appState = {
    version: '3.0.0-FINAL',
    buildDate: '2025-10-30',
    darkMode: false,
    autoSave: true,
    consulente: null,
    company: {
        anagrafica: {},
        referente: {},
        datiSocietari: {},
        consulente: {}
    },
    profilo: {},
    questionario: {
        domandeFiltrate: [],
        risposte: {},
        completato: false
    },
    results: {
        generated: false,
        timestamp: null,
        indiceGlobale: 0,
        punteggiSezioni: {},
        normotipo: null,
        confidenzaNormotipo: 0,
        bias: [],
        scenariStress: [],
        gapAnalysis: [],
        raccomandazioni: [],
        benchmark: {},
        risposteAnalizzate: 0,
        totaleDomande: 0
    }
};

// CONTINUA NELLA PROSSIMA SEZIONE
console.log('%c✅ SEZIONE 2/15 COMPLETATA: Struttura HTML', 'color: #10B981; font-weight: bold; font-size: 14px');

// ========================================
// SEZIONE 3/15: CONSULENTI + LOGIN + TOAST + DARK MODE
// ========================================

// Mappa completa email consulenti Generali (46 consulenti)
const consulentiEmailMap = {
    "MARIAPIA.ADINOLFI": "mariapia.adinolfi@generali.com",
    "GIANLUCA.AMENDOLA": "gianluca.amendola@generali.com",
    "MARCO.BAGNOLI": "marco.bagnoli@generali.com",
    "MERZIA.BENEDETTI": "merzia.benedetti@generali.com",
    "ELISA.BERARDONO": "elisa.berardono@generali.com",
    "FEDERICO.BOGANI": "federico.bogani@generali.com",
    "ALESSANDRO.BORGHI": "alessandro.borghi@generali.com",
    "MATTEO.BRUNELLI": "matteo.brunelli@generali.com",
    "FRANCESCO.BRUNI": "francesco.bruni@generali.com",
    "ANTONIO.CAMA": "antonio.cama@generali.com",
    "LUCIA.CARDICCHI": "lucia.cardicchi@generali.com",
    "FABIO.CARMIGNANI": "fabio.carmignani@generali.com",
    "MARCO.CAROSELLA": "marco.carosella@generali.com",
    "MATTEO.CASSARA'": "matteo.cassara@generali.com",
    "MATTEO.CAVAGNA": "matteo.cavagna@generali.com",
    "STEFANIA.CECCARELLI": "stefania.ceccarelli@generali.com",
    "ANTONELLO.DEIANA": "antonello.deiana@generali.com",
    "FRANCESCO.ERBAGGIO": "francesco.erbaggio@generali.com",
    "GIORGIO.FABBRI": "giorgio.fabbri@generali.com",
    "ALESSANDRO.FINESCHI": "alessandro.fineschi@generali.com",
    "EMANUELE.FRASCARO": "emanuele.frascaro@generali.com",
    "OLIVIA.FRATONI": "olivia.fratoni@generali.com",
    "EDOARDO.GABBIANI": "edoardo.gabbiani@generali.com",
    "ALESSIO.GIACOMELLI": "alessio.giacomelli@generali.com",
    "ALICE.GIGLIOTTI": "alice.gigliotti@generali.com",
    "MIRKO.GIOVACCHINI": "mirko.giovacchini@generali.com",
    "SARA.GIUSTI": "sara.giusti@generali.com",
    "DAVA.GJACI": "dava.gjaci@generali.com",
    "GIOELE.GOTI": "gioele.goti@generali.com",
    "GUIDO.GRIFONI": "guido.grifoni@generali.com",
    "STEFANO.MACCIONI": "stefano.maccioni@generali.com",
    "LETIZIA.MAGGIO": "letizia.maggio@generali.com",
    "SIMONE.MARMORINI": "simone.marmorini@generali.com",
    "MATTEO.NINCHERI": "matteo.nincheri@generali.com",
    "VERONICA.PETRACCHI": "veronica.petracchi@generali.com",
    "SIMONE.PIAZZINI": "simone.piazzini@generali.com",
    "NICOLA.PIERATTINI": "nicola.pierattini@generali.com",
    "ANDREA.PIPPA": "andrea.pippa@generali.com",
    "ANDREA.PORRO": "andrea.porro@generali.com",
    "CLAUDIO.PROVENZANO": "claudio.provenzano@generali.com",
    "CLAUDIA.ROSSI": "claudia.rossi@generali.com",
    "CLAUDIO.SCIANNAME'": "claudio.scianname@generali.com",
    "LORENZO.SCURZONI": "lorenzo.scurzoni@generali.com",
    "SIMONE.SETTESOLDI": "simone.settesoldi@generali.com",
    "PAMELA.TORRE": "pamela.torre@generali.com",
    "ALBERTO.VAIANI": "alberto.vaiani@generali.com",
    "SAMUELE.VALECCHI": "samuele.valecchi@generali.com",
    "FRANCESCO.VALLERINI": "francesco.vallerini@generali.com"
};

// ========================================
// LOGIN SYSTEM
// ========================================

function handleLogin() {
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    
    if (!username) {
        showToast('⚠️ Inserisci il nome consulente', 'warning');
        return;
    }
    
    if (!password) {
        showToast('⚠️ Inserisci la password', 'warning');
        return;
    }
    
    // Validazione (in produzione usare autenticazione vera)
    if (password === 'generali2025' || password === 'demo') {
        appState.consulente = username;
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainApp').classList.remove('hidden');
        showToast(`✅ Benvenuto ${username}!`, 'success');
        
        console.log('%c🏢 SISTEMA AVVIATO', 'color: #10B981; font-weight: bold; font-size: 16px');
        console.log(`Consulente: ${username}`);
        console.log(`Build: ${appState.buildDate}`);
    } else {
        showToast('❌ Password non corretta', 'error');
        document.getElementById('loginPassword').value = '';
    }
}

// Enter key per login
document.addEventListener('DOMContentLoaded', function() {
    const loginPassword = document.getElementById('loginPassword');
    if (loginPassword) {
        loginPassword.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                handleLogin();
            }
        });
    }
});

// ========================================
// TOAST NOTIFICATION SYSTEM COMPLETO
// ========================================

let toastCounter = 0;

function showToast(message, type = 'info', duration = 3000, dismissible = true) {
    const container = document.getElementById('toastContainer');
    if (!container) return;
    
    const toastId = `toast-${toastCounter++}`;
    const toast = document.createElement('div');
    toast.id = toastId;
    toast.className = `toast ${type}`;
    
    const icons = {
        success: '✅',
        error: '❌',
        warning: '⚠️',
        info: 'ℹ️'
    };
    
    toast.innerHTML = `
        <span class="toast-icon">${icons[type] || icons.info}</span>
        <span class="toast-message">${message}</span>
        ${dismissible ? '<button class="toast-close" onclick="closeToast(\'' + toastId + '\')">×</button>' : ''}
    `;
    
    container.appendChild(toast);
    
    if (duration > 0) {
        setTimeout(() => {
            closeToast(toastId);
        }, duration);
    }
    
    return toastId;
}

function closeToast(toastId) {
    const toast = document.getElementById(toastId);
    if (toast) {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(400px)';
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }
}

// ========================================
// DARK MODE
// ========================================

function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    appState.darkMode = document.body.classList.contains('dark-mode');
    
    const btn = document.querySelector('.dark-mode-toggle');
    if (btn) {
        btn.textContent = appState.darkMode ? '☀️ Light Mode' : '🌙 Dark Mode';
    }
    
    showToast(
        appState.darkMode ? '🌙 Dark Mode attivato' : '☀️ Light Mode attivato',
        'info',
        2000
    );
    
    // Salva preferenza
    localStorage.setItem('partner_vita_darkMode', appState.darkMode);
    console.log(`Dark Mode: ${appState.darkMode ? 'ON' : 'OFF'}`);
}

// Carica preferenza Dark Mode salvata
document.addEventListener('DOMContentLoaded', function() {
    const savedDarkMode = localStorage.getItem('partner_vita_darkMode');
    if (savedDarkMode === 'true') {
        document.body.classList.add('dark-mode');
        appState.darkMode = true;
        const btn = document.querySelector('.dark-mode-toggle');
        if (btn) btn.textContent = '☀️ Light Mode';
    }
});

// ========================================
// EMAIL CONSULENTE AUTO-UPDATE
// ========================================

function aggiornaEmailConsulente() {
    const selectConsulente = document.getElementById('consulenteSelect');
    const inputEmail = document.getElementById('consulenteEmail');
    
    if (!selectConsulente || !inputEmail) return;
    
    const consulenteSelezionato = selectConsulente.value;
    
    if (!consulenteSelezionato) {
        inputEmail.value = '';
        inputEmail.style.background = '';
        inputEmail.style.borderColor = '';
        return;
    }
    
    const email = consulentiEmailMap[consulenteSelezionato];
    
    if (email) {
        inputEmail.value = email;
        inputEmail.style.background = 'var(--green-light)';
        inputEmail.style.borderColor = 'var(--green)';
        showToast(`✉️ Email: ${email}`, 'success', 2000);
    } else {
        inputEmail.value = '';
        inputEmail.style.background = 'var(--red-light)';
        inputEmail.style.borderColor = 'var(--red)';
        showToast('⚠️ Email non trovata', 'warning');
    }
}

console.log('%c✅ SEZIONE 3/15 COMPLETATA: Consulenti + Login + Toast + Dark Mode', 'color: #10B981; font-weight: bold; font-size: 14px');

// ========================================
// SEZIONE 4/15: VALIDAZIONI + AUTO-SAVE + UTILITIES
// ========================================

// ========================================
// VALIDAZIONE PARTITA IVA (ALGORITMO COMPLETO)
// ========================================

function validaPartitaIVA(piva) {
    if (!piva || piva.length !== 11 || !/^\d{11}$/.test(piva)) return false;
    
    let sum = 0;
    for (let i = 0; i < 10; i++) {
        let digit = parseInt(piva[i]);
        if (i % 2 === 1) {
            digit *= 2;
            if (digit > 9) digit -= 9;
        }
        sum += digit;
    }
    const checkDigit = (10 - (sum % 10)) % 10;
    return checkDigit === parseInt(piva[10]);
}

// Validazione real-time P.IVA
document.addEventListener('DOMContentLoaded', function() {
    const pivaInput = document.getElementById('partitaIVA');
    if (pivaInput) {
        pivaInput.addEventListener('blur', function() {
            const value = this.value.trim();
            if (value) {
                if (validaPartitaIVA(value)) {
                    this.classList.remove('invalid');
                    this.classList.add('valid');
                    showToast('✅ Partita IVA valida', 'success', 2000);
                } else {
                    this.classList.remove('valid');
                    this.classList.add('invalid');
                    showToast('❌ Partita IVA non valida', 'error', 3000);
                }
            } else {
                this.classList.remove('valid', 'invalid');
            }
        });
        
        // Solo numeri
        pivaInput.addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9]/g, '');
        });
    }
});

// ========================================
// VALIDAZIONE EMAIL
// ========================================

function validaEmail(email) {
    const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return regex.test(email);
}

// Validazione email real-time
document.addEventListener('DOMContentLoaded', function() {
    const emailInputs = ['emailAzienda', 'emailReferente'];
    emailInputs.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.addEventListener('blur', function() {
                if (this.value) {
                    if (validaEmail(this.value)) {
                        this.classList.add('valid');
                        this.classList.remove('invalid');
                    } else {
                        this.classList.add('invalid');
                        this.classList.remove('valid');
                        showToast('⚠️ Email non valida', 'warning', 2000);
                    }
                } else {
                    this.classList.remove('valid', 'invalid');
                }
            });
        }
    });
});

// ========================================
// VALIDAZIONI CAMPI SPECIFICI
// ========================================

// CAP - solo numeri
document.addEventListener('DOMContentLoaded', function() {
    const capInput = document.getElementById('cap');
    if (capInput) {
        capInput.addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9]/g, '');
        });
    }
});

// Provincia - solo lettere, max 2, uppercase
document.addEventListener('DOMContentLoaded', function() {
    const provInput = document.getElementById('provincia');
    if (provInput) {
        provInput.addEventListener('input', function() {
            this.value = this.value.replace(/[^a-zA-Z]/g, '').toUpperCase();
        });
    }
});

// Telefono - formato italiano
document.addEventListener('DOMContentLoaded', function() {
    const telInputs = ['telefonoAzienda', 'telefonoReferente'];
    telInputs.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.addEventListener('blur', function() {
                let value = this.value.replace(/\s/g, '');
                // Accetta formati: +39..., 0039..., o direttamente 3... o 0...
                if (value && !/^(\+39|0039)?[0-9]{6,12}$/.test(value)) {
                    showToast('⚠️ Numero di telefono non valido', 'warning', 2000);
                }
            });
        }
    });
});

// ========================================
// AUTO-SAVE SYSTEM
// ========================================

function autoSave() {
    if (appState.autoSave) {
        try {
            const dataToSave = {
                version: appState.version,
                timestamp: new Date().toISOString(),
                data: appState
            };
            localStorage.setItem('partner_vita_aziende_autosave', JSON.stringify(dataToSave));
            console.log('💾 Auto-save completato:', new Date().toLocaleTimeString('it-IT'));
        } catch (e) {
            console.warn('⚠️ Errore auto-save:', e);
            showToast('⚠️ Errore salvataggio automatico', 'warning', 2000);
        }
    }
}

// Auto-save ogni 5 minuti
setInterval(autoSave, 300000);

// Auto-save prima di chiudere
window.addEventListener('beforeunload', function(e) {
    autoSave();
});

// ========================================
// CARICAMENTO DATI SALVATI
// ========================================

function caricaDatiSalvati() {
    try {
        const saved = localStorage.getItem('partner_vita_aziende_autosave');
        if (saved) {
            const backup = JSON.parse(saved);
            if (backup.data) {
                // Merge con appState mantenendo la struttura
                Object.assign(appState, backup.data);
                console.log('✅ Dati precedenti ripristinati');
                console.log('Timestamp backup:', backup.timestamp);
                return true;
            }
        }
    } catch (e) {
        console.warn('⚠️ Errore caricamento dati salvati:', e);
    }
    return false;
}

// ========================================
// UTILITIES GENERALI
// ========================================

function resetApp() {
    if (confirm('⚠️ ATTENZIONE: Questo resetterà TUTTI i dati. Continuare?')) {
        if (confirm('Sei SICURO? Tutti i dati non salvati andranno persi definitivamente!')) {
            localStorage.clear();
            showToast('🔄 Applicazione resettata', 'info', 2000);
            setTimeout(() => {
                location.reload();
            }, 2000);
        }
    }
}

function exportJSON() {
    const dataStr = JSON.stringify(appState, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    const timestamp = Date.now();
    link.download = `partner_vita_aziende_${appState.company.anagrafica.ragioneSociale || 'backup'}_${timestamp}.json`;
    link.click();
    URL.revokeObjectURL(url);
    showToast('📥 File JSON esportato', 'success');
}

function backupCompleto() {
    const backup = {
        versione: appState.version,
        buildDate: appState.buildDate,
        timestamp: new Date().toISOString(),
        consulente: appState.consulente,
        data: appState
    };
    
    const dataStr = JSON.stringify(backup, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `backup_completo_${Date.now()}.json`;
    link.click();
    URL.revokeObjectURL(url);
    
    showToast('💾 Backup completo eseguito', 'success');
    console.log('✅ Backup salvato con successo');
}

// ========================================
// CONSOLE UTILITIES
// ========================================

window.help = function() {
    console.log('%c═══════════════════════════════════════', 'color: #003366; font-weight: bold');
    console.log('%c📚 COMANDI CONSOLE DISPONIBILI', 'color: #0066CC; font-weight: bold; font-size: 16px');
    console.log('%c═══════════════════════════════════════', 'color: #003366; font-weight: bold');
    console.log('%cstatus()', 'color: #10B981; font-weight: bold', '- Mostra stato sistema');
    console.log('%cversion()', 'color: #10B981; font-weight: bold', '- Info versione completa');
    console.log('%cdiagnostica()', 'color: #10B981; font-weight: bold', '- Diagnostica sistema completa');
    console.log('%cstatistiche()', 'color: #10B981; font-weight: bold', '- Statistiche analisi');
    console.log('%cexportJSON()', 'color: #10B981; font-weight: bold', '- Esporta dati JSON');
    console.log('%cexportExcel()', 'color: #10B981; font-weight: bold', '- Esporta Excel');
    console.log('%cbackupCompleto()', 'color: #10B981; font-weight: bold', '- Backup completo');
    console.log('%cviewState()', 'color: #F59E0B; font-weight: bold', '- Visualizza appState');
    console.log('%cresetApp()', 'color: #DC2626; font-weight: bold', '- Reset completo (⚠️ ATTENZIONE)');
    console.log('%c═══════════════════════════════════════', 'color: #003366; font-weight: bold');
};

window.status = function() {
    console.log('%c📊 STATO SISTEMA COMPLETO', 'color: #0066CC; font-weight: bold; font-size: 14px');
    console.log('Versione:', appState.version);
    console.log('Build:', appState.buildDate);
    console.log('Consulente:', appState.consulente || 'Non loggato');
    console.log('Azienda:', appState.company.anagrafica.ragioneSociale || 'Non compilata');
    console.log('Settore:', appState.company.datiSocietari.settore || 'N/D');
    console.log('Dimensione:', appState.company.datiSocietari.numeroDipendenti || 'N/D');
    console.log('Domande filtrate:', appState.questionario.domandeFiltrate.length);
    console.log('Risposte date:', Object.keys(appState.questionario.risposte).length);
    console.log('Questionario completato:', appState.questionario.completato ? '✅' : '⏳');
    console.log('Risultati generati:', appState.results.generated ? '✅' : '⏳');
    console.log('Dark Mode:', appState.darkMode ? '🌙 Attivo' : '☀️ Disattivo');
    console.log('Auto-save:', appState.autoSave ? '✅ Attivo' : '❌ Disattivo');
};

window.version = function() {
    console.log('%c🏢 Partner di Vita AZIENDE - Ultimate Complete Edition', 'color: #003366; font-weight: bold; font-size: 16px');
    console.log('Versione:', appState.version);
    console.log('Build Date:', appState.buildDate);
    console.log('Features Complete:');
    console.log('  ✅ Sistema Adattivo (24 domande)');
    console.log('  ✅ Normotipi Dinamici (dimensione + settore)');
    console.log('  ✅ 10 Scenari Stress');
    console.log('  ✅ GAP Analysis 5 aree');
    console.log('  ✅ Benchmark Settore');
    console.log('  ✅ Diagnostica Avanzata');
    console.log('  ✅ 8 Bias Cognitivi');
    console.log('  ✅ Dark Mode + Auto-save');
    console.log('  ✅ Export JSON/Excel/PDF');
    console.log('Generali Business Edition - Metodo Rosso');
};

window.viewState = function() {
    console.log(appState);
    return appState;
};

console.log('%c✅ SEZIONE 4/15 COMPLETATA: Validazioni + Auto-save + Utilities', 'color: #10B981; font-weight: bold; font-size: 14px');

// ========================================
// SEZIONE 5/15: ANAGRAFICA E PROFILAZIONE
// ========================================

function salvaAnagraficaEProcedi() {
    // Raccogli dati anagrafica
    const anagrafica = {
        ragioneSociale: document.getElementById('ragioneSociale')?.value.trim() || '',
        partitaIVA: document.getElementById('partitaIVA')?.value.trim() || '',
        emailAzienda: document.getElementById('emailAzienda')?.value.trim() || '',
        telefonoAzienda: document.getElementById('telefonoAzienda')?.value.trim() || '',
        indirizzo: document.getElementById('indirizzo')?.value.trim() || '',
        citta: document.getElementById('citta')?.value.trim() || '',
        cap: document.getElementById('cap')?.value.trim() || '',
        provincia: document.getElementById('provincia')?.value.trim() || '',
        sitoWeb: document.getElementById('sitoWeb')?.value.trim() || ''
    };
    
    // Referente
    const referente = {
        nome: document.getElementById('nomeReferente')?.value.trim() || '',
        ruolo: document.getElementById('ruoloReferente')?.value || '',
        email: document.getElementById('emailReferente')?.value.trim() || '',
        telefono: document.getElementById('telefonoReferente')?.value.trim() || ''
    };
    
    // Dati societari (CRUCIALI per sistema adattivo)
    const datiSocietari = {
        formaGiuridica: document.getElementById('formaGiuridica')?.value || '',
        settore: document.getElementById('settore')?.value || '',
        numeroDipendenti: document.getElementById('numeroDipendenti')?.value || '',
        fatturatoAnnuo: document.getElementById('fatturatoAnnuo')?.value || '',
        annoFondazione: document.getElementById('annoFondazione')?.value || ''
    };
    
    // Consulente
    const consulente = {
        nome: document.getElementById('consulenteSelect')?.value || '',
        email: document.getElementById('consulenteEmail')?.value.trim() || ''
    };
    
    // Validazione campi obbligatori
    const campiObbligatori = [
        { valore: anagrafica.ragioneSociale, nome: 'Ragione Sociale' },
        { valore: anagrafica.partitaIVA, nome: 'Partita IVA' },
        { valore: anagrafica.emailAzienda, nome: 'Email Aziendale' },
        { valore: anagrafica.citta, nome: 'Città' },
        { valore: referente.nome, nome: 'Nome Referente' },
        { valore: referente.ruolo, nome: 'Ruolo Referente' },
        { valore: datiSocietari.formaGiuridica, nome: 'Forma Giuridica' },
        { valore: datiSocietari.settore, nome: 'Settore' },
        { valore: datiSocietari.numeroDipendenti, nome: 'Numero Dipendenti' },
        { valore: datiSocietari.fatturatoAnnuo, nome: 'Fatturato Annuo' }
    ];
    
    const campiMancanti = campiObbligatori.filter(c => !c.valore);
    
    if (campiMancanti.length > 0) {
        const lista = campiMancanti.map(c => c.nome).join(', ');
        showToast(`⚠️ Compila i campi obbligatori: ${lista}`, 'warning', 5000);
        
        // Focus sul primo campo mancante
        const primoMancante = campiMancanti[0];
        const mapping = {
            'Ragione Sociale': 'ragioneSociale',
            'Partita IVA': 'partitaIVA',
            'Email Aziendale': 'emailAzienda',
            'Città': 'citta',
            'Nome Referente': 'nomeReferente',
            'Ruolo Referente': 'ruoloReferente',
            'Forma Giuridica': 'formaGiuridica',
            'Settore': 'settore',
            'Numero Dipendenti': 'numeroDipendenti',
            'Fatturato Annuo': 'fatturatoAnnuo'
        };
        const elementId = mapping[primoMancante.nome];
        if (elementId) {
            document.getElementById(elementId)?.focus();
        }
        return;
    }
    
    // Validazione Partita IVA
    if (!validaPartitaIVA(anagrafica.partitaIVA)) {
        showToast('❌ Partita IVA non valida', 'error', 4000);
        document.getElementById('partitaIVA')?.focus();
        return;
    }
    
    // Validazione Email
    if (!validaEmail(anagrafica.emailAzienda)) {
        showToast('❌ Email aziendale non valida', 'error', 4000);
        document.getElementById('emailAzienda')?.focus();
        return;
    }
    
    // Salva nello stato
    appState.company.anagrafica = anagrafica;
    appState.company.referente = referente;
    appState.company.datiSocietari = datiSocietari;
    appState.company.consulente = consulente;
    
    // Crea profilo per sistema adattivo
    appState.profilo = {
        formaGiuridica: datiSocietari.formaGiuridica,
        settore: datiSocietari.settore,
        dimensione: datiSocietari.numeroDipendenti,
        fatturato: datiSocietari.fatturatoAnnuo,
        ruoloReferente: referente.ruolo,
        annoFondazione: datiSocietari.annoFondazione
    };
    
    console.log('%c📊 PROFILO AZIENDALE CREATO', 'color: #0066CC; font-weight: bold; font-size: 14px');
    console.log('Settore:', appState.profilo.settore);
    console.log('Dimensione:', appState.profilo.dimensione);
    console.log('Fatturato:', appState.profilo.fatturato);
    
    // Nascondi anagrafica, mostra questionario
    document.getElementById('anagraficaSection')?.classList.add('hidden');
    document.getElementById('questionarioSection')?.classList.remove('hidden');
    
    showToast('✅ Anagrafica salvata! Sistema adattivo pronto', 'success', 3000);
    
    // Genera domande adattive
    generaDomandeAdattive();
    
    // Scroll al questionario
    setTimeout(() => {
        document.getElementById('questionarioSection')?.scrollIntoView({ 
            behavior: 'smooth',
            block: 'start'
        });
    }, 300);
    
    // Auto-save
    autoSave();
}

console.log('%c✅ SEZIONE 5/15 COMPLETATA: Anagrafica + Profilazione', 'color: #10B981; font-weight: bold; font-size: 14px');

// ========================================
// SEZIONE 6/15: DATABASE DOMANDE ADATTIVE COMPLETE
// ========================================

// Database completo 24 domande adattive con pesi e condizioni
const DOMANDE_ADATTIVE = [
    // SEZIONE: Business & Strategia (6 domande)
    {
        id: "B1",
        sezione: "Business & Strategia",
        testo: "Quanto è stabile il tuo fatturato annuo negli ultimi 3 anni?",
        help: "Considera la crescita, stabilità o calo del fatturato",
        scala: ["Molto instabile (-30%)", "Instabile (-10%)", "Stabile (±5%)", "Crescita (10-20%)", "Forte crescita (>20%)"],
        peso: 1.3,
        showIf: {
            formaGiuridica: ["SRL", "SPA", "Cooperativa"],
            dimensione: ["6-20", "21-50", "51-100", "101-250", "251+"]
        }
    },
    {
        id: "B2",
        sezione: "Business & Strategia",
        testo: "Quanto è competitivo il tuo settore di mercato?",
        help: "Valuta numero di concorrenti e barriere all'ingresso",
        scala: ["Monopolio", "Poca concorrenza", "Media competizione", "Alta competizione", "Altissima competizione"],
        peso: 1.0,
        showIf: {}
    },
    {
        id: "B3",
        sezione: "Business & Strategia",
        testo: "Quanto pianifichi strategicamente il business?",
        help: "Piano industriale, business plan, previsioni budget",
        scala: ["Mai", "Raramente", "Annualmente", "Trimestralmente", "Mensilmente"],
        peso: 1.2,
        showIf: {
            dimensione: ["21-50", "51-100", "101-250", "251+"]
        }
    },
    {
        id: "B4",
        sezione: "Business & Strategia",
        testo: "Quanto dipendi da clienti chiave per il fatturato?",
        help: "Concentrazione del fatturato su pochi clienti",
        scala: ["1 cliente (80%+)", "2-3 clienti (60%+)", "4-10 clienti (40%+)", "Diversificata", "Molto diversificata"],
        peso: 1.4,
        showIf: {}
    },
    {
        id: "B5",
        sezione: "Business & Strategia",
        testo: "Livello di innovazione e digitalizzazione aziendale?",
        help: "Investimenti in tecnologia, R&D, processi digitali",
        scala: ["Assente", "Minima", "In corso", "Avanzata", "Eccellenza"],
        peso: 1.0,
        showIf: {}
    },
    {
        id: "B6",
        sezione: "Business & Strategia",
        testo: "Presenza su mercati internazionali?",
        help: "Export, clienti esteri, sedi estere",
        scala: ["Solo Italia", "Export <10%", "Export 10-30%", "Export 30-50%", "Export >50%"],
        peso: 0.9,
        showIf: {
            dimensione: ["21-50", "51-100", "101-250", "251+"],
            settore: ["Manifatturiero", "Tecnologia", "Servizi"]
        }
    },
    
    // SEZIONE: Rischi e Sicurezza (6 domande)
    {
        id: "R1",
        sezione: "Rischi e Sicurezza",
        testo: "Procedure documentate per rischi operativi?",
        help: "Sicurezza lavoro, prevenzione incendi, emergenze",
        scala: ["Nessuna", "Parziali", "Adeguate", "Avanzate", "Certificate"],
        peso: 1.5,
        showIf: {
            dimensione: ["21-50", "51-100", "101-250", "251+"]
        }
    },
    {
        id: "R2",
        sezione: "Rischi e Sicurezza",
        testo: "Gestione rischi fornitori critici?",
        help: "Dipendenza da fornitori strategici, alternative",
        scala: ["Nessun controllo", "Minimo", "Base", "Strutturato", "Ottimale"],
        peso: 1.2,
        showIf: {
            settore: ["Manifatturiero", "Commercio", "Edilizia", "Logistica"]
        }
    },
    {
        id: "R3",
        sezione: "Rischi e Sicurezza",
        testo: "Livello protezione dati e cyber security?",
        help: "GDPR, backup, antivirus, formazione personale",
        scala: ["Assente", "Minima", "Base", "Avanzata", "Completa"],
        peso: 1.4,
        showIf: {
            settore: ["Tecnologia", "Servizi", "Sanità", "Commercio"]
        }
    },
    {
        id: "R4",
        sezione: "Rischi e Sicurezza",
        testo: "Coperture assicurative attuali?",
        help: "RC, incendio, furto, infortuni, cyber, etc.",
        scala: ["Nessuna", "Solo obbligatorie", "Base", "Buone", "Complete"],
        peso: 1.6,
        showIf: {}
    },
    {
        id: "R5",
        sezione: "Rischi e Sicurezza",
        testo: "Liquidità disponibile per emergenze?",
        help: "Riserve di cassa per eventi imprevisti",
        scala: ["< 1 mese", "1-3 mesi", "3-6 mesi", "6-12 mesi", "> 12 mesi"],
        peso: 1.3,
        showIf: {}
    },
    {
        id: "R6",
        sezione: "Rischi e Sicurezza",
        testo: "Esposizione a rischi ambientali e ESG?",
        help: "Impatto ambientale, sostenibilità, normative",
        scala: ["Molto alta", "Alta", "Media", "Bassa", "Minima"],
        peso: 1.1,
        showIf: {}
    },
    
    // SEZIONE: Governance e Persone (6 domande)
    {
        id: "G1",
        sezione: "Governance e Persone",
        testo: "Procedure di delega e responsabilità definite?",
        help: "Organigramma, ruoli, processi decisionali",
        scala: ["Assenti", "Minime", "Parziali", "Strutturate", "Formalizzate"],
        peso: 1.3,
        showIf: {
            dimensione: ["21-50", "51-100", "101-250", "251+"]
        }
    },
    {
        id: "G2",
        sezione: "Governance e Persone",
        testo: "Turnover del personale dipendente?",
        help: "Stabilità e retention dei dipendenti",
        scala: ["Altissimo (>30%)", "Alto (20-30%)", "Medio (10-20%)", "Basso (5-10%)", "Minimo (<5%)"],
        peso: 1.2,
        showIf: {
            dimensione: ["21-50", "51-100", "101-250", "251+"]
        }
    },
    {
        id: "G3",
        sezione: "Governance e Persone",
        testo: "Investimento in formazione e sviluppo personale?",
        help: "Training, aggiornamento professionale, crescita",
        scala: ["Assente", "Sporadica", "Annuale", "Continua", "Strutturata"],
        peso: 1.0,
        showIf: {
            dimensione: ["21-50", "51-100", "101-250", "251+"]
        }
    },
    {
        id: "G4",
        sezione: "Governance e Persone",
        testo: "Dipendenza da figure chiave?",
        help: "Rischio operativo se mancano persone specifiche",
        scala: ["Totale", "Molto alta", "Media", "Bassa", "Nessuna"],
        peso: 1.4,
        showIf: {}
    },
    {
        id: "G5",
        sezione: "Governance e Persone",
        testo: "Piani di successione aziendale?",
        help: "Preparazione per passaggio generazionale",
        scala: ["Nessuno", "Informale", "In sviluppo", "Definito", "Attuato"],
        peso: 1.3,
        showIf: {
            formaGiuridica: ["Ditta Individuale", "SNC", "SAS"]
        }
    },
    {
        id: "G6",
        sezione: "Governance e Persone",
        testo: "Clima aziendale e benessere dei dipendenti?",
        help: "Soddisfazione, welfare, ambiente di lavoro",
        scala: ["Critico", "Scarso", "Accettabile", "Buono", "Ottimo"],
        peso: 1.0,
        showIf: {
            dimensione: ["21-50", "51-100", "101-250", "251+"]
        }
    },
    
    // SEZIONE: Finanza (6 domande)
    {
        id: "F1",
        sezione: "Finanza",
        testo: "Liquidità e gestione dei flussi di cassa?",
        help: "Cash conversion cycle, previsioni finanziarie",
        scala: ["Molto scarsa", "Scarsa", "Adeguata", "Solida", "Eccellente"],
        peso: 1.4,
        showIf: {}
    },
    {
        id: "F2",
        sezione: "Finanza",
        testo: "Dipendenza da finanziamenti esterni?",
        help: "Livello di indebitamento, autonomia finanziaria",
        scala: ["Totale", "Alta", "Media", "Bassa", "Autofinanziamento"],
        peso: 1.3,
        showIf: {}
    },
    {
        id: "F3",
        sezione: "Finanza",
        testo: "Sistema di controllo di gestione e KPI?",
        help: "Monitoraggio performance economiche e operative",
        scala: ["Assente", "Annuale", "Trimestrale", "Mensile", "Real-time"],
        peso: 1.1,
        showIf: {
            dimensione: ["21-50", "51-100", "101-250", "251+"]
        }
    },
    {
        id: "F4",
        sezione: "Finanza",
        testo: "Marginalità e redditività aziendale?",
        help: "EBITDA, ROE, profittabilità generale",
        scala: ["Negativa", "Scarsa (<5%)", "Media (5-10%)", "Buona (10-20%)", "Eccellente (>20%)"],
        peso: 1.5,
        showIf: {}
    },
    {
        id: "F5",
        sezione: "Finanza",
        testo: "Diversificazione delle fonti di ricavo?",
        help: "Numero di prodotti/servizi, mix revenue",
        scala: ["Monolinea", "2-3 prodotti", "Diversificata", "Molto diversificata", "Portfolio ampio"],
        peso: 1.1,
        showIf: {}
    },
    {
        id: "F6",
        sezione: "Finanza",
        testo: "Tempi medi di incasso crediti commerciali (DSO)?",
        help: "Days Sales Outstanding, gestione crediti",
        scala: ["Critici (>180gg)", "Lunghi (90-180gg)", "Medi (60-90gg)", "Brevi (30-60gg)", "Rapidi (<30gg)"],
        peso: 1.2,
        showIf: {}
    }
];

console.log('%c✅ SEZIONE 6/15 COMPLETATA: Database 24 Domande Adattive', 'color: #10B981; font-weight: bold; font-size: 14px');
console.log(`📋 ${DOMANDE_ADATTIVE.length} domande caricate con successo`);

// ========================================
// SEZIONE 7/15: SISTEMA ADATTIVO COMPLETO
// ========================================

// ========================================
// GENERAZIONE DOMANDE ADATTIVE
// ========================================

function generaDomandeAdattive() {
    const profilo = appState.profilo;
    
    console.log('%c🧠 GENERAZIONE DOMANDE ADATTIVE', 'color: #8B5CF6; font-weight: bold; font-size: 14px');
    console.log('Profilo:', profilo);
    
    // Filtra domande basandosi sul profilo aziendale
    const domandeFiltrate = DOMANDE_ADATTIVE.filter(domanda => {
        const condizioni = domanda.showIf || {};
        
        // Se non ci sono condizioni, mostra sempre
        if (Object.keys(condizioni).length === 0) return true;
        
        // Verifica ogni condizione
        for (const [campo, valoriAccettati] of Object.entries(condizioni)) {
            const valoreProfilo = profilo[campo];
            
            // Se il profilo ha un valore per questo campo e non è nella lista accettata, escludi
            if (valoreProfilo && !valoriAccettati.includes(valoreProfilo)) {
                return false;
            }
        }
        
        return true;
    });
    
    appState.questionario.domandeFiltrate = domandeFiltrate;
    
    console.log(`✅ Domande filtrate: ${domandeFiltrate.length}/24`);
    console.log('Distribuzione per sezione:');
    const distribuzione = {};
    domandeFiltrate.forEach(d => {
        distribuzione[d.sezione] = (distribuzione[d.sezione] || 0) + 1;
    });
    console.table(distribuzione);
    
    // Renderizza le domande
    renderizzaDomande(domandeFiltrate);
    
    // Aggiorna progress bar
    aggiornaProgressBar();
}

// ========================================
// RENDERING DOMANDE
// ========================================

function renderizzaDomande(domande) {
    const container = document.getElementById('questionarioContainer');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (domande.length === 0) {
        container.innerHTML = `
            <div class="alert alert-warning">
                ⚠️ Nessuna domanda disponibile per questo profilo. 
                Verifica i dati aziendali inseriti.
            </div>
        `;
        return;
    }
    
    domande.forEach((domanda, index) => {
        const card = document.createElement('div');
        card.className = 'question-card';
        card.setAttribute('data-question-id', domanda.id);
        
        card.innerHTML = `
            <div class="question-header">
                <span class="question-number">${index + 1}</span>
                <span class="question-section">${domanda.sezione}</span>
                <span class="question-peso">Peso: ${domanda.peso.toFixed(1)}</span>
            </div>
            <div class="question-text">${domanda.testo}</div>
            ${domanda.help ? `<div class="question-help">💡 ${domanda.help}</div>` : ''}
            <div class="likert-scale">
                ${domanda.scala.map((label, i) => `
                    <div class="likert-option">
                        <input type="radio" 
                               name="${domanda.id}" 
                               id="${domanda.id}_${i + 1}" 
                               value="${i + 1}" 
                               onchange="salvaRisposta('${domanda.id}', ${i + 1})">
                        <label for="${domanda.id}_${i + 1}">
                            <div class="likert-number">${i + 1}</div>
                            <div class="likert-label">${label}</div>
                        </label>
                    </div>
                `).join('')}
            </div>
        `;
        
        container.appendChild(card);
    });
    
    // Ripristina risposte esistenti
    Object.keys(appState.questionario.risposte).forEach(idDomanda => {
        const valore = appState.questionario.risposte[idDomanda];
        const radio = document.getElementById(`${idDomanda}_${valore}`);
        if (radio) {
            radio.checked = true;
        }
    });
    
    console.log('✅ Domande renderizzate con successo');
}

// ========================================
// SALVATAGGIO RISPOSTE
// ========================================

function salvaRisposta(idDomanda, valore) {
    appState.questionario.risposte[idDomanda] = Number(valore);
    
    // Aggiorna progress bar
    aggiornaProgressBar();
    
    // Evidenzia la domanda completata
    const card = document.querySelector(`[data-question-id="${idDomanda}"]`);
    if (card) {
        card.style.borderColor = 'var(--green)';
        card.style.background = 'var(--green-light)';
        
        setTimeout(() => {
            card.style.background = 'var(--gray-50)';
        }, 500);
    }
    
    // Auto-save
    if (appState.autoSave) {
        setTimeout(autoSave, 1000);
    }
    
    console.log(`Risposta salvata: ${idDomanda} = ${valore}`);
}

// ========================================
// PROGRESS BAR
// ========================================

function aggiornaProgressBar() {
    const totaleDomande = appState.questionario.domandeFiltrate.length || 0;
    const risposteDate = Object.keys(appState.questionario.risposte).filter(id => 
        appState.questionario.domandeFiltrate.find(d => d.id === id)
    ).length;
    
    const percentuale = totaleDomande > 0 ? Math.round((risposteDate / totaleDomande) * 100) : 0;
    
    const progressBar = document.getElementById('progressBar');
    if (progressBar) {
        progressBar.style.width = percentuale + '%';
        progressBar.textContent = percentuale + '%';
        
        // Cambia colore in base alla percentuale
        if (percentuale === 100) {
            progressBar.style.background = 'linear-gradient(90deg, var(--green), var(--green-dark))';
            progressBar.classList.remove('animated');
        } else if (percentuale >= 70) {
            progressBar.style.background = 'linear-gradient(90deg, var(--yellow), var(--orange))';
            progressBar.classList.add('animated');
        } else {
            progressBar.style.background = 'linear-gradient(90deg, var(--generali-blue), var(--generali-light-blue))';
            progressBar.classList.add('animated');
        }
    }
    
    // Aggiorna stato completamento
    appState.questionario.completato = (percentuale === 100);
    
    if (percentuale === 100) {
        showToast('🎉 Questionario completato!', 'success', 3000);
    }
}

// ========================================
// CALCOLO PUNTEGGI PONDERATI
// ========================================

function calcolaPunteggioPonderato(risposte, domande) {
    let sommaPesata = 0;
    let sommaPesi = 0;
    
    for (const domanda of domande) {
        const valore = Number(risposte[domanda.id] || 0);
        const peso = Number(domanda.peso || 1.0);
        
        if (valore > 0) {
            sommaPesata += valore * peso;
            sommaPesi += peso;
        }
    }
    
    return sommaPesi > 0 ? (sommaPesata / sommaPesi) : 0;
}

function calcolaPunteggiPerSezione(risposte, domande) {
    const sezioni = {};
    
    for (const domanda of domande) {
        const sezione = domanda.sezione || "Altra Sezione";
        
        if (!sezioni[sezione]) {
            sezioni[sezione] = { sommaPesata: 0, sommaPesi: 0, count: 0 };
        }
        
        const valore = Number(risposte[domanda.id] || 0);
        const peso = Number(domanda.peso || 1.0);
        
        if (valore > 0) {
            sezioni[sezione].sommaPesata += valore * peso;
            sezioni[sezione].sommaPesi += peso;
            sezioni[sezione].count++;
        }
    }
    
    const punteggi = {};
    for (const [sezione, dati] of Object.entries(sezioni)) {
        punteggi[sezione] = dati.sommaPesi > 0 ? (dati.sommaPesata / dati.sommaPesi) : 0;
    }
    
    return punteggi;
}

console.log('%c✅ SEZIONE 7/15 COMPLETATA: Sistema Adattivo Completo', 'color: #10B981; font-weight: bold; font-size: 14px');

// ========================================
// SEZIONE 8/15: NORMOTIPI DINAMICI (Sistema File 3)
// ========================================

function identificaNormotipoAziendale(companyData, punteggioGlobale, punteggiSezioni) {
    const dimensione = companyData.datiSocietari.numeroDipendenti || '';
    const settore = companyData.datiSocietari.settore || '';
    const fatturato = companyData.datiSocietari.fatturatoAnnuo || '';
    
    let normotipo = {
        profilo: '',
        caratteristiche: [],
        priorita: {},
        descrizione: ''
    };
    
    // CLASSIFICAZIONE PER DIMENSIONE
    if (dimensione === '1-5') {
        normotipo.profilo = 'MICROIMPRESA';
        normotipo.caratteristiche = [
            'Struttura semplice',
            'Decisioni rapide',
            'Flessibilità operativa',
            'Dipendenza da titolare'
        ];
        normotipo.descrizione = 'Microimpresa con struttura organizzativa semplice, alta flessibilità ma forte dipendenza dalla figura del titolare.';
        normotipo.priorita = {
            key_man: 95,
            rc_generale: 85,
            infortuni_dipendenti: 80,
            tutela_legale: 75,
            interruzione_attivita: 70,
            cyber: 60,
            patrimonio: 85,
            malattia_titolare: 90
        };
    } else if (dimensione === '6-20') {
        normotipo.profilo = 'PICCOLA IMPRESA IN CRESCITA';
        normotipo.caratteristiche = [
            'Struttura in sviluppo',
            'Prime deleghe',
            'Crescita dimensionale',
            'Necessità di strutturazione'
        ];
        normotipo.descrizione = 'Piccola impresa in fase di crescita, con prime deleghe operative ma ancora forte centralizzazione decisionale.';
        normotipo.priorita = {
            rc_generale: 90,
            key_man: 85,
            interruzione_attivita: 80,
            infortuni_dipendenti: 85,
            tutela_legale: 80,
            cyber: 70,
            credito: 75,
            flotte: 65
        };
    } else if (dimensione === '21-50') {
        normotipo.profilo = 'MEDIA IMPRESA STRUTTURATA';
        normotipo.caratteristiche = [
            'Organizzazione definita',
            'Deleghe operative',
            'Processi standardizzati',
            'Rischi diversificati'
        ];
        normotipo.descrizione = 'Media impresa con organizzazione strutturata, processi definiti e necessità di protezioni complete e articolate.';
        normotipo.priorita = {
            rc_generale: 95,
            interruzione_attivita: 90,
            infortuni_dipendenti: 90,
            cyber: 85,
            tutela_legale: 85,
            key_man: 75,
            credito: 80,
            do: 70,
            flotte: 75,
            merci: 70
        };
    } else if (dimensione === '51-100' || dimensione === '101-250' || dimensione === '251+') {
        normotipo.profilo = 'GRANDE IMPRESA';
        normotipo.caratteristiche = [
            'Struttura complessa',
            'Governance articolata',
            'Rischi enterprise',
            'Esposizioni significative'
        ];
        normotipo.descrizione = 'Grande impresa con struttura organizzativa complessa, governance articolata e necessità di soluzioni assicurative enterprise.';
        normotipo.priorita = {
            rc_generale: 95,
            rc_prodotti: 90,
            interruzione_attivita: 95,
            cyber: 95,
            do: 90,
            infortuni_dipendenti: 90,
            tutela_legale: 85,
            credito: 85,
            ambientale: 80,
            flotte: 80,
            merci: 75,
            key_man: 70
        };
    }
    
    // PERSONALIZZAZIONE PER SETTORE
    if (settore === 'Edilizia') {
        normotipo.profilo += ' - SETTORE EDILIZIA';
        normotipo.caratteristiche.push('Settore ad alto rischio infortuni');
        normotipo.caratteristiche.push('Rischio RC elevato');
        normotipo.priorita.rc_generale = 95;
        normotipo.priorita.infortuni_dipendenti = 95;
        normotipo.priorita.tutela_legale = 85;
        normotipo.priorita.car = 90;
    } else if (settore === 'Tecnologia') {
        normotipo.profilo += ' - SETTORE IT';
        normotipo.caratteristiche.push('Alto rischio cyber');
        normotipo.caratteristiche.push('Dipendenza da dati');
        normotipo.priorita.cyber = 95;
        normotipo.priorita.rc_professionale = 90;
        normotipo.priorita.key_man = 85;
    } else if (settore === 'Sanità') {
        normotipo.profilo += ' - SETTORE SANITÀ';
        normotipo.caratteristiche.push('Rischio RC professionale elevato');
        normotipo.caratteristiche.push('Protezione dati sensibili');
        normotipo.priorita.rc_professionale = 95;
        normotipo.priorita.tutela_legale = 90;
        normotipo.priorita.cyber = 90;
    } else if (settore === 'Manifatturiero') {
        normotipo.profilo += ' - MANIFATTURIERO';
        normotipo.caratteristiche.push('Rischio operativo e prodotti');
        normotipo.caratteristiche.push('Dipendenza da fornitori');
        normotipo.priorita.rc_prodotti = 90;
        normotipo.priorita.interruzione_attivita = 90;
        normotipo.priorita.fornitori = 85;
    } else if (settore === 'Commercio') {
        normotipo.profilo += ' - COMMERCIO';
        normotipo.caratteristiche.push('Rischio merci e magazzino');
        normotipo.caratteristiche.push('RC prodotti');
        normotipo.priorita.merci = 90;
        normotipo.priorita.rc_prodotti = 85;
        normotipo.priorita.furto = 85;
    } else if (settore === 'Ristorazione') {
        normotipo.profilo += ' - HORECA';
        normotipo.caratteristiche.push('Rischio igiene e sicurezza alimentare');
        normotipo.caratteristiche.push('RC verso clienti');
        normotipo.priorita.rc_generale = 95;
        normotipo.priorita.interruzione_attivita = 90;
        normotipo.priorita.tutela_legale = 85;
    } else if (settore === 'Logistica') {
        normotipo.profilo += ' - LOGISTICA/TRASPORTI';
        normotipo.caratteristiche.push('Rischio flotte e merci');
        normotipo.caratteristiche.push('RC trasportatore');
        normotipo.priorita.flotte = 95;
        normotipo.priorita.merci = 95;
        normotipo.priorita.rc_generale = 90;
    }
    
    // AGGIUSTAMENTI PER FATTURATO
    if (fatturato === '> 50M') {
        normotipo.caratteristiche.push('Elevato valore patrimoniale');
        Object.keys(normotipo.priorita).forEach(key => {
            normotipo.priorita[key] = Math.min(95, normotipo.priorita[key] + 5);
        });
    }
    
    // Calcola confidenza basata su completezza dati
    const confidenza = calcolaConfidenzaNormotipo(companyData, punteggioGlobale);
    
    console.log('🧠 Normotipo identificato:', normotipo.profilo);
    console.log('Confidenza:', confidenza + '%');
    
    return {
        normotipo: normotipo,
        confidenza: confidenza
    };
}

function calcolaConfidenzaNormotipo(companyData, punteggioGlobale) {
    let confidenza = 70; // Base
    
    // Aumenta confidenza se abbiamo dati completi
    if (companyData.datiSocietari.numeroDipendenti) confidenza += 10;
    if (companyData.datiSocietari.settore) confidenza += 10;
    if (companyData.datiSocietari.fatturatoAnnuo) confidenza += 5;
    if (punteggioGlobale > 0) confidenza += 5;
    
    return Math.min(confidenza, 100);
}

console.log('%c✅ SEZIONE 8/15 COMPLETATA: Normotipi Dinamici', 'color: #10B981; font-weight: bold; font-size: 14px');

// ========================================
// SEZIONE 9/15: 8 BIAS COGNITIVI COMPLETI
// ========================================

// Database completo Bias Cognitivi
const BIAS_COGNITIVI = [
    {
        id: "OVERCONFIDENCE",
        nome: "Overconfidence Bias",
        descrizione: "Eccessiva fiducia nelle proprie capacità di gestione del rischio. Sovrastima della propria preparazione e sottostima dei rischi reali.",
        segnali: ["Punteggi molto alti (4-5) senza giustificazione oggettiva", "Disallineamento tra percezione e realtà operativa"],
        impatto: "Sottovalutazione delle necessità di protezione assicurativa, esposizione a rischi non coperti",
        contromisure: ["Analisi oggettiva con benchmark di settore", "Stress test su scenari critici", "Confronto con dati statistici reali"]
    },
    {
        id: "STATUS_QUO",
        nome: "Status Quo Bias",
        descrizione: "Forte preferenza per mantenere la situazione attuale, resistenza al cambiamento anche quando necessario.",
        segnali: ["Nessuna revisione polizze da anni", "Rifiuto di innovazione nelle coperture", "Risposte uniformi senza variazione"],
        impatto: "Gap di protezione crescente nel tempo, coperture obsolete non adeguate ai rischi attuali",
        contromisure: ["Gap analysis periodica strutturata", "Review annuale obbligatoria", "Educazione sui rischi emergenti"]
    },
    {
        id: "AVAILABILITY",
        nome: "Availability Bias",
        descrizione: "Sovrastima dei rischi recenti o visibili nei media, sottostima dei rischi meno evidenti ma statisticamente più probabili.",
        segnali: ["Focus esclusivo su rischi mediatici (es. solo cyber)", "Ignorare rischi statisticamente rilevanti ma meno noti"],
        impatto: "Portfolio assicurativo squilibrato, protezione inadeguata su rischi reali",
        contromisure: ["Analisi statistica storica dei sinistri", "Matrice rischi completa con probabilità oggettive", "Prioritizzazione data-driven"]
    },
    {
        id: "CONFIRMATION",
        nome: "Confirmation Bias",
        descrizione: "Tendenza a cercare e interpretare informazioni che confermano le proprie convinzioni pre-esistenti.",
        segnali: ["Rifiuto sistematico di evidenze contrarie", "Attenzione selettiva solo su dati che confermano la visione attuale"],
        impatto: "Resistenza a nuove soluzioni assicurative vantaggiose, mancato adeguamento del portfolio",
        contromisure: ["Consulenza indipendente esterna", "Revisione periodica con terze parti", "Analisi basata su dati oggettivi"]
    },
    {
        id: "SUNK_COST",
        nome: "Sunk Cost Fallacy",
        descrizione: "Mantenimento di decisioni passate per giustificare investimenti già effettuati, anche se non più convenienti.",
        segnali: ["Rinnovo automatico polizze obsolete", "Fedeltà irrazionale a soluzioni non più competitive"],
        impatto: "Costi eccessivi, protezioni inadeguate, mancato risparmio",
        contromisure: ["Analisi zero-based annuale", "Confronto aperto mercato", "Calcolo ROI assicurativo effettivo"]
    },
    {
        id: "ANCHORING",
        nome: "Anchoring Bias",
        descrizione: "Eccessivo affidamento sulla prima informazione ricevuta (ancora) che influenza tutte le valutazioni successive.",
        segnali: ["Premio iniziale come riferimento fisso immutabile", "Difficoltà ad aggiornare percezione del valore"],
        impatto: "Valutazione distorta del rapporto costi-benefici, decisioni subottimali",
        contromisure: ["Richiedere multiple quotazioni indipendenti", "Analisi comparativa strutturata", "Benchmarking settoriale"]
    },
    {
        id: "RECENCY",
        nome: "Recency Bias",
        descrizione: "Attribuzione di maggior peso a eventi recenti rispetto a quelli più distanti nel tempo.",
        segnali: ["Reazione solo immediatamente dopo sinistri", "Memoria corta dei rischi passati"],
        impatto: "Protezione ciclica e inadeguata, sottostima rischi con bassa frequenza ma alto impatto",
        contromisure: ["Mantenere storico sinistri completo", "Trend analysis pluriennale", "Pianificazione assicurativa a lungo termine"]
    },
    {
        id: "OPTIMISM",
        nome: "Optimism Bias",
        descrizione: "Tendenza sistematica a sottostimare la probabilità che eventi negativi accadano alla propria azienda.",
        segnali: ["Mentalità 'a me non capiterà mai'", "Sottostima frequenza sinistri del settore"],
        impatto: "Sotto-assicurazione cronica, esposizione critica a eventi avversi",
        contromisure: ["Presentazione dati settoriali concreti", "Casi studio di aziende simili", "Scenario analysis con probabilità realistiche"]
    }
];

// ========================================
// RILEVAMENTO BIAS AUTOMATICO
// ========================================

function rilevaBiasCognitivi(risposte, punteggioGlobale, punteggiSezioni, domandeFiltrate) {
    const biasRilevati = [];
    
    const valoriRisposte = Object.values(risposte);
    if (valoriRisposte.length === 0) return biasRilevati;
    
    const mediaRisposte = valoriRisposte.reduce((a, b) => a + b, 0) / valoriRisposte.length;
    const varianza = valoriRisposte.reduce((sum, val) => sum + Math.pow(val - mediaRisposte, 2), 0) / valoriRisposte.length;
    
    // OVERCONFIDENCE: tutti punteggi molto alti
    const risposteAlte = valoriRisposte.filter(v => v >= 4).length;
    const percAlte = risposteAlte / valoriRisposte.length;
    if (percAlte > 0.7) {
        const bias = BIAS_COGNITIVI.find(b => b.id === "OVERCONFIDENCE");
        biasRilevati.push({
            ...bias,
            intensita: percAlte > 0.85 ? "ALTA" : "MEDIA",
            dettaglio: `${Math.round(percAlte * 100)}% delle risposte sono 4-5`
        });
    }
    
    // STATUS QUO: punteggi tutti medi, poca varianza
    if (varianza < 0.5 && mediaRisposte > 2.5 && mediaRisposte < 3.5) {
        const bias = BIAS_COGNITIVI.find(b => b.id === "STATUS_QUO");
        biasRilevati.push({
            ...bias,
            intensita: "MEDIA",
            dettaglio: `Varianza bassissima (${varianza.toFixed(2)}), risposte uniformi`
        });
    }
    
    // OPTIMISM: Rischi bassi ma business alto
    if (punteggiSezioni["Rischi e Sicurezza"] && punteggiSezioni["Business & Strategia"]) {
        const gap = punteggiSezioni["Business & Strategia"] - punteggiSezioni["Rischi e Sicurezza"];
        if (gap > 1.5) {
            const bias = BIAS_COGNITIVI.find(b => b.id === "OPTIMISM");
            biasRilevati.push({
                ...bias,
                intensita: gap > 2.0 ? "ALTA" : "MEDIA",
                dettaglio: `Gap ${gap.toFixed(1)} punti tra Business e Rischi`
            });
        }
    }
    
    // SUNK COST: dipendenza finanziamenti alta + marginalità bassa
    if (risposte.F2 && risposte.F4) {
        if (risposte.F2 >= 4 && risposte.F4 <= 2) {
            const bias = BIAS_COGNITIVI.find(b => b.id === "SUNK_COST");
            biasRilevati.push({
                ...bias,
                intensita: "MEDIA",
                dettaglio: "Alta dipendenza finanziamenti + bassa marginalità"
            });
        }
    }
    
    // RECENCY: coperture attuali basse
    if (risposte.R4 && risposte.R4 <= 2) {
        const bias = BIAS_COGNITIVI.find(b => b.id === "RECENCY");
        biasRilevati.push({
            ...bias,
            intensita: "BASSA",
            dettaglio: "Coperture assicurative minime o assenti"
        });
    }
    
    // AVAILABILITY: focus sproporzionato su cyber vs altri rischi
    if (risposte.R3 && risposte.R3 >= 4 && risposte.R4 && risposte.R4 <= 2) {
        const bias = BIAS_COGNITIVI.find(b => b.id === "AVAILABILITY");
        biasRilevati.push({
            ...bias,
            intensita: "MEDIA",
            dettaglio: "Focus cyber ma coperture generali basse"
        });
    }
    
    // CONFIRMATION: risposte estremamente polarizzate (solo 1-2 o solo 4-5)
    const risposteBasse = valoriRisposte.filter(v => v <= 2).length;
    const risposteAltissime = valoriRisposte.filter(v => v >= 4).length;
    const polarizzazione = (risposteBasse + risposteAltissime) / valoriRisposte.length;
    if (polarizzazione > 0.8 && valoriRisposte.length > 5) {
        const bias = BIAS_COGNITIVI.find(b => b.id === "CONFIRMATION");
        biasRilevati.push({
            ...bias,
            intensita: "MEDIA",
            dettaglio: `${Math.round(polarizzazione * 100)}% risposte polarizzate (estremi)`
        });
    }
    
    console.log(`⚠️ Bias rilevati: ${biasRilevati.length}`);
    biasRilevati.forEach(b => console.log(`  - ${b.nome} (${b.intensita})`));
    
    return biasRilevati;
}

console.log('%c✅ SEZIONE 9/15 COMPLETATA: 8 Bias Cognitivi', 'color: #10B981; font-weight: bold; font-size: 14px');

// ========================================
// SEZIONE 10/15: 10 SCENARI STRESS COMPLETI (PARTE 1/2)
// ========================================

function simulaScenariStressAziendali(companyData, risposte, punteggiSezioni) {
    const scenari = [];
    
    // Estrai dati aziendali
    const fatturato = estraiFatturatoNumerico(companyData.datiSocietari.fatturatoAnnuo);
    const dipendenti = estraiNumeroDipendenti(companyData.datiSocietari.numeroDipendenti);
    const settore = companyData.datiSocietari.settore;
    
    console.log('%c🌪️ SIMULAZIONE SCENARI STRESS', 'color: #F97316; font-weight: bold; font-size: 14px');
    console.log('Fatturato:', fatturato.toLocaleString(), '€');
    console.log('Dipendenti:', dipendenti);
    console.log('Settore:', settore);
    
    // ===========================================
    // SCENARIO 1: PERDITA KEY PERSON
    // ===========================================
    {
        const dipendenzaKeyPerson = risposte.G4 || 3;
        let impattoPerdita = 0;
        
        if (dipendenzaKeyPerson === 1) impattoPerdita = fatturato * 1.0;
        else if (dipendenzaKeyPerson === 2) impattoPerdita = fatturato * 0.7;
        else if (dipendenzaKeyPerson === 3) impattoPerdita = fatturato * 0.4;
        else if (dipendenzaKeyPerson === 4) impattoPerdita = fatturato * 0.2;
        else impattoPerdita = fatturato * 0.05;
        
        const costiStruttura = fatturato * 0.6;
        const impattoPrimoAnno = impattoPerdita * 0.5 + costiStruttura * 0.5;
        const coperturaKeyMan = 0; // Da configurare
        const scoperturaKeyPerson = Math.max(0, impattoPrimoAnno - coperturaKeyMan);
        
        scenari.push({
            id: 'key_person_loss',
            titolo: 'Perdita improvvisa Key Person',
            descrizione: 'Decesso o inabilità permanente dell\'amministratore o socio operativo chiave',
            icon: '🔑',
            probabilita: dipendenzaKeyPerson <= 2 ? 'alta' : dipendenzaKeyPerson <= 3 ? 'media' : 'bassa',
            probabilitaPerc: dipendenzaKeyPerson <= 2 ? 15 : dipendenzaKeyPerson <= 3 ? 8 : 3,
            impatto: impattoPrimoAnno,
            copertura: coperturaKeyMan,
            scoperta: scoperturaKeyPerson,
            gravita: scoperturaKeyPerson > fatturato * 0.5 ? 'catastrofica' :
                     scoperturaKeyPerson > fatturato * 0.25 ? 'critica' : 'significativa',
            dettagli: [
                `Dipendenza: ${dipendenzaKeyPerson}/5`,
                `Perdita fatturato 12m: €${impattoPerdita.toLocaleString()}`,
                `Impatto economico: €${impattoPrimoAnno.toLocaleString()}`,
                `Esposizione netta: €${scoperturaKeyPerson.toLocaleString()}`
            ],
            raccomandazioni: [
                'Key Man Insurance adeguata',
                'Documentare processi critici',
                'Formare sostituti/backup',
                'Piano continuità aziendale'
            ]
        });
    }
    
    // ===========================================
    // SCENARIO 2: INCENDIO/CALAMITÀ SEDE
    // ===========================================
    {
        const valoreSede = fatturato * 0.8; // Stima valore immobile/attrezzature
        const costiRipristino = valoreSede * 0.7;
        const perditaRedditizia6Mesi = fatturato * 0.5 * 0.7; // 6 mesi al 70%
        const costiExtra = fatturato * 0.15; // Sedi temporanee, traslochi
        
        const impatto = costiRipristino + perditaRedditizia6Mesi + costiExtra;
        const coperturaIncendio = valoreSede * 0.6; // Sottostima tipica
        const scoperta = Math.max(0, impatto - coperturaIncendio);
        
        scenari.push({
            id: 'incendio_calamita',
            titolo: 'Incendio o calamità naturale sede',
            descrizione: 'Distruzione totale o parziale della sede principale con interruzione attività',
            icon: '🔥',
            probabilita: settore === 'Manifatturiero' || settore === 'Logistica' ? 'media' : 'bassa',
            probabilitaPerc: settore === 'Manifatturiero' ? 5 : 2,
            impatto: impatto,
            copertura: coperturaIncendio,
            scoperta: scoperta,
            gravita: scoperta > fatturato * 0.5 ? 'catastrofica' : scoperta > fatturato * 0.25 ? 'critica' : 'significativa',
            dettagli: [
                `Valore sede/attrezzature: €${valoreSede.toLocaleString()}`,
                `Costi ripristino: €${costiRipristino.toLocaleString()}`,
                `Perdita redditizia 6m: €${perditaRedditizia6Mesi.toLocaleString()}`,
                `Costi extra: €${costiExtra.toLocaleString()}`,
                `Impatto totale: €${impatto.toLocaleString()}`
            ],
            raccomandazioni: [
                'Polizza incendio adeguata al valore a nuovo',
                'Business Interruption per perdita redditizia',
                'Copertura spese extra (sedi temporanee)',
                'Piano emergenza e business continuity'
            ]
        });
    }
    
    // ===========================================
    // SCENARIO 3: CYBER ATTACK / RANSOMWARE
    // ===========================================
    {
        const cybersecurity = risposte.R3 || 3;
        const costiRipristino = 50000 + (dipendenti * 500); // Consulenza IT
        const ransom = 30000 + (fatturato * 0.001); // Richiesta riscatto
        const perditaDati = fatturato * 0.1; // Perdita dati clienti/fornitori
        const interruzione5Giorni = (fatturato / 250) * 5; // 5 giorni lavorativi
        const dannoReputazionale = fatturato * 0.15;
        const multaGDPR = dipendenti > 50 ? 50000 : 10000;
        
        const impatto = costiRipristino + ransom + perditaDati + interruzione5Giorni + dannoReputazionale + multaGDPR;
        const coperturaCyber = 0;
        const scoperta = impatto - coperturaCyber;
        
        const prob = settore === 'Tecnologia' ? 25 : settore === 'Servizi' ? 15 : 10;
        
        scenari.push({
            id: 'cyber_attack',
            titolo: 'Cyber Attack / Ransomware',
            descrizione: 'Attacco informatico con crittografia dati, richiesta riscatto, violazione GDPR',
            icon: '🔒',
            probabilita: prob > 20 ? 'alta' : prob > 10 ? 'media' : 'bassa',
            probabilitaPerc: prob,
            impatto: impatto,
            copertura: coperturaCyber,
            scoperta: scoperta,
            gravita: 'critica',
            dettagli: [
                `Cyber security attuale: ${cybersecurity}/5`,
                `Costi ripristino IT: €${costiRipristino.toLocaleString()}`,
                `Richiesta riscatto: €${ransom.toLocaleString()}`,
                `Interruzione 5gg: €${interruzione5Giorni.toLocaleString()}`,
                `Danno reputazionale: €${dannoReputazionale.toLocaleString()}`,
                `Multa GDPR: €${multaGDPR.toLocaleString()}`
            ],
            raccomandazioni: [
                'Cyber Risk Insurance completa',
                'Backup offsite e disaster recovery',
                'Formazione anti-phishing dipendenti',
                'Audit sicurezza periodici',
                'Copertura violazioni GDPR'
            ]
        });
    }
    
    // ===========================================
    // SCENARIO 4: CAUSA LEGALE RC IMPORTANTE
    // ===========================================
    {
        const massimaleRC = fatturato * 2; // Massimale tipico
        const risarcimentoMedio = settore === 'Edilizia' ? 500000 :
                                  settore === 'Sanità' ? 800000 :
                                  settore === 'Manifatturiero' ? 400000 : 200000;
        const speseLegali = 80000;
        const dannoReputazionale = fatturato * 0.1;
        
        const impatto = risarcimentoMedio + speseLegali + dannoReputazionale;
        const coperturaRC = Math.min(impatto, massimaleRC);
        const scoperta = Math.max(0, impatto - coperturaRC);
        
        scenari.push({
            id: 'rc_legale',
            titolo: 'Causa RC con risarcimento importante',
            descrizione: 'Responsabilità civile verso terzi con richiesta risarcimento significativa',
            icon: '⚖️',
            probabilita: settore === 'Edilizia' || settore === 'Sanità' ? 'media' : 'bassa',
            probabilitaPerc: settore === 'Edilizia' ? 12 : settore === 'Sanità' ? 10 : 5,
            impatto: impatto,
            copertura: coperturaRC,
            scoperta: scoperta,
            gravita: scoperta > 100000 ? 'critica' : scoperta > 50000 ? 'significativa' : 'gestibile',
            dettagli: [
                `Risarcimento medio settore: €${risarcimentoMedio.toLocaleString()}`,
                `Spese legali: €${speseLegali.toLocaleString()}`,
                `Danno reputazionale: €${dannoReputazionale.toLocaleString()}`,
                `Massimale RC attuale: €${massimaleRC.toLocaleString()}`
            ],
            raccomandazioni: [
                'RC Generale con massimali adeguati',
                'RC Prodotti se applicabile',
                'Tutela Legale inclusa',
                'Revisione massimali annuale',
                'Clausole specifiche settore'
            ]
        });
    }
    
    // ===========================================
    // SCENARIO 5: INTERRUZIONE ATTIVITÀ 3 MESI
    // ===========================================
    {
        const fatturato3Mesi = fatturato * 0.25;
        const costiFissi3Mesi = fatturato3Mesi * 0.7; // Costi fissi continuano
        const perditaMargine = fatturato3Mesi * 0.25; // EBITDA perso
        const costiExtra = fatturato * 0.05; // Soluzioni temporanee
        
        const impatto = costiFissi3Mesi + perditaMargine + costiExtra;
        const coperturaBI = 0;
        const scoperta = impatto - coperturaBI;
        
        scenari.push({
            id: 'interruzione_attivita',
            titolo: 'Interruzione attività 3 mesi',
            descrizione: 'Blocco operativo prolungato per cause diverse (guasto, fornitore, autorità)',
            icon: '⏸️',
            probabilita: 'media',
            probabilitaPerc: 8,
            impatto: impatto,
            copertura: coperturaBI,
            scoperta: scoperta,
            gravita: scoperta > fatturato * 0.2 ? 'critica' : 'significativa',
            dettagli: [
                `Fatturato 3 mesi: €${fatturato3Mesi.toLocaleString()}`,
                `Costi fissi 3m: €${costiFissi3Mesi.toLocaleString()}`,
                `Perdita margine: €${perditaMargine.toLocaleString()}`,
                `Costi extra: €${costiExtra.toLocaleString()}`,
                `Impatto totale: €${impatto.toLocaleString()}`
            ],
            raccomandazioni: [
                'Business Interruption Insurance',
                'Copertura perdita redditizia',
                'Inclusione guasti macchinari',
                'Copertura fornitori critici',
                'Piano continuità operativa'
            ]
        });
    }
    
    return scenari; // Continua con altri 5 scenari nella parte 2
}

// Funzioni helper
function estraiFatturatoNumerico(fatturato) {
    if (!fatturato) return 1000000;
    if (fatturato === '< 100K') return 75000;
    if (fatturato === '100K-500K') return 300000;
    if (fatturato === '500K-2M') return 1250000;
    if (fatturato === '2M-10M') return 6000000;
    if (fatturato === '10M-50M') return 30000000;
    if (fatturato === '> 50M') return 75000000;
    return 1000000;
}

function estraiNumeroDipendenti(dimensione) {
    if (!dimensione) return 10;
    if (dimensione === '1-5') return 3;
    if (dimensione === '6-20') return 13;
    if (dimensione === '21-50') return 35;
    if (dimensione === '51-100') return 75;
    if (dimensione === '101-250') return 175;
    if (dimensione === '251+') return 350;
    return 10;
}

console.log('%c✅ SEZIONE 10/15 PARTE 1 COMPLETATA: Scenari Stress 1-5', 'color: #10B981; font-weight: bold; font-size: 14px');

// ========================================
// SEZIONE 10/15: PARTE 2 - SCENARI 6-10
// ========================================

// Aggiungo questa funzione per continuare gli scenari
function simulaScenariStressAziendaliFull(companyData, risposte, punteggiSezioni) {
    // Chiama la prima parte
    const scenari = simulaScenariStressAziendali(companyData, risposte, punteggiSezioni);
    
    // Estrai dati aziendali
    const fatturato = estraiFatturatoNumerico(companyData.datiSocietari.fatturatoAnnuo);
    const dipendenti = estraiNumeroDipendenti(companyData.datiSocietari.numeroDipendenti);
    const settore = companyData.datiSocietari.settore;
    
    // ===========================================
    // SCENARIO 6: INFEDELTÀ DIPENDENTE / FRODE
    // ===========================================
    {
        const dimensioneAzienda = dipendenti > 50 ? 'grande' : dipendenti > 20 ? 'media' : 'piccola';
        const importoFrode = dimensioneAzienda === 'grande' ? 150000 :
                            dimensioneAzienda === 'media' ? 80000 : 30000;
        const costiLegali = 25000;
        const costiForensi = 15000;
        const dannoReputazionale = fatturato * 0.05;
        const costiRiorganizzazione = 20000;
        
        const impatto = importoFrode + costiLegali + costiForensi + dannoReputazionale + costiRiorganizzazione;
        const copertura = 0; // Fidelity insurance rara
        const scoperta = impatto - copertura;
        
        scenari.push({
            id: 'frode_interna',
            titolo: 'Infedeltà dipendente / Frode interna',
            descrizione: 'Appropriazione indebita, furto, frode contabile da parte di dipendente',
            icon: '🕵️',
            probabilita: dipendenti > 50 ? 'media' : 'bassa',
            probabilitaPerc: dipendenti > 50 ? 10 : 4,
            impatto: impatto,
            copertura: copertura,
            scoperta: scoperta,
            gravita: scoperta > 100000 ? 'critica' : 'significativa',
            dettagli: [
                `Importo frode medio: €${importoFrode.toLocaleString()}`,
                `Costi legali procedimento: €${costiLegali.toLocaleString()}`,
                `Indagini forensi: €${costiForensi.toLocaleString()}`,
                `Danno reputazionale: €${dannoReputazionale.toLocaleString()}`,
                `Riorganizzazione controlli: €${costiRiorganizzazione.toLocaleString()}`
            ],
            raccomandazioni: [
                'Fidelity Insurance (infedeltà dipendenti)',
                'Sistema controlli interni robusto',
                'Segregazione funzioni sensibili',
                'Audit periodici indipendenti',
                'Background check assunzioni ruoli critici'
            ]
        });
    }
    
    // ===========================================
    // SCENARIO 7: PERDITA CLIENTE PRINCIPALE
    // ===========================================
    {
        const concentrazioneClienti = risposte.B4 || 3;
        let percPerdita = 0;
        if (concentrazioneClienti === 1) percPerdita = 0.8;
        else if (concentrazioneClienti === 2) percPerdita = 0.6;
        else if (concentrazioneClienti === 3) percPerdita = 0.4;
        else if (concentrazioneClienti === 4) percPerdita = 0.2;
        else percPerdita = 0.1;
        
        const perditaFatturato = fatturato * percPerdita;
        const marginePerso = perditaFatturato * 0.25;
        const costiCommerciali = fatturato * 0.1; // Acquisizione nuovi clienti
        const costiRistrutturazione = fatturato * 0.05;
        
        const impatto = marginePerso + costiCommerciali + costiRistrutturazione;
        const coperturaTradeLoss = 0;
        const scoperta = impatto - coperturaTradeLoss;
        
        scenari.push({
            id: 'perdita_cliente',
            titolo: 'Perdita cliente principale',
            descrizione: 'Perdita improvvisa del cliente più importante per fatturato',
            icon: '📉',
            probabilita: concentrazioneClienti <= 2 ? 'alta' : concentrazioneClienti <= 3 ? 'media' : 'bassa',
            probabilitaPerc: concentrazioneClienti <= 2 ? 20 : concentrazioneClienti <= 3 ? 12 : 5,
            impatto: impatto,
            copertura: coperturaTradeLoss,
            scoperta: scoperta,
            gravita: percPerdita > 0.5 ? 'catastrofica' : percPerdita > 0.3 ? 'critica' : 'significativa',
            dettagli: [
                `Concentrazione cliente: ${concentrazioneClienti}/5`,
                `% fatturato cliente: ${(percPerdita * 100).toFixed(0)}%`,
                `Perdita fatturato annua: €${perditaFatturato.toLocaleString()}`,
                `Margine perso: €${marginePerso.toLocaleString()}`,
                `Costi commerciali nuovi clienti: €${costiCommerciali.toLocaleString()}`
            ],
            raccomandazioni: [
                'Diversificare portafoglio clienti',
                'Contratti pluriennali con clienti chiave',
                'Trade Credit Insurance',
                'Piano B commerciale sempre attivo',
                'Monitoraggio salute finanziaria clienti top'
            ]
        });
    }
    
    // ===========================================
    // SCENARIO 8: DANNO AMBIENTALE
    // ===========================================
    {
        const rischioAmbientale = settore === 'Manifatturiero' || settore === 'Logistica' || 
                                 settore === 'Edilizia' || settore === 'Agricoltura' ? 'alto' : 'basso';
        
        const costiRipristino = rischioAmbientale === 'alto' ? 200000 : 50000;
        const multaAutorita = rischioAmbientale === 'alto' ? 100000 : 30000;
        const speseLegali = 50000;
        const dannoReputazionale = fatturato * 0.15;
        const costiMonitoraggio = 30000;
        
        const impatto = costiRipristino + multaAutorita + speseLegali + dannoReputazionale + costiMonitoraggio;
        const coperturaAmbientale = 0;
        const scoperta = impatto - coperturaAmbientale;
        
        scenari.push({
            id: 'danno_ambientale',
            titolo: 'Danno ambientale / Inquinamento',
            descrizione: 'Contaminazione suolo, acqua, aria con responsabilità ambientale',
            icon: '🌍',
            probabilita: rischioAmbientale === 'alto' ? 'media' : 'bassa',
            probabilitaPerc: rischioAmbientale === 'alto' ? 8 : 2,
            impatto: impatto,
            copertura: coperturaAmbientale,
            scoperta: scoperta,
            gravita: scoperta > 300000 ? 'critica' : 'significativa',
            dettagli: [
                `Rischio settore: ${rischioAmbientale}`,
                `Costi ripristino ambientale: €${costiRipristino.toLocaleString()}`,
                `Multe autorità: €${multaAutorita.toLocaleString()}`,
                `Spese legali: €${speseLegali.toLocaleString()}`,
                `Danno reputazionale: €${dannoReputazionale.toLocaleString()}`
            ],
            raccomandazioni: [
                'Environmental Liability Insurance',
                'Audit ambientale periodico',
                'Certificazioni ISO 14001',
                'Procedure gestione rifiuti/sostanze',
                'Formazione personale su normativa ambientale'
            ]
        });
    }
    
    // ===========================================
    // SCENARIO 9: CRISI REPUTAZIONALE
    // ===========================================
    {
        const perditaClienti = fatturato * 0.25;
        const costiComunicazione = 80000; // Crisis management, PR
        const scontiDifensivi = fatturato * 0.05;
        const costiLegali = 50000;
        const perditaValoreBrand = fatturato * 0.1;
        
        const impatto = perditaClienti + costiComunicazione + scontiDifensivi + costiLegali + perditaValoreBrand;
        const coperturaReputazione = 0;
        const scoperta = impatto - coperturaReputazione;
        
        scenari.push({
            id: 'crisi_reputazionale',
            titolo: 'Crisi reputazionale / Social media',
            descrizione: 'Crisi di immagine virale sui social media, recensioni negative massive',
            icon: '📱',
            probabilita: 'media',
            probabilitaPerc: 10,
            impatto: impatto,
            copertura: coperturaReputazione,
            scoperta: scoperta,
            gravita: 'critica',
            dettagli: [
                `Perdita clienti stimata: €${perditaClienti.toLocaleString()}`,
                `Crisis management & PR: €${costiComunicazione.toLocaleString()}`,
                `Sconti difensivi: €${scontiDifensivi.toLocaleString()}`,
                `Tutela legale: €${costiLegali.toLocaleString()}`,
                `Perdita valore brand: €${perditaValoreBrand.toLocaleString()}`
            ],
            raccomandazioni: [
                'Piano crisis management preparato',
                'Social media monitoring 24/7',
                'Portavoce e team comunicazione formati',
                'Assicurazione specifica reputazione',
                'Gestione proattiva recensioni online'
            ]
        });
    }
    
    // ===========================================
    // SCENARIO 10: FALLIMENTO FORNITORE STRATEGICO
    // ===========================================
    {
        const dipendenzaFornitori = risposte.R2 || 3;
        const interruzioneGiorni = dipendenzaFornitori <= 2 ? 45 : dipendenzaFornitori <= 3 ? 30 : 15;
        
        const perditaFatturato = (fatturato / 365) * interruzioneGiorni;
        const costiFissiContinui = perditaFatturato * 0.7;
        const costiFornitoriAlternativi = fatturato * 0.08; // Maggiori costi
        const penaliClienti = fatturato * 0.05;
        
        const impatto = perditaFatturato + costiFissiContinui + costiFornitoriAlternativi + penaliClienti;
        const coperturaFornitori = 0;
        const scoperta = impatto - coperturaFornitori;
        
        scenari.push({
            id: 'fallimento_fornitore',
            titolo: 'Fallimento fornitore strategico',
            descrizione: 'Insolvenza o blocco improvviso del principale fornitore critico',
            icon: '🏭',
            probabilita: dipendenzaFornitori <= 2 ? 'alta' : 'media',
            probabilitaPerc: dipendenzaFornitori <= 2 ? 15 : 8,
            impatto: impatto,
            copertura: coperturaFornitori,
            scoperta: scoperta,
            gravita: interruzioneGiorni > 30 ? 'critica' : 'significativa',
            dettagli: [
                `Dipendenza fornitori: ${dipendenzaFornitori}/5`,
                `Giorni interruzione: ${interruzioneGiorni}`,
                `Perdita fatturato: €${perditaFatturato.toLocaleString()}`,
                `Costi fornitori alternativi: €${costiFornitoriAlternativi.toLocaleString()}`,
                `Penali verso clienti: €${penaliClienti.toLocaleString()}`
            ],
            raccomandazioni: [
                'Contingent Business Interruption',
                'Qualificare fornitori alternativi',
                'Diversificare supply chain',
                'Scorte strategiche prodotti critici',
                'Monitorare salute finanziaria fornitori'
            ]
        });
    }
    
    console.log(`✅ ${scenari.length} scenari stress simulati`);
    return scenari;
}

console.log('%c✅ SEZIONE 10/15 COMPLETATA: 10 Scenari Stress Completi', 'color: #10B981; font-weight: bold; font-size: 14px');

// ========================================
// SEZIONE 11/15: GAP ANALYSIS 5 AREE
// ========================================

function analizzaGapProtettivi(risposte, punteggiSezioni, normotipo, companyData) {
    const gaps = [];
    
    console.log('%c🔍 GAP ANALYSIS', 'color: #06B6D4; font-weight: bold; font-size: 14px');
    
    // ===========================================
    // GAP 1: PROTEZIONE PERSONE CHIAVE
    // ===========================================
    {
        const dipendenzaKeyPerson = risposte.G4 || 3;
        const copertureAttuali = risposte.R4 || 2;
        const pianoSuccessione = risposte.G5 || 2;
        
        const score = ((5 - dipendenzaKeyPerson) + copertureAttuali + pianoSuccessione) / 3;
        const gapScore = 5 - score;
        const livello = gapScore > 3 ? 'ALTO' : gapScore > 1.5 ? 'MEDIO' : 'BASSO';
        
        gaps.push({
            area: 'Protezione Persone Chiave',
            icon: '👥',
            score: score.toFixed(1),
            gapScore: gapScore.toFixed(1),
            livello: livello,
            descrizione: dipendenzaKeyPerson <= 2 ? 
                'Alta dipendenza da figure chiave senza adeguata protezione assicurativa. Rischio paralisi operativa.' :
                'Dipendenza moderata ma serve maggiore strutturazione e protezione.',
            raccomandazioni: [
                'Key Man Insurance su figure critiche',
                'Assicurazione malattia/infortuni amministratori',
                'Piano di successione formalizzato',
                'Documentazione processi critici',
                'Formazione sostituti designati'
            ],
            priorita: dipendenzaKeyPerson <= 2 ? 'ALTA' : 'MEDIA'
        });
    }
    
    // ===========================================
    // GAP 2: PROTEZIONE PATRIMONIO AZIENDALE
    // ===========================================
    {
        const liquidita = risposte.R5 || 3;
        const coperturePatrimoniali = risposte.R4 || 2;
        const marginalita = risposte.F4 || 3;
        
        const score = (liquidita + coperturePatrimoniali + marginalita) / 3;
        const gapScore = 5 - score;
        const livello = gapScore > 3 ? 'ALTO' : gapScore > 1.5 ? 'MEDIO' : 'BASSO';
        
        gaps.push({
            area: 'Protezione Patrimonio Aziendale',
            icon: '🏢',
            score: score.toFixed(1),
            gapScore: gapScore.toFixed(1),
            livello: livello,
            descrizione: liquidita <= 2 ?
                'Liquidità scarsa con protezioni patrimoniali insufficienti. Alta vulnerabilità a shock.' :
                'Patrimonio parzialmente protetto ma migliorabile.',
            raccomandazioni: [
                'Polizza Incendio/Furto valore a nuovo',
                'All Risks contenuto e impianti',
                'Business Interruption per perdita redditizia',
                'Assicurazione Merci e scorte',
                'Copertura elettronica/macchinari'
            ],
            priorita: liquidita <= 2 ? 'ALTA' : 'MEDIA'
        });
    }
    
    // ===========================================
    // GAP 3: RESPONSABILITÀ CIVILE
    // ===========================================
    {
        const settore = companyData.datiSocietari.settore;
        const rischioSettore = ['Edilizia', 'Sanità', 'Manifatturiero'].includes(settore) ? 'alto' : 'medio';
        const copertureRC = risposte.R4 || 2;
        const esposizioneRC = risposte.R6 || 3;
        
        const score = (copertureRC + (5 - esposizioneRC)) / 2;
        const gapScore = 5 - score;
        const livello = rischioSettore === 'alto' && gapScore > 2 ? 'ALTO' :
                       gapScore > 2.5 ? 'ALTO' : gapScore > 1.5 ? 'MEDIO' : 'BASSO';
        
        gaps.push({
            area: 'Responsabilità Civile',
            icon: '⚖️',
            score: score.toFixed(1),
            gapScore: gapScore.toFixed(1),
            livello: livello,
            descrizione: rischioSettore === 'alto' ?
                'Settore ad alto rischio RC con coperture potenzialmente insufficienti.' :
                'Esposizione RC da valutare in relazione all\'attività svolta.',
            raccomandazioni: [
                'RC Generale con massimali adeguati',
                'RC Prodotti se applicabile',
                'RC Professionale per servizi',
                'RC Inquinamento ambientale',
                'Tutela Legale inclusa',
                'Revisione massimali annuale'
            ],
            priorita: rischioSettore === 'alto' ? 'ALTA' : 'MEDIA'
        });
    }
    
    // ===========================================
    // GAP 4: CYBER SECURITY E DATI
    // ===========================================
    {
        const cyberSecurity = risposte.R3 || 3;
        const dipendenzaDati = ['Tecnologia', 'Servizi', 'Commercio', 'Sanità'].includes(companyData.datiSocietari.settore) ? 'alta' : 'media';
        const digitalizzazione = risposte.B5 || 3;
        
        const score = (cyberSecurity + digitalizzazione) / 2;
        const gapScore = 5 - score;
        const livello = dipendenzaDati === 'alta' && gapScore > 2 ? 'ALTO' :
                       gapScore > 3 ? 'ALTO' : gapScore > 1.5 ? 'MEDIO' : 'BASSO';
        
        gaps.push({
            area: 'Cyber Security e Protezione Dati',
            icon: '🔒',
            score: score.toFixed(1),
            gapScore: gapScore.toFixed(1),
            livello: livello,
            descrizione: cyberSecurity <= 2 ?
                'Protezione cyber inadeguata con alto rischio attacchi e violazioni GDPR.' :
                'Protezione base presente ma necessario rafforzamento.',
            raccomandazioni: [
                'Cyber Risk Insurance completa',
                'Copertura violazioni GDPR',
                'Business Interruption da cyber',
                'Costi ripristino dati',
                'Backup remoto e disaster recovery',
                'Formazione anti-phishing',
                'Audit sicurezza periodici'
            ],
            priorita: dipendenzaDati === 'alta' ? 'ALTA' : 'MEDIA'
        });
    }
    
    // ===========================================
    // GAP 5: CONTINUITÀ OPERATIVA
    // ===========================================
    {
        const pianificazione = risposte.B3 || 3;
        const gestioneFornitori = risposte.R2 || 3;
        const procedureRischi = risposte.R1 || 3;
        const dipendenzaClienti = risposte.B4 || 3;
        
        const score = (pianificazione + (5 - gestioneFornitori) + procedureRischi + (5 - dipendenzaClienti)) / 4;
        const gapScore = 5 - score;
        const livello = gapScore > 3 ? 'ALTO' : gapScore > 1.5 ? 'MEDIO' : 'BASSO';
        
        gaps.push({
            area: 'Continuità Operativa',
            icon: '⚙️',
            score: score.toFixed(1),
            gapScore: gapScore.toFixed(1),
            livello: livello,
            descrizione: procedureRischi <= 2 ?
                'Mancano procedure strutturate per garantire continuità in caso di shock operativi.' :
                'Procedure parziali, necessario piano completo di business continuity.',
            raccomandazioni: [
                'Business Continuity Plan formalizzato',
                'Contingent BI per fornitori',
                'Sedi/magazzini alternativi identificati',
                'Copertura interruzione attività completa',
                'Test periodici piani emergenza',
                'Diversificazione fornitori critici'
            ],
            priorita: procedureRischi <= 2 ? 'ALTA' : 'MEDIA'
        });
    }
    
    // Statistiche GAP
    const gapAlti = gaps.filter(g => g.livello === 'ALTO').length;
    const gapMedi = gaps.filter(g => g.livello === 'MEDIO').length;
    const gapBassi = gaps.filter(g => g.livello === 'BASSO').length;
    
    console.log('Gap Analysis completata:');
    console.log(`  ALTO: ${gapAlti}, MEDIO: ${gapMedi}, BASSO: ${gapBassi}`);
    
    return gaps;
}

console.log('%c✅ SEZIONE 11/15 COMPLETATA: GAP Analysis 5 Aree', 'color: #10B981; font-weight: bold; font-size: 14px');

// ========================================
// SEZIONE 12/15: SISTEMA RACCOMANDAZIONI 12 PRODOTTI
// ========================================

function generaRaccomandazioniProdotti(risposte, gaps, normotipo, scenari, companyData) {
    const raccomandazioni = [];
    const prioritaNormotipo = normotipo.normotipo.priorita || {};
    
    console.log('%c💡 GENERAZIONE RACCOMANDAZIONI PRODOTTI', 'color: #8B5CF6; font-weight: bold; font-size: 14px');
    
    // ===========================================
    // 1. RC GENERALE
    // ===========================================
    {
        const priorita = prioritaNormotipo.rc_generale || 80;
        const copertureAttuali = risposte.R4 || 2;
        const urgenza = copertureAttuali <= 2 ? 'ALTA' : copertureAttuali <= 3 ? 'MEDIA' : 'BASSA';
        
        raccomandazioni.push({
            numero: 1,
            prodotto: 'RC Generale',
            categoria: 'Responsabilità',
            descrizione: 'Copertura per danni involontariamente causati a terzi nell\'esercizio dell\'attività aziendale.',
            motivazione: 'Protezione fondamentale contro richieste di risarcimento danni a terzi (persone, cose, animali).',
            benefici: [
                'Massimali elevati per danni a terzi',
                'Copertura spese legali di difesa',
                'Estensibile a prodotti difettosi',
                'Valida per tutto il territorio operativo'
            ],
            priorita: urgenza,
            scoreNormotipo: priorita,
            rationale: copertureAttuali <= 2 ? 
                'URGENTE: Coperture attuali insufficienti, rischio elevato' :
                'Raccomandato incrementare massimali'
        });
    }
    
    // ===========================================
    // 2. INCENDIO E RISCHI DIVERSI
    // ===========================================
    {
        const priorita = Math.max(
            prioritaNormotipo.patrimonio || 80,
            prioritaNormotipo.interruzione_attivita || 75
        );
        const liquidita = risposte.R5 || 3;
        const urgenza = liquidita <= 2 ? 'ALTA' : 'MEDIA';
        
        raccomandazioni.push({
            numero: 2,
            prodotto: 'Incendio e Rischi Diversi',
            categoria: 'Patrimonio',
            descrizione: 'Protezione di fabbricati, macchinari, impianti, merci contro incendio, fulmine, esplosione, eventi naturali.',
            motivazione: 'Salvaguardia del patrimonio aziendale da eventi distruttivi che possono compromettere la continuità.',
            benefici: [
                'Valore a nuovo per ricostruzione',
                'Copertura contenuto e attrezzature',
                'Eventi naturali (terremoto, alluvione)',
                'Spese extra per soluzioni temporanee'
            ],
            priorita: urgenza,
            scoreNormotipo: priorita,
            rationale: liquidita <= 2 ?
                'CRITICO: Scarsa liquidità, impossibile assorbire shock patrimoniale' :
                'Protezione patrimonio essenziale'
        });
    }
    
    // ===========================================
    // 3. BUSINESS INTERRUPTION
    // ===========================================
    {
        const priorita = prioritaNormotipo.interruzione_attivita || 85;
        const marginalita = risposte.F4 || 3;
        const liquidita = risposte.R5 || 3;
        const urgenza = (marginalita <= 2 || liquidita <= 2) ? 'ALTA' : 'MEDIA';
        
        raccomandazioni.push({
            numero: 3,
            prodotto: 'Business Interruption',
            categoria: 'Continuità',
            descrizione: 'Indennizzo perdita redditizia e costi fissi continuanti durante interruzione forzata attività.',
            motivazione: 'Garantisce sopravvivenza finanziaria durante periodi di blocco operativo anche se i costi fissi continuano.',
            benefici: [
                'Copertura margine operativo perso',
                'Pagamento costi fissi (affitti, stipendi)',
                'Durata personalizzabile (12-24 mesi)',
                'Include spese extra per ripresa'
            ],
            priorita: urgenza,
            scoreNormotipo: priorita,
            rationale: urgenza === 'ALTA' ?
                'URGENTE: Marginalità bassa, interruzione sarebbe fatale' :
                'Fondamentale per continuità aziendale'
        });
    }
    
    // ===========================================
    // 4. CYBER RISK
    // ===========================================
    {
        const priorita = prioritaNormotipo.cyber || 70;
        const cyberSecurity = risposte.R3 || 3;
        const settore = companyData.datiSocietari.settore;
        const settoreRischio = ['Tecnologia', 'Servizi', 'Sanità'].includes(settore);
        const urgenza = (cyberSecurity <= 2 || settoreRischio) ? 'ALTA' : 'MEDIA';
        
        raccomandazioni.push({
            numero: 4,
            prodotto: 'Cyber Risk Insurance',
            categoria: 'Digitale',
            descrizione: 'Protezione completa da attacchi informatici, ransomware, violazioni dati, interruzioni da cyber.',
            motivazione: 'Rischio cyber in costante crescita. Copertura danni diretti, indiretti, legali e reputazionali.',
            benefici: [
                'Costi ripristino sistemi IT',
                'Gestione crisi e comunicazione',
                'Copertura richieste riscatto',
                'Violazioni GDPR e multe',
                'Business Interruption da cyber',
                'Supporto esperti forensi'
            ],
            priorita: urgenza,
            scoreNormotipo: priorita,
            rationale: settoreRischio ?
                'PRIORITÀ MASSIMA: Settore ad altissimo rischio cyber' :
                cyberSecurity <= 2 ? 'URGENTE: Protezioni tecniche inadeguate' :
                'Rischio crescente per tutte le aziende'
        });
    }
    
    // ===========================================
    // 5. KEY MAN INSURANCE
    // ===========================================
    {
        const priorita = prioritaNormotipo.key_man || 85;
        const dipendenza = risposte.G4 || 3;
        const urgenza = dipendenza <= 2 ? 'ALTA' : dipendenza <= 3 ? 'MEDIA' : 'BASSA';
        
        raccomandazioni.push({
            numero: 5,
            prodotto: 'Key Man Insurance',
            categoria: 'Persone',
            descrizione: 'Capitale liquidabile in caso di decesso o invalidità permanente di figure chiave aziendali.',
            motivazione: 'Compensa perdita economica derivante dalla mancanza improvvisa di persone strategiche.',
            benefici: [
                'Capitale immediato per riorganizzazione',
                'Copertura costi ricerca sostituto',
                'Garanzia continuità operativa',
                'Deducibilità fiscale premi'
            ],
            priorita: urgenza,
            scoreNormotipo: priorita,
            rationale: dipendenza <= 2 ?
                'URGENTE: Altissima dipendenza da figure chiave, rischio paralisi' :
                'Protezione figure strategiche'
        });
    }
    
    // ===========================================
    // 6. INFORTUNI DIPENDENTI
    // ===========================================
    {
        const priorita = prioritaNormotipo.infortuni_dipendenti || 85;
        const dipendenti = estraiNumeroDipendenti(companyData.datiSocietari.numeroDipendenti);
        const settoreRischio = ['Edilizia', 'Manifatturiero', 'Logistica'].includes(companyData.datiSocietari.settore);
        const urgenza = (settoreRischio && dipendenti > 10) ? 'ALTA' : dipendenti > 20 ? 'MEDIA' : 'BASSA';
        
        raccomandazioni.push({
            numero: 6,
            prodotto: 'Infortuni Dipendenti',
            categoria: 'Persone',
            descrizione: 'Copertura integrativa infortuni professionali ed extraprofessionali per tutti i dipendenti.',
            motivazione: 'Welfare aziendale, protezione dipendenti 24h, riduzione contenzioso, attrattività come datore.',
            benefici: [
                'Copertura 24h su 24 (anche extra lavoro)',
                'Indennizzi invalidità e morte',
                'Rimborso spese mediche',
                'Diarie ricovero/ingessatura',
                'Migliora employer branding'
            ],
            priorita: urgenza,
            scoreNormotipo: priorita,
            rationale: settoreRischio ?
                'ALTA PRIORITÀ: Settore ad alto rischio infortuni' :
                'Welfare fondamentale per dipendenti'
        });
    }
    
    // ===========================================
    // 7. TUTELA LEGALE
    // ===========================================
    {
        const priorita = prioritaNormotipo.tutela_legale || 75;
        const urgenza = 'MEDIA';
        
        raccomandazioni.push({
            numero: 7,
            prodotto: 'Tutela Legale',
            categoria: 'Servizi',
            descrizione: 'Copertura spese legali per controversie civili, penali, amministrative relative all\'attività.',
            motivazione: 'I costi legali possono essere ingenti e imprevedibili. Garantisce difesa senza esborsi.',
            benefici: [
                'Spese avvocati e consulenti',
                'Perizie e consulenze tecniche',
                'Controversie con clienti/fornitori',
                'Difesa penale amministratori',
                'Contenzioso del lavoro'
            ],
            priorita: urgenza,
            scoreNormotipo: priorita,
            rationale: 'Protezione contro spese legali imprevedibili e onerose'
        });
    }
    
    // ===========================================
    // 8. D&O (Directors & Officers)
    // ===========================================
    {
        const priorita = prioritaNormotipo.do || 70;
        const dimensione = companyData.datiSocietari.numeroDipendenti;
        const formaGiuridica = companyData.datiSocietari.formaGiuridica;
        const urgenza = (dimensione.includes('50') || dimensione.includes('100') || dimensione.includes('250')) &&
                       (formaGiuridica === 'SRL' || formaGiuridica === 'SPA') ? 'ALTA' : 'MEDIA';
        
        raccomandazioni.push({
            numero: 8,
            prodotto: 'D&O - Directors & Officers',
            categoria: 'Responsabilità',
            descrizione: 'Tutela amministratori e dirigenti per responsabilità nell\'esercizio delle funzioni aziendali.',
            motivazione: 'Protegge patrimonio personale di amministratori da azioni legali per decisioni aziendali.',
            benefici: [
                'Copertura responsabilità gestionale',
                'Difesa contenzioso soci/terzi',
                'Violazioni normative societarie',
                'Spese legali difesa penale',
                'Tranquillità amministratori'
            ],
            priorita: urgenza,
            scoreNormotipo: priorita,
            rationale: urgenza === 'ALTA' ?
                'Dimensione societaria richiede protezione amministratori' :
                'Protezione patrimonio personale gestori'
        });
    }
    
    // ===========================================
    // 9. CREDITO COMMERCIALE
    // ===========================================
    {
        const priorita = prioritaNormotipo.credito || 70;
        const dso = risposte.F6 || 3;
        const dipendenzaClienti = risposte.B4 || 3;
        const urgenza = (dso <= 2 || dipendenzaClienti <= 2) ? 'ALTA' : 'MEDIA';
        
        raccomandazioni.push({
            numero: 9,
            prodotto: 'Credito Commerciale',
            categoria: 'Finanza',
            descrizione: 'Assicurazione crediti verso clienti contro insolvenza, protrae, fallimento.',
            motivazione: 'Protegge da mancati incassi che possono compromettere liquidità e solidità finanziaria.',
            benefici: [
                'Indennizzo crediti insoluti (85-90%)',
                'Monitoraggio merito creditizio clienti',
                'Miglioramento rating aziendale',
                'Supporto recupero crediti',
                'Possibilità smobilizzo anticipato'
            ],
            priorita: urgenza,
            scoreNormotipo: priorita,
            rationale: urgenza === 'ALTA' ?
                'URGENTE: Tempi incasso lunghi o alta concentrazione clienti' :
                'Protezione flussi di cassa critici'
        });
    }
    
    // ===========================================
    // 10. RC PRODOTTI
    // ===========================================
    {
        const priorita = prioritaNormotipo.rc_prodotti || 75;
        const settore = companyData.datiSocietari.settore;
        const settoreProdotti = ['Manifatturiero', 'Commercio', 'Ristorazione'].includes(settore);
        const urgenza = settoreProdotti ? 'ALTA' : 'BASSA';
        
        raccomandazioni.push({
            numero: 10,
            prodotto: 'RC Prodotti',
            categoria: 'Responsabilità',
            descrizione: 'Copertura danni causati da prodotti difettosi o pericolosi venduti/fabbricati.',
            motivazione: 'Settori produttivi/commerciali esposti a richieste risarcimento per difetti prodotti.',
            benefici: [
                'Risarcimenti danni da prodotti',
                'Ritiro prodotti dal mercato',
                'Spese legali difesa',
                'Valida anche dopo cessazione attività',
                'Copertura worldwide se export'
            ],
            priorita: urgenza,
            scoreNormotipo: priorita,
            rationale: settoreProdotti ?
                'ESSENZIALE: Settore con vendita/produzione beni' :
                'Valutare se commercio prodotti'
        });
    }
    
    // ===========================================
    // 11. FLOTTE AUTO AZIENDALI
    // ===========================================
    {
        const priorita = prioritaNormotipo.flotte || 65;
        const settore = companyData.datiSocietari.settore;
        const settoreFlotte = ['Logistica', 'Commercio', 'Servizi'].includes(settore);
        const urgenza = settoreFlotte ? 'MEDIA' : 'BASSA';
        
        raccomandazioni.push({
            numero: 11,
            prodotto: 'Flotte Auto Aziendali',
            categoria: 'Mobilità',
            descrizione: 'Gestione unitaria parco veicoli con coperture ottimizzate e servizi dedicati.',
            motivazione: 'Razionalizzazione costi, servizi aggiuntivi, gestione semplificata per flotte ≥3 veicoli.',
            benefici: [
                'Tariffe fleet dedicate',
                'Gestione sinistri centralizzata',
                'Veicolo sostitutivo',
                'Assistenza stradale H24',
                'Tutela conducente',
                'Reporting e statistiche'
            ],
            priorita: urgenza,
            scoreNormotipo: priorita,
            rationale: settoreFlotte ?
                'Ottimizzare gestione flotta aziendale' :
                'Valutare se presenza veicoli aziendali'
        });
    }
    
    // ===========================================
    // 12. ENVIRONMENTAL LIABILITY
    // ===========================================
    {
        const priorita = prioritaNormotipo.ambientale || 60;
        const settore = companyData.datiSocietari.settore;
        const rischioAmbientale = ['Manifatturiero', 'Edilizia', 'Logistica', 'Agricoltura'].includes(settore);
        const urgenza = rischioAmbientale ? 'MEDIA' : 'BASSA';
        
        raccomandazioni.push({
            numero: 12,
            prodotto: 'Environmental Liability',
            categoria: 'Ambiente',
            descrizione: 'Copertura danni ambientali, inquinamento, bonifiche secondo normativa europea.',
            motivazione: 'Normativa ambientale stringente con responsabilità oggettiva. Costi bonifiche elevatissimi.',
            benefici: [
                'Ripristino ambientale',
                'Bonifiche suolo/acqua',
                'Spese legali contenzioso',
                'Consulenza tecnica specializzata',
                'Multe e sanzioni amministrative'
            ],
            priorita: urgenza,
            scoreNormotipo: priorita,
            rationale: rischioAmbientale ?
                'Settore con potenziale impatto ambientale significativo' :
                'Valutare esposizione rischi ESG'
        });
    }
    
    // Ordinamento per priorità
    raccomandazioni.sort((a, b) => {
        const prioritaMap = { 'ALTA': 3, 'MEDIA': 2, 'BASSA': 1 };
        const diff = prioritaMap[b.priorita] - prioritaMap[a.priorita];
        if (diff !== 0) return diff;
        return b.scoreNormotipo - a.scoreNormotipo;
    });
    
    console.log(`✅ ${raccomandazioni.length} raccomandazioni generate`);
    raccomandazioni.forEach((r, i) => {
        console.log(`  ${i+1}. ${r.prodotto} - Priorità: ${r.priorita}`);
    });
    
    return raccomandazioni;
}

console.log('%c✅ SEZIONE 12/15 COMPLETATA: 12 Raccomandazioni Prodotti', 'color: #10B981; font-weight: bold; font-size: 14px');

// ========================================
// SEZIONE 13/15: BENCHMARK SETTORE
// ========================================

function generaBenchmarkSettore(companyData, punteggioGlobale, punteggiSezioni) {
    const settore = companyData.datiSocietari.settore || 'Generico';
    const dimensione = companyData.datiSocietari.numeroDipendenti || '';
    const fatturato = estraiFatturatoNumerico(companyData.datiSocietari.fatturatoAnnuo);
    
    // Database benchmark per settore (valori medi statistici)
    const benchmarkDB = {
        'Manifatturiero': { polizzeMedia: 7, coherenceMedia: 72, fatturatoMedio: 5000000, margineEBITDA: 12 },
        'Commercio': { polizzeMedia: 5, coherenceMedia: 68, fatturatoMedio: 3000000, margineEBITDA: 8 },
        'Servizi': { polizzeMedia: 6, coherenceMedia: 70, fatturatoMedio: 2500000, margineEBITDA: 18 },
        'Tecnologia': { polizzeMedia: 6, coherenceMedia: 75, fatturatoMedio: 4000000, margineEBITDA: 22 },
        'Edilizia': { polizzeMedia: 6, coherenceMedia: 65, fatturatoMedio: 4500000, margineEBITDA: 10 },
        'Ristorazione': { polizzeMedia: 4, coherenceMedia: 62, fatturatoMedio: 1500000, margineEBITDA: 15 },
        'Logistica': { polizzeMedia: 7, coherenceMedia: 68, fatturatoMedio: 6000000, margineEBITDA: 8 },
        'Sanità': { polizzeMedia: 6, coherenceMedia: 78, fatturatoMedio: 3500000, margineEBITDA: 14 },
        'Agricoltura': { polizzeMedia: 5, coherenceMedia: 60, fatturatoMedio: 2000000, margineEBITDA: 10 },
        'Generico': { polizzeMedia: 5, coherenceMedia: 70, fatturatoMedio: 3000000, margineEBITDA: 12 }
    };
    
    const benchmark = benchmarkDB[settore] || benchmarkDB['Generico'];
    
    // Calcola numero polizze consigliate
    const numPolizzeRaccom andate = Math.round(punteggioGlobale < 3 ? benchmark.polizzeMedia + 2 : benchmark.polizzeMedia);
    
    const confronto = {
        settore: settore,
        dimensione: dimensione,
        fatturato: fatturato,
        benchmarkSettore: {
            polizzeMedia: benchmark.polizzeMedia,
            coherenceMedia: benchmark.coherenceMedia,
            fatturatoMedio: benchmark.fatturatoMedio,
            margineEBITDA: benchmark.margineEBITDA
        },
        tuoiDati: {
            polizzeRaccom: numPolizzeRaccommandate,
            coherence: Math.round(punteggioGlobale * 20), // Converti 1-5 in 0-100
            fatturato: fatturato,
            punteggioGlobale: punteggioGlobale.toFixed(2)
        },
        comparazione: {
            polizze: numPolizzeRaccommandate >= benchmark.polizzeMedia ? 'adeguato' : 'sotto_media',
            protezione: punteggioGlobale >= 3.5 ? 'sopra_media' : punteggioGlobale >= 2.5 ? 'nella_media' : 'sotto_media',
            dimensione: fatturato >= benchmark.fatturatoMedio ? 'sopra_media' : 'sotto_media'
        }
    };
    
    console.log('📊 Benchmark settore:', settore);
    console.log('Confronto:', confronto.comparazione);
    
    return confronto;
}

console.log('%c✅ SEZIONE 13/15 COMPLETATA: Benchmark Settore', 'color: #10B981; font-weight: bold; font-size: 14px');

// ========================================
// SEZIONE 14/15: FUNZIONE PRINCIPALE - GENERA ANALISI COMPLETA
// ========================================

function generaAnalisiCompleta() {
    console.log('%c' + '═'.repeat(80), 'color: #003366; font-weight: bold');
    console.log('%c🎯 GENERAZIONE ANALISI COMPLETA AVVIATA', 'color: #E31E24; font-weight: bold; font-size: 18px');
    console.log('%c' + '═'.repeat(80), 'color: #003366; font-weight: bold');
    
    const startTime = Date.now();
    
    // Validazione risposte
    const risposte = appState.questionario.risposte;
    const domandeFiltrate = appState.questionario.domandeFiltrate;
    const risposteValide = Object.keys(risposte).filter(id => 
        domandeFiltrate.find(d => d.id === id)
    );
    
    if (risposteValide.length < domandeFiltrate.length * 0.7) {
        showToast(`⚠️ Compila almeno il 70% del questionario (${risposteValide.length}/${domandeFiltrate.length})`, 'warning', 5000);
        return;
    }
    
    // Mostra loading
    showToast('⚙️ Elaborazione in corso...', 'info', 0, false);
    
    setTimeout(() => {
        try {
            // ===============================
            // STEP 1: CALCOLI BASE
            // ===============================
            console.log('%c📊 STEP 1: Calcoli punteggi', 'color: #0066CC; font-weight: bold');
            
            const punteggioGlobale = calcolaPunteggioPonderato(risposte, domandeFiltrate);
            const punteggiSezioni = calcolaPunteggiPerSezione(risposte, domandeFiltrate);
            
            appState.results.indiceGlobale = punteggioGlobale;
            appState.results.punteggiSezioni = punteggiSezioni;
            appState.results.risposteAnalizzate = risposteValide.length;
            appState.results.totaleDomande = domandeFiltrate.length;
            
            console.log('Punteggio globale:', punteggioGlobale.toFixed(2));
            console.log('Punteggi sezioni:', punteggiSezioni);
            
            // ===============================
            // STEP 2: NORMOTIPO
            // ===============================
            console.log('%c🧠 STEP 2: Identificazione Normotipo', 'color: #8B5CF6; font-weight: bold');
            
            const normotipoResult = identificaNormotipoAziendale(
                appState.company,
                punteggioGlobale,
                punteggiSezioni
            );
            
            appState.results.normotipo = normotipoResult.normotipo;
            appState.results.confidenzaNormotipo = normotipoResult.confidenza;
            
            // ===============================
            // STEP 3: BIAS COGNITIVI
            // ===============================
            console.log('%c⚠️ STEP 3: Rilevamento Bias', 'color: #F59E0B; font-weight: bold');
            
            const bias = rilevaBiasCognitivi(
                risposte,
                punteggioGlobale,
                punteggiSezioni,
                domandeFiltrate
            );
            
            appState.results.bias = bias;
            
            // ===============================
            // STEP 4: SCENARI STRESS
            // ===============================
            console.log('%c🌪️ STEP 4: Scenari Stress', 'color: #F97316; font-weight: bold');
            
            const scenari = simulaScenariStressAziendaliFull(
                appState.company,
                risposte,
                punteggiSezioni
            );
            
            appState.results.scenariStress = scenari;
            
            // ===============================
            // STEP 5: GAP ANALYSIS
            // ===============================
            console.log('%c🔍 STEP 5: GAP Analysis', 'color: #06B6D4; font-weight: bold');
            
            const gaps = analizzaGapProtettivi(
                risposte,
                punteggiSezioni,
                normotipoResult,
                appState.company
            );
            
            appState.results.gapAnalysis = gaps;
            
            // ===============================
            // STEP 6: RACCOMANDAZIONI
            // ===============================
            console.log('%c💡 STEP 6: Raccomandazioni Prodotti', 'color: #8B5CF6; font-weight: bold');
            
            const raccomandazioni = generaRaccomandazioniProdotti(
                risposte,
                gaps,
                normotipoResult,
                scenari,
                appState.company
            );
            
            appState.results.raccomandazioni = raccomandazioni;
            
            // ===============================
            // STEP 7: BENCHMARK
            // ===============================
            console.log('%c📊 STEP 7: Benchmark Settore', 'color: #10B981; font-weight: bold');
            
            const benchmark = generaBenchmarkSettore(
                appState.company,
                punteggioGlobale,
                punteggiSezioni
            );
            
            appState.results.benchmark = benchmark;
            
            // ===============================
            // FINALIZZAZIONE
            // ===============================
            appState.results.generated = true;
            appState.results.timestamp = new Date().toISOString();
            
            const endTime = Date.now();
            const elapsed = ((endTime - startTime) / 1000).toFixed(2);
            
            console.log('%c' + '═'.repeat(80), 'color: #10B981; font-weight: bold');
            console.log('%c✅ ANALISI COMPLETATA', 'color: #10B981; font-weight: bold; font-size: 18px');
            console.log(`%cTempo elaborazione: ${elapsed}s`, 'color: #10B981; font-weight: bold');
            console.log('%c' + '═'.repeat(80), 'color: #10B981; font-weight: bold');
            
            // Chiudi toast loading
            const toasts = document.querySelectorAll('.toast');
            toasts.forEach(t => t.remove());
            
            // Mostra successo
            showToast('✅ Analisi completata con successo!', 'success', 3000);
            
            // Render risultati
            renderRisultati();
            
            // Scroll ai risultati
            setTimeout(() => {
                document.getElementById('risultatiContainer')?.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }, 500);
            
            // Auto-save
            autoSave();
            
        } catch (error) {
            console.error('❌ Errore durante l\'analisi:', error);
            showToast('❌ Errore durante l\'elaborazione. Riprova.', 'error', 5000);
        }
    }, 100);
}

console.log('%c✅ SEZIONE 14/15 COMPLETATA: Funzione Principale', 'color: #10B981; font-weight: bold; font-size: 14px');

// ========================================
// SEZIONE 15/15 PARTE 1: RENDERING RISULTATI
// ========================================

function renderRisultati() {
    const container = document.getElementById('risultatiContenuto');
    const risultatiCard = document.getElementById('risultatiContainer');
    
    if (!container || !risultatiCard) return;
    
    risultatiCard.classList.remove('hidden');
    
    let html = '';
    
    const results = appState.results;
    const company = appState.company;
    
    // ===============================
    // SUMMARY HEADER
    // ===============================
    html += `
    <div class="risultati-summary">
        <h2>🎯 Analisi Completata per ${company.anagrafica.ragioneSociale}</h2>
        <p style="font-size: 16px; opacity: 0.9; margin-bottom: 25px;">
            ${company.datiSocietari.settore} • ${company.datiSocietari.numeroDipendenti} • ${company.datiSocietari.fatturatoAnnuo}
        </p>
        <div class="summary-grid">
            <div class="summary-stat">
                <div class="summary-stat-value">${results.indiceGlobale.toFixed(1)}/5</div>
                <div class="summary-stat-label">Indice Globale Protezione</div>
            </div>
            <div class="summary-stat">
                <div class="summary-stat-value">${results.risposteAnalizzate}/${results.totaleDomande}</div>
                <div class="summary-stat-label">Domande Analizzate</div>
            </div>
            <div class="summary-stat">
                <div class="summary-stat-value">${results.gapAnalysis.filter(g => g.livello === 'ALTO').length}</div>
                <div class="summary-stat-label">Gap Critici</div>
            </div>
            <div class="summary-stat">
                <div class="summary-stat-value">${results.raccomandazioni.filter(r => r.priorita === 'ALTA').length}</div>
                <div class="summary-stat-label">Priorità Alta</div>
            </div>
        </div>
    </div>
    `;
    
    // ===============================
    // PUNTEGGI PER SEZIONE
    // ===============================
    html += `
    <div class="card">
        <h3 class="card-title">
            <span class="icon">📊</span>
            Punteggi per Sezione
        </h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
    `;
    
    for (const [sezione, punteggio] of Object.entries(results.punteggiSezioni)) {
        const perc = (punteggio / 5) * 100;
        const color = perc >= 70 ? 'var(--green)' : perc >= 50 ? 'var(--orange)' : 'var(--red)';
        
        html += `
        <div style="background: var(--gray-50); padding: 20px; border-radius: 10px; border-left: 4px solid ${color};">
            <div style="font-size: 14px; font-weight: 600; color: var(--gray-700); margin-bottom: 10px;">${sezione}</div>
            <div style="font-size: 32px; font-weight: 700; color: ${color}; margin-bottom: 5px;">${punteggio.toFixed(1)}/5</div>
            <div style="background: var(--gray-200); height: 8px; border-radius: 4px; overflow: hidden;">
                <div style="width: ${perc}%; height: 100%; background: ${color}; transition: width 0.5s;"></div>
            </div>
        </div>
        `;
    }
    
    html += `
        </div>
    </div>
    `;
    
    // ===============================
    // NORMOTIPO
    // ===============================
    if (results.normotipo) {
        html += `
        <div class="card">
            <h3 class="card-title">
                <span class="icon">🧠</span>
                Profilo Aziendale (Normotipo)
            </h3>
            <div class="normotipo-card">
                <div class="normotipo-title">
                    ${results.normotipo.profilo}
                    <span style="font-size: 14px; font-weight: normal; color: var(--purple); margin-left: 10px;">
                        (Confidenza: ${results.confidenzaNormotipo}%)
                    </span>
                </div>
                <div class="normotipo-description">
                    ${results.normotipo.descrizione}
                </div>
                <div class="normotipo-traits">
                    ${results.normotipo.caratteristiche.map(c => `
                        <span class="trait-badge">${c}</span>
                    `).join('')}
                </div>
                <div class="normotipo-priorita">
                    <div class="priorita-title">🎯 Priorità Assicurative Specifiche</div>
                    ${Object.entries(results.normotipo.priorita)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 8)
                        .map(([key, val]) => {
                            const classe = val >= 90 ? 'priorita-alta' : val >= 75 ? 'priorita-media' : 'priorita-bassa';
                            const nome = key.replace(/_/g, ' ').toUpperCase();
                            return `
                            <div class="priorita-item">
                                <span class="priorita-nome">${nome}</span>
                                <span class="priorita-valore ${classe}">${val}</span>
                            </div>
                            `;
                        }).join('')}
                </div>
            </div>
        </div>
        `;
    }
    
    // ===============================
    // BIAS COGNITIVI
    // ===============================
    if (results.bias && results.bias.length > 0) {
        html += `
        <div class="card">
            <h3 class="card-title">
                <span class="icon">⚠️</span>
                Bias Cognitivi Rilevati (${results.bias.length})
            </h3>
            <div class="alert alert-warning" style="margin-bottom: 20px;">
                <strong>💡 Cosa sono i bias?</strong> I bias cognitivi sono distorsioni sistematiche nella percezione del rischio 
                che possono portare a decisioni subottimali. Riconoscerli aiuta a prendere decisioni più razionali e informate.
            </div>
        `;
        
        results.bias.forEach(bias => {
            const colorIntensita = bias.intensita === 'ALTA' ? 'var(--red)' :
                                  bias.intensita === 'MEDIA' ? 'var(--orange)' : 'var(--yellow)';
            
            html += `
            <div class="bias-card">
                <div class="bias-header">
                    <div class="bias-title">${bias.nome}</div>
                    <div class="bias-intensita" style="background: ${colorIntensita};">${bias.intensita}</div>
                </div>
                <div class="bias-description">${bias.descrizione}</div>
                ${bias.dettaglio ? `<div class="bias-info"><strong>Rilevato:</strong> ${bias.dettaglio}</div>` : ''}
                <div class="bias-info"><strong>Segnali:</strong> ${bias.segnali.join(', ')}</div>
                <div class="bias-info"><strong>Impatto:</strong> ${bias.impatto}</div>
                <div class="bias-info"><strong>Contromisure:</strong> ${bias.contromisure.slice(0, 3).join(' • ')}</div>
            </div>
            `;
        });
        
        html += `</div>`;
    }
    
    container.innerHTML = html;
    
    // Continua con parte 2...
    renderRisultatiParte2(container);
}

console.log('%c✅ SEZIONE 15 PARTE 1 COMPLETATA: Rendering Summary + Normotipo + Bias', 'color: #10B981; font-weight: bold; font-size: 14px');

// ========================================
// SEZIONE 15/15 PARTE 2: RENDERING SCENARI + GAP + RACC + BENCHMARK
// ========================================

function renderRisultatiParte2(container) {
    const results = appState.results;
    let html = container.innerHTML;
    
    // ===============================
    // SCENARI STRESS
    // ===============================
    if (results.scenariStress && results.scenariStress.length > 0) {
        html += `
        <div class="card">
            <h3 class="card-title">
                <span class="icon">🌪️</span>
                Scenari Stress Aziendali (${results.scenariStress.length})
            </h3>
            <div class="alert alert-info" style="margin-bottom: 20px;">
                <strong>🔍 Scenari What-If:</strong> Simulazioni di eventi avversi realistici con impatto economico stimato, 
                per valutare l'esposizione al rischio e identificare le aree di maggiore vulnerabilità.
            </div>
        `;
        
        // Ordina per gravità
        const scenariOrdinati = [...results.scenariStress].sort((a, b) => {
            const gravitaOrder = { 'catastrofica': 4, 'critica': 3, 'significativa': 2, 'gestibile': 1 };
            return (gravitaOrder[b.gravita] || 0) - (gravitaOrder[a.gravita] || 0);
        });
        
        scenariOrdinati.forEach((scenario, idx) => {
            const probColor = scenario.probabilita === 'alta' ? 'var(--red)' :
                            scenario.probabilita === 'media' ? 'var(--orange)' : 'var(--green)';
            const probClass = scenario.probabilita === 'alta' ? 'prob-alta' :
                            scenario.probabilita === 'media' ? 'prob-media' : 'prob-bassa';
            
            html += `
            <div class="scenario-card">
                <div class="scenario-header">
                    <div class="scenario-title">
                        ${scenario.icon} ${scenario.titolo}
                    </div>
                    <div class="scenario-probabilita ${probClass}">
                        ${scenario.probabilita.toUpperCase()} (${scenario.probabilitaPerc}%)
                    </div>
                </div>
                <div class="scenario-descrizione">${scenario.descrizione}</div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                    <div class="scenario-impatto">
                        <div class="impatto-economico">€${scenario.impatto.toLocaleString('it-IT')}</div>
                        <div class="impatto-label">Impatto Economico</div>
                    </div>
                    <div class="scenario-impatto" style="background: var(--yellow-light);">
                        <div class="impatto-economico" style="color: var(--orange);">€${scenario.copertura.toLocaleString('it-IT')}</div>
                        <div class="impatto-label">Copertura Attuale</div>
                    </div>
                    <div class="scenario-impatto" style="background: var(--red-light);">
                        <div class="impatto-economico" style="color: var(--red);">€${scenario.scoperta.toLocaleString('it-IT')}</div>
                        <div class="impatto-label">ESPOSIZIONE</div>
                    </div>
                </div>
                <div style="background: var(--gray-50); padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                    <strong style="color: var(--gray-800);">📋 Dettagli:</strong>
                    <ul style="margin: 8px 0 0 20px; color: var(--gray-700);">
                        ${scenario.dettagli.map(d => `<li style="margin: 4px 0;">${d}</li>`).join('')}
                    </ul>
                </div>
                <div class="scenario-raccomandazione">
                    <div class="raccomandazione-title">✅ Raccomandazioni</div>
                    <ul style="margin: 8px 0 0 20px; list-style: none; padding: 0;">
                        ${scenario.raccomandazioni.map(r => `
                            <li style="margin: 5px 0; padding-left: 20px; position: relative;">
                                <span style="position: absolute; left: 0; color: var(--green); font-weight: bold;">→</span>
                                ${r}
                            </li>
                        `).join('')}
                    </ul>
                </div>
            </div>
            `;
        });
        
        html += `</div>`;
    }
    
    // ===============================
    // GAP ANALYSIS
    // ===============================
    if (results.gapAnalysis && results.gapAnalysis.length > 0) {
        html += `
        <div class="card">
            <h3 class="card-title">
                <span class="icon">🔍</span>
                GAP Analysis - Aree di Miglioramento (${results.gapAnalysis.length})
            </h3>
        `;
        
        // Ordina per GAP Score (più alto = più critico)
        const gapOrdinati = [...results.gapAnalysis].sort((a, b) => b.gapScore - a.gapScore);
        
        gapOrdinati.forEach(gap => {
            const gapClass = gap.livello === 'ALTO' ? 'gap-alto' :
                           gap.livello === 'MEDIO' ? 'gap-medio' : 'gap-basso';
            const borderColor = gap.livello === 'ALTO' ? 'var(--red)' :
                              gap.livello === 'MEDIO' ? 'var(--orange)' : 'var(--green)';
            
            html += `
            <div class="gap-card" style="border-color: ${borderColor};">
                <div class="gap-header">
                    <div class="gap-title">${gap.icon} ${gap.area}</div>
                    <div style="text-align: right;">
                        <div class="gap-score ${gapClass}">${gap.gapScore}</div>
                        <div style="font-size: 12px; color: var(--gray-600); margin-top: 4px;">GAP Score</div>
                    </div>
                </div>
                <div class="gap-descrizione">${gap.descrizione}</div>
                <div style="background: var(--gray-50); padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                    <strong style="color: var(--gray-800);">Punteggio attuale: ${gap.score}/5</strong>
                    <div style="background: var(--gray-200); height: 8px; border-radius: 4px; margin-top: 8px; overflow: hidden;">
                        <div style="width: ${(gap.score / 5) * 100}%; height: 100%; background: ${borderColor};"></div>
                    </div>
                </div>
                <div style="background: ${gap.priorita === 'ALTA' ? 'var(--red-light)' : 'var(--yellow-light)'}; padding: 10px; border-radius: 6px; margin-bottom: 12px;">
                    <strong style="color: ${gap.priorita === 'ALTA' ? 'var(--red-dark)' : 'var(--orange-dark)'};">
                        Priorità: ${gap.priorita}
                    </strong>
                </div>
                <div>
                    <strong style="color: var(--cyan-dark);">💡 Azioni Raccomandate:</strong>
                    <ul class="gap-raccomandazioni">
                        ${gap.raccomandazioni.map(r => `<li>${r}</li>`).join('')}
                    </ul>
                </div>
            </div>
            `;
        });
        
        html += `</div>`;
    }
    
    // ===============================
    // RACCOMANDAZIONI PRODOTTI
    // ===============================
    if (results.raccomandazioni && results.raccomandazioni.length > 0) {
        html += `
        <div class="card">
            <h3 class="card-title">
                <span class="icon">💡</span>
                Raccomandazioni Prodotti Assicurativi (${results.raccomandazioni.length})
            </h3>
            <div class="alert alert-success" style="margin-bottom: 20px;">
                <strong>🎯 Portfolio Consigliato:</strong> Selezione personalizzata di coperture assicurative basata sul profilo aziendale, 
                sui gap rilevati e sulle priorità del normotipo identificato.
            </div>
        `;
        
        results.raccomandazioni.forEach((racc, idx) => {
            const prioritaBgColor = racc.priorita === 'ALTA' ? 'var(--red)' :
                                   racc.priorita === 'MEDIA' ? 'var(--orange)' : 'var(--green)';
            const prioritaBadgeClass = racc.priorita === 'ALTA' ? 'priorita-alta-badge' :
                                      racc.priorita === 'MEDIA' ? 'priorita-media-badge' : 'priorita-bassa-badge';
            
            html += `
            <div class="raccomandazione-card">
                <div class="racc-header">
                    <div class="racc-numero">${racc.numero}</div>
                    <div class="racc-priorita-badge ${prioritaBadgeClass}">${racc.priorita}</div>
                </div>
                <div class="racc-titolo">${racc.prodotto}</div>
                <div style="display: inline-block; background: var(--blue-light); color: var(--blue-dark); padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; margin-bottom: 10px;">
                    ${racc.categoria}
                </div>
                <div class="racc-descrizione">${racc.descrizione}</div>
                <div style="background: var(--yellow-light); padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                    <strong style="color: var(--orange-dark);">🎯 Perché consigliato:</strong>
                    <div style="margin-top: 6px; color: var(--gray-800);">${racc.motivazione}</div>
                </div>
                <div style="background: var(--green-light); padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                    <strong style="color: var(--green-dark);">✅ Benefici chiave:</strong>
                    <ul style="margin: 8px 0 0 20px; color: var(--gray-800);">
                        ${racc.benefici.map(b => `<li style="margin: 4px 0;">${b}</li>`).join('')}
                    </ul>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 10px; border-top: 2px solid var(--gray-200);">
                    <div style="font-size: 13px; color: var(--gray-600);">
                        <strong>Score Normotipo:</strong> <span style="color: var(--generali-blue); font-weight: 700;">${racc.scoreNormotipo}</span>
                    </div>
                    <div style="font-size: 12px; color: var(--gray-600); font-style: italic;">
                        ${racc.rationale}
                    </div>
                </div>
            </div>
            `;
        });
        
        html += `</div>`;
    }
    
    // ===============================
    // BENCHMARK SETTORE
    // ===============================
    if (results.benchmark) {
        const bench = results.benchmark;
        html += `
        <div class="card">
            <h3 class="card-title">
                <span class="icon">📊</span>
                Confronto con Benchmark Settore
            </h3>
            <div style="background: var(--blue-light); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <div style="font-size: 20px; font-weight: 700; color: var(--blue-dark); margin-bottom: 10px;">
                    Settore: ${bench.settore}
                </div>
                <div style="font-size: 14px; color: var(--gray-700);">
                    Confronto con aziende simili nel settore ${bench.settore}
                </div>
            </div>
            <div class="benchmark-grid">
                <div class="benchmark-item">
                    <div class="benchmark-label">Numero Polizze</div>
                    <div class="benchmark-values">
                        <div class="benchmark-value">
                            <div class="benchmark-numero" style="color: var(--generali-blue);">${bench.tuoiDati.polizzeRaccom}</div>
                            <div class="benchmark-sublabel">LA TUA AZIENDA</div>
                        </div>
                        <div class="benchmark-vs">vs</div>
                        <div class="benchmark-value">
                            <div class="benchmark-numero" style="color: var(--gray-600);">${bench.benchmarkSettore.polizzeMedia}</div>
                            <div class="benchmark-sublabel">MEDIA SETTORE</div>
                        </div>
                    </div>
                    <div style="margin-top: 15px; text-align: center; font-size: 13px; font-weight: 600; color: ${bench.comparazione.polizze === 'adeguato' ? 'var(--green)' : 'var(--orange)'};">
                        ${bench.comparazione.polizze === 'adeguato' ? '✅ Adeguato' : '⚠️ Sotto Media'}
                    </div>
                </div>
                
                <div class="benchmark-item">
                    <div class="benchmark-label">Livello Protezione</div>
                    <div class="benchmark-values">
                        <div class="benchmark-value">
                            <div class="benchmark-numero" style="color: var(--generali-blue);">${bench.tuoiDati.coherence}%</div>
                            <div class="benchmark-sublabel">LA TUA AZIENDA</div>
                        </div>
                        <div class="benchmark-vs">vs</div>
                        <div class="benchmark-value">
                            <div class="benchmark-numero" style="color: var(--gray-600);">${bench.benchmarkSettore.coherenceMedia}%</div>
                            <div class="benchmark-sublabel">MEDIA SETTORE</div>
                        </div>
                    </div>
                    <div style="margin-top: 15px; text-align: center; font-size: 13px; font-weight: 600; color: ${bench.comparazione.protezione === 'sopra_media' ? 'var(--green)' : bench.comparazione.protezione === 'nella_media' ? 'var(--orange)' : 'var(--red)'};">
                        ${bench.comparazione.protezione === 'sopra_media' ? '✅ Sopra Media' : bench.comparazione.protezione === 'nella_media' ? '📊 Nella Media' : '⚠️ Sotto Media'}
                    </div>
                </div>
                
                <div class="benchmark-item">
                    <div class="benchmark-label">Fatturato Annuo</div>
                    <div class="benchmark-values">
                        <div class="benchmark-value">
                            <div class="benchmark-numero" style="color: var(--generali-blue);">€${(bench.tuoiDati.fatturato / 1000000).toFixed(1)}M</div>
                            <div class="benchmark-sublabel">LA TUA AZIENDA</div>
                        </div>
                        <div class="benchmark-vs">vs</div>
                        <div class="benchmark-value">
                            <div class="benchmark-numero" style="color: var(--gray-600);">€${(bench.benchmarkSettore.fatturatoMedio / 1000000).toFixed(1)}M</div>
                            <div class="benchmark-sublabel">MEDIA SETTORE</div>
                        </div>
                    </div>
                    <div style="margin-top: 15px; text-align: center; font-size: 13px; font-weight: 600; color: ${bench.comparazione.dimensione === 'sopra_media' ? 'var(--green)' : 'var(--orange)'};">
                        ${bench.comparazione.dimensione === 'sopra_media' ? '✅ Sopra Media' : '📊 Sotto Media'}
                    </div>
                </div>
            </div>
        </div>
        `;
    }
    
    // ===============================
    // AZIONI FINALI
    // ===============================
    html += `
    <div class="card">
        <h3 class="card-title">
            <span class="icon">📥</span>
            Esporta Risultati
        </h3>
        <div class="btn-group">
            <button class="btn btn-secondary btn-block" onclick="exportJSON()">
                📄 Esporta JSON
            </button>
            <button class="btn btn-success btn-block" onclick="exportExcel()">
                📊 Esporta Excel
            </button>
            <button class="btn btn-primary btn-block" onclick="window.print()">
                🖨️ Stampa Report
            </button>
        </div>
    </div>
    `;
    
    container.innerHTML = html;
    
    console.log('✅ Rendering risultati completo');
}

console.log('%c✅ SEZIONE 15 COMPLETATA: Rendering Risultati Completo', 'color: #10B981; font-weight: bold; font-size: 14px');

// ========================================
// SEZIONE FINALE: EXPORT + DIAGNOSTICA + UTILITIES
// ========================================

// ========================================
// EXPORT EXCEL COMPLETO
// ========================================

function exportExcel() {
    if (!appState.results.generated) {
        showToast('⚠️ Genera prima l\'analisi completa', 'warning');
        return;
    }
    
    try {
        const wb = XLSX.utils.book_new();
        
        // ===== SHEET 1: ANAGRAFICA =====
        const anagraficaData = [
            ['Partner di Vita AZIENDE - Analisi Completa'],
            [''],
            ['DATI AZIENDALI'],
            ['Ragione Sociale', appState.company.anagrafica.ragioneSociale || ''],
            ['Partita IVA', appState.company.anagrafica.partitaIVA || ''],
            ['Settore', appState.company.datiSocietari.settore || ''],
            ['Dimensione', appState.company.datiSocietari.numeroDipendenti || ''],
            ['Fatturato', appState.company.datiSocietari.fatturatoAnnuo || ''],
            ['Città', appState.company.anagrafica.citta || ''],
            [''],
            ['REFERENTE'],
            ['Nome', appState.company.referente.nome || ''],
            ['Ruolo', appState.company.referente.ruolo || ''],
            ['Email', appState.company.referente.email || ''],
            [''],
            ['CONSULENTE GENERALI'],
            ['Nome', appState.company.consulente.nome || ''],
            ['Email', appState.company.consulente.email || ''],
            [''],
            ['ANALISI'],
            ['Data', new Date(appState.results.timestamp).toLocaleString('it-IT')],
            ['Versione Sistema', appState.version]
        ];
        const wsAnagrafica = XLSX.utils.aoa_to_sheet(anagraficaData);
        XLSX.utils.book_append_sheet(wb, wsAnagrafica, 'Anagrafica');
        
        // ===== SHEET 2: PUNTEGGI =====
        const punteggiData = [
            ['PUNTEGGI ANALISI'],
            [''],
            ['Indice Globale', appState.results.indiceGlobale.toFixed(2)],
            ['Risposte Analizzate', appState.results.risposteAnalizzate],
            ['Totale Domande', appState.results.totaleDomande],
            [''],
            ['PUNTEGGI PER SEZIONE'],
            ['Sezione', 'Punteggio']
        ];
        
        Object.entries(appState.results.punteggiSezioni).forEach(([sez, punt]) => {
            punteggiData.push([sez, punt.toFixed(2)]);
        });
        
        const wsPunteggi = XLSX.utils.aoa_to_sheet(punteggiData);
        XLSX.utils.book_append_sheet(wb, wsPunteggi, 'Punteggi');
        
        // ===== SHEET 3: NORMOTIPO =====
        if (appState.results.normotipo) {
            const normotipoData = [
                ['PROFILO AZIENDALE (NORMOTIPO)'],
                [''],
                ['Profilo', appState.results.normotipo.profilo],
                ['Confidenza', appState.results.confidenzaNormotipo + '%'],
                [''],
                ['DESCRIZIONE'],
                [appState.results.normotipo.descrizione],
                [''],
                ['CARATTERISTICHE']
            ];
            
            appState.results.normotipo.caratteristiche.forEach(c => {
                normotipoData.push([c]);
            });
            
            normotipoData.push([''], ['PRIORITÀ ASSICURATIVE'], ['Copertura', 'Score']);
            
            Object.entries(appState.results.normotipo.priorita)
                .sort((a, b) => b[1] - a[1])
                .forEach(([key, val]) => {
                    normotipoData.push([key.replace(/_/g, ' ').toUpperCase(), val]);
                });
            
            const wsNormotipo = XLSX.utils.aoa_to_sheet(normotipoData);
            XLSX.utils.book_append_sheet(wb, wsNormotipo, 'Normotipo');
        }
        
        // ===== SHEET 4: SCENARI STRESS =====
        const scenariData = [
            ['SCENARI STRESS AZIENDALI'],
            [''],
            ['Scenario', 'Probabilità', 'Probabilità %', 'Impatto €', 'Copertura €', 'Esposizione €', 'Gravità']
        ];
        
        appState.results.scenariStress.forEach(sc => {
            scenariData.push([
                sc.titolo,
                sc.probabilita,
                sc.probabilitaPerc,
                sc.impatto,
                sc.copertura,
                sc.scoperta,
                sc.gravita
            ]);
        });
        
        const wsScenari = XLSX.utils.aoa_to_sheet(scenariData);
        XLSX.utils.book_append_sheet(wb, wsScenari, 'Scenari Stress');
        
        // ===== SHEET 5: GAP ANALYSIS =====
        const gapData = [
            ['GAP ANALYSIS'],
            [''],
            ['Area', 'Livello', 'Score', 'GAP Score', 'Priorità']
        ];
        
        appState.results.gapAnalysis.forEach(gap => {
            gapData.push([
                gap.area,
                gap.livello,
                gap.score,
                gap.gapScore,
                gap.priorita
            ]);
        });
        
        const wsGap = XLSX.utils.aoa_to_sheet(gapData);
        XLSX.utils.book_append_sheet(wb, wsGap, 'GAP Analysis');
        
        // ===== SHEET 6: RACCOMANDAZIONI =====
        const raccData = [
            ['RACCOMANDAZIONI PRODOTTI'],
            [''],
            ['#', 'Prodotto', 'Categoria', 'Priorità', 'Score Normotipo']
        ];
        
        appState.results.raccomandazioni.forEach(racc => {
            raccData.push([
                racc.numero,
                racc.prodotto,
                racc.categoria,
                racc.priorita,
                racc.scoreNormotipo
            ]);
        });
        
        const wsRacc = XLSX.utils.aoa_to_sheet(raccData);
        XLSX.utils.book_append_sheet(wb, wsRacc, 'Raccomandazioni');
        
        // ===== SHEET 7: BIAS =====
        if (appState.results.bias && appState.results.bias.length > 0) {
            const biasData = [
                ['BIAS COGNITIVI RILEVATI'],
                [''],
                ['Bias', 'Intensità', 'Descrizione']
            ];
            
            appState.results.bias.forEach(bias => {
                biasData.push([
                    bias.nome,
                    bias.intensita,
                    bias.descrizione
                ]);
            });
            
            const wsBias = XLSX.utils.aoa_to_sheet(biasData);
            XLSX.utils.book_append_sheet(wb, wsBias, 'Bias Cognitivi');
        }
        
        // Scarica file
        const filename = `Partner_Vita_${appState.company.anagrafica.ragioneSociale || 'Azienda'}_${Date.now()}.xlsx`;
        XLSX.writeFile(wb, filename);
        
        showToast('📊 Excel esportato con successo!', 'success');
        console.log('✅ Export Excel completato:', filename);
        
    } catch (error) {
        console.error('Errore export Excel:', error);
        showToast('❌ Errore durante l\'export Excel', 'error');
    }
}

// ========================================
// DIAGNOSTICA SISTEMA AVANZATA
// ========================================

window.diagnostica = function() {
    console.log('%c' + '═'.repeat(80), 'color: #3B82F6; font-weight: bold');
    console.log('%c🔍 DIAGNOSTICA SISTEMA COMPLETA', 'color: #3B82F6; font-weight: bold; font-size: 16px');
    console.log('%c' + '═'.repeat(80), 'color: #3B82F6; font-weight: bold');
    
    const diagnostica = {
        sistema: {
            versione: appState.version,
            build: appState.buildDate,
            darkMode: appState.darkMode,
            autoSave: appState.autoSave
        },
        utente: {
            consulente: appState.consulente || 'Non loggato',
            timestamp: new Date().toISOString()
        },
        azienda: {
            ragioneSociale: appState.company.anagrafica.ragioneSociale || 'Non compilata',
            settore: appState.company.datiSocietari.settore || 'N/D',
            dimensione: appState.company.datiSocietari.numeroDipendenti || 'N/D',
            fatturato: appState.company.datiSocietari.fatturatoAnnuo || 'N/D'
        },
        questionario: {
            domandeFiltrate: appState.questionario.domandeFiltrate.length,
            risposteDate: Object.keys(appState.questionario.risposte).length,
            completamento: appState.questionario.domandeFiltrate.length > 0 ? 
                Math.round((Object.keys(appState.questionario.risposte).length / appState.questionario.domandeFiltrate.length) * 100) + '%' : '0%',
            completato: appState.questionario.completato
        },
        risultati: {
            generated: appState.results.generated,
            timestamp: appState.results.timestamp || 'N/D',
            indiceGlobale: appState.results.indiceGlobale.toFixed(2),
            normotipo: appState.results.normotipo ? appState.results.normotipo.profilo : 'N/D',
            biasRilevati: appState.results.bias ? appState.results.bias.length : 0,
            scenariSimulati: appState.results.scenariStress ? appState.results.scenariStress.length : 0,
            gapIdentificati: appState.results.gapAnalysis ? appState.results.gapAnalysis.length : 0,
            raccomandazioni: appState.results.raccomandazioni ? appState.results.raccomandazioni.length : 0
        },
        memoria: {
            localStorage: localStorage.length + ' chiavi',
            appStateSize: JSON.stringify(appState).length + ' bytes'
        }
    };
    
    console.table(diagnostica.sistema);
    console.table(diagnostica.utente);
    console.table(diagnostica.azienda);
    console.table(diagnostica.questionario);
    console.table(diagnostica.risultati);
    console.table(diagnostica.memoria);
    
    console.log('%c' + '═'.repeat(80), 'color: #10B981; font-weight: bold');
    
    return diagnostica;
};

// ========================================
// STATISTICHE AVANZATE
// ========================================

window.statistiche = function() {
    if (!appState.results.generated) {
        console.warn('⚠️ Genera prima l\'analisi per vedere le statistiche');
        return null;
    }
    
    console.log('%c📈 STATISTICHE ANALISI', 'color: #8B5CF6; font-weight: bold; font-size: 14px');
    
    const stats = {
        punteggi: {
            globale: appState.results.indiceGlobale.toFixed(2),
            sezioni: appState.results.punteggiSezioni
        },
        gaps: {
            totale: appState.results.gapAnalysis.length,
            alti: appState.results.gapAnalysis.filter(g => g.livello === 'ALTO').length,
            medi: appState.results.gapAnalysis.filter(g => g.livello === 'MEDIO').length,
            bassi: appState.results.gapAnalysis.filter(g => g.livello === 'BASSO').length
        },
        raccomandazioni: {
            totale: appState.results.raccomandazioni.length,
            prioritaAlta: appState.results.raccomandazioni.filter(r => r.priorita === 'ALTA').length,
            prioritaMedia: appState.results.raccomandazioni.filter(r => r.priorita === 'MEDIA').length,
            prioritaBassa: appState.results.raccomandazioni.filter(r => r.priorita === 'BASSA').length
        },
        scenari: {
            totale: appState.results.scenariStress.length,
            esposizioneT otale: appState.results.scenariStress.reduce((sum, s) => sum + s.scoperta, 0),
            mediaEsposizione: appState.results.scenariStress.length > 0 ?
                appState.results.scenariStress.reduce((sum, s) => sum + s.scoperta, 0) / appState.results.scenariStress.length : 0
        },
        bias: {
            totale: appState.results.bias.length,
            intensitaAlta: appState.results.bias.filter(b => b.intensita === 'ALTA').length,
            intensitaMedia: appState.results.bias.filter(b => b.intensita === 'MEDIA').length
        }
    };
    
    console.table(stats.punteggi);
    console.table(stats.gaps);
    console.table(stats.raccomandazioni);
    console.table(stats.scenari);
    console.table(stats.bias);
    
    return stats;
};

// ========================================
// INIZIALIZZAZIONE SISTEMA
// ========================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('%c' + '═'.repeat(80), 'color: #003366; font-weight: bold');
    console.log('%c🏢 PARTNER DI VITA AZIENDE - ULTIMATE COMPLETE EDITION v3.0', 'color: #E31E24; font-weight: bold; font-size: 20px');
    console.log('%c' + '═'.repeat(80), 'color: #003366; font-weight: bold');
    console.log('%cBuild:', 'font-weight: bold', appState.buildDate);
    console.log('%cVersione:', 'font-weight: bold', appState.version);
    console.log('%c' + '═'.repeat(80), 'color: #003366; font-weight: bold');
    console.log('');
    console.log('%c📚 Digita help() per vedere i comandi disponibili', 'color: #0066CC; font-size: 14px');
    console.log('');
    console.log('%c✅ SISTEMA CARICATO CORRETTAMENTE', 'color: #10B981; font-weight: bold; font-size: 14px');
    console.log('');
    console.log('%cFunzionalità Attive:', 'font-weight: bold');
    console.log('  ✓ Sistema Adattivo 24 domande');
    console.log('  ✓ Normotipi Dinamici (dimensione + settore)');
    console.log('  ✓ 10 Scenari Stress completi');
    console.log('  ✓ GAP Analysis 5 aree');
    console.log('  ✓ 12 Raccomandazioni prodotti');
    console.log('  ✓ 8 Bias Cognitivi');
    console.log('  ✓ Benchmark Settore');
    console.log('  ✓ Export JSON/Excel');
    console.log('  ✓ Dark Mode + Auto-save');
    console.log('  ✓ Diagnostica Sistema');
    console.log('');
    console.log('%c' + '═'.repeat(80), 'color: #10B981; font-weight: bold');
    
    // Carica dati salvati se presenti
    const hasSaved = caricaDatiSalvati();
    if (hasSaved) {
        console.log('%c💾 Dati precedenti ripristinati', 'color: #F59E0B; font-weight: bold');
    }
    
    // Setup console helpers
    window.help();
});

// ========================================
// CHIUSURA E CREDITS
// ========================================

console.log('%c' + '═'.repeat(80), 'color: #003366; font-weight: bold');
console.log('%c✅ TUTTI I MODULI CARICATI CON SUCCESSO', 'color: #10B981; font-weight: bold; font-size: 16px');
console.log('%c' + '═'.repeat(80), 'color: #003366; font-weight: bold');
console.log('');
console.log('%cPartner di Vita AZIENDE - Ultimate Complete Edition', 'font-weight: bold; font-size: 14px');
console.log('Versione: v3.0.0-FINAL');
console.log('Build Date: 2025-10-30');
console.log('');
console.log('%c© 2025 Generali Italia - Metodo Rosso', 'color: #003366');
console.log('Sistema completo di analisi rischi aziendali e advisory assicurativo');
console.log('');
console.log('%c' + '═'.repeat(80), 'color: #10B981; font-weight: bold');

</script>

</body>
</html>
</script>

</body>
</html>
