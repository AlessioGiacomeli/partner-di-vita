<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partner di Vita - Metodo Rosso Generali</title>
    <style>
        :root {
            --generali-blue: #003366;
            --generali-red: #E31E24;
            --generali-light-blue: #0066CC;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-900: #111827;
            --green: #10B981;
            --yellow: #F59E0B;
            --orange: #F97316;
            --red: #EF4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            line-height: 1.6;
        }

        #loginScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--generali-blue) 0%, #004080 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .login-box {
            background: white;
            padding: 50px;
            border-radius: 8px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.3);
            max-width: 450px;
            width: 90%;
            text-align: center;
        }

        .login-box h1 {
            color: var(--generali-blue);
            margin-bottom: 10px;
            font-size: 28px;
        }

        .login-box .subtitle {
            color: var(--gray-600);
            margin-bottom: 30px;
            font-size: 14px;
        }

        .login-box input {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--gray-200);
            border-radius: 6px;
            font-size: 16px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .login-box input:focus {
            outline: none;
            border-color: var(--generali-blue);
        }

        .login-box button {
            width: 100%;
            padding: 15px;
            background: var(--generali-red);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-box button:hover {
            background: #C01A1F;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(227, 30, 36, 0.3);
        }

        .header {
            background: linear-gradient(135deg, var(--generali-blue) 0%, var(--generali-light-blue) 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header .tagline {
            font-size: 16px;
            opacity: 0.9;
        }

        .container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .card-title {
            font-size: 24px;
            color: var(--generali-blue);
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--generali-red);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--gray-200);
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--generali-blue);
            box-shadow: 0 0 0 3px rgba(0, 51, 102, 0.1);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-item label {
            cursor: pointer;
            font-weight: normal;
            margin: 0;
        }

        .polizza-fields {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: var(--gray-50);
            border-radius: 6px;
            border-left: 4px solid var(--generali-blue);
        }

        .polizza-fields.active {
            display: block;
        }

        .figli-details {
            display: none;
            margin-top: 15px;
            padding: 20px;
            background: var(--gray-50);
            border-radius: 8px;
            border-left: 4px solid var(--generali-blue);
        }

        .figli-details.active {
            display: block;
        }

        .figlio-item {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
            border: 1px solid var(--gray-200);
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--generali-red);
            color: white;
        }

        .btn-primary:hover {
            background: #C01A1F;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(227, 30, 36, 0.3);
        }

        .btn-secondary {
            background: var(--generali-blue);
            color: white;
        }

        .btn-secondary:hover {
            background: #00509E;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 51, 102, 0.3);
        }

        .btn-block {
            width: 100%;
        }

        #questionario {
            display: none;
        }

        .question-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-left: 4px solid var(--generali-blue);
        }

        .question-card h3 {
            color: var(--generali-blue);
            margin-bottom: 15px;
            font-size: 18px;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .option {
            padding: 12px 15px;
            border: 2px solid var(--gray-200);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .option:hover {
            border-color: var(--generali-blue);
            background: var(--gray-50);
        }

        .option.selected {
            border-color: var(--generali-blue);
            background: rgba(0, 51, 102, 0.05);
            font-weight: 600;
        }

        .progress-container {
            background: var(--gray-200);
            height: 8px;
            border-radius: 4px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--generali-blue), var(--generali-light-blue));
            width: 0%;
            transition: width 0.4s ease;
        }

        #risultati {
            display: none;
        }

        .semaforo {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
        }

        .semaforo.red {
            background: #FEE2E2;
            color: #991B1B;
        }

        .semaforo.orange {
            background: #FED7AA;
            color: #9A3412;
        }

        .semaforo.yellow {
            background: #FEF3C7;
            color: #92400E;
        }

        .semaforo.green {
            background: #D1FAE5;
            color: #065F46;
        }

        .semaforo.gray {
            background: var(--gray-200);
            color: var(--gray-600);
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .product-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-top: 4px solid var(--generali-blue);
            transition: all 0.3s;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .product-card h3 {
            color: var(--generali-blue);
            margin-bottom: 15px;
            font-size: 20px;
        }

        .warning-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #FEF3C7;
            color: #92400E;
            padding: 15px 20px;
            border-radius: 8px;
            border-left: 4px solid #F59E0B;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 9999;
            max-width: 400px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .incoherent {
            border-color: var(--red) !important;
            background: #FEE2E2 !important;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--generali-blue);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 9999;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .toast.success {
            background: var(--green);
        }

        .toast.error {
            background: var(--red);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 24px;
            }

            .card {
                padding: 20px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .product-grid {
                grid-template-columns: 1fr;
            }

            .login-box {
                padding: 30px 20px;
            }

            .checkbox-group {
                grid-template-columns: 1fr;
            }
        }

        @media print {
            .header,
            .btn,
            #loginScreen {
                display: none !important;
            }

            body {
                background: white;
            }

            .card {
                box-shadow: none;
                border: 1px solid var(--gray-300);
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>

    <!-- LOGIN SCREEN -->
    <div id="loginScreen">
        <div class="login-box">
            <h1>Partner di Vita</h1>
            <p class="subtitle">Metodo Rosso Generali - Sistema Integrato v4.2</p>
            <input type="password" id="passwordInput" placeholder="Inserisci password" autocomplete="off">
            <button onclick="checkPassword()">Accedi</button>
        </div>
    </div>

    <!-- HEADER -->
    <div class="header">
        <h1>Partner di Vita</h1>
        <p class="tagline">Sistema di Analisi Bisogni Assicurativi - Metodo Rosso Generali</p>
    </div>

    <!-- CONTAINER -->
    <div class="container">

        <!-- ANAGRAFICA -->
        <div class="card" id="anagraficaSection">
            <h2 class="card-title">Dati Anagrafici Cliente</h2>

            <div class="form-row">
                <div class="form-group">
                    <label for="nomeCliente">Nome e Cognome *</label>
                    <input type="text" id="nomeCliente" required>
                </div>
                <div class="form-group">
                    <label for="dataNascita">Data di Nascita *</label>
                    <input type="date" id="dataNascita" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="codiceFiscale">Codice Fiscale</label>
                    <input type="text" id="codiceFiscale" maxlength="16" style="text-transform: uppercase;">
                </div>
                <div class="form-group">
                    <label for="telefono">Telefono *</label>
                    <input type="tel" id="telefono" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="email">Email Cliente *</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label for="provincia">Provincia *</label>
                    <select id="provincia" required>
                        <option value="">Seleziona provincia</option>
                        <option value="AG">Agrigento</option>
                        <option value="AL">Alessandria</option>
                        <option value="AN">Ancona</option>
                        <option value="AO">Aosta</option>
                        <option value="AP">Ascoli Piceno</option>
                        <option value="AQ">L'Aquila</option>
                        <option value="AR">Arezzo</option>
                        <option value="AT">Asti</option>
                        <option value="AV">Avellino</option>
                        <option value="BA">Bari</option>
                        <option value="BG">Bergamo</option>
                        <option value="BI">Biella</option>
                        <option value="BL">Belluno</option>
                        <option value="BN">Benevento</option>
                        <option value="BO">Bologna</option>
                        <option value="BR">Brindisi</option>
                        <option value="BS">Brescia</option>
                        <option value="BT">Barletta-Andria-Trani</option>
                        <option value="BZ">Bolzano</option>
                        <option value="CA">Cagliari</option>
                        <option value="CB">Campobasso</option>
                        <option value="CE">Caserta</option>
                        <option value="CH">Chieti</option>
                        <option value="CL">Caltanissetta</option>
                        <option value="CN">Cuneo</option>
                        <option value="CO">Como</option>
                        <option value="CR">Cremona</option>
                        <option value="CS">Cosenza</option>
                        <option value="CT">Catania</option>
                        <option value="CZ">Catanzaro</option>
                        <option value="EN">Enna</option>
                        <option value="FC">Forlì-Cesena</option>
                        <option value="FE">Ferrara</option>
                        <option value="FG">Foggia</option>
                        <option value="FI">Firenze</option>
                        <option value="FM">Fermo</option>
                        <option value="FR">Frosinone</option>
                        <option value="GE">Genova</option>
                        <option value="GO">Gorizia</option>
                        <option value="GR">Grosseto</option>
                        <option value="IM">Imperia</option>
                        <option value="IS">Isernia</option>
                        <option value="KR">Crotone</option>
                        <option value="LC">Lecco</option>
                        <option value="LE">Lecce</option>
                        <option value="LI">Livorno</option>
                        <option value="LO">Lodi</option>
                        <option value="LT">Latina</option>
                        <option value="LU">Lucca</option>
                        <option value="MB">Monza e Brianza</option>
                        <option value="MC">Macerata</option>
                        <option value="ME">Messina</option>
                        <option value="MI">Milano</option>
                        <option value="MN">Mantova</option>
                        <option value="MO">Modena</option>
                        <option value="MS">Massa-Carrara</option>
                        <option value="MT">Matera</option>
                        <option value="NA">Napoli</option>
                        <option value="NO">Novara</option>
                        <option value="NU">Nuoro</option>
                        <option value="OR">Oristano</option>
                        <option value="PA">Palermo</option>
                        <option value="PC">Piacenza</option>
                        <option value="PD">Padova</option>
                        <option value="PE">Pescara</option>
                        <option value="PG">Perugia</option>
                        <option value="PI">Pisa</option>
                        <option value="PN">Pordenone</option>
                        <option value="PO">Prato</option>
                        <option value="PR">Parma</option>
                        <option value="PT">Pistoia</option>
                        <option value="PU">Pesaro e Urbino</option>
                        <option value="PV">Pavia</option>
                        <option value="PZ">Potenza</option>
                        <option value="RA">Ravenna</option>
                        <option value="RC">Reggio Calabria</option>
                        <option value="RE">Reggio Emilia</option>
                        <option value="RG">Ragusa</option>
                        <option value="RI">Rieti</option>
                        <option value="RM">Roma</option>
                        <option value="RN">Rimini</option>
                        <option value="RO">Rovigo</option>
                        <option value="SA">Salerno</option>
                        <option value="SI">Siena</option>
                        <option value="SO">Sondrio</option>
                        <option value="SP">La Spezia</option>
                        <option value="SR">Siracusa</option>
                        <option value="SS">Sassari</option>
                        <option value="SU">Sud Sardegna</option>
                        <option value="SV">Savona</option>
                        <option value="TA">Taranto</option>
                        <option value="TE">Teramo</option>
                        <option value="TN">Trento</option>
                        <option value="TO">Torino</option>
                        <option value="TP">Trapani</option>
                        <option value="TR">Terni</option>
                        <option value="TS">Trieste</option>
                        <option value="TV">Treviso</option>
                        <option value="UD">Udine</option>
                        <option value="VA">Varese</option>
                        <option value="VB">Verbano-Cusio-Ossola</option>
                        <option value="VC">Vercelli</option>
                        <option value="VE">Venezia</option>
                        <option value="VI">Vicenza</option>
                        <option value="VR">Verona</option>
                        <option value="VT">Viterbo</option>
                        <option value="VV">Vibo Valentia</option>
                    </select>
                </div>
            </div>
<div class="form-row">
                <div class="form-group">
                    <label for="professione">Professione *</label>
                    <select id="professione" required>
                        <option value="">Seleziona professione</option>
                        <optgroup label="Dipendenti">
                            <option value="Impiegato">Impiegato</option>
                            <option value="Quadro">Quadro</option>
                            <option value="Dirigente">Dirigente</option>
                            <option value="Operaio">Operaio</option>
                        </optgroup>
                        <optgroup label="Liberi Professionisti">
                            <option value="Avvocato">Avvocato</option>
                            <option value="Commercialista">Commercialista</option>
                            <option value="Notaio">Notaio</option>
                            <option value="Medico">Medico</option>
                            <option value="Odontoiatra">Odontoiatra</option>
                            <option value="Ingegnere">Ingegnere</option>
                            <option value="Architetto">Architetto</option>
                            <option value="Geometra">Geometra</option>
                            <option value="Agronomo">Agronomo</option>
                            <option value="Psicologo">Psicologo</option>
                            <option value="Fisioterapista">Fisioterapista</option>
                            <option value="Infermiere">Infermiere</option>
                            <option value="Consulente">Consulente</option>
                        </optgroup>
                        <optgroup label="Autonomi">
                            <option value="Artigiano">Artigiano</option>
                            <option value="Commerciante">Commerciante</option>
                            <option value="Imprenditore">Imprenditore</option>
                            <option value="Titolare azienda">Titolare azienda</option>
                        </optgroup>
                        <optgroup label="Tecnologia">
                            <option value="Informatico">Informatico</option>
                            <option value="Programmatore">Programmatore</option>
                            <option value="Sviluppatore">Sviluppatore</option>
                            <option value="Web designer">Web designer</option>
                            <option value="Digital marketer">Digital marketer</option>
                        </optgroup>
                        <optgroup label="Altro">
                            <option value="Studente">Studente</option>
                            <option value="Pensionato">Pensionato</option>
                            <option value="Disoccupato">Disoccupato</option>
                            <option value="Casalinga/o">Casalinga/o</option>
                            <option value="Religioso/a">Religioso/a</option>
                        </optgroup>
                    </select>
                </div>

                <div class="form-group">
                    <label for="tipoLavoratore">Tipo Lavoratore *</label>
                    <select id="tipoLavoratore" required>
                        <option value="">Seleziona tipo</option>
                        <option value="dipendente_pubblico">Dipendente Pubblico</option>
                        <option value="dipendente_privato">Dipendente Privato</option>
                        <option value="autonomo">Autonomo</option>
                        <option value="imprenditore">Imprenditore</option>
                        <option value="artigiano">Artigiano</option>
                        <option value="commerciante">Commerciante</option>
                        <option value="pensionato">Pensionato</option>
                        <option value="studente">Studente</option>
                        <option value="disoccupato">Disoccupato</option>
                        <option value="altro">Altro</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="redditoAnnuo">Reddito Annuo Lordo (€) *</label>
                    <input type="number" id="redditoAnnuo" min="0" step="1000" required>
                </div>

                <div class="form-group">
                    <label for="anniContributivi">Anni Contributivi</label>
                    <input type="number" id="anniContributivi" min="0" max="50">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="regimeFiscale">Regime Fiscale *</label>
                    <select id="regimeFiscale" required>
                        <option value="">Seleziona regime</option>
                        <option value="ordinario">Ordinario</option>
                        <option value="forfettario">Forfettario</option>
                        <option value="non_applicabile">Non Applicabile (Dipendente/Pensionato)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="statoFamiliare">Stato Familiare *</label>
                    <select id="statoFamiliare" required onchange="toggleFigliDetails()">
                        <option value="">Seleziona stato</option>
                        <option value="single">Single</option>
                        <option value="fidanzati_senza_figli">Fidanzati senza figli</option>
                        <option value="fidanzati_con_figli">Fidanzati con figli</option>
                        <option value="conviventi_senza_figli">Conviventi senza figli</option>
                        <option value="conviventi_con_figli">Conviventi con figli</option>
                        <option value="sposati_senza_figli">Sposati senza figli</option>
                        <option value="sposati_con_figli">Sposati con figli</option>
                        <option value="coppia_fatto_senza_figli">Coppia di fatto senza figli</option>
                        <option value="coppia_fatto_con_figli">Coppia di fatto con figli</option>
                        <option value="separato_divorziato_senza_figli">Separato/Divorziato senza figli</option>
                        <option value="separato_divorziato_con_figli">Separato/Divorziato con figli</option>
                        <option value="vedovo_senza_figli">Vedovo/a senza figli</option>
                        <option value="vedovo_con_figli">Vedovo/a con figli</option>
                        <option value="genitore_single">Genitore single</option>
                        <option value="religioso">Religioso/a</option>
                    </select>
                </div>
            </div>

            <div class="form-group" id="numeroFigliGroup">
                <label for="numeroFigli">Numero Figli</label>
                <input type="number" id="numeroFigli" min="0" max="15" value="0" onchange="toggleFigliDetails()">
            </div>

            <div id="figliDetails" class="figli-details">
                <h3 style="color: var(--generali-blue); margin-bottom: 15px;">Dettagli Figli</h3>
                <div id="figliContainer"></div>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="altrePersoneACarico" onchange="toggleAltrePersone()">
                    Altre persone a carico (genitori, familiari, etc.)
                </label>
            </div>

            <div class="form-group" id="altrePersoneGroup" style="display: none;">
                <label for="altrePersoneDescrizione">Descrizione persone a carico</label>
                <textarea id="altrePersoneDescrizione" placeholder="Es: Madre 75 anni, Padre 78 anni non autosufficiente..."></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="consulenteSelect">Seleziona Consulente</label>
                    <select id="consulenteSelect">
                        <option value="">Seleziona consulente</option>
                        <option value="Alessandro Rossi">Alessandro Rossi</option>
                        <option value="Marco Bianchi">Marco Bianchi</option>
                        <option value="Luca Verdi">Luca Verdi</option>
                        <option value="Giuseppe Neri">Giuseppe Neri</option>
                        <option value="Francesco Romano">Francesco Romano</option>
                        <option value="Antonio Colombo">Antonio Colombo</option>
                        <option value="Giovanni Ferrari">Giovanni Ferrari</option>
                        <option value="Roberto Ricci">Roberto Ricci</option>
                        <option value="Paolo Russo">Paolo Russo</option>
                        <option value="Stefano Marino">Stefano Marino</option>
                        <option value="Andrea Greco">Andrea Greco</option>
                        <option value="Diego Bruno">Diego Bruno</option>
                        <option value="Matteo Gallo">Matteo Gallo</option>
                        <option value="Davide Costa">Davide Costa</option>
                        <option value="Simone Fontana">Simone Fontana</option>
                        <option value="Federico Barbieri">Federico Barbieri</option>
                        <option value="Lorenzo Vitale">Lorenzo Vitale</option>
                        <option value="Gabriele Leone">Gabriele Leone</option>
                        <option value="Riccardo Lombardi">Riccardo Lombardi</option>
                        <option value="Altro">Altro (specificare)</option>
                    </select>
                </div>

                <div class="form-group" id="altroConsulenteGroup" style="display: none;">
                    <label for="altroConsulente">Nome Altro Consulente</label>
                    <input type="text" id="altroConsulente" placeholder="Inserisci nome consulente">
                </div>
            </div>
        </div>

        <!-- POLIZZE ESISTENTI -->
        <div class="card">
            <h2 class="card-title">Polizze Assicurative Esistenti</h2>

            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="pol_vita" onchange="togglePolizzaFields('vita')">
                    <label for="pol_vita">Polizza Vita</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="pol_tcm" onchange="togglePolizzaFields('tcm')">
                    <label for="pol_tcm">TCM (Temporanea Caso Morte)</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="pol_infortuni" onchange="togglePolizzaFields('infortuni')">
                    <label for="pol_infortuni">Infortuni</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="pol_sanitaria" onchange="togglePolizzaFields('sanitaria')">
                    <label for="pol_sanitaria">Sanitaria Integrativa</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="pol_ltc" onchange="togglePolizzaFields('ltc')">
                    <label for="pol_ltc">LTC (Long Term Care)</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="pol_abitazione" onchange="togglePolizzaFields('abitazione')">
                    <label for="pol_abitazione">Abitazione</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="pol_rca" onchange="togglePolizzaFields('rca')">
                    <label for="pol_rca">RCA Auto</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="pol_investimenti" onchange="togglePolizzaFields('investimenti')">
                    <label for="pol_investimenti">Investimenti/Previdenza</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="pol_accantonamento" onchange="togglePolizzaFields('accantonamento')">
                    <label for="pol_accantonamento">Accantonamento/Risparmio</label>
                </div>
            </div>

            <!-- Vita -->
            <div id="pol_vita_fields" class="polizza-fields">
                <h4>Dettagli Polizza Vita</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_vita_compagnia">Compagnia</label>
                        <select id="pol_vita_compagnia" onchange="handleCompagniaChange('vita')">
                            <option value="">Seleziona</option>
                            <option value="Generali">Generali</option>
                            <option value="Allianz">Allianz</option>
                            <option value="AXA">AXA</option>
                            <option value="Poste Vita">Poste Vita</option>
                            <option value="Intesa Sanpaolo Vita">Intesa Sanpaolo Vita</option>
                            <option value="UnipolSai">UnipolSai</option>
                            <option value="Zurich">Zurich</option>
                            <option value="Reale Mutua">Reale Mutua</option>
                            <option value="Cattolica">Cattolica</option>
                            <option value="Altro (specificare)">Altro (specificare)</option>
                        </select>
                    </div>
                    <div class="form-group" id="pol_vita_altro_group" style="display: none;">
                        <label for="pol_vita_altra">Altra Compagnia</label>
                        <input type="text" id="pol_vita_altra" placeholder="Specifica compagnia">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_vita_capitale">Capitale Assicurato (€)</label>
                        <input type="number" id="pol_vita_capitale" min="0" step="1000">
                    </div>
                    <div class="form-group">
                        <label for="pol_vita_premio">Premio Annuo (€)</label>
                        <input type="number" id="pol_vita_premio" min="0" step="100">
                    </div>
                </div>
            </div>

            <!-- TCM -->
            <div id="pol_tcm_fields" class="polizza-fields">
                <h4>Dettagli TCM</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_tcm_compagnia">Compagnia</label>
                        <select id="pol_tcm_compagnia" onchange="handleCompagniaChange('tcm')">
                            <option value="">Seleziona</option>
                            <option value="Generali">Generali</option>
                            <option value="Allianz">Allianz</option>
                            <option value="AXA">AXA</option>
                            <option value="Poste Vita">Poste Vita</option>
                            <option value="UnipolSai">UnipolSai</option>
                            <option value="Zurich">Zurich</option>
                            <option value="Reale Mutua">Reale Mutua</option>
                            <option value="Altro (specificare)">Altro (specificare)</option>
                        </select>
                    </div>
                    <div class="form-group" id="pol_tcm_altro_group" style="display: none;">
                        <label for="pol_tcm_altra">Altra Compagnia</label>
                        <input type="text" id="pol_tcm_altra" placeholder="Specifica compagnia">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_tcm_capitale">Capitale Assicurato (€)</label>
                        <input type="number" id="pol_tcm_capitale" min="0" step="1000">
                    </div>
                    <div class="form-group">
                        <label for="pol_tcm_premio">Premio Annuo (€)</label>
                        <input type="number" id="pol_tcm_premio" min="0" step="100">
                    </div>
                </div>
            </div>

            <!-- Infortuni -->
            <div id="pol_infortuni_fields" class="polizza-fields">
                <h4>Dettagli Infortuni</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_infortuni_compagnia">Compagnia</label>
                        <select id="pol_infortuni_compagnia" onchange="handleCompagniaChange('infortuni')">
                            <option value="">Seleziona</option>
                            <option value="Generali">Generali</option>
                            <option value="Allianz">Allianz</option>
                            <option value="UnipolSai">UnipolSai</option>
                            <option value="Zurich">Zurich</option>
                            <option value="Reale Mutua">Reale Mutua</option>
                            <option value="AXA">AXA</option>
                            <option value="Altro (specificare)">Altro (specificare)</option>
                        </select>
                    </div>
                    <div class="form-group" id="pol_infortuni_altro_group" style="display: none;">
                        <label for="pol_infortuni_altra">Altra Compagnia</label>
                        <input type="text" id="pol_infortuni_altra" placeholder="Specifica compagnia">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_infortuni_capitale">Capitale Assicurato (€)</label>
                        <input type="number" id="pol_infortuni_capitale" min="0" step="1000">
                    </div>
                    <div class="form-group">
                        <label for="pol_infortuni_premio">Premio Annuo (€)</label>
                        <input type="number" id="pol_infortuni_premio" min="0" step="100">
                    </div>
                </div>
            </div>

            <!-- Sanitaria -->
            <div id="pol_sanitaria_fields" class="polizza-fields">
                <h4>Dettagli Sanitaria Integrativa</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_sanitaria_compagnia">Compagnia</label>
                        <select id="pol_sanitaria_compagnia" onchange="handleCompagniaChange('sanitaria')">
                            <option value="">Seleziona</option>
                            <option value="Generali">Generali</option>
                            <option value="Allianz">Allianz</option>
                            <option value="UnipolSai">UnipolSai</option>
                            <option value="UniSalute">UniSalute</option>
                            <option value="Blue Assistance">Blue Assistance</option>
                            <option value="RBM Salute">RBM Salute</option>
                            <option value="Sanitas">Sanitas</option>
                            <option value="Altro (specificare)">Altro (specificare)</option>
                        </select>
                    </div>
                    <div class="form-group" id="pol_sanitaria_altro_group" style="display: none;">
                        <label for="pol_sanitaria_altra">Altra Compagnia</label>
                        <input type="text" id="pol_sanitaria_altra" placeholder="Specifica compagnia">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_sanitaria_massimale">Massimale Annuo (€)</label>
                        <input type="number" id="pol_sanitaria_massimale" min="0" step="1000">
                    </div>
                    <div class="form-group">
                        <label for="pol_sanitaria_premio">Premio Annuo (€)</label>
                        <input type="number" id="pol_sanitaria_premio" min="0" step="100">
                    </div>
                </div>
            </div>

            <!-- LTC -->
            <div id="pol_ltc_fields" class="polizza-fields">
                <h4>Dettagli LTC</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_ltc_compagnia">Compagnia</label>
                        <select id="pol_ltc_compagnia" onchange="handleCompagniaChange('ltc')">
                            <option value="">Seleziona</option>
                            <option value="Generali">Generali</option>
                            <option value="Allianz">Allianz</option>
                            <option value="UnipolSai">UnipolSai</option>
                            <option value="Zurich">Zurich</option>
                            <option value="Reale Mutua">Reale Mutua</option>
                            <option value="Altro (specificare)">Altro (specificare)</option>
                        </select>
                    </div>
                    <div class="form-group" id="pol_ltc_altro_group" style="display: none;">
                        <label for="pol_ltc_altra">Altra Compagnia</label>
                        <input type="text" id="pol_ltc_altra" placeholder="Specifica compagnia">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_ltc_rendita">Rendita Mensile (€)</label>
                        <input type="number" id="pol_ltc_rendita" min="0" step="100">
                    </div>
                    <div class="form-group">
                        <label for="pol_ltc_premio">Premio Annuo (€)</label>
                        <input type="number" id="pol_ltc_premio" min="0" step="100">
                    </div>
                </div>
            </div>

            <!-- Abitazione -->
            <div id="pol_abitazione_fields" class="polizza-fields">
                <h4>Dettagli Abitazione</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_abitazione_compagnia">Compagnia</label>
                        <select id="pol_abitazione_compagnia" onchange="handleCompagniaChange('abitazione')">
                            <option value="">Seleziona</option>
                            <option value="Generali">Generali</option>
                            <option value="Allianz">Allianz</option>
                            <option value="UnipolSai">UnipolSai</option>
                            <option value="Zurich">Zurich</option>
                            <option value="Reale Mutua">Reale Mutua</option>
                            <option value="AXA">AXA</option>
                            <option value="Altro (specificare)">Altro (specificare)</option>
                        </select>
                    </div>
                    <div class="form-group" id="pol_abitazione_altro_group" style="display: none;">
                        <label for="pol_abitazione_altra">Altra Compagnia</label>
                        <input type="text" id="pol_abitazione_altra" placeholder="Specifica compagnia">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_abitazione_valore">Valore Immobile (€)</label>
                        <input type="number" id="pol_abitazione_valore" min="0" step="10000">
                    </div>
                    <div class="form-group">
                        <label for="pol_abitazione_premio">Premio Annuo (€)</label>
                        <input type="number" id="pol_abitazione_premio" min="0" step="100">
                    </div>
                </div>
            </div>

            <!-- RCA -->
            <div id="pol_rca_fields" class="polizza-fields">
                <h4>Dettagli RCA Auto</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_rca_compagnia">Compagnia</label>
                        <select id="pol_rca_compagnia" onchange="handleCompagniaChange('rca')">
                            <option value="">Seleziona</option>
                            <option value="Generali">Generali</option>
                            <option value="Allianz">Allianz</option>
                            <option value="UnipolSai">UnipolSai</option>
                            <option value="Zurich">Zurich</option>
                            <option value="Reale Mutua">Reale Mutua</option>
                            <option value="Linear">Linear</option>
                            <option value="Direct Line">Direct Line</option>
                            <option value="Altro (specificare)">Altro (specificare)</option>
                        </select>
                    </div>
                    <div class="form-group" id="pol_rca_altro_group" style="display: none;">
                        <label for="pol_rca_altra">Altra Compagnia</label>
                        <input type="text" id="pol_rca_altra" placeholder="Specifica compagnia">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_rca_massimale">Massimale (€)</label>
                        <input type="number" id="pol_rca_massimale" min="0" step="100000">
                    </div>
                    <div class="form-group">
                        <label for="pol_rca_premio">Premio Annuo (€)</label>
                        <input type="number" id="pol_rca_premio" min="0" step="100">
                    </div>
                </div>
            </div>

            <!-- Investimenti -->
            <div id="pol_investimenti_fields" class="polizza-fields">
                <h4>Dettagli Investimenti/Previdenza</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_investimenti_compagnia">Compagnia/Banca</label>
                        <select id="pol_investimenti_compagnia" onchange="handleCompagniaChange('investimenti')">
                            <option value="">Seleziona</option>
                            <option value="Generali">Generali</option>
                            <option value="Allianz">Allianz</option>
                            <option value="Poste Vita">Poste Vita</option>
                            <option value="Intesa Sanpaolo">Intesa Sanpaolo</option>
                            <option value="UniCredit">UniCredit</option>
                            <option value="Fineco">Fineco</option>
                            <option value="Mediolanum">Mediolanum</option>
                            <option value="Altro (specificare)">Altro (specificare)</option>
                        </select>
                    </div>
                    <div class="form-group" id="pol_investimenti_altro_group" style="display: none;">
                        <label for="pol_investimenti_altra">Altra Compagnia</label>
                        <input type="text" id="pol_investimenti_altra" placeholder="Specifica compagnia">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_investimenti_montante">Montante Accumulato (€)</label>
                        <input type="number" id="pol_investimenti_montante" min="0" step="1000">
                    </div>
                    <div class="form-group">
                        <label for="pol_investimenti_contributo">Contributo Annuo (€)</label>
                        <input type="number" id="pol_investimenti_contributo" min="0" step="100">
                    </div>
                </div>
            </div>

            <!-- Accantonamento -->
            <div id="pol_accantonamento_fields" class="polizza-fields">
                <h4>Dettagli Accantonamento/Risparmio</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_accantonamento_compagnia">Istituto</label>
                        <select id="pol_accantonamento_compagnia" onchange="handleCompagniaChange('accantonamento')">
                            <option value="">Seleziona</option>
                            <option value="Intesa Sanpaolo">Intesa Sanpaolo</option>
                            <option value="UniCredit">UniCredit</option>
                            <option value="BNL">BNL</option>
                            <option value="Fineco">Fineco</option>
                            <option value="Poste Italiane">Poste Italiane</option>
                            <option value="Mediolanum">Mediolanum</option>
                            <option value="Altro (specificare)">Altro (specificare)</option>
                        </select>
                    </div>
                    <div class="form-group" id="pol_accantonamento_altro_group" style="display: none;">
                        <label for="pol_accantonamento_altra">Altro Istituto</label>
                        <input type="text" id="pol_accantonamento_altra" placeholder="Specifica istituto">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pol_accantonamento_saldo">Saldo Attuale (€)</label>
                        <input type="number" id="pol_accantonamento_saldo" min="0" step="1000">
                    </div>
                    <div class="form-group">
                        <label for="pol_accantonamento_versamento">Versamento Mensile (€)</label>
                        <input type="number" id="pol_accantonamento_versamento" min="0" step="100">
                    </div>
                </div>
            </div>

            <button class="btn btn-primary btn-block" onclick="iniziaQuestionario()" style="margin-top: 30px;">
                Avvia Questionario Bisogni
            </button>
        </div>

        <!-- SALVATAGGIO E CARICAMENTO -->
        <div class="card">
            <h2 class="card-title">Gestione Analisi</h2>

            <div class="form-row">
                <div class="form-group">
                    <label for="nomeAnalisi">Nome Analisi da Salvare</label>
                    <input type="text" id="nomeAnalisi" placeholder="Es: Mario Rossi - Gennaio 2025">
                </div>
                <div class="form-group">
                    <button class="btn btn-secondary btn-block" onclick="salvaAnalisi()">
                        💾 Salva Analisi
                    </button>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="analisiSalvateSelect">Carica Analisi Salvata</label>
                    <select id="analisiSalvateSelect">
                        <option value="">Seleziona analisi salvata</option>
                    </select>
                </div>
                <div class="form-group">
                    <button class="btn btn-secondary btn-block" onclick="caricaAnalisi()">
                        📂 Carica Analisi
                    </button>
                </div>
            </div>
        </div>
<!-- QUESTIONARIO -->
        <div id="questionario">
            <div class="card">
                <div class="progress-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>

                <div id="questionContainer"></div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-secondary" id="prevBtn" onclick="prevQuestion()" style="display: none;">
                        ← Precedente
                    </button>
                    <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()" style="flex: 1;">
                        Successiva →
                    </button>
                    <button class="btn btn-primary" id="finishBtn" onclick="finalizzaQuestionario()" style="display: none; flex: 1;">
                        Genera Risultati
                    </button>
                </div>
            </div>
        </div>

        <!-- RISULTATI -->
        <div id="risultati">
            <div class="card">
                <h2 class="card-title">Analisi Bisogni Completata</h2>
                <div id="risultatiContent"></div>

                <div style="margin-top: 30px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="window.print()">
                        🖨️ Stampa Report
                    </button>
                    <button class="btn btn-secondary" onclick="location.reload()">
                        🔄 Nuova Analisi
                    </button>
                    <button class="btn btn-secondary" onclick="esportaPDF()">
                        📄 Esporta PDF
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- JAVASCRIPT -->
    <script>
        // ========================================
        // CONFIGURAZIONE GLOBALE
        // ========================================

        const PASSWORD = 'Generali2025!';

        const MIN_PENSION_AGE = 58;
        const MAX_WORKING_AGE = 75;

        // ========================================
        // AUTENTICAZIONE
        // ========================================

        function checkPassword() {
            const input = document.getElementById('passwordInput');
            if (input.value === PASSWORD) {
                document.getElementById('loginScreen').style.display = 'none';
                showToast('Accesso consentito', 'success');
            } else {
                input.value = '';
                input.style.borderColor = 'var(--red)';
                showToast('Password errata', 'error');
                setTimeout(() => {
                    input.style.borderColor = '';
                }, 1000);
            }
        }

        document.getElementById('passwordInput')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================

        function calculateAge(birthdate) {
            if (!birthdate) return 0;
            const today = new Date();
            const birth = new Date(birthdate);
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }

        function showToast(message, type = 'info', duration = 3000) {
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideUp 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        function showWarningBadge(message) {
            const existingBadge = document.querySelector('.warning-badge');
            if (existingBadge) {
                existingBadge.remove();
            }

            const badge = document.createElement('div');
            badge.className = 'warning-badge';
            badge.innerHTML = `<strong>⚠️ Attenzione:</strong><br>${message}`;
            document.body.appendChild(badge);

            setTimeout(() => {
                badge.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => badge.remove(), 300);
            }, 5000);
        }

        // ========================================
        // GESTIONE ANAGRAFICA
        // ========================================

        function toggleAltrePersone() {
            const checkbox = document.getElementById('altrePersoneACarico');
            const group = document.getElementById('altrePersoneGroup');
            group.style.display = checkbox.checked ? 'block' : 'none';
        }

        function toggleFigliDetails() {
            const statoFamiliare = document.getElementById('statoFamiliare').value;
            const numeroFigli = parseInt(document.getElementById('numeroFigli').value) || 0;
            const figliDetails = document.getElementById('figliDetails');
            const figliContainer = document.getElementById('figliContainer');

            const statiConFigli = [
                'fidanzati_con_figli', 'conviventi_con_figli', 'sposati_con_figli',
                'coppia_fatto_con_figli', 'separato_divorziato_con_figli',
                'vedovo_con_figli', 'genitore_single'
            ];

            if (numeroFigli > 0 && (statiConFigli.includes(statoFamiliare) || statoFamiliare === '')) {
                figliDetails.classList.add('active');
                generaFigliFields(numeroFigli);
            } else {
                figliDetails.classList.remove('active');
                figliContainer.innerHTML = '';
            }
        }

        function generaFigliFields(numeroFigli) {
            const container = document.getElementById('figliContainer');
            container.innerHTML = '';

            for (let i = 1; i <= numeroFigli; i++) {
                const figlioDiv = document.createElement('div');
                figlioDiv.className = 'figlio-item';
                figlioDiv.innerHTML = `
                    <h4 style="color: var(--generali-blue); margin-bottom: 10px;">Figlio ${i}</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="figlio_${i}_eta">Età</label>
                            <input type="number" id="figlio_${i}_eta" min="0" max="100">
                        </div>
                        <div class="form-group">
                            <label for="figlio_${i}_carico">A carico fiscalmente?</label>
                            <select id="figlio_${i}_carico">
                                <option value="si">Sì</option>
                                <option value="no">No</option>
                            </select>
                        </div>
                    </div>
                `;
                container.appendChild(figlioDiv);
            }
        }

        function togglePolizzaFields(tipo) {
            const checkbox = document.getElementById(`pol_${tipo}`);
            const fields = document.getElementById(`pol_${tipo}_fields`);

            if (checkbox.checked) {
                fields.classList.add('active');
            } else {
                fields.classList.remove('active');
            }
        }

        function handleCompagniaChange(tipo) {
            const select = document.getElementById(`pol_${tipo}_compagnia`);
            const altroGroup = document.getElementById(`pol_${tipo}_altro_group`);

            if (select.value === 'Altro (specificare)') {
                altroGroup.style.display = 'block';
            } else {
                altroGroup.style.display = 'none';
            }
        }

        document.getElementById('consulenteSelect')?.addEventListener('change', function() {
            const altroGroup = document.getElementById('altroConsulenteGroup');
            if (this.value === 'Altro') {
                altroGroup.style.display = 'block';
            } else {
                altroGroup.style.display = 'none';
            }
        });

        // ========================================
        // VALIDAZIONE COERENZA PROFESSIONE
        // ========================================

        function validateProfessionCoherence() {
            const professione = document.getElementById('professione').value;
            const tipoLavoratore = document.getElementById('tipoLavoratore').value;

            const professioneSelect = document.getElementById('professione');
            const tipoLavoratoreSelect = document.getElementById('tipoLavoratore');

            // Reset
            professioneSelect.classList.remove('incoherent');
            tipoLavoratoreSelect.classList.remove('incoherent');

            const mappings = {
                'Impiegato': ['dipendente_pubblico', 'dipendente_privato'],
                'Quadro': ['dipendente_pubblico', 'dipendente_privato'],
                'Dirigente': ['dipendente_pubblico', 'dipendente_privato'],
                'Operaio': ['dipendente_pubblico', 'dipendente_privato'],
                'Avvocato': ['autonomo'],
                'Commercialista': ['autonomo'],
                'Notaio': ['autonomo'],
                'Medico': ['autonomo', 'dipendente_pubblico', 'dipendente_privato'],
                'Odontoiatra': ['autonomo'],
                'Artigiano': ['artigiano', 'autonomo'],
                'Commerciante': ['commerciante', 'autonomo'],
                'Imprenditore': ['imprenditore', 'autonomo'],
                'Titolare azienda': ['imprenditore'],
                'Studente': ['studente', 'altro'],
                'Pensionato': ['pensionato'],
                'Disoccupato': ['disoccupato', 'altro'],
                'Casalinga/o': ['altro'],
                'Religioso/a': ['altro']
            };

            if (mappings[professione] && !mappings[professione].includes(tipoLavoratore)) {
                professioneSelect.classList.add('incoherent');
                tipoLavoratoreSelect.classList.add('incoherent');
                showWarningBadge(`⚠️ Incoerenza: ${professione} non corrisponde a ${tipoLavoratore}`);
            }
        }

        document.getElementById('professione')?.addEventListener('change', validateProfessionCoherence);
        document.getElementById('tipoLavoratore')?.addEventListener('change', validateProfessionCoherence);

        // ========================================
        // QUESTIONARIO - DOMANDE
        // ========================================

        const questions = [
            // SEZIONE A: PROTEZIONE
            {
                id: 'A1',
                section: 'A',
                text: 'In una scala da 1 a 5, quanto ti senti protetto economicamente in caso di imprevisti gravi?',
                options: [
                    { value: 1, label: '1 - Per nulla protetto' },
                    { value: 2, label: '2 - Poco protetto' },
                    { value: 3, label: '3 - Mediamente protetto' },
                    { value: 4, label: '4 - Abbastanza protetto' },
                    { value: 5, label: '5 - Molto protetto' }
                ]
            },
            {
                id: 'A2',
                section: 'A',
                text: 'Se dovessi rimanere infortunato e non poter lavorare per 6 mesi, quanto saresti coperto economicamente?',
                options: [
                    { value: 1, label: '1 - Nessuna copertura' },
                    { value: 2, label: '2 - Copertura minima (< 30% reddito)' },
                    { value: 3, label: '3 - Copertura parziale (30-60% reddito)' },
                    { value: 4, label: '4 - Buona copertura (60-90% reddito)' },
                    { value: 5, label: '5 - Copertura completa (> 90% reddito)' }
                ]
            },
            {
                id: 'A3',
                section: 'A',
                text: 'Se tu fossi assente dal lavoro per un lungo periodo, quanto tempo la tua famiglia riuscirebbe a sostenere le spese correnti?',
                options: [
                    { value: 1, label: '1 - Nessuna autonomia economica' },
                    { value: 2, label: '2 - Meno di 3 mesi' },
                    { value: 3, label: '3 - 3-6 mesi' },
                    { value: 4, label: '4 - 6-12 mesi' },
                    { value: 5, label: '5 - Oltre 12 mesi' }
                ]
            },
            {
                id: 'A4',
                section: 'A',
                text: 'Quanto sei soddisfatto del Servizio Sanitario Nazionale per le tue esigenze di salute?',
                options: [
                    { value: 1, label: '1 - Per nulla soddisfatto' },
                    { value: 2, label: '2 - Poco soddisfatto' },
                    { value: 3, label: '3 - Mediamente soddisfatto' },
                    { value: 4, label: '4 - Abbastanza soddisfatto' },
                    { value: 5, label: '5 - Molto soddisfatto' }
                ]
            },
            {
                id: 'A5',
                section: 'A',
                text: 'Hai già pianificato cosa accadrebbe alla tua famiglia in caso di tua prematura scomparsa?',
                options: [
                    { value: 1, label: '1 - Mai pensato' },
                    { value: 2, label: '2 - Ci ho pensato ma non ho fatto nulla' },
                    { value: 3, label: '3 - Ho alcune coperture base' },
                    { value: 4, label: '4 - Ho pianificato discretamente' },
                    { value: 5, label: '5 - Ho pianificato tutto accuratamente' }
                ]
            },
            {
                id: 'A6',
                section: 'A',
                text: 'Hai mai considerato di assicurare i tuoi figli (se presenti)?',
                options: [
                    { value: 1, label: '1 - Mai pensato' },
                    { value: 2, label: '2 - Ci ho pensato ma mi sembra prematuro' },
                    { value: 3, label: '3 - Lo sto valutando' },
                    { value: 4, label: '4 - Ho già qualche copertura base' },
                    { value: 5, label: '5 - I miei figli sono già ben assicurati' }
                ]
            },

            // SEZIONE B: REDDITO E STILE DI VITA
            {
                id: 'B1',
                section: 'B',
                text: 'Come definiresti la stabilità del tuo reddito?',
                options: [
                    { value: 1, label: '1 - Molto incerto e variabile' },
                    { value: 2, label: '2 - Piuttosto incerto' },
                    { value: 3, label: '3 - Mediamente stabile' },
                    { value: 4, label: '4 - Stabile (dipendente privato)' },
                    { value: 5, label: '5 - Molto stabile e garantito (dipendente pubblico)' }
                ]
            },
            {
                id: 'B2',
                section: 'B',
                text: 'Quanto riesci a risparmiare mensilmente rispetto al tuo reddito?',
                options: [
                    { value: 1, label: '1 - Nulla, spendo tutto' },
                    { value: 2, label: '2 - Meno del 5%' },
                    { value: 3, label: '3 - Tra 5% e 10%' },
                    { value: 4, label: '4 - Tra 10% e 20%' },
                    { value: 5, label: '5 - Oltre il 20%' }
                ]
            },
            {
                id: 'B3',
                section: 'B',
                text: 'Hai un fondo di emergenza per coprire spese impreviste?',
                options: [
                    { value: 1, label: '1 - No, nessun fondo' },
                    { value: 2, label: '2 - Meno di 1 mese di spese' },
                    { value: 3, label: '3 - 3-6 mesi di spese coperte' },
                    { value: 4, label: '4 - 6-12 mesi di spese' },
                    { value: 5, label: '5 - Oltre 12 mesi di spese' }
                ]
            },
            {
                id: 'B4',
                section: 'B',
                text: 'Quanto spendi annualmente in viaggi, hobby e tempo libero?',
                options: [
                    { value: 1, label: '1 - Quasi nulla (< €1.000)' },
                    { value: 2, label: '2 - Poco (€1.000 - €3.000)' },
                    { value: 3, label: '3 - Moderato (€3.000 - €6.000)' },
                    { value: 4, label: '4 - Consistente (€6.000 - €10.000)' },
                    { value: 5, label: '5 - Molto (oltre €10.000)' }
                ]
            },
            {
                id: 'B5',
                section: 'B',
                text: 'Pratichi sport o attività considerate ad alto rischio?',
                options: [
                    { value: 1, label: '1 - No, vita sedentaria' },
                    { value: 2, label: '2 - Sport leggeri (camminata, yoga)' },
                    { value: 3, label: '3 - Sport moderati (palestra, nuoto)' },
                    { value: 4, label: '4 - Sport intensi (calcio, basket, sci)' },
                    { value: 5, label: '5 - Sport ad alto rischio (motociclismo, paracadutismo, alpinismo)' }
                ]
            },
            {
                id: 'B6',
                section: 'B',
                text: 'Come ti descriveresti in termini di propensione al rischio finanziario?',
                options: [
                    { value: 1, label: '1 - Molto prudente, evito ogni rischio' },
                    { value: 2, label: '2 - Prudente, preferisco certezze' },
                    { value: 3, label: '3 - Equilibrato, accetto rischi moderati' },
                    { value: 4, label: '4 - Dinamico, accetto rischi elevati per rendimenti' },
                    { value: 5, label: '5 - Aggressivo, punto ai massimi rendimenti' }
                ]
            },
            {
                id: 'B7',
                section: 'B',
                text: 'In caso di difficoltà economiche, su chi potresti contare per un supporto?',
                options: [
                    { value: 1, label: '1 - Nessuno, sono solo' },
                    { value: 2, label: '2 - Forse qualche amico' },
                    { value: 3, label: '3 - Famiglia, ma con limiti' },
                    { value: 4, label: '4 - Famiglia e/o amici disponibili' },
                    { value: 5, label: '5 - Forte rete di supporto familiare/sociale' }
                ]
            },
            {
                id: 'B8',
                section: 'B',
                text: 'Il tuo lavoro comporta rischi fisici o per la salute?',
                options: [
                    { value: 1, label: '1 - Lavoro d\'ufficio, zero rischi' },
                    { value: 2, label: '2 - Rischi minimi' },
                    { value: 3, label: '3 - Rischi moderati (es. spostamenti frequenti)' },
                    { value: 4, label: '4 - Rischi elevati (cantieri, lavori manuali)' },
                    { value: 5, label: '5 - Rischi molto elevati (vigili del fuoco, forze dell\'ordine)' }
                ]
            },

            // SEZIONE C: PREVIDENZA E FUTURO
            {
                id: 'C1',
                section: 'C',
                text: 'Hai già sottoscritto una forma di previdenza complementare?',
                options: [
                    { value: 1, label: '1 - No, non ci ho mai pensato' },
                    { value: 2, label: '2 - No, ma lo sto valutando' },
                    { value: 3, label: '3 - Sì, contributo minimo' },
                    { value: 4, label: '4 - Sì, contributo moderato' },
                    { value: 5, label: '5 - Sì, contributo significativo e costante' }
                ]
            },
            {
                id: 'C2',
                section: 'C',
                text: 'Come vedi l\'evoluzione del tuo reddito nei prossimi 5-10 anni?',
                options: [
                    { value: 1, label: '1 - Prevedo diminuzione' },
                    { value: 2, label: '2 - Stabile o lieve diminuzione' },
                    { value: 3, label: '3 - Stabile' },
                    { value: 4, label: '4 - Crescita moderata' },
                    { value: 5, label: '5 - Forte crescita attesa' }
                ]
            },
            {
                id: 'C3',
                section: 'C',
                text: 'Hai una strategia patrimoniale definita (investimenti, risparmi, immobili)?',
                options: [
                    { value: 1, label: '1 - No, vivo alla giornata' },
                    { value: 2, label: '2 - Parziale, ma poco strutturata' },
                    { value: 3, label: '3 - Sto iniziando a pianificare' },
                    { value: 4, label: '4 - Sì, ho una strategia definita' },
                    { value: 5, label: '5 - Sì, strategia avanzata con consulente' }
                ]
            },
            {
                id: 'C4',
                section: 'C',
                text: 'Quali sono i tuoi obiettivi finanziari a lungo termine?',
                options: [
                    { value: 1, label: '1 - Non ho obiettivi chiari' },
                    { value: 2, label: '2 - Obiettivi vaghi' },
                    { value: 3, label: '3 - Qualche obiettivo generico (casa, figli)' },
                    { value: 4, label: '4 - Obiettivi definiti e quantificati' },
                    { value: 5, label: '5 - Piano dettagliato con scadenze precise' }
                ]
            },
            {
                id: 'C5',
                section: 'C',
                text: 'Quanto sei informato su strumenti finanziari e assicurativi innovativi?',
                options: [
                    { value: 1, label: '1 - Per nulla, mi spaventano' },
                    { value: 2, label: '2 - Poco, conosco solo i più comuni' },
                    { value: 3, label: '3 - Mediamente informato' },
                    { value: 4, label: '4 - Abbastanza informato' },
                    { value: 5, label: '5 - Molto informato, sempre aggiornato' }
                ]
            },
            {
                id: 'C6',
                section: 'C',
                text: 'Quanto è importante per te lasciare un\'eredità significativa?',
                options: [
                    { value: 1, label: '1 - Non ci penso' },
                    { value: 2, label: '2 - Poco importante' },
                    { value: 3, label: '3 - Moderatamente importante' },
                    { value: 4, label: '4 - Importante' },
                    { value: 5, label: '5 - Molto importante, priorità assoluta' }
                ]
            },
            {
                id: 'C7',
                section: 'C',
                text: 'Quanto sei propenso a investire regolarmente parte del tuo reddito?',
                options: [
                    { value: 1, label: '1 - Per nulla, preferisco liquidità' },
                    { value: 2, label: '2 - Poco propenso' },
                    { value: 3, label: '3 - Moderatamente, se ci sono garanzie' },
                    { value: 4, label: '4 - Propenso, voglio iniziare' },
                    { value: 5, label: '5 - Molto propenso, già lo faccio' }
                ]
            },
            {
                id: 'C8',
                section: 'C',
                text: 'Hai debiti o mutui in corso? Come li gestisci?',
                options: [
                    { value: 1, label: '1 - Debiti elevati che fatico a gestire' },
                    { value: 2, label: '2 - Debiti gestibili ma pesanti' },
                    { value: 3, label: '3 - Mutuo/debiti sotto controllo' },
                    { value: 4, label: '4 - Pochi debiti, ben gestiti' },
                    { value: 5, label: '5 - Nessun debito' }
                ]
            }
        ];

        // ========================================
        // STATE MANAGEMENT
        // ========================================

        const appState = {
            user: {
                anagrafica: {},
                polizze: {},
                figli: []
            },
            currentQuestion: 0,
            answers: {},
            results: null
        };

        // ========================================
        // INIZIA QUESTIONARIO
        // ========================================

        function iniziaQuestionario() {
            // Valida campi obbligatori anagrafica
            const requiredFields = [
                'nomeCliente', 'dataNascita', 'telefono', 'email',
                'provincia', 'professione', 'tipoLavoratore',
                'redditoAnnuo', 'regimeFiscale', 'statoFamiliare'
            ];

            for (const field of requiredFields) {
                const element = document.getElementById(field);
                if (!element || !element.value) {
                    element?.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    element?.focus();
                    showToast(`Compila il campo: ${element?.previousElementSibling?.textContent || field}`, 'error');
                    return;
                }
            }

            // Salva anagrafica
            collectAnagrafica();

            // Mostra questionario
            document.getElementById('anagraficaSection').style.display = 'none';
            document.getElementById('questionario').style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Render prima domanda
            renderQuestion();
        }

        function collectAnagrafica() {
            const dataNascita = document.getElementById('dataNascita').value;

            appState.user.anagrafica = {
                nome: document.getElementById('nomeCliente').value,
                dataNascita: dataNascita,
                age: calculateAge(dataNascita),
                codiceFiscale: document.getElementById('codiceFiscale').value.toUpperCase(),
                telefono: document.getElementById('telefono').value,
                email: document.getElementById('email').value,
                provincia: document.getElementById('provincia').value,
                professione: document.getElementById('professione').value,
                tipoLavoratore: document.getElementById('tipoLavoratore').value,
                redditoAnnuo: parseFloat(document.getElementById('redditoAnnuo').value) || 0,
                anniContributivi: parseInt(document.getElementById('anniContributivi').value) || 0,
                regimeFiscale: document.getElementById('regimeFiscale').value,
                statoFamiliare: document.getElementById('statoFamiliare').value,
                numeroFigli: parseInt(document.getElementById('numeroFigli').value) || 0,
                altrePersoneACarico: document.getElementById('altrePersoneACarico').checked ?
                    document.getElementById('altrePersoneDescrizione').value : null,
                consulente: document.getElementById('consulenteSelect').value === 'Altro' ?
                    document.getElementById('altroConsulente').value :
                    document.getElementById('consulenteSelect').value
            };

            // Figli
            const numeroFigli = appState.user.anagrafica.numeroFigli;
            appState.user.figli = [];
            for (let i = 1; i <= numeroFigli; i++) {
                const eta = parseInt(document.getElementById(`figlio_${i}_eta`)?.value) || 0;
                const aCarico = document.getElementById(`figlio_${i}_carico`)?.value === 'si';
                appState.user.figli.push({ eta, aCarico });
            }

            // Polizze
            const tipiPolizze = ['vita', 'tcm', 'infortuni', 'sanitaria', 'ltc', 'abitazione', 'rca', 'investimenti', 'accantonamento'];
            appState.user.polizze = {};

            tipiPolizze.forEach(tipo => {
                const checkbox = document.getElementById(`pol_${tipo}`);
                if (checkbox && checkbox.checked) {
                    const compagniaSelect = document.getElementById(`pol_${tipo}_compagnia`);
                    const compagnia = compagniaSelect.value === 'Altro (specificare)' ?
                        document.getElementById(`pol_${tipo}_altra`).value :
                        compagniaSelect.value;

                    appState.user.polizze[tipo] = {
                        compagnia: compagnia,
                        capitale: parseFloat(document.getElementById(`pol_${tipo}_capitale`)?.value) || 0,
                        premio: parseFloat(document.getElementById(`pol_${tipo}_premio`)?.value) || 0,
                        massimale: parseFloat(document.getElementById(`pol_${tipo}_massimale`)?.value) || 0,
                        rendita: parseFloat(document.getElementById(`pol_${tipo}_rendita`)?.value) || 0,
                        montante: parseFloat(document.getElementById(`pol_${tipo}_montante`)?.value) || 0,
                        contributo: parseFloat(document.getElementById(`pol_${tipo}_contributo`)?.value) || 0,
                        saldo: parseFloat(document.getElementById(`pol_${tipo}_saldo`)?.value) || 0,
                        versamento: parseFloat(document.getElementById(`pol_${tipo}_versamento`)?.value) || 0,
                        valore: parseFloat(document.getElementById(`pol_${tipo}_valore`)?.value) || 0
                    };
                }
            });
        }

        // ========================================
        // RENDERING QUESTIONARIO
        // ========================================

        function renderQuestion() {
            const question = questions[appState.currentQuestion];
            const container = document.getElementById('questionContainer');

            let html = '<div class="question-card">';
            html += `<h3>Domanda ${appState.currentQuestion + 1} di ${questions.length}</h3>`;
            html += `<p style="font-size: 16px; margin: 15px 0;">${question.text}</p>`;
            html += '<div class="options">';

            question.options.forEach(opt => {
                const selected = appState.answers[question.id] === opt.value ? 'selected' : '';
                html += `<div class="option ${selected}" onclick="selectOption('${question.id}', ${opt.value})">`;
                html += opt.label;
                html += '</div>';
            });

            html += '</div>';
            html += '</div>';

            container.innerHTML = html;

            updateProgress();
            updateButtons();
        }

        function selectOption(questionId, value) {
            appState.answers[questionId] = value;
            renderQuestion();
        }

        function updateProgress() {
            const progress = ((appState.currentQuestion + 1) / questions.length) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
        }

        function updateButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const finishBtn = document.getElementById('finishBtn');

            prevBtn.style.display = appState.currentQuestion > 0 ? 'block' : 'none';

            const isLastQuestion = appState.currentQuestion === questions.length - 1;
            nextBtn.style.display = isLastQuestion ? 'none' : 'block';
            finishBtn.style.display = isLastQuestion ? 'block' : 'none';
        }

        function nextQuestion() {
            const currentQ = questions[appState.currentQuestion];
            if (!appState.answers[currentQ.id]) {
                showToast('Seleziona una risposta prima di continuare', 'error');
                return;
            }

            if (appState.currentQuestion < questions.length - 1) {
                appState.currentQuestion++;
                renderQuestion();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function prevQuestion() {
            if (appState.currentQuestion > 0) {
                appState.currentQuestion--;
                renderQuestion();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function finalizzaQuestionario() {
            const currentQ = questions[appState.currentQuestion];
            if (!appState.answers[currentQ.id]) {
                showToast('Seleziona una risposta prima di continuare', 'error');
                return;
            }

            showToast('Analisi in corso...', 'info', 2000);

            setTimeout(() => {
                generaRisultati();
            }, 1000);
        }
// ========================================
        // CALCOLO GAP STATALE
        // ========================================

        function calcolaGapStatale(userData) {
            const eta = userData.age;
            const reddito = userData.redditoAnnuo;
            const tipoLavoratore = userData.tipoLavoratore;
            const anniContributivi = userData.anniContributivi || 0;

            const gap = {
                morte: { copertura: 0, gap: 0 },
                invalidita: { copertura: 0, gap: 0 },
                ltc: { copertura: 0, gap: 0 },
                pensione: { copertura: 0, gap: 0 }
            };

            // GAP MORTE
            if (tipoLavoratore === 'dipendente_pubblico' || tipoLavoratore === 'dipendente_privato') {
                gap.morte.copertura = reddito * 0.4 * 5;
            } else {
                gap.morte.copertura = 0;
            }
            gap.morte.gap = Math.max(0, reddito * 10 - gap.morte.copertura);

            // GAP INVALIDITÀ
            if (tipoLavoratore === 'dipendente_pubblico' || tipoLavoratore === 'dipendente_privato') {
                gap.invalidita.copertura = reddito * 0.60;
            } else if (tipoLavoratore === 'autonomo' || tipoLavoratore === 'imprenditore') {
                gap.invalidita.copertura = reddito * 0.30;
            }
            gap.invalidita.gap = Math.max(0, reddito - gap.invalidita.copertura);

            // GAP LTC
            const costoMedioLTC = 2500;
            gap.ltc.copertura = 0;
            gap.ltc.gap = costoMedioLTC * 12;

            // GAP PENSIONE
            const anniMancanti = Math.max(0, 67 - eta);
            const coefficienteRendimento = tipoLavoratore === 'dipendente_pubblico' ? 0.70 : 0.55;
            gap.pensione.copertura = reddito * coefficienteRendimento;
            gap.pensione.gap = Math.max(0, reddito * 0.80 - gap.pensione.copertura);

            return gap;
        }

        // ========================================
        // ANALISI NORMOTIPO
        // ========================================

        function analizzaNormotipo(userData, answers) {
            const eta = userData.age;
            const professione = userData.professione || '';
            const tipoLavoratore = userData.tipoLavoratore || '';
            const reddito = userData.redditoAnnuo || 0;
            const statoFamiliare = userData.statoFamiliare || '';
            const numeroFigli = userData.numeroFigli || 0;

            // Default
            let normotipo = {
                profilo: 'EQUILIBRATO',
                caratteristiche: ['Situazione standard', 'Approccio bilanciato'],
                priorita: {
                    vita: 70,
                    tcm: 65,
                    infortuni: 75,
                    sanitaria: 75,
                    ltc: 65,
                    previdenza: 75,
                    investimenti: 70
                },
                esclusioni: []
            };

            // FAMIGLIA CON FIGLI
            if (numeroFigli > 0) {
                normotipo.profilo = 'FAMIGLIA CON FIGLI';
                normotipo.caratteristiche = [
                    `${numeroFigli} ${numeroFigli === 1 ? 'figlio' : 'figli'} a carico`,
                    'Protezione famiglia prioritaria',
                    'Focus su stabilità e futuro'
                ];
                normotipo.priorita = {
                    vita: 95,
                    tcm: 90,
                    infortuni: 85,
                    sanitaria: 80,
                    ltc: 65,
                    previdenza: 80,
                    investimenti: 70
                };
            }

            // GIOVANE PROFESSIONISTA
            if (eta >= 25 && eta <= 35 && reddito >= 25000 && numeroFigli === 0) {
                normotipo.profilo = 'GIOVANE PROFESSIONISTA';
                normotipo.caratteristiche = [
                    'Inizio carriera',
                    'Alta propensione investimenti',
                    'Focus crescita patrimonio'
                ];
                normotipo.priorita = {
                    vita: 60,
                    tcm: 55,
                    infortuni: 75,
                    sanitaria: 80,
                    ltc: 50,
                    previdenza: 90,
                    investimenti: 85
                };
            }

            // SENIOR
            if (eta >= 55) {
                normotipo.profilo = 'SENIOR';
                normotipo.caratteristiche = [
                    'Vicino alla pensione',
                    'Consolidamento patrimonio',
                    'Protezione sanitaria prioritaria'
                ];
                normotipo.priorita = {
                    vita: 70,
                    tcm: 60,
                    infortuni: 65,
                    sanitaria: 95,
                    ltc: 90,
                    previdenza: 85,
                    investimenti: 65
                };
            }

            // AUTONOMO/IMPRENDITORE
            if (tipoLavoratore === 'autonomo' || tipoLavoratore === 'imprenditore') {
                normotipo.profilo = 'AUTONOMO/IMPRENDITORE';
                normotipo.caratteristiche = [
                    'Reddito variabile',
                    'Assenza tutele INPS complete',
                    'Protezione infortuni essenziale'
                ];
                normotipo.priorita = {
                    vita: 80,
                    tcm: 75,
                    infortuni: 95,
                    sanitaria: 85,
                    ltc: 70,
                    previdenza: 95,
                    investimenti: 75
                };
            }

            // DIPENDENTE PUBBLICO
            if (tipoLavoratore === 'dipendente_pubblico') {
                normotipo.profilo = 'DIPENDENTE PUBBLICO';
                normotipo.caratteristiche = [
                    'Reddito stabile garantito',
                    'Buone tutele previdenziali',
                    'Focus integrazioni'
                ];
                normotipo.priorita = {
                    vita: 65,
                    tcm: 60,
                    infortuni: 65,
                    sanitaria: 75,
                    ltc: 70,
                    previdenza: 70,
                    investimenti: 75
                };
            }

            // Esclusioni età
            if (eta >= 75) {
                normotipo.esclusioni.push('TCM: età limite raggiunta');
            }
            if (eta > 70) {
                normotipo.esclusioni.push('LTC: età limite superata per nuove sottoscrizioni');
            }

            return normotipo;
        }

        // ========================================
        // CALCOLO SEMAFORO
        // ========================================

        function calcolaSemaforo(userData, answers, normotipo, gapStatale) {
            const eta = userData.age;
            const reddito = userData.redditoAnnuo;
            const statoFamiliare = userData.statoFamiliare || '';
            const numeroFigli = userData.numeroFigli || 0;
            const polizze = userData.polizze || {};

            const haFamiglia = !statoFamiliare.includes('single') && 
                              !statoFamiliare.includes('vedovo_senza_figli') && 
                              statoFamiliare !== 'religioso';

            const semaforo = {
                vita: 'yellow',
                tcm: 'yellow',
                infortuni: 'yellow',
                sanitaria: 'yellow',
                ltc: 'yellow',
                previdenza: 'yellow',
                investimenti: 'yellow'
            };

            // VITA
            if (!haFamiglia) {
                semaforo.vita = 'gray';
                semaforo.vita_motivo = 'Senza nucleo familiare: non necessaria';
            } else if (polizze.vita || polizze.tcm) {
                semaforo.vita = 'green';
                semaforo.vita_motivo = 'Già coperto con polizza esistente';
            } else if (normotipo.priorita.vita >= 80) {
                semaforo.vita = 'red';
                semaforo.vita_motivo = 'Priorità alta: famiglia scoperta';
            } else {
                semaforo.vita = 'yellow';
                semaforo.vita_motivo = 'Valutare copertura famiglia';
            }

            // TCM
            if (eta > 75) {
                semaforo.tcm = 'gray';
                semaforo.tcm_motivo = 'Età oltre limite sottoscrivibilità';
            } else if (polizze.tcm) {
                semaforo.tcm = 'green';
                semaforo.tcm_motivo = 'Già coperto';
            } else if (haFamiglia && numeroFigli > 0) {
                semaforo.tcm = 'red';
                semaforo.tcm_motivo = 'Famiglia con figli: protezione essenziale';
            } else {
                semaforo.tcm = 'yellow';
                semaforo.tcm_motivo = 'Da valutare in base a esigenze';
            }

            // INFORTUNI
            if (polizze.infortuni) {
                semaforo.infortuni = 'green';
                semaforo.infortuni_motivo = 'Già coperto';
            } else if ((answers.B5 || 3) >= 4 || (answers.B8 || 3) >= 4) {
                semaforo.infortuni = 'red';
                semaforo.infortuni_motivo = 'Attività ad alto rischio: urgente';
            } else if (normotipo.priorita.infortuni >= 85) {
                semaforo.infortuni = 'orange';
                semaforo.infortuni_motivo = 'Priorità alta per categoria';
            } else {
                semaforo.infortuni = 'yellow';
                semaforo.infortuni_motivo = 'Consigliata per tutti';
            }

            // SANITARIA
            if (polizze.sanitaria) {
                semaforo.sanitaria = 'green';
                semaforo.sanitaria_motivo = 'Già coperto';
            } else if (eta > 50 || (answers.A4 || 3) <= 2) {
                semaforo.sanitaria = 'orange';
                semaforo.sanitaria_motivo = eta > 50 ? 'Età critica: fortemente consigliata' : 'SSN insoddisfacente';
            } else {
                semaforo.sanitaria = 'yellow';
                semaforo.sanitaria_motivo = 'Consigliata come integrazione SSN';
            }

            // LTC
            if (eta > 70) {
                semaforo.ltc = 'gray';
                semaforo.ltc_motivo = 'Età oltre limite sottoscrivibilità';
            } else if (polizze.ltc) {
                semaforo.ltc = 'green';
                semaforo.ltc_motivo = 'Già coperto';
            } else if (eta >= 55 && eta <= 70) {
                semaforo.ltc = 'orange';
                semaforo.ltc_motivo = 'Età ideale: consigliata fortemente';
            } else if (eta >= 40) {
                semaforo.ltc = 'yellow';
                semaforo.ltc_motivo = 'Da valutare: premi aumentano con età';
            } else {
                semaforo.ltc = 'green';
                semaforo.ltc_motivo = 'Giovane: non urgente ma vantaggioso';
            }

            // PREVIDENZA
            const anniPensione = 67 - eta;
            if (polizze.investimenti?.contributo > 0) {
                semaforo.previdenza = 'green';
                semaforo.previdenza_motivo = 'Già contributo attivo';
            } else if (anniPensione <= 15 && anniPensione > 0) {
                semaforo.previdenza = 'red';
                semaforo.previdenza_motivo = `Pensione tra ${anniPensione} anni: urgente`;
            } else if (anniPensione <= 30) {
                semaforo.previdenza = 'orange';
                semaforo.previdenza_motivo = 'Iniziare ora: interesse composto';
            } else {
                semaforo.previdenza = 'yellow';
                semaforo.previdenza_motivo = 'Prima inizi, meglio è';
            }

            // INVESTIMENTI
            if ((answers.C7 || 3) >= 4 && (answers.B2 || 3) >= 3 && reddito > 30000) {
                semaforo.investimenti = 'green';
                semaforo.investimenti_motivo = 'Profilo adatto: consigliati';
            } else if ((answers.B2 || 3) <= 2) {
                semaforo.investimenti = 'gray';
                semaforo.investimenti_motivo = 'Prima creare capacità risparmio';
            } else {
                semaforo.investimenti = 'yellow';
                semaforo.investimenti_motivo = 'Valutare in base a propensione';
            }

            return semaforo;
        }

        // ========================================
        // DETECT CONTRADICTIONS
        // ========================================

        function detectContradictions(userData, answers) {
            const contradictions = [];
            const eta = userData.age || 40;
            const tipoLavoratore = userData.tipoLavoratore || '';

            // Pensionato troppo giovane
            if (tipoLavoratore === 'pensionato' && eta < MIN_PENSION_AGE) {
                contradictions.push({
                    type: 'age_pension_mismatch',
                    severity: 'high',
                    message: `Età ${eta} anni incompatibile con Pensionato (minimo ${MIN_PENSION_AGE} anni)`
                });
            }

            // Risparmio vs Investimenti
            if ((answers.C7 || 3) >= 4 && (answers.B2 || 3) <= 2) {
                contradictions.push({
                    type: 'saving_contradiction',
                    severity: 'medium',
                    message: 'Alta propensione investimenti ma incapacità risparmio'
                });
            }

            const coherenceScore = Math.max(50, 100 - (contradictions.length * 15));

            return { contradictions, coherenceScore };
        }

        // ========================================
        // GENERA RISULTATI
        // ========================================

        async function generaRisultati() {
            const userData = appState.user.anagrafica;
            const answers = appState.answers;

            // Calcoli
            const gapStatale = calcolaGapStatale(userData);
            const normotipo = analizzaNormotipo(userData, answers);
            const semaforo = calcolaSemaforo(userData, answers, normotipo, gapStatale);
            const coherence = detectContradictions(userData, answers);

            appState.results = {
                gapStatale,
                normotipo,
                semaforo,
                coherence,
                timestamp: new Date().toISOString()
            };

            renderResults();
        }

        function renderResults() {
            document.getElementById('questionario').style.display = 'none';
            document.getElementById('risultati').style.display = 'block';

            const container = document.getElementById('risultatiContent');
            const r = appState.results;
            const userData = appState.user.anagrafica;

            let html = '';

            // HEADER
            html += '<div style="background: linear-gradient(135deg, var(--generali-blue), var(--generali-light-blue)); color: white; padding: 30px; border-radius: 8px; margin-bottom: 30px;">';
            html += `<h2 style="margin: 0 0 10px 0;">${userData.nome}</h2>`;
            html += `<p style="margin: 0; opacity: 0.9;">Età: ${userData.age} anni | ${userData.professione} | Reddito: €${userData.redditoAnnuo.toLocaleString()}/anno</p>`;
            html += '</div>';

            // NORMOTIPO
            html += '<div class="card" style="background: linear-gradient(135deg, #F0F9FF 0%, #E0F2FE 100%); border-left: 4px solid var(--generali-blue);">';
            html += `<h3 class="card-title">Profilo: ${r.normotipo.profilo}</h3>`;
            html += '<ul style="margin-left: 20px;">';
            r.normotipo.caratteristiche.forEach(c => {
                html += `<li style="margin-bottom: 8px;">${c}</li>`;
            });
            html += '</ul>';
            if (r.normotipo.esclusioni.length > 0) {
                html += '<div style="background: #FEF3C7; padding: 15px; border-radius: 6px; margin-top: 15px;">';
                html += '<strong>⚠️ Note:</strong><ul style="margin: 10px 0 0 20px;">';
                r.normotipo.esclusioni.forEach(e => {
                    html += `<li>${e}</li>`;
                });
                html += '</ul></div>';
            }
            html += '</div>';

            // COHERENCE SCORE
            html += '<div class="card">';
            html += '<h3 class="card-title">Coerenza Risposte</h3>';
            const coherenceColor = r.coherence.coherenceScore >= 80 ? 'var(--green)' : 
                                   r.coherence.coherenceScore >= 60 ? 'var(--yellow)' : 'var(--red)';
            html += `<div style="text-align: center; padding: 20px;">`;
            html += `<div style="font-size: 48px; font-weight: bold; color: ${coherenceColor};">${r.coherence.coherenceScore}%</div>`;
            html += `<p style="color: var(--gray-600);">Indice di coerenza delle risposte</p>`;
            html += '</div>';
            if (r.coherence.contradictions.length > 0) {
                html += '<div style="background: #FEE2E2; padding: 15px; border-radius: 6px;">';
                html += '<strong>⚠️ Contraddizioni rilevate:</strong><ul style="margin: 10px 0 0 20px;">';
                r.coherence.contradictions.forEach(c => {
                    html += `<li>${c.message}</li>`;
                });
                html += '</ul></div>';
            }
            html += '</div>';

            // GAP STATALE
            html += '<div class="card">';
            html += '<h3 class="card-title">Gap Tutele Statali</h3>';
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">';
            
            const gaps = [
                { label: 'Morte', data: r.gapStatale.morte },
                { label: 'Invalidità', data: r.gapStatale.invalidita },
                { label: 'LTC', data: r.gapStatale.ltc },
                { label: 'Pensione', data: r.gapStatale.pensione }
            ];

            gaps.forEach(g => {
                html += '<div style="background: var(--gray-50); padding: 20px; border-radius: 8px; text-align: center;">';
                html += `<h4 style="margin: 0 0 10px 0; color: var(--generali-blue);">${g.label}</h4>`;
                html += `<div style="font-size: 14px; color: var(--gray-600); margin-bottom: 5px;">Copertura Stato</div>`;
                html += `<div style="font-size: 18px; font-weight: 600; color: var(--green);">€${g.data.copertura.toLocaleString()}</div>`;
                html += `<div style="font-size: 14px; color: var(--gray-600); margin: 10px 0 5px 0;">Gap da Coprire</div>`;
                html += `<div style="font-size: 18px; font-weight: 600; color: var(--red);">€${g.data.gap.toLocaleString()}</div>`;
                html += '</div>';
            });

            html += '</div>';
            html += '</div>';

            // SEMAFORO
            html += '<div class="card">';
            html += '<h3 class="card-title">Analisi Bisogni Assicurativi</h3>';
            html += '<div class="product-grid">';

            const prodotti = [
                { key: 'vita', nome: 'Polizza Vita', icon: '🛡️' },
                { key: 'tcm', nome: 'TCM (Caso Morte)', icon: '⚰️' },
                { key: 'infortuni', nome: 'Infortuni', icon: '🏥' },
                { key: 'sanitaria', nome: 'Sanitaria', icon: '⚕️' },
                { key: 'ltc', nome: 'LTC', icon: '♿' },
                { key: 'previdenza', nome: 'Previdenza', icon: '🏦' },
                { key: 'investimenti', nome: 'Investimenti', icon: '📈' }
            ];

            prodotti.forEach(p => {
                const stato = r.semaforo[p.key];
                const motivo = r.semaforo[`${p.key}_motivo`] || '';
                
                html += '<div class="product-card">';
                html += `<h3>${p.icon} ${p.nome}</h3>`;
                html += `<div class="semaforo ${stato}" style="margin: 15px 0;">${stato.toUpperCase()}</div>`;
                if (motivo) {
                    html += `<p style="color: var(--gray-600); font-size: 14px;">${motivo}</p>`;
                }
                html += `<div style="margin-top: 15px; padding: 10px; background: var(--gray-50); border-radius: 6px;">`;
                html += `<strong>Priorità:</strong> ${r.normotipo.priorita[p.key]}/100`;
                html += '</div>';
                html += '</div>';
            });

            html += '</div>';
            html += '</div>';

            container.innerHTML = html;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ========================================
        // SALVATAGGIO/CARICAMENTO
        // ========================================

        function salvaAnalisi() {
            const nomeAnalisi = document.getElementById('nomeAnalisi').value || 
                               `${appState.user.anagrafica?.nome || 'Analisi'} - ${new Date().toLocaleDateString('it-IT')}`;

            const analisiData = {
                timestamp: new Date().toISOString(),
                versioni: [{
                    timestamp: new Date().toISOString(),
                    valori: raccogliValoriForm(),
                    note: 'Versione iniziale'
                }]
            };

            const stored = JSON.parse(localStorage.getItem('analisiSalvate') || '{}');
            stored[nomeAnalisi] = analisiData;
            localStorage.setItem('analisiSalvate', JSON.stringify(stored));

            aggiornaListaAnalisi();
            showToast(`✅ Analisi "${nomeAnalisi}" salvata`, 'success');
        }

        function raccogliValoriForm() {
            const valori = {};
            const inputs = document.querySelectorAll('input, select, textarea');
            
            inputs.forEach(el => {
                if (el.id) {
                    if (el.type === 'checkbox') {
                        valori[el.id] = el.checked;
                    } else if (el.type === 'radio') {
                        if (el.checked) {
                            valori[el.id] = el.value;
                        }
                    } else {
                        valori[el.id] = el.value;
                    }
                }
            });

            return valori;
        }

        function aggiornaListaAnalisi() {
            const select = document.getElementById('analisiSalvateSelect');
            if (!select) return;

            const stored = JSON.parse(localStorage.getItem('analisiSalvate') || '{}');
            const keys = Object.keys(stored).sort();

            select.innerHTML = '<option value="">Seleziona analisi salvata</option>';
            keys.forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = key;
                select.appendChild(option);
            });
        }

        function caricaAnalisi() {
            const select = document.getElementById('analisiSalvateSelect');
            const key = select.value;

            if (!key) {
                showToast('Seleziona un\'analisi da caricare', 'error');
                return;
            }

            const stored = JSON.parse(localStorage.getItem('analisiSalvate') || '{}');
            const analisiWrapper = stored[key];

            if (!analisiWrapper) {
                showToast('Analisi non trovata', 'error');
                return;
            }

            let valori;
            if (analisiWrapper.versioni && Array.isArray(analisiWrapper.versioni)) {
                const ultimaVersione = analisiWrapper.versioni[analisiWrapper.versioni.length - 1];
                valori = ultimaVersione.valori;
            } else if (analisiWrapper.valori) {
                valori = analisiWrapper.valori;
            } else {
                valori = analisiWrapper;
            }

            Object.entries(valori).forEach(([id, val]) => {
                const el = document.getElementById(id);
                if (!el) return;

                if (el.type === 'checkbox') {
                    el.checked = val === true || val === 'true';
                    el.dispatchEvent(new Event('change', { bubbles: true }));
                } else if (el.type === 'radio') {
                    if (el.value === val) {
                        el.checked = true;
                        el.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                } else {
                    el.value = val;
                    el.dispatchEvent(new Event('change', { bubbles: true }));
                }
            });

            showToast(`✅ Analisi "${key}" caricata`, 'success');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ========================================
        // ESPORTA PDF
        // ========================================

        function esportaPDF() {
            showToast('Funzionalità export PDF in sviluppo', 'info');
        }

        // ========================================
        // INIT
        // ========================================

        window.addEventListener('DOMContentLoaded', () => {
            aggiornaListaAnalisi();
        });
    </script>
<script>
/* === MODULO MIGLIORAMENTI UX V2.0 === */
(function() {
    console.log('%c🎨 MIGLIORAMENTI UX V2.0 - ATTIVO', 'color: #3B82F6; font-weight: bold');

    // ========================================
    // 1. SALVATAGGIO COMPLETO POLIZZE
    // ========================================

    const originalSalvaAnalisi = window.salvaAnalisi;

    window.salvaAnalisi = function() {
        const nomeAnalisi = document.getElementById('nomeAnalisi').value || 
                           `${appState.user?.anagrafica?.nome || 'Analisi'} - ${new Date().toLocaleDateString('it-IT')}`;

        const valoriCompleti = raccogliValoriFormCompleto();

        const analisiData = {
            timestamp: new Date().toISOString(),
            versioni: [{
                timestamp: new Date().toISOString(),
                valori: valoriCompleti,
                note: 'Salvataggio completo',
                sottoscrizioni: window.trackingSottoscrizioni || {},
                modifiche: window.trackingModifiche || []
            }]
        };

        const stored = JSON.parse(localStorage.getItem('analisiSalvate') || '{}');

        if (stored[nomeAnalisi]) {
            analisiData.versioni = stored[nomeAnalisi].versioni || [];
            analisiData.versioni.push({
                timestamp: new Date().toISOString(),
                valori: valoriCompleti,
                note: 'Aggiornamento',
                sottoscrizioni: window.trackingSottoscrizioni || {},
                modifiche: window.trackingModifiche || []
            });
        }

        stored[nomeAnalisi] = analisiData;
        localStorage.setItem('analisiSalvate', JSON.stringify(stored));

        aggiornaListaAnalisi();
        showToast(`✅ Analisi "${nomeAnalisi}" salvata (v${analisiData.versioni.length})`, 'success', 3000);
    };

    function raccogliValoriFormCompleto() {
        const valori = {};
        const selectors = 'input, select, textarea';
        document.querySelectorAll(selectors).forEach(el => {
            if (!el.id) return;

            if (el.type === 'checkbox') {
                valori[el.id] = el.checked;
            } else if (el.type === 'radio') {
                if (el.checked) valori[el.id] = el.value;
            } else {
                valori[el.id] = el.value;
            }
        });

        if (window.appState) {
            valori._appState = JSON.stringify(window.appState);
        }

        return valori;
    }

    // ========================================
    // 2. TRACKING SOTTOSCRIZIONI/DINIEGHI
    // ========================================

    window.trackingSottoscrizioni = {};
    window.trackingModifiche = [];

    function trackPolizzaChange(tipo, stato) {
        if (!window.trackingSottoscrizioni[tipo]) {
            window.trackingSottoscrizioni[tipo] = {
                storia: [],
                statoCorrente: stato
            };
        }

        window.trackingSottoscrizioni[tipo].storia.push({
            timestamp: new Date().toISOString(),
            stato: stato
        });
        window.trackingSottoscrizioni[tipo].statoCorrente = stato;

        const modifica = {
            timestamp: new Date().toISOString(),
            tipo: 'polizza',
            prodotto: tipo,
            azione: stato
        };
        window.trackingModifiche.push(modifica);

        console.log(`📝 Tracked: ${tipo} → ${stato}`);
    }

    const tipiPolizze = ['vita', 'tcm', 'infortuni', 'sanitaria', 'ltc', 'abitazione', 'rca', 'investimenti', 'accantonamento'];

    tipiPolizze.forEach(tipo => {
        const checkbox = document.getElementById(`pol_${tipo}`);
        if (checkbox) {
            checkbox.addEventListener('change', function() {
                trackPolizzaChange(tipo, this.checked ? 'attivata' : 'disattivata');
            });
        }
    });

    console.log('✅ Tracking sottoscrizioni attivo');

    // ========================================
    // 3. ORDINAMENTO ALFABETICO DROPDOWN
    // ========================================

    function ordinaDropdown() {
        // Ordina CONSULENTI
        const consulentiSelect = document.getElementById('consulenteSelect');
        if (consulentiSelect) {
            const options = Array.from(consulentiSelect.options).slice(1); // Escludi prima opzione
            options.sort((a, b) => a.text.localeCompare(b.text, 'it'));
            options.forEach(opt => consulentiSelect.appendChild(opt));
            console.log('✅ Consulenti ordinati alfabeticamente');
        }

        // Ordina PROFESSIONI per optgroup
        const professioneSelect = document.getElementById('professione');
        if (professioneSelect) {
            const optgroups = Array.from(professioneSelect.querySelectorAll('optgroup'));
            optgroups.forEach(group => {
                const options = Array.from(group.querySelectorAll('option'));
                options.sort((a, b) => a.text.localeCompare(b.text, 'it'));
                options.forEach(opt => group.appendChild(opt));
            });
            console.log('✅ Professioni ordinate alfabeticamente');
        }

        // Ordina COMPAGNIE (per ogni tipo polizza)
        tipiPolizze.forEach(tipo => {
            const select = document.getElementById(`pol_${tipo}_compagnia`);
            if (select) {
                const options = Array.from(select.options).slice(1); // Escludi "Seleziona"
                const altroOption = options.find(opt => opt.value.includes('Altro'));
                const otherOptions = options.filter(opt => !opt.value.includes('Altro'));

                otherOptions.sort((a, b) => a.text.localeCompare(b.text, 'it'));

                // Ricostruisci select
                select.innerHTML = '<option value="">Seleziona</option>';
                otherOptions.forEach(opt => select.appendChild(opt));
                if (altroOption) select.appendChild(altroOption);
            }
        });
        console.log('✅ Compagnie assicurative ordinate alfabeticamente');
    }

    setTimeout(ordinaDropdown, 1000);

    // ========================================
    // 4. DETRAZIONI FORFETTARI - SEMI-TRASPARENZA
    // ========================================

    function gestisciDetrazioniForfettari() {
        const regimeFiscaleSelect = document.getElementById('regimeFiscale');
        if (!regimeFiscaleSelect) return;

        regimeFiscaleSelect.addEventListener('change', function() {
            const isForfettario = this.value === 'forfettario';

            // Trova tutti i riferimenti a detrazioni/deduzioni nei risultati
            setTimeout(() => {
                const risultatiContent = document.getElementById('risultatiContent');
                if (!risultatiContent) return;

                // Trova tutti gli elementi con detrazioni/deduzioni
                const detrazionielements = risultatiContent.querySelectorAll('[class*="detrazioni"], [class*="deduzioni"]');

                detrazionielements.forEach(el => {
                    if (isForfettario) {
                        el.style.opacity = '0.4';
                        el.style.position = 'relative';

                        // Aggiungi badge "irrilevante"
                        let badge = el.querySelector('.badge-irrilevante');
                        if (!badge) {
                            badge = document.createElement('span');
                            badge.className = 'badge-irrilevante';
                            badge.style.cssText = 'position: absolute; top: 5px; right: 5px; background: #FEF3C7; color: #92400E; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;';
                            badge.textContent = 'Irrilevante (forfettario)';
                            el.style.position = 'relative';
                            el.appendChild(badge);
                        }
                    } else {
                        el.style.opacity = '1';
                        const badge = el.querySelector('.badge-irrilevante');
                        if (badge) badge.remove();
                    }
                });
            }, 2000); // Attendi rendering risultati
        });
    }

    setTimeout(gestisciDetrazioniForfettari, 1000);

    // ========================================
    // 5. VALIDAZIONE FIGLI - HIDE COMPLETO
    // ========================================

    const originalToggleFigliDetails = window.toggleFigliDetails;

    window.toggleFigliDetails = function() {
        const statoFamiliare = document.getElementById('statoFamiliare').value;
        const numeroFigliGroup = document.getElementById('numeroFigliGroup');
        const numeroFigliInput = document.getElementById('numeroFigli');
        const figliDetails = document.getElementById('figliDetails');

        // Stati senza possibilità figli
        const statiSenzaFigli = ['single', 'vedovo_senza_figli', 'religioso',
                                  'fidanzati_senza_figli', 'conviventi_senza_figli',
                                  'sposati_senza_figli', 'coppia_fatto_senza_figli'];

        if (statiSenzaFigli.includes(statoFamiliare)) {
            // NASCONDI completamente
            numeroFigliGroup.style.display = 'none';
            numeroFigliInput.value = 0;
            numeroFigliInput.disabled = true;
            figliDetails.classList.remove('active');
            document.getElementById('figliContainer').innerHTML = '';
        } else {
            // MOSTRA
            numeroFigliGroup.style.display = 'block';
            numeroFigliInput.disabled = false;

            // Chiama funzione originale
            if (originalToggleFigliDetails) {
                originalToggleFigliDetails.call(this);
            }
        }
    };

    console.log('✅ Miglioramenti UX: ATTIVI');
    console.log('  ✓ Salvataggio polizze completo');
    console.log('  ✓ Versioning con storico modifiche');
    console.log('  ✓ Tracking sottoscrizioni/dinieghi');
    console.log('  ✓ Dropdown ordinati alfabeticamente');
    console.log('  ✓ Detrazioni forfettari semi-trasparenti');
    console.log('  ✓ Validazione figli migliorata');
})();
</script>
<script>
/* === MODULO VALIDAZIONI AVANZATE V3.0 === */
(function() {
    console.log('%c🛡️ MODULO VALIDAZIONI V3.0 - ATTIVO', 'color: #DC2626; font-weight: bold');

    // ========================================
    // 1. VALIDAZIONE ETÀ FIGLI
    // ========================================

    function validaEtaFigli() {
        const numeroFigliInput = document.getElementById('numeroFigli');
        if (!numeroFigliInput) return;

        numeroFigliInput.addEventListener('change', aggiungiValidazioneFigli);
    }

    function aggiungiValidazioneFigli() {
        const numeroFigli = parseInt(document.getElementById('numeroFigli').value) || 0;

        if (numeroFigli === 0) return;

        // Attendi che i campi figli siano generati
        setTimeout(() => {
            for (let i = 1; i <= numeroFigli; i++) {
                const etaFiglioInput = document.getElementById(`figlio_${i}_eta`);
                if (!etaFiglioInput) continue;

                etaFiglioInput.addEventListener('blur', function() {
                    validaSingoloFiglio(i);
                });
            }
        }, 500);
    }

    function validaSingoloFiglio(numeroFiglio) {
        const dataNascitaGenitore = document.getElementById('dataNascita').value;
        if (!dataNascitaGenitore) {
            if (typeof showToast === 'function') {
                showToast('⚠️ Inserisci prima la tua data di nascita', 'error');
            }
            return false;
        }

        const etaGenitore = calculateAge(dataNascitaGenitore);
        const etaFiglioInput = document.getElementById(`figlio_${numeroFiglio}_eta`);
        const etaFiglio = parseInt(etaFiglioInput.value) || 0;

        const ETA_MIN_GENITORIALITA = 15;
        const etaMassimaFiglio = etaGenitore - ETA_MIN_GENITORIALITA;

        if (etaFiglio > etaMassimaFiglio) {
            // ERRORE: figlio troppo vecchio
            etaFiglioInput.style.borderColor = '#EF4444';
            etaFiglioInput.style.background = '#FEE2E2';

            if (typeof showWarningBadge === 'function') {
                showWarningBadge(`❌ Figlio ${numeroFiglio}: età ${etaFiglio} impossibile. Avresti dovuto averlo a ${etaGenitore - etaFiglio} anni (min 15 anni)`);
            }

            // Blocca
            etaFiglioInput.value = '';
            etaFiglioInput.focus();
            return false;
        } else if (etaFiglio < 0) {
            etaFiglioInput.style.borderColor = '#EF4444';
            etaFiglioInput.style.background = '#FEE2E2';
            if (typeof showToast === 'function') {
                showToast('⚠️ Età figlio non può essere negativa', 'error');
            }
            etaFiglioInput.value = '';
            return false;
        } else {
            // OK
            etaFiglioInput.style.borderColor = '#10B981';
            etaFiglioInput.style.background = '#F0FDF4';
            return true;
        }
    }

    // ========================================
    // 2. VALIDAZIONE REGIME FISCALE AUTOMATICO
    // ========================================

    function validaRegimeFiscale() {
        const redditoInput = document.getElementById('redditoAnnuo');
        const tipoLavoratoreSelect = document.getElementById('tipoLavoratore');
        const regimeSelect = document.getElementById('regimeFiscale');

        if (!redditoInput || !tipoLavoratoreSelect || !regimeSelect) return;

        const LIMITE_FORFETTARIO = 85000;

        function checkRegime() {
            const reddito = parseFloat(redditoInput.value) || 0;
            const tipoLavoratore = tipoLavoratoreSelect.value;
            const regimeFiscale = regimeSelect.value;

            // Dipendenti/pensionati non possono avere forfettario
            if ((tipoLavoratore === 'dipendente_pubblico' || tipoLavoratore === 'dipendente_privato' || tipoLavoratore === 'pensionato') && regimeFiscale === 'forfettario') {
                regimeSelect.value = 'non_applicabile';
                if (typeof showToast === 'function') {
                    showToast('✅ Regime fiscale corretto automaticamente', 'success', 2000);
                }
            }

            // Autonomi con reddito > 85k devono essere ordinari
            if ((tipoLavoratore === 'autonomo' || tipoLavoratore === 'imprenditore' || tipoLavoratore === 'artigiano' || tipoLavoratore === 'commerciante') && reddito > LIMITE_FORFETTARIO) {
                if (regimeFiscale === 'forfettario') {
                    regimeSelect.value = 'ordinario';
                    regimeSelect.style.borderColor = '#F59E0B';
                    regimeSelect.style.background = '#FEF3C7';

                    if (typeof showWarningBadge === 'function') {
                        showWarningBadge(`⚠️ Reddito €${reddito.toLocaleString()} > €85.000: regime forfettario NON ammesso. Impostato su ORDINARIO`);
                    }
                } else if (!regimeFiscale) {
                    // Suggerisci ordinario
                    regimeSelect.style.borderColor = '#F59E0B';
                }
            }

            // Reset colori se tutto OK
            if (regimeFiscale === 'ordinario' || regimeFiscale === 'non_applicabile' || (regimeFiscale === 'forfettario' && reddito <= LIMITE_FORFETTARIO)) {
                regimeSelect.style.borderColor = '#10B981';
                regimeSelect.style.background = '#F0FDF4';
            }
        }

        redditoInput.addEventListener('blur', checkRegime);
        tipoLavoratoreSelect.addEventListener('change', checkRegime);
        regimeSelect.addEventListener('change', checkRegime);
    }

    // ========================================
    // 3. VALIDAZIONE ANNI CONTRIBUTIVI
    // ========================================

    function validaAnniContributivi() {
        const dataNascitaInput = document.getElementById('dataNascita');
        const anniContributiviInput = document.getElementById('anniContributivi');
        const tipoLavoratoreSelect = document.getElementById('tipoLavoratore');

        if (!dataNascitaInput || !anniContributiviInput || !tipoLavoratoreSelect) return;

        function checkContributi() {
            const dataNascita = dataNascitaInput.value;
            if (!dataNascita) return;

            const eta = calculateAge(dataNascita);
            const anniContributivi = parseInt(anniContributiviInput.value) || 0;
            const tipoLavoratore = tipoLavoratoreSelect.value;

            const ETA_FINE_SCUOLA_OBBLIGO = 16; // Minimo per iniziare a lavorare
            const maxAnniContributivi = eta - ETA_FINE_SCUOLA_OBBLIGO;

            // Skip per studenti/disoccupati
            if (tipoLavoratore === 'studente' || tipoLavoratore === 'disoccupato') {
                anniContributiviInput.style.borderColor = '';
                anniContributiviInput.style.background = '';
                return;
            }

            if (anniContributivi > maxAnniContributivi) {
                // INCONGRUENZA CRITICA
                anniContributiviInput.style.borderColor = '#EF4444';
                anniContributiviInput.style.background = '#FEE2E2';

                const messaggio = `❌ IMPOSSIBILE: ${anniContributivi} anni contributivi con età ${eta} anni. Massimo teorico: ${maxAnniContributivi} anni (inizio lavoro a ${ETA_FINE_SCUOLA_OBBLIGO} anni)`;

                if (confirm(messaggio + '\n\nVuoi correggere il valore?')) {
                    anniContributiviInput.value = maxAnniContributivi;
                    anniContributiviInput.style.borderColor = '#10B981';
                    anniContributiviInput.style.background = '#F0FDF4';
                } else {
                    // Forza correzione comunque
                    anniContributiviInput.value = maxAnniContributivi;
                    if (typeof showToast === 'function') {
                        showToast('Anni contributivi corretti automaticamente', 'success');
                    }
                }
            } else if (anniContributivi < 0) {
                anniContributiviInput.style.borderColor = '#EF4444';
                anniContributiviInput.style.background = '#FEE2E2';
                anniContributiviInput.value = 0;
                if (typeof showToast === 'function') {
                    showToast('⚠️ Anni contributivi non possono essere negativi', 'error');
                }
            } else {
                // OK
                anniContributiviInput.style.borderColor = '#10B981';
                anniContributiviInput.style.background = '#F0FDF4';
            }
        }

        anniContributiviInput.addEventListener('blur', checkContributi);
        dataNascitaInput.addEventListener('change', checkContributi);
        tipoLavoratoreSelect.addEventListener('change', checkContributi);
    }

    // ========================================
    // 4. FIX COHERENCE SCORE (sempre 100% = BUG)
    // ========================================

    const originalDetectContradictions = window.detectContradictions;

    window.detectContradictions = function(userData, answers) {
        const contradictions = [];
        const eta = userData.age || 40;
        const tipoLavoratore = userData.tipoLavoratore || 'dipendente_privato';
        const reddito = userData.redditoAnnuo || 30000;
        const statoFamiliare = userData.statoFamiliare || 'single';
        const numeroFigli = userData.numeroFigli || 0;

        // 1. Età vs Pensionato (ESISTENTE)
        if (tipoLavoratore === 'pensionato' && eta < MIN_PENSION_AGE) {
            contradictions.push({
                type: 'age_pension_mismatch',
                severity: 'critical',
                message: 'Età ' + eta + ' anni incompatibile con Pensionato (min ' + MIN_PENSION_AGE + ' anni)'
            });
        }

        // 2. Risparmio vs Investimenti (ESISTENTE)
        if ((answers.C7 || 3) >= 4 && (answers.B2 || 3) <= 2) {
            contradictions.push({
                type: 'saving_contradiction',
                severity: 'medium',
                message: 'Alta propensione investimenti ma incapacità risparmio'
            });
        }

        // 3. Protezione dichiarata vs Coperture (NUOVO)
        if ((answers.A1 || 3) >= 4 && (answers.A2 || 3) <= 2) {
            contradictions.push({
                type: 'protection_mismatch',
                severity: 'medium',
                message: 'Dichiari di essere molto protetto ma non hai coperture per infortuni'
            });
        }

        // 4. Stato familiare vs Pianificazione famiglia (NUOVO)
        const haFamiglia = !statoFamiliare.includes('single') && !statoFamiliare.includes('vedovo_senza_figli') && statoFamiliare !== 'religioso';
        if (haFamiglia && (answers.A5 || 3) <= 2) {
            contradictions.push({
                type: 'family_planning_gap',
                severity: 'high',
                message: 'Hai famiglia ma non hai pianificato protezione in caso di decesso'
            });
        }

        // 5. Figli vs Assicurazione figli (NUOVO)
        if (numeroFigli > 0 && (answers.A6 || 3) <= 2) {
            contradictions.push({
                type: 'children_protection_gap',
                severity: 'medium',
                message: 'Hai figli ma non hai mai pensato ad assicurarli'
            });
        }

        // 6. Reddito stabile vs Fondo emergenza (NUOVO)
        if ((answers.B1 || 3) >= 4 && (answers.B3 || 3) <= 2) {
            contradictions.push({
                type: 'stable_income_no_savings',
                severity: 'medium',
                message: 'Reddito stabile ma nessun fondo emergenza'
            });
        }

        // 7. Spende molto in viaggi ma non risparmia (NUOVO)
        if ((answers.B4 || 3) >= 4 && (answers.B2 || 3) <= 2) {
            contradictions.push({
                type: 'lifestyle_savings_mismatch',
                severity: 'low',
                message: 'Spendi molto in viaggi ma dichiari di non risparmiare'
            });
        }

        // 8. Sport ad alto rischio ma nessuna copertura infortuni (NUOVO)
        if ((answers.B5 || 3) >= 4 && (answers.A2 || 3) <= 2) {
            contradictions.push({
                type: 'risky_sport_no_coverage',
                severity: 'high',
                message: 'Pratichi sport ad alto rischio senza coperture infortuni'
            });
        }

        // 9. Lavoro rischioso ma nessuna protezione (NUOVO)
        if ((answers.B8 || 3) >= 4 && (answers.A1 || 3) <= 2) {
            contradictions.push({
                type: 'risky_job_no_protection',
                severity: 'high',
                message: 'Lavoro ad alto rischio ma ti senti poco protetto'
            });
        }

        // 10. Previdenza: vicino pensione ma non pianificato (NUOVO)
        const anniPensione = 67 - eta;
        if (anniPensione <= 10 && anniPensione > 0 && (answers.C1 || 3) <= 2) {
            contradictions.push({
                type: 'retirement_near_unprepared',
                severity: 'critical',
                message: 'Pensione vicina (tra ' + anniPensione + ' anni) ma nessuna integrazione'
            });
        }

        // 11. Eredità importante ma non pianificato (NUOVO)
        if ((answers.C6 || 3) >= 4 && (answers.A5 || 3) <= 2) {
            contradictions.push({
                type: 'inheritance_goal_no_plan',
                severity: 'medium',
                message: 'Vuoi lasciare eredità ma non hai pianificato protezione'
            });
        }

        // 12. SSN insoddisfacente ma non ha sanitaria (NUOVO - da verificare con polizze)
        if ((answers.A4 || 3) <= 2 && !userData.polizze?.sanitaria) {
            contradictions.push({
                type: 'ssn_unsatisfied_no_insurance',
                severity: 'medium',
                message: 'Insoddisfatto SSN ma non hai polizza sanitaria'
            });
        }

        // 13. Reddito alto ma non propenso a investimenti (NUOVO)
        if (reddito > 50000 && (answers.C7 || 3) <= 2) {
            contradictions.push({
                type: 'high_income_no_investments',
                severity: 'low',
                message: 'Reddito elevato ma scarsa propensione investimenti'
            });
        }

        // 14. Debiti elevati ma vuole investire (NUOVO)
        if ((answers.C8 || 3) <= 2 && (answers.C7 || 3) >= 4) {
            contradictions.push({
                type: 'high_debt_wants_invest',
                severity: 'medium',
                message: 'Debiti elevati ma alta propensione investimenti (priorità errata)'
            });
        }

        // 15. Autonomia economica famiglia bassa ma non preoccupato (NUOVO)
        if ((answers.A3 || 3) <= 2 && (answers.A1 || 3) >= 4) {
            contradictions.push({
                type: 'low_autonomy_feels_protected',
                severity: 'high',
                message: 'Famiglia con poca autonomia economica ma ti senti molto protetto'
            });
        }

        // CALCOLO COHERENCE SCORE MIGLIORATO
        let penalita = 0;
        contradictions.forEach(c => {
            if (c.severity === 'critical') penalita += 15;
            else if (c.severity === 'high') penalita += 10;
            else if (c.severity === 'medium') penalita += 7;
            else penalita += 3;
        });

        const coherenceScore = Math.max(0, 100 - penalita);

        console.log(`🎯 Contraddizioni rilevate: ${contradictions.length}`);
        console.log(`📊 Coherence Score: ${coherenceScore}%`);

        return { contradictions: contradictions, coherenceScore: coherenceScore };
    };

    // ========================================
    // 5. FIX DOMANDE QUESTIONARIO DINAMICHE
    // ========================================

    const originalRenderQuestion = window.renderQuestion;

    window.renderQuestion = function() {
        const question = questions[appState.currentQuestion];
        const userData = appState.user?.anagrafica || {};
        const statoFamiliare = userData.statoFamiliare || '';
        const haFamiglia = !statoFamiliare.includes('single') && !statoFamiliare.includes('vedovo_senza_figli') && statoFamiliare !== 'religioso';

        // Domande da modificare per single
        const domandeProblematiche = ['A3', 'A5'];

        if (domandeProblematiche.includes(question.id) && !haFamiglia) {
            // Modifica testo domanda
            const container = document.getElementById('questionContainer');

            let html = '<div class="question-card">';
            html += '<h3>Domanda ' + (appState.currentQuestion + 1) + ' di ' + questions.length + '</h3>';

            let testoModificato = question.text;
            if (question.id === 'A3') {
                testoModificato = 'Se tu fossi assente dal lavoro per un lungo periodo, quanto tempo riusciresti a sostenere le tue spese correnti? (es. affitto, bollette, spesa)';
            }
            if (question.id === 'A5') {
                testoModificato = 'Hai già pianificato la tua successione o cosa accadrebbe al tuo patrimonio in caso di prematura scomparsa?';
            }

            html += '<p style="font-size: 16px; margin: 15px 0;">' + testoModificato + '</p>';
            html += '<div class="options">';

            question.options.forEach(opt => {
                const selected = appState.answers[question.id] === opt.value ? 'selected' : '';
                html += '<div class="option ' + selected + '" onclick="selectOption(\'' + question.id + '\', ' + opt.value + ')">';
                html += opt.label;
                html += '</div>';
            });

            html += '</div>';
            html += '</div>';

            container.innerHTML = html;
            updateProgress();
            updateButtons();
        } else {
            // Usa rendering originale
            originalRenderQuestion.call(this);
        }
    };

    // ========================================
    // 6. FIX DOMANDA B3 (risposta ridondante)
    // ========================================

    // Trova la domanda B3 e modifica opzione ridondante
    const domandeModificate = window.questions || questions;
    const domanadB3 = domandeModificate.find(q => q.id === 'B3');
    if (domanadB3) {
        // Modifica la terza opzione (value 3)
        const opzione3 = domanadB3.options.find(o => o.value === 3);
        if (opzione3) {
            opzione3.label = '3-6 mesi di spese coperte';
        }
    }

    // ========================================
    // AVVIO AUTOMATICO VALIDAZIONI
    // ========================================

    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        setTimeout(() => {
            validaEtaFigli();
            validaRegimeFiscale();
            validaAnniContributivi();
        }, 1000);
    } else {
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                validaEtaFigli();
                validaRegimeFiscale();
                validaAnniContributivi();
            }, 1000);
        });
    }

    console.log('✅ Validazioni V3.0: OPERATIVE');
    console.log('  ✓ Validazione età figli (min genitorialità: 15 anni)');
    console.log('  ✓ Regime fiscale automatico (>85k = ordinario)');
    console.log('  ✓ Anni contributivi (max: età - 16)');
    console.log('  ✓ Coherence score migliorato (15 controlli)');
    console.log('  ✓ Domande dinamiche per single');
    console.log('  ✓ Domanda B3 corretta');
})();
</script>
<script>
/* === PATCH CORRETTIVO V3.1 - FIX BUGS CRITICI === */
(function() {
    console.log('%c🔧 PATCH CORRETTIVO V3.1 - ATTIVO', 'color: #F59E0B; font-weight: bold');

    // ========================================
    // 1. FIX CARICAMENTO ANALISI (CRITICO)
    // ========================================

    let originalCaricaAnalisiSaved = null;

    if (typeof window.caricaAnalisi === 'function') {
        originalCaricaAnalisiSaved = window.caricaAnalisi;
    }

    window.caricaAnalisi = function caricaAnalisiFixed() {
        try {
            const select = document.getElementById("analisiSalvateSelect");
            const key = select?.value;

            if (!key) {
                console.warn('⚠️ Nessuna analisi selezionata');
                return;
            }

            console.log(`🔄 Caricamento analisi: "${key}"`);

            const stored = JSON.parse(localStorage.getItem("analisiSalvate") || "{}");
            const analisiWrapper = stored[key];

            if (!analisiWrapper) {
                if (typeof showToast === 'function') {
                    showToast('❌ Analisi non trovata', 'error');
                }
                return;
            }

            let valori;
            if (analisiWrapper.versioni && Array.isArray(analisiWrapper.versioni)) {
                const ultimaVersione = analisiWrapper.versioni[analisiWrapper.versioni.length - 1];
                valori = ultimaVersione.valori;
            } else if (analisiWrapper.valori) {
                valori = analisiWrapper.valori;
            } else {
                valori = analisiWrapper;
            }

            if (!valori) {
                console.error('❌ Formato analisi non riconosciuto');
                if (typeof showToast === 'function') {
                    showToast('❌ Formato analisi corrotto', 'error');
                }
                return;
            }

            console.log(`📦 Trovati ${Object.keys(valori).length} campi da ripristinare`);

            Object.entries(valori).forEach(([id, val]) => {
                const el = document.getElementById(id);
                if (!el) return;

                if (el.type === 'checkbox') {
                    el.checked = val === true || val === 'true';
                    el.dispatchEvent(new Event('change', { bubbles: true }));
                } else if (el.type === 'radio') {
                    if (el.value === val) {
                        el.checked = true;
                        el.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                } else {
                    el.value = val;
                    el.dispatchEvent(new Event('change', { bubbles: true }));
                }
            });

            if (valori._appState) {
                try {
                    window.appState = JSON.parse(valori._appState);
                    console.log('✅ appState ripristinato');
                } catch(e) {
                    console.warn('⚠️ appState non ripristinabile', e);
                }
            }

            setTimeout(() => {
                document.getElementById('statoFamiliare')?.dispatchEvent(new Event('change', { bubbles: true }));
                document.getElementById('professione')?.dispatchEvent(new Event('change', { bubbles: true }));
                document.getElementById('tipoLavoratore')?.dispatchEvent(new Event('change', { bubbles: true }));
                document.getElementById('regimeFiscale')?.dispatchEvent(new Event('change', { bubbles: true }));
                document.getElementById('numeroFigli')?.dispatchEvent(new Event('change', { bubbles: true }));
            }, 200);

            window.scrollTo({ top: 0, behavior: 'smooth' });

            if (typeof showToast === 'function') {
                showToast(`✅ Analisi "${key}" caricata con successo`, 'success', 3000);
            }

            console.log('✅ Caricamento completato');

        } catch(e) {
            console.error('❌ Errore caricamento analisi:', e);
            if (typeof showToast === 'function') {
                showToast('❌ Errore caricamento (vedi console)', 'error', 4000);
            }
        }
    };

    console.log('✅ Funzione caricaAnalisi() FISSATA');

    // ========================================
    // 2. FIX HANDLECOMPAGNIACHANGE
    // ========================================

    window.handleCompagniaChange = function(tipo) {
        const select = document.getElementById('pol_' + tipo + '_compagnia');
        const altroGroup = document.getElementById('pol_' + tipo + '_altro_group');

        if (!select || !altroGroup) {
            console.error('❌ Campi non trovati:', tipo);
            return;
        }

        if (select.value === 'Altro (specificare)') {
            altroGroup.style.display = 'block';
            altroGroup.style.opacity = '1';

            const input = document.getElementById('pol_' + tipo + '_altra');
            if (input) {
                input.style.display = 'block';
                input.focus();
            }

            console.log('✅ Campo "Altro" aperto per:', tipo);
        } else {
            altroGroup.style.display = 'none';
            const altroInput = document.getElementById('pol_' + tipo + '_altra');
            if (altroInput) altroInput.value = '';
        }
    };

    console.log('✅ handleCompagniaChange() ridefinita');

    // ========================================
    // 3. FIX PROFESSIONI FLESSIBILI
    // ========================================

    const PROFESSIONI_FLESSIBILI = [
        'Geometra', 'Architetto', 'Ingegnere', 'Agronomo',
        'Infermiere', 'Fisioterapista', 'Psicologo',
        'Avvocato', 'Commercialista', 'Consulente', 'Notaio'
    ];

    const professioneSelect = document.getElementById('professione');
    const tipoLavoratoreSelect = document.getElementById('tipoLavoratore');

    if (professioneSelect && tipoLavoratoreSelect) {
        professioneSelect.addEventListener('change', function() {
            const prof = this.value;

            if (PROFESSIONI_FLESSIBILI.some(p => prof.includes(p))) {
                Array.from(tipoLavoratoreSelect.options).forEach(opt => {
                    opt.disabled = false;
                    opt.style.color = '';
                });

                tipoLavoratoreSelect.style.borderColor = '#3B82F6';
                tipoLavoratoreSelect.style.background = '#EFF6FF';

                console.log(`✅ ${prof}: tipo lavoratore flessibile`);
            }
        });

        const originalValidate = window.validateProfessionCoherence;
        window.validateProfessionCoherence = function() {
            const prof = professioneSelect.value;
            if (PROFESSIONI_FLESSIBILI.some(p => prof.includes(p))) {
                professioneSelect.classList.remove('incoherent');
                tipoLavoratoreSelect.classList.remove('incoherent');
                return;
            }
            if (originalValidate) originalValidate();
        };

        console.log('✅ Professioni flessibili attivate');
    }

    console.log('✅ PATCH V3.1 COMPLETATA');
    console.log('  ✓ Caricamento analisi RIPARATO');
    console.log('  ✓ handleCompagniaChange FISSATA');
    console.log('  ✓ Professioni flessibili ATTIVE');
})();
</script>
<style>
/* === PATCH MOBILE STYLE (non altera codice originale) === */

/* Adattamento generale per schermi piccoli */
@media (max-width: 768px) {

  body {
    font-size: 17px !important;
    line-height: 1.5 !important;
    padding: 8px !important;
    -webkit-text-size-adjust: 100%;
  }

  input, select, button, textarea {
    font-size: 16px !important;
    padding: 12px 14px !important;
    border-radius: 10px !important;
  }

  button, .btn {
    min-height: 48px !important;
    min-width: 120px !important;
    margin: 4px !important;
  }

  label {
    font-size: 16px !important;
    display: block;
    margin-bottom: 3px;
  }

  /* Popup centrato e leggibile su mobile */
  .popup, .modal, .toast {
    max-width: 90vw !important;
    left: 50% !important;
    transform: translateX(-50%) !important;
    font-size: 16px !important;
    padding: 16px !important;
  }

  /* Miglior centratura dei toast (notifiche) */
  .toast {
    top: 15px !important;
    left: 50% !important;
    transform: translateX(-50%) !important;
    z-index: 9999 !important;
  }

  /* Miglior gestione griglie o tabelle */
  table {
    width: 100% !important;
    border-collapse: collapse !important;
  }

  td, th {
    padding: 8px !important;
    font-size: 15px !important;
  }
}

/* === Scroll automatico dopo caricamento analisi === */
html, body {
  scroll-behavior: smooth !important;
}
</style>
<script>
/* === MEGA-PATCH DEFINITIVA V5.0 - ZERO MARGINE DI ERRORE === */
(function() {
    'use strict';

    console.log('%c🚀 MEGA-PATCH V5.0 - ATTIVO', 'color: #DC2626; font-weight: bold; font-size: 18px');
    console.log('%c⚡ OTTIMIZZAZIONI: 100+ controlli | 0 errori ammessi', 'color: #059669; font-weight: bold');

    // ========================================
    // CONFIGURAZIONI GLOBALI
    // ========================================

    const CONFIG = {
        CATEGORIE_SPECIALI: {
            'Casalinga/o': {
                redditoMax: 10000,
                contributiMax: 0,
                regimeFiscale: 'non_applicabile',
                tipoLavoratore: 'altro',
                figli: true
            },
            'Studente': {
                redditoMax: 8000,
                contributiMax: 0,
                regimeFiscale: 'non_applicabile',
                tipoLavoratore: 'studente',
                etaMax: 30,
                figli: false
            },
            'Disoccupato': {
                redditoMax: 5000,
                contributiAccettabili: true,
                regimeFiscale: 'non_applicabile',
                tipoLavoratore: 'disoccupato',
                figli: true
            },
            'Religioso/a': {
                redditoMax: 0,
                contributiMax: 0,
                regimeFiscale: 'non_applicabile',
                tipoLavoratore: 'altro',
                statoFamiliare: ['religioso'],
                figli: false
            }
        },

        LIMITI_REDDITO_PROFESSIONI: {
            'Imprenditore': { min: 15000, msg: 'Reddito impresa sotto soglia minima sostenibilità' },
            'Titolare azienda': { min: 15000, msg: 'Reddito azienda sotto soglia minima sostenibilità' },
            'Libero Professionista': { min: 10000, msg: 'Reddito libera professione sotto soglia minima' },
            'Avvocato': { min: 12000, msg: 'Reddito medio avvocato sotto minimo di settore' },
            'Commercialista': { min: 12000, msg: 'Reddito medio commercialista sotto minimo di settore' },
            'Medico': { min: 20000, msg: 'Reddito medico sotto minimo di settore' },
            'Odontoiatra': { min: 25000, msg: 'Reddito odontoiatra sotto minimo di settore' }
        },

        PROVINCE_RISCHIO_SISMICO_ALTO: [
            'AQ', 'PG', 'RI', 'FR', 'IS', 'CB', 'BN', 'AV', 'SA', 'PZ', 'MT', 'CS', 'RC', 'ME', 'CT', 'SR', 'RG', 'CZ'
        ]
    };

    // ========================================
    // 1. VALIDAZIONI CATEGORIE SPECIALI ESTESE
    // ========================================

    function validaCategorieSpecialiEstese() {
        const professioneSelect = document.getElementById('professione');
        const redditoInput = document.getElementById('redditoAnnuo');
        const contributiInput = document.getElementById('anniContributivi');
        const regimeSelect = document.getElementById('regimeFiscale');
        const tipoLavoratoreSelect = document.getElementById('tipoLavoratore');
        const statoFamiliareSelect = document.getElementById('statoFamiliare');
        const numeroFigliInput = document.getElementById('numeroFigli');
        const dataNascitaInput = document.getElementById('dataNascita');

        if (!professioneSelect) return;

        function validaCompleta() {
            const professione = professioneSelect.value;
            const config = CONFIG.CATEGORIE_SPECIALI[professione];
            const limiteReddito = CONFIG.LIMITI_REDDITO_PROFESSIONI[professione];

            [redditoInput, contributiInput, regimeSelect, tipoLavoratoreSelect, statoFamiliareSelect, numeroFigliInput].forEach(el => {
                if (el) {
                    el.style.borderColor = '';
                    el.style.background = '';
                }
            });

            if (config) {
                const reddito = parseFloat(redditoInput.value) || 0;
                const contributi = parseInt(contributiInput.value) || 0;
                const statoFamiliare = statoFamiliareSelect.value;
                const numeroFigli = parseInt(numeroFigliInput.value) || 0;

                if (reddito > config.redditoMax) {
                    redditoInput.style.borderColor = '#EF4444';
                    redditoInput.style.background = '#FEE2E2';

                    if (confirm(`⚠️ ${professione} con reddito €${reddito.toLocaleString()} > max €${config.redditoMax}\n\nCorreggere automaticamente?`)) {
                        redditoInput.value = config.redditoMax;
                        redditoInput.style.borderColor = '#10B981';
                        redditoInput.style.background = '#F0FDF4';
                    }
                }

                if (!config.contributiAccettabili && contributi > config.contributiMax) {
                    contributiInput.style.borderColor = '#EF4444';
                    contributiInput.style.background = '#FEE2E2';

                    if (confirm(`⚠️ ${professione} non può avere anni contributivi\n\nCorreggere a 0?`)) {
                        contributiInput.value = 0;
                        contributiInput.style.borderColor = '#10B981';
                        contributiInput.style.background = '#F0FDF4';
                    }
                }

                if (regimeSelect.value !== config.regimeFiscale) {
                    regimeSelect.value = config.regimeFiscale;
                    regimeSelect.disabled = true;
                    regimeSelect.style.background = '#F3F4F6';
                }

                if (tipoLavoratoreSelect.value !== config.tipoLavoratore) {
                    tipoLavoratoreSelect.value = config.tipoLavoratore;
                }

                if (config.statoFamiliare && !config.statoFamiliare.includes(statoFamiliare)) {
                    statoFamiliareSelect.style.borderColor = '#EF4444';
                    statoFamiliareSelect.style.background = '#FEE2E2';

                    if (confirm(`⚠️ ${professione} deve avere stato familiare "Religioso/a"\n\nCorreggere?`)) {
                        statoFamiliareSelect.value = 'religioso';
                        statoFamiliareSelect.dispatchEvent(new Event('change'));
                    }
                }

                if (!config.figli && numeroFigli > 0) {
                    numeroFigliInput.style.borderColor = '#EF4444';
                    numeroFigliInput.style.background = '#FEE2E2';

                    if (confirm(`⚠️ ${professione} normalmente non ha figli\n\nConfermi la presenza di ${numeroFigli} figli?`)) {
                        numeroFigliInput.style.borderColor = '#F59E0B';
                        numeroFigliInput.style.background = '#FEF3C7';
                    } else {
                        numeroFigliInput.value = 0;
                        numeroFigliInput.dispatchEvent(new Event('change'));
                    }
                }

                if (config.etaMax && dataNascitaInput.value) {
                    const eta = calculateAge(dataNascitaInput.value);
                    if (eta > config.etaMax) {
                        dataNascitaInput.style.borderColor = '#F59E0B';
                        dataNascitaInput.style.background = '#FEF3C7';

                        if (typeof showWarningBadge === 'function') {
                            showWarningBadge(`⚠️ Studente con ${eta} anni (insolito, laurea tardiva?)`);
                        }
                    }
                }
            }

            if (limiteReddito) {
                const reddito = parseFloat(redditoInput.value) || 0;

                if (reddito > 0 && reddito < limiteReddito.min) {
                    redditoInput.style.borderColor = '#F59E0B';
                    redditoInput.style.background = '#FEF3C7';

                    if (typeof showWarningBadge === 'function') {
                        showWarningBadge(`⚠️ ${professione}: ${limiteReddito.msg} (€${limiteReddito.min.toLocaleString()})`);
                    }
                }
            }
        }

        [professioneSelect, redditoInput, contributiInput, regimeSelect, tipoLavoratoreSelect, statoFamiliareSelect, numeroFigliInput, dataNascitaInput].forEach(el => {
            if (el) {
                el.addEventListener('change', validaCompleta);
                el.addEventListener('blur', validaCompleta);
            }
        });
    }

    // ========================================
    // 2. VALIDAZIONE PROVINCIA vs ABITAZIONE
    // ========================================

    function validaProvinciaAbitazione() {
        const provinciaSelect = document.getElementById('provincia');
        const polAbitazioneCheckbox = document.getElementById('pol_abitazione');

        if (!provinciaSelect || !polAbitazioneCheckbox) return;

        function checkRischioSismico() {
            const provincia = provinciaSelect.value;

            if (!provincia) return;

            const isRischioAlto = CONFIG.PROVINCE_RISCHIO_SISMICO_ALTO.includes(provincia);

            if (isRischioAlto && !polAbitazioneCheckbox.checked) {
                provinciaSelect.style.borderColor = '#F59E0B';
                provinciaSelect.style.background = '#FEF3C7';

                if (typeof showWarningBadge === 'function') {
                    showWarningBadge(`⚠️ Provincia ${provincia}: ZONA SISMICA ALTA. Polizza abitazione fortemente consigliata!`);
                }
            } else {
                provinciaSelect.style.borderColor = '';
                provinciaSelect.style.background = '';
            }
        }

        provinciaSelect.addEventListener('change', checkRischioSismico);
        polAbitazioneCheckbox.addEventListener('change', checkRischioSismico);
    }

    // ========================================
    // AVVIO AUTOMATICO
    // ========================================

    function inizializzazioneCompleta() {
        validaCategorieSpecialiEstese();
        validaProvinciaAbitazione();

        console.log('✅ MEGA-PATCH V5.0 INIZIALIZZATA');
        console.log('   📊 50+ controlli coerenza attivi');
        console.log('   🛡️ Validazioni estese: Casalinga/Studente/Disoccupato/Religioso');
        console.log('   🏠 Validazione provincia vs abitazione (zone sismiche)');
    }

    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        setTimeout(inizializzazioneCompleta, 1000);
    } else {
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(inizializzazioneCompleta, 1000);
        });
    }

    console.log('%c✅ MEGA-PATCH V5.0 CARICATA', 'color: #10B981; font-weight: bold; font-size: 16px');

})();
</script>
<script>
/* === MODULO ANALITICO AVANZATO V1.0 - COMPATIBILE === */
(function() {
    'use strict';

    console.log('%c🧠 MODULO ANALITICO AVANZATO V1.0 - ATTIVO', 'color: #8B5CF6; font-weight: bold');

    const PESI_ANALISI = {
        coerenza_anagrafica: 0.3,
        coerenza_economica: 0.3,
        coerenza_protezione: 0.4
    };

    function calcolaIndiceCoerenzaAvanzato(userData, answers) {
        let coerenzaAnagrafica = 1.0;
        let coerenzaEconomica = 1.0;
        let coerenzaProtezione = 1.0;

        const eta = userData.age || 40;
        const professione = (userData.professione || '').toLowerCase();
        const tipoLavoratore = userData.tipoLavoratore || '';
        const reddito = userData.redditoAnnuo || 0;
        const numeroFigli = userData.numeroFigli || 0;
        const polizze = userData.polizze || {};
        const statoFamiliare = userData.statoFamiliare || '';

        if (eta < 30 && professione.includes('pension')) coerenzaAnagrafica -= 0.5;
        if (eta > 65 && professione.includes('student')) coerenzaAnagrafica -= 0.5;
        if (tipoLavoratore === 'pensionato' && eta < 58) coerenzaAnagrafica -= 0.6;

        if (statoFamiliare.includes('sposati') && eta < 20) coerenzaAnagrafica -= 0.3;
        if (statoFamiliare === 'religioso' && numeroFigli > 0) coerenzaAnagrafica -= 1.0;

        if (numeroFigli > 2 && reddito < 30000) coerenzaEconomica -= 0.4;
        if (numeroFigli > 3 && reddito < 40000) coerenzaEconomica -= 0.6;

        if (tipoLavoratore === 'imprenditore' && reddito < 15000) coerenzaEconomica -= 0.5;
        if (tipoLavoratore === 'disoccupato' && reddito > 5000) coerenzaEconomica -= 0.3;

        const capacitaRisparmio = (answers.B2 || 3) / 5;
        const redditoRelativo = Math.min(reddito / 50000, 1);
        if (capacitaRisparmio > redditoRelativo + 0.3) coerenzaEconomica -= 0.2;

        const haFamiglia = !statoFamiliare.includes('single') &&
                          !statoFamiliare.includes('vedovo_senza_figli') &&
                          statoFamiliare !== 'religioso';

        if (haFamiglia && numeroFigli > 0 && !polizze.vita && !polizze.tcm) {
            coerenzaProtezione -= 0.4;
        }

        if (eta > 50 && !polizze.sanitaria) coerenzaProtezione -= 0.25;
        if (eta > 60 && !polizze.ltc) coerenzaProtezione -= 0.25;
        if ((answers.B8 || 3) >= 4 && !polizze.infortuni) coerenzaProtezione -= 0.3;
        if ((answers.B5 || 3) >= 4 && !polizze.infortuni) coerenzaProtezione -= 0.2;

        coerenzaAnagrafica = Math.max(0, Math.min(1, coerenzaAnagrafica));
        coerenzaEconomica = Math.max(0, Math.min(1, coerenzaEconomica));
        coerenzaProtezione = Math.max(0, Math.min(1, coerenzaProtezione));

        const scoreTotale =
            coerenzaAnagrafica * PESI_ANALISI.coerenza_anagrafica +
            coerenzaEconomica * PESI_ANALISI.coerenza_economica +
            coerenzaProtezione * PESI_ANALISI.coerenza_protezione;

        return {
            coerenzaAnagrafica: Math.round(coerenzaAnagrafica * 100),
            coerenzaEconomica: Math.round(coerenzaEconomica * 100),
            coerenzaProtezione: Math.round(coerenzaProtezione * 100),
            scoreTotale: Math.round(scoreTotale * 100)
        };
    }

    window.calcolaIndiceCoerenzaAvanzato = calcolaIndiceCoerenzaAvanzato;

    console.log('✅ Modulo Analitico Avanzato: OPERATIVO');

})();
</script>
<script>
/* === PULSANTE ELIMINA TUTTE LE ANALISI === */
window.addEventListener('load', () => {
    const container = document.querySelector('#risultati .btn-block')?.parentNode;
    if (!container) return;

    const btnDeleteAll = document.createElement('button');
    btnDeleteAll.className = 'btn btn-secondary';
    btnDeleteAll.style.background = '#EF4444';
    btnDeleteAll.textContent = '🗑️ Elimina Tutte le Analisi';
    btnDeleteAll.onclick = function() {
        if (confirm('⚠️ ATTENZIONE!\n\nSei sicuro di voler eliminare TUTTE le analisi salvate?\n\nQuesta azione è IRREVERSIBILE.')) {
            localStorage.removeItem('analisiSalvate');
            localStorage.removeItem('generali_partner_draft');
            alert('✅ Tutte le analisi eliminate!');
            location.reload();
        }
    };

    container.appendChild(btnDeleteAll);
});
</script>
<script>
/* === BEHAVIORAL GAP ANALYSIS V2.0 === */
(function() {
    'use strict';

    console.log('%c🎯 BEHAVIORAL GAP ANALYSIS V2.0 - ATTIVO', 'color: #7C3AED; font-weight: bold');

    // ========================================
    // ANALISI BEHAVIORAL GAP
    // ========================================

    function calcolaBehavioralGap(userData, answers, normotipo, polizzeEsistenti) {
        const gaps = {
            protezione: {},
            risparmio: {},
            investimenti: {},
            previdenza: {},
            salute: {}
        };

        const eta = userData.age || 40;
        const reddito = userData.redditoAnnuo || 0;
        const numeroFigli = userData.numeroFigli || 0;
        const statoFamiliare = userData.statoFamiliare || '';

        const haFamiglia = !statoFamiliare.includes('single') && 
                          !statoFamiliare.includes('vedovo_senza_figli') && 
                          statoFamiliare !== 'religioso';

        // ========================================
        // GAP PROTEZIONE
        // ========================================

        // Percezione protezione vs Realtà
        const percezioneSicurezza = answers.A1 || 3;
        const coperturaInfortuni = answers.A2 || 3;
        const autonomiaEconomica = answers.A3 || 3;

        let protezioneTeorica = 0;
        if (polizzeEsistenti.vita) protezioneTeorica += 25;
        if (polizzeEsistenti.tcm) protezioneTeorica += 25;
        if (polizzeEsistenti.infortuni) protezioneTeorica += 20;
        if (polizzeEsistenti.sanitaria) protezioneTeorica += 15;
        if (polizzeEsistenti.ltc) protezioneTeorica += 15;

        const percezioneProtezionePct = (percezioneSicurezza / 5) * 100;
        const gapProtezione = percezioneProtezionePct - protezioneTeorica;

        gaps.protezione = {
            percezione: Math.round(percezioneProtezionePct),
            realta: Math.round(protezioneTeorica),
            gap: Math.round(gapProtezione),
            severity: Math.abs(gapProtezione) > 40 ? 'high' : Math.abs(gapProtezione) > 20 ? 'medium' : 'low',
            messaggio: gapProtezione > 20 ? 
                'Percezione di protezione ECCESSIVA rispetto a coperture reali' : 
                gapProtezione < -20 ? 
                'Ti senti poco protetto ma hai buone coperture' : 
                'Percezione allineata alla realtà'
        };

        // ========================================
        // GAP RISPARMIO
        // ========================================

        const capacitaRisparmio = answers.B2 || 3;
        const fondoEmergenza = answers.B3 || 3;

        const risparmioDichiarato = (capacitaRisparmio / 5) * reddito * 0.20; // Max 20% reddito
        const fondoEmergenzaMesi = [0, 0.5, 3, 4.5, 6, 12][fondoEmergenza];
        const speseAnnue = reddito * 0.70; // Stima spese = 70% reddito
        const fondoReale = (speseAnnue / 12) * fondoEmergenzaMesi;

        const risparmiConsigliato = reddito * 0.15; // 15% reddito minimo
        const fondoConsigliato = speseAnnue * 0.50; // 6 mesi spese

        gaps.risparmio = {
            capacitaDichiarata: Math.round(risparmioDichiarato),
            capacitaConsigliata: Math.round(risparmiConsigliato),
            gapRisparmio: Math.round(risparmioDichiarato - risparmiConsigliato),
            fondoReale: Math.round(fondoReale),
            fondoConsigliato: Math.round(fondoConsigliato),
            gapFondo: Math.round(fondoReale - fondoConsigliato),
            severity: fondoReale < fondoConsigliato * 0.5 ? 'high' : fondoReale < fondoConsigliato ? 'medium' : 'low',
            messaggio: fondoReale < fondoConsigliato * 0.3 ? 
                'CRITICO: Fondo emergenza gravemente insufficiente' : 
                fondoReale < fondoConsigliato ? 
                'Fondo emergenza da incrementare' : 
                'Fondo emergenza adeguato'
        };

        // ========================================
        // GAP INVESTIMENTI
        // ========================================

        const propensioneInvestimenti = answers.C7 || 3;
        const propensioneRischio = answers.B6 || 3;
        const conoscenzaStrumenti = answers.C5 || 3;

        const attitudineInvestimenti = Math.round(((propensioneInvestimenti + propensioneRischio + conoscenzaStrumenti) / 15) * 100);

        const haInvestimenti = polizzeEsistenti.investimenti || polizzeEsistenti.accantonamento;
        const investimentiReali = haInvestimenti ? 70 : 0;

        const gapInvestimenti = attitudineInvestimenti - investimentiReali;

        gaps.investimenti = {
            attitudine: attitudineInvestimenti,
            realta: investimentiReals,
            gap: Math.round(gapInvestimenti),
            severity: Math.abs(gapInvestimenti) > 50 ? 'high' : Math.abs(gapInvestimenti) > 25 ? 'medium' : 'low',
            messaggio: gapInvestimenti > 40 ? 
                'Alta propensione ma non investi: opportunità persa' : 
                gapInvestimenti < -40 ? 
                'Investi ma con bassa propensione: rischio eccessivo' : 
                'Comportamento coerente con propensione'
        };

        // ========================================
        // GAP PREVIDENZA
        // ========================================

        const pianificazioneFuturo = answers.C1 || 3;
        const obiettivi = answers.C4 || 3;
        const importanzaEredita = answers.C6 || 3;

        const anniPensione = Math.max(0, 67 - eta);
        const urgenzaPrevidenza = anniPensione <= 15 ? 90 : anniPensione <= 25 ? 70 : 50;

        const attenzioneFuturo = Math.round(((pianificazioneFuturo + obiettivi + importanzaEredita) / 15) * 100);

        const haPrevidenza = polizzeEsistenti.investimenti?.contributo > 0;
        const previdenzaReale = haPrevidenza ? 80 : 0;

        const gapPrevidenza = urgenzaPrevidenza - previdenzaReale;

        gaps.previdenza = {
            urgenza: urgenzaPrevidenza,
            realta: previdenzaReale,
            attenzioneFuturo: attenzioneFuturo,
            anniMancanti: anniPensione,
            gap: Math.round(gapPrevidenza),
            severity: gapPrevidenza > 60 ? 'critical' : gapPrevidenza > 40 ? 'high' : gapPrevidenza > 20 ? 'medium' : 'low',
            messaggio: gapPrevidenza > 60 && anniPensione <= 15 ? 
                'CRITICO: Pensione vicina senza integrazione' : 
                gapPrevidenza > 40 ? 
                'Urgente: avviare previdenza complementare' : 
                gapPrevidenza > 20 ? 
                'Consigliato iniziare previdenza' : 
                'Situazione sotto controllo'
        };

        // ========================================
        // GAP SALUTE
        // ========================================

        const soddisfazioneSSN = answers.A4 || 3;
        const attivitaRischiose = Math.max(answers.B5 || 3, answers.B8 || 3);

        const bisognoSalute = Math.round(((5 - soddisfazioneSSN + attivitaRischiose + (eta / 100)) / 3) * 33.33);

        let coperturaReale = 0;
        if (polizzeEsistenti.sanitaria) coperturaReale += 50;
        if (polizzeEsistenti.ltc) coperturaReale += 30;
        if (polizzeEsistenti.infortuni) coperturaReale += 20;

        const gapSalute = bisognoSalute - coperturaReale;

        gaps.salute = {
            bisogno: bisognoSalute,
            realta: coperturaReale,
            gap: Math.round(gapSalute),
            severity: gapSalute > 60 ? 'high' : gapSalute > 40 ? 'medium' : 'low',
            messaggio: gapSalute > 60 ? 
                'Bisogno salute elevato: coperture insufficienti' : 
                gapSalute > 40 ? 
                'Considera integrazione sanitaria' : 
                gapSalute > 20 ? 
                'Coperture adeguate ma migliorabili' : 
                'Coperture salute ottimali'
        };

        return gaps;
    }

    // ========================================
    // RENDERING GAP ANALYSIS
    // ========================================

    function renderBehavioralGapAnalysis(gaps) {
        let html = '<div class="card" style="background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%); border-left: 4px solid #F59E0B;">';
        html += '<h3 class="card-title" style="color: #92400E;">📊 Behavioral Gap Analysis</h3>';
        html += '<p style="color: #78350F; margin-bottom: 20px;">Analisi degli scostamenti tra comportamenti dichiarati e situazione reale</p>';

        // Protezione
        html += renderSingleGap('Protezione', gaps.protezione, '🛡️');
        
        // Risparmio
        html += renderSingleGap('Risparmio', gaps.risparmio, '💰');
        
        // Investimenti
        html += renderSingleGap('Investimenti', gaps.investimenti, '📈');
        
        // Previdenza
        html += renderSingleGap('Previdenza', gaps.previdenza, '🏦');
        
        // Salute
        html += renderSingleGap('Salute', gaps.salute, '⚕️');

        html += '</div>';

        return html;
    }

    function renderSingleGap(titolo, dati, icon) {
        const severityColors = {
            critical: { bg: '#FEE2E2', text: '#991B1B', label: 'CRITICO' },
            high: { bg: '#FED7AA', text: '#9A3412', label: 'ALTO' },
            medium: { bg: '#FEF3C7', text: '#92400E', label: 'MEDIO' },
            low: { bg: '#D1FAE5', text: '#065F46', label: 'BASSO' }
        };

        const severity = severityColors[dati.severity] || severityColors.low;

        let html = '<div style="background: white; padding: 20px; margin-bottom: 15px; border-radius: 8px; border-left: 4px solid ' + severity.text + ';">';
        html += '<h4 style="color: var(--generali-blue); margin-bottom: 15px;">' + icon + ' ' + titolo + '</h4>';

        html += '<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">';
        
        if (dati.percezione !== undefined) {
            html += '<div style="text-align: center;"><div style="font-size: 12px; color: var(--gray-600);">Percezione</div><div style="font-size: 24px; font-weight: bold; color: var(--generali-blue);">' + dati.percezione + '%</div></div>';
        }
        if (dati.realta !== undefined) {
            html += '<div style="text-align: center;"><div style="font-size: 12px; color: var(--gray-600);">Realtà</div><div style="font-size: 24px; font-weight: bold; color: ' + (dati.realta >= 70 ? 'var(--green)' : 'var(--red)') + ';">' + dati.realta + '%</div></div>';
        }
        if (dati.gap !== undefined) {
            html += '<div style="text-align: center;"><div style="font-size: 12px; color: var(--gray-600);">Gap</div><div style="font-size: 24px; font-weight: bold; color: ' + (Math.abs(dati.gap) > 30 ? 'var(--red)' : 'var(--green)') + ';">' + (dati.gap > 0 ? '+' : '') + dati.gap + '</div></div>';
        }

        if (dati.capacitaDichiarata !== undefined) {
            html += '<div style="text-align: center;"><div style="font-size: 12px; color: var(--gray-600);">Risparmio Dichiarato</div><div style="font-size: 20px; font-weight: bold; color: var(--generali-blue);">€' + dati.capacitaDichiarata.toLocaleString() + '</div></div>';
        }
        if (dati.capacitaConsigliata !== undefined) {
            html += '<div style="text-align: center;"><div style="font-size: 12px; color: var(--gray-600);">Consigliato</div><div style="font-size: 20px; font-weight: bold; color: var(--green);">€' + dati.capacitaConsigliata.toLocaleString() + '</div></div>';
        }
        if (dati.gapRisparmio !== undefined) {
            html += '<div style="text-align: center;"><div style="font-size: 12px; color: var(--gray-600);">Gap</div><div style="font-size: 20px; font-weight: bold; color: ' + (dati.gapRisparmio < 0 ? 'var(--red)' : 'var(--green)') + ';">€' + dati.gapRisparmio.toLocaleString() + '</div></div>';
        }

        if (dati.fondoReale !== undefined) {
            html += '<div style="text-align: center;"><div style="font-size: 12px; color: var(--gray-600);">Fondo Attuale</div><div style="font-size: 20px; font-weight: bold; color: var(--generali-blue);">€' + dati.fondoReale.toLocaleString() + '</div></div>';
        }
        if (dati.fondoConsigliato !== undefined) {
            html += '<div style="text-align: center;"><div style="font-size: 12px; color: var(--gray-600);">Fondo Ideale</div><div style="font-size: 20px; font-weight: bold; color: var(--green);">€' + dati.fondoConsigliato.toLocaleString() + '</div></div>';
        }
        if (dati.gapFondo !== undefined) {
            html += '<div style="text-align: center;"><div style="font-size: 12px; color: var(--gray-600);">Da Accumulare</div><div style="font-size: 20px; font-weight: bold; color: ' + (dati.gapFondo < 0 ? 'var(--red)' : 'var(--green)') + ';">€' + Math.abs(dati.gapFondo).toLocaleString() + '</div></div>';
        }

        if (dati.attitudine !== undefined) {
            html += '<div style="text-align: center;"><div style="font-size: 12px; color: var(--gray-600);">Attitudine</div><div style="font-size: 24px; font-weight: bold; color: var(--generali-blue);">' + dati.attitudine + '%</div></div>';
        }

        if (dati.urgenza !== undefined) {
            html += '<div style="text-align: center;"><div style="font-size: 12px; color: var(--gray-600);">Urgenza</div><div style="font-size: 24px; font-weight: bold; color: ' + (dati.urgenza >= 80 ? 'var(--red)' : 'var(--yellow)') + ';">' + dati.urgenza + '%</div></div>';
        }
        if (dati.attenzioneFuturo !== undefined) {
            html += '<div style="text-align: center;"><div style="font-size: 12px; color: var(--gray-600);">Attenzione Futuro</div><div style="font-size: 24px; font-weight: bold; color: var(--generali-blue);">' + dati.attenzioneFuturo + '%</div></div>';
        }
        if (dati.anniMancanti !== undefined && dati.anniMancanti > 0) {
            html += '<div style="text-align: center;"><div style="font-size: 12px; color: var(--gray-600);">Anni a Pensione</div><div style="font-size: 24px; font-weight: bold; color: var(--yellow);">' + dati.anniMancanti + '</div></div>';
        }

        if (dati.bisogno !== undefined) {
            html += '<div style="text-align: center;"><div style="font-size: 12px; color: var(--gray-600);">Bisogno</div><div style="font-size: 24px; font-weight: bold; color: var(--generali-blue);">' + dati.bisogno + '%</div></div>';
        }

        html += '</div>';

        html += '<div style="background: ' + severity.bg + '; color: ' + severity.text + '; padding: 12px; border-radius: 6px; margin-top: 10px;">';
        html += '<strong>Gravità: ' + severity.label + '</strong><br>';
        html += dati.messaggio;
        html += '</div>';

        html += '</div>';

        return html;
    }

    // ========================================
    // INTEGRAZIONE CON GENERA RISULTATI
    // ========================================

    const originalGeneraRisultati = window.generaRisultati;

    window.generaRisultati = async function() {
        await originalGeneraRisultati.call(this);

        setTimeout(() => {
            const userData = appState.user.anagrafica;
            const answers = appState.answers;
            const normotipo = appState.results.normotipo;
            const polizze = appState.user.polizze || {};

            const behavioralGaps = calcolaBehavioralGap(userData, answers, normotipo, polizze);

            appState.results.behavioralGaps = behavioralGaps;

            const container = document.getElementById('risultatiContent');
            const gapHTML = renderBehavioralGapAnalysis(behavioralGaps);
            
            const coherenceCard = container.querySelector('.card');
            if (coherenceCard && coherenceCard.nextSibling) {
                coherenceCard.insertAdjacentHTML('afterend', gapHTML);
            } else {
                container.insertAdjacentHTML('beforeend', gapHTML);
            }

            console.log('✅ Behavioral Gap Analysis completata');

        }, 1500);
    };

    console.log('✅ Behavioral Gap Analysis: OPERATIVO');
    console.log('  ✓ 5 aree analizzate: Protezione, Risparmio, Investimenti, Previdenza, Salute');
    console.log('  ✓ Severity levels: critical, high, medium, low');

})();
</script>
<script>
/* === SIMULAZIONE SCENARI STRESS V2.0 === */
(function() {
    'use strict';

    console.log('%c🚨 SIMULAZIONE SCENARI STRESS V2.0 - ATTIVO', 'color: #DC2626; font-weight: bold');

    // ========================================
    // DEFINIZIONE SCENARI
    // ========================================

    const SCENARI = {
        morte: {
            nome: 'Decesso Improvviso',
            icon: '⚰️',
            descrizione: 'Simulazione perdita reddito principale per decesso',
            probabilita: 'bassa',
            impatto: 'critico'
        },
        invalidita: {
            nome: 'Invalidità Permanente',
            icon: '♿',
            descrizione: 'Perdita capacità lavorativa permanente',
            probabilita: 'media',
            impatto: 'alto'
        },
        infortunio: {
            nome: 'Infortunio Grave',
            icon: '🏥',
            descrizione: 'Stop lavorativo 6-12 mesi',
            probabilita: 'media',
            impatto: 'medio'
        },
        malattia: {
            nome: 'Malattia Grave',
            icon: '⚕️',
            descrizione: 'Spese sanitarie straordinarie + stop lavoro',
            probabilita: 'media',
            impatto: 'alto'
        },
        non_autosufficienza: {
            nome: 'Non Autosufficienza',
            icon: '🛏️',
            descrizione: 'Perdita autonomia e necessità assistenza',
            probabilita: 'crescente con età',
            impatto: 'critico'
        },
        crisi_economica: {
            nome: 'Crisi Economica/Perdita Lavoro',
            icon: '📉',
            descrizione: 'Perdita lavoro o riduzione significativa reddito',
            probabilita: 'media',
            impatto: 'alto'
        }
    };

    // ========================================
    // CALCOLO IMPATTI
    // ========================================

    function simulaScenari(userData, answers, polizze) {
        const eta = userData.age || 40;
        const reddito = userData.redditoAnnuo || 0;
        const numeroFigli = userData.numeroFigli || 0;
        const statoFamiliare = userData.statoFamiliare || '';
        const tipoLavoratore = userData.tipoLavoratore || '';
        const anniContributivi = userData.anniContributivi || 0;

        const haFamiglia = !statoFamiliare.includes('single') && 
                          !statoFamiliare.includes('vedovo_senza_figli') && 
                          statoFamiliare !== 'religioso';

        const fondoEmergenzaMesi = [0, 0.5, 3, 4.5, 6, 12][answers.B3 || 3];
        const speseAnnue = reddito * 0.70;
        const speseMensili = speseAnnue / 12;
        const fondoEmergenza = speseMensili * fondoEmergenzaMesi;

        const risultati = {};

        // ========================================
        // SCENARIO 1: MORTE
        // ========================================

        const bisognoFamiglia = haFamiglia ? speseAnnue * 10 : 0; // 10 anni spese
        const coperturaMorte = (polizze.vita?.capitale || 0) + (polizze.tcm?.capitale || 0);
        const renditeINPS = tipoLavoratore.includes('dipendente') ? reddito * 0.40 * 5 : 0;

        const scoperturaLorda = Math.max(0, bisognoFamiglia - coperturaMorte - renditeINPS);
        const scoperturaAnno = scoperturaLorda / 10;

        risultati.morte = {
            bisogno: bisognoFamiglia,
            copertura: coperturaMorte,
            renditeStatali: renditeINPS,
            scoperturaLorda: scoperturaLorda,
            scoperturaAnnua: scoperturaAnno,
            gravita: scoperturaLorda > bisognoFamiglia * 0.7 ? 'critica' : 
                     scoperturaLorda > bisognoFamiglia * 0.4 ? 'alta' : 
                     scoperturaLorda > 0 ? 'media' : 'coperta',
            messaggio: haFamiglia ? 
                (scoperturaLorda > bisognoFamiglia * 0.7 ? 
                    `CRITICO: Famiglia scoperta per €${scoperturaLorda.toLocaleString()} (${Math.round(scoperturaAnno).toLocaleString()}/anno per 10 anni)` :
                    scoperturaLorda > 0 ?
                    `Gap da coprire: €${scoperturaLorda.toLocaleString()}` :
                    'Famiglia adeguatamente protetta') :
                'Scenario non applicabile (nessuna famiglia a carico)'
        };

        // ========================================
        // SCENARIO 2: INVALIDITÀ
        // ========================================

        const redditoPerso = reddito * 1.0; // Perdita totale capacità lavorativa
        const indennizzaINPS = tipoLavoratore.includes('dipendente') ? reddito * 0.60 : 
                               tipoLavoratore.includes('autonomo') ? reddito * 0.30 : 0;
        
        const capitaleInvalidita = polizze.infortuni?.capitale || 0;
        const renditeAnnoInvalidita = capitaleInvalidita > 0 ? capitaleInvalidita * 0.05 : 0; // 5% annuo

        const scoperturaInvaliditaAnno = Math.max(0, redditoPerso - indennizzaINPS - renditeAnnoInvalidita);

        risultati.invalidita = {
            redditoPerso: redditoPerso,
            indennizzaINPS: indennizzaINPS,
            capitaleAssicurato: capitaleInvalidita,
            renditeAnnuali: renditeAnnoInvalidita,
            scoperturaAnnua: scoperturaInvaliditaAnno,
            gravita: scoperturaInvaliditaAnno > reddito * 0.7 ? 'critica' : 
                     scoperturaInvaliditaAnno > reddito * 0.4 ? 'alta' : 
                     scoperturaInvaliditaAnno > 0 ? 'media' : 'coperta',
            messaggio: scoperturaInvaliditaAnno > reddito * 0.7 ?
                `CRITICO: Perdita €${scoperturaInvaliditaAnno.toLocaleString()}/anno senza copertura` :
                scoperturaInvaliditaAnno > 0 ?
                `Gap annuo da coprire: €${scoperturaInvaliditaAnno.toLocaleString()}` :
                'Invalidità adeguatamente coperta'
        };

        // ========================================
        // SCENARIO 3: INFORTUNIO (6 mesi stop)
        // ========================================

        const mesiStop = 6;
        const redditoPersoInfortunio = (reddito / 12) * mesiStop;
        const indennizzaInfortuni = polizze.infortuni ? redditoPersoInfortunio * 0.70 : 0;
        const indennizzaINPSInfortunio = tipoLavoratore.includes('dipendente') ? redditoPersoInfortunio * 0.50 : 0;

        const scoperturaInfortunio = Math.max(0, redditoPersoInfortunio - indennizzaInfortuni - indennizzaINPSInfortunio - fondoEmergenza);

        risultati.infortunio = {
            mesiStop: mesiStop,
            redditoPerso: redditoPersoInfortunio,
            indennizzaPolizza: indennizzaInfortuni,
            indennizzaINPS: indennizzaINPSInfortunio,
            fondoDisponibile: fondoEmergenza,
            scoperturaLorda: scoperturaInfortunio,
            gravita: scoperturaInfortunio > redditoPersoInfortunio * 0.5 ? 'alta' : 
                     scoperturaInfortunio > 0 ? 'media' : 'coperta',
            messaggio: scoperturaInfortunio > redditoPersoInfortunio * 0.5 ?
                `ALTO: Scopertura €${scoperturaInfortunio.toLocaleString()} per 6 mesi stop` :
                scoperturaInfortunio > 0 ?
                `Gap da coprire: €${scoperturaInfortunio.toLocaleString()}` :
                'Infortunio adeguatamente coperto'
        };

        // ========================================
        // SCENARIO 4: MALATTIA GRAVE
        // ========================================

        const speseCure = 30000; // Spese straordinarie chemio/ricoveri
        const mesiStopMalattia = 12;
        const redditoPersoMalattia = (reddito / 12) * mesiStopMalattia;
        
        const rimborsaSanitaria = polizze.sanitaria ? Math.min(speseCure, polizze.sanitaria.massimale || 50000) : 0;
        const indennizzaINPSMalattia = tipoLavoratore.includes('dipendente') ? redditoPersoMalattia * 0.50 : 0;

        const scoperturaMalattia = Math.max(0, speseCure + redditoPersoMalattia - rimborsaSanitaria - indennizzaINPSMalattia - fondoEmergenza);

        risultati.malattia = {
            speseCure: speseCure,
            mesiStop: mesiStopMalattia,
            redditoPerso: redditoPersoMalattia,
            rimborsoSanitaria: rimborsaSanitaria,
            indennizzaINPS: indennizzaINPSMalattia,
            fondoDisponibile: fondoEmergenza,
            impattototale: speseCure + redditoPersoMalattia,
            scoperturaLorda: scoperturaMalattia,
            gravita: scoperturaMalattia > 40000 ? 'critica' : 
                     scoperturaMalattia > 20000 ? 'alta' : 
                     scoperturaMalattia > 0 ? 'media' : 'coperta',
            messaggio: scoperturaMalattia > 40000 ?
                `CRITICO: Scopertura €${scoperturaMalattia.toLocaleString()} (cure + reddito perso)` :
                scoperturaMalattia > 0 ?
                `Gap da coprire: €${scoperturaMalattia.toLocaleString()}` :
                'Malattia grave adeguatamente coperta'
        };

        // ========================================
        // SCENARIO 5: NON AUTOSUFFICIENZA
        // ========================================

        const costoMensileAssistenza = 2500;
        const costoAnnuoLTC = costoMensileAssistenza * 12;
        const durataMediaAnni = 5; // Durata media non autosufficienza
        const costoTotaleLTC = costoAnnuoLTC * durataMediaAnni;

        const renditaLTC = polizze.ltc?.rendita || 0;
        const renditaAnnuaLTC = renditaLTC * 12;
        const coperturaTotaleLTC = renditaAnnuaLTC * durataMediaAnni;

        const scoperturaLTCTotale = Math.max(0, costoTotaleLTC - coperturaTotaleLTC);
        const scoperturaLTCAnnua = scoperturaLTCTotale / durataMediaAnni;

        const probabilitaLTC = eta < 50 ? 'bassa' : eta < 65 ? 'media' : eta < 75 ? 'alta' : 'molto alta';

        risultati.non_autosufficienza = {
            costoMensile: costoMensileAssistenza,
            costoAnnuo: costoAnnuoLTC,
            durataMedia: durataMediaAnni,
            costoTotale: costoTotaleLTC,
            renditaMensile: renditaLTC,
            renditaAnnua: renditaAnnuaLTC,
            coperturaTotale: coperturaTotaleLTC,
            scoperturaLorda: scoperturaLTCTotale,
            scoperturaAnnua: scoperturaLTCAnnua,
            probabilita: probabilitaLTC,
            gravita: scoperturaLTCTotale > costoTotaleLTC * 0.7 ? 'critica' : 
                     scoperturaLTCTotale > costoTotaleLTC * 0.4 ? 'alta' : 
                     scoperturaLTCTotale > 0 ? 'media' : 'coperta',
            messaggio: scoperturaLTCTotale > costoTotaleLTC * 0.7 ?
                `CRITICO: Scopertura €${scoperturaLTCTotale.toLocaleString()} (€${Math.round(scoperturaLTCAnnua).toLocaleString()}/anno per ${durataMediaAnni} anni)` :
                scoperturaLTCTotale > 0 ?
                `Gap da coprire: €${scoperturaLTCTotale.toLocaleString()}` :
                'Non autosufficienza adeguatamente coperta'
        };

        // ========================================
        // SCENARIO 6: CRISI ECONOMICA
        // ========================================

        const mesiDisoccupazione = 12;
        const redditoPersoDisoccupazione = reddito * 1.0;
        const indennizzaNASPI = tipoLavoratore === 'dipendente_privato' && anniContributivi >= 2 ? reddito * 0.75 * 0.50 : 0; // 75% per max 24 mesi, qui 50% medio
        
        const scoperturaCrisi = Math.max(0, redditoPersoDisoccupazione - indennizzaNASPI - fondoEmergenza);

        risultati.crisi_economica = {
            mesiDisoccupazione: mesiDisoccupazione,
            redditoPerso: redditoPersoDisoccupazione,
            indennizzaNASPI: indennizzaNASPI,
            fondoDisponibile: fondoEmergenza,
            scoperturaLorda: scoperturaCrisi,
            gravita: scoperturaCrisi > reddito * 0.7 ? 'critica' : 
                     scoperturaCrisi > reddito * 0.4 ? 'alta' : 
                     scoperturaCrisi > 0 ? 'media' : 'coperta',
            messaggio: scoperturaCrisi > reddito * 0.7 ?
                `CRITICO: Scopertura €${scoperturaCrisi.toLocaleString()} in caso perdita lavoro` :
                scoperturaCrisi > 0 ?
                `Gap da coprire: €${scoperturaCrisi.toLocaleString()} (fondo emergenza insufficiente)` :
                'Situazione coperta da fondo emergenza adeguato'
        };

        return risultati;
    }

    // ========================================
    // RENDERING SCENARI
    // ========================================

    function renderScenariStress(scenariRisultati) {
        let html = '<div class="card" style="background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%); border-left: 4px solid #DC2626;">';
        html += '<h3 class="card-title" style="color: #991B1B;">🚨 Simulazione Scenari Stress</h3>';
        html += '<p style="color: #7F1D1D; margin-bottom: 20px;">Analisi impatto di 6 scenari critici sulla tua situazione finanziaria</p>';

        Object.entries(scenariRisultati).forEach(([key, risultato]) => {
            const scenario = SCENARI[key];
            html += renderSingoloScenario(scenario, risultato);
        });

        html += '</div>';

        return html;
    }

    function renderSingoloScenario(scenario, risultato) {
        const gravitaColors = {
            critica: { bg: '#FEE2E2', border: '#DC2626', text: '#991B1B', label: '🔴 CRITICA' },
            alta: { bg: '#FED7AA', border: '#EA580C', text: '#9A3412', label: '🟠 ALTA' },
            media: { bg: '#FEF3C7', border: '#F59E0B', text: '#92400E', label: '🟡 MEDIA' },
            coperta: { bg: '#D1FAE5', border: '#10B981', text: '#065F46', label: '🟢 COPERTA' }
        };

        const style = gravitaColors[risultato.gravita] || gravitaColors.media;

        let html = '<div style="background: white; padding: 20px; margin-bottom: 15px; border-radius: 8px; border-left: 4px solid ' + style.border + ';">';
        
        html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">';
        html += '<h4 style="color: var(--generali-blue); margin: 0;">' + scenario.icon + ' ' + scenario.nome + '</h4>';
        html += '<span style="background: ' + style.bg + '; color: ' + style.text + '; padding: 6px 12px; border-radius: 20px; font-weight: 600; font-size: 12px;">' + style.label + '</span>';
        html += '</div>';

        html += '<p style="color: var(--gray-600); font-size: 14px; margin-bottom: 15px;">' + scenario.descrizione + '</p>';

        // Dettagli numerici
        html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">';

        Object.entries(risultato).forEach(([key, value]) => {
            if (key === 'gravita' || key === 'messaggio' || key === 'probabilita') return;

            const labels = {
                bisogno: 'Bisogno Famiglia',
                copertura: 'Copertura Attuale',
                renditeStatali: 'Rendite INPS',
                scoperturaLorda: 'Scoperta Totale',
                scoperturaAnnua: 'Scopertura Annua',
                redditoPerso: 'Reddito Perso',
                indennizzaINPS: 'Indennizzo INPS',
                capitaleAssicurato: 'Capitale Assicurato',
                renditeAnnuali: 'Rendite Annuali',
                mesiStop: 'Mesi Stop Lavoro',
                indennizzaPolizza: 'Indennizzo Polizza',
                fondoDisponibile: 'Fondo Emergenza',
                speseCure: 'Spese Cure',
                rimborsoSanitaria: 'Rimborso Sanitaria',
                impattotale: 'Impatto Totale',
                costoMensile: 'Costo Mensile',
                costoAnnuo: 'Costo Annuo',
                durataMedia: 'Durata Media (anni)',
                costoTotale: 'Costo Totale',
                renditaMensile: 'Rendita Mensile LTC',
                renditaAnnua: 'Rendita Annua LTC',
                coperturaTotale: 'Copertura Totale',
                mesiDisoccupazione: 'Mesi Disoccupazione',
                indennizzaNASPI: 'NASPI'
            };

            const label = labels[key] || key;

            if (typeof value === 'number') {
                const color = key.includes('scopert') || key.includes('Perso') || key.includes('Gap') ? 'var(--red)' : 
                             key.includes('copertura') || key.includes('indennizz') || key.includes('rendita') || key.includes('rimborso') || key.includes('fondo') ? 'var(--green)' : 
                             'var(--generali-blue)';

                html += '<div style="background: var(--gray-50); padding: 12px; border-radius: 6px;">';
                html += '<div style="font-size: 11px; color: var(--gray-600); margin-bottom: 4px;">' + label + '</div>';
                html += '<div style="font-size: 18px; font-weight: bold; color: ' + color + ';">';
                
                if (key === 'mesiStop' || key === 'mesiDisoccupazione' || key === 'durataMedia') {
                    html += value;
                } else {
                    html += '€' + value.toLocaleString();
                }
                
                html += '</div>';
                html += '</div>';
            }
        });

        html += '</div>';

        // Messaggio finale
        html += '<div style="background: ' + style.bg + '; color: ' + style.text + '; padding: 12px; border-radius: 6px; border-left: 3px solid ' + style.border + ';">';
        html += '<strong>⚠️ Valutazione:</strong><br>' + risultato.messaggio;
        html += '</div>';

        html += '</div>';

        return html;
    }

    // ========================================
    // INTEGRAZIONE CON GENERA RISULTATI
    // ========================================

    const originalGeneraRisultati = window.generaRisultati;

    window.generaRisultati = async function() {
        await originalGeneraRisultati.call(this);

        setTimeout(() => {
            const userData = appState.user.anagrafica;
            const answers = appState.answers;
            const polizze = appState.user.polizze || {};

            const scenariRisultati = simulaScenari(userData, answers, polizze);

            appState.results.scenariStress = scenariRisultati;

            const container = document.getElementById('risultatiContent');
            const scenariHTML = renderScenariStress(scenariRisultati);
            
            container.insertAdjacentHTML('beforeend', scenariHTML);

            console.log('✅ Simulazione Scenari Stress completata');

        }, 2000);
    };

    console.log('✅ Simulazione Scenari Stress: OPERATIVO');
    console.log('  ✓ 6 scenari simulati');
    console.log('  ✓ Morte, Invalidità, Infortunio, Malattia, LTC, Crisi Economica');
    console.log('  ✓ Calcolo scoperture con gravità critica/alta/media/coperta');

})();
</script>
<script>
/* === SUGGERIMENTI INTELLIGENTI PRIORITIZZATI V2.0 === */
(function() {
    'use strict';

    console.log('%c💡 SUGGERIMENTI INTELLIGENTI V2.0 - ATTIVO', 'color: #059669; font-weight: bold');

    // ========================================
    // MOTORE SUGGERIMENTI
    // ========================================

    function generaSuggerimentiPrioritizzati(userData, answers, normotipo, semaforo, gaps, scenari, polizze) {
        const suggerimenti = [];

        const eta = userData.age || 40;
        const reddito = userData.redditoAnnuo || 0;
        const numeroFigli = userData.numeroFigli || 0;
        const statoFamiliare = userData.statoFamiliare || '';
        const tipoLavoratore = userData.tipoLavoratore || '';

        const haFamiglia = !statoFamiliare.includes('single') && 
                          !statoFamiliare.includes('vedovo_senza_figli') && 
                          statoFamiliare !== 'religioso';

        // ========================================
        // SUGGERIMENTO 1: TCM/VITA URGENTE
        // ========================================

        if (haFamiglia && numeroFigli > 0 && !polizze.tcm && !polizze.vita) {
            const priorita = 100;
            const scoperturaAnno = scenari.morte?.scoperturaAnnua || 0;

            suggerimenti.push({
                id: 'tcm_urgente',
                tipo: 'protezione',
                prodotto: 'TCM (Temporanea Caso Morte)',
                priorita: priorita,
                urgenza: 'CRITICA',
                titolo: '🚨 URGENTE: Protezione Famiglia Assente',
                descrizione: `Hai ${numeroFigli} ${numeroFigli === 1 ? 'figlio' : 'figli'} ma NESSUNA copertura caso morte. In caso di decesso, la tua famiglia perderebbe €${scoperturaAnno.toLocaleString()}/anno per 10 anni.`,
                azione: 'Sottoscrivere IMMEDIATAMENTE una TCM',
                capitaleConsigliato: Math.round(scoperturaAnno * 10),
                costoStimato: Math.round((scoperturaAnno * 10) * 0.003), // 0.3% capitale annuo
                benefici: [
                    `Protezione famiglia per €${Math.round(scoperturaAnno * 10).toLocaleString()}`,
                    'Detraibilità fiscale 19% (max €530/anno)',
                    'Serenità per i tuoi cari',
                    'Premi accessibili (età ' + eta + ' anni)'
                ],
                rischi: [
                    '⚠️ Famiglia economicamente esposta',
                    '⚠️ Impossibilità sostenere spese correnti',
                    '⚠️ Necessità vendita patrimonio in emergenza'
                ]
            });
        }

        // ========================================
        // SUGGERIMENTO 2: INFORTUNI
        // ========================================

        if (!polizze.infortuni) {
            let priorita = 70;
            const attivitaRischiose = Math.max(answers.B5 || 3, answers.B8 || 3);
            
            if (attivitaRischiose >= 4) priorita = 95;
            if (tipoLavoratore === 'autonomo' || tipoLavoratore === 'imprenditore') priorita += 10;

            const scoperturaInfortunio = scenari.infortunio?.scoperturaLorda || 0;

            suggerimenti.push({
                id: 'infortuni',
                tipo: 'protezione',
                prodotto: 'Polizza Infortuni',
                priorita: priorita,
                urgenza: priorita >= 90 ? 'ALTA' : 'MEDIA',
                titolo: attivitaRischiose >= 4 ? '⚠️ ALTA PRIORITÀ: Attività ad Alto Rischio' : '💼 Protezione Infortuni Consigliata',
                descrizione: attivitaRischiose >= 4 ?
                    `Sport/lavoro ad alto rischio senza copertura. Scopertura stimata: €${scoperturaInfortunio.toLocaleString()} per 6 mesi stop.` :
                    `Protezione essenziale per tutti. Scopertura stimata: €${scoperturaInfortunio.toLocaleString()}.`,
                azione: 'Sottoscrivere polizza infortuni',
                capitaleConsigliato: Math.round(reddito * 3),
                costoStimato: attivitaRischiose >= 4 ? Math.round(reddito * 0.008) : Math.round(reddito * 0.004), // 0.4-0.8% reddito
                benefici: [
                    'Invalidità permanente coperta',
                    'Diaria ricovero/convalescenza',
                    'Copertura 24h (lavoro, casa, sport)',
                    'Detraibilità fiscale 19%'
                ],
                rischi: [
                    '⚠️ Stop reddito in caso infortunio',
                    '⚠️ Spese mediche straordinarie',
                    '⚠️ Impossibilità mantenere tenore vita'
                ]
            });
        }

        // ========================================
        // SUGGERIMENTO 3: SANITARIA
        // ========================================

        if (!polizze.sanitaria) {
            let priorita = 60;
            
            if (eta > 50) priorita = 85;
            if ((answers.A4 || 3) <= 2) priorita += 15; // SSN insoddisfacente

            const scoperturaMalattia = scenari.malattia?.scoperturaLorda || 30000;

            suggerimenti.push({
                id: 'sanitaria',
                tipo: 'salute',
                prodotto: 'Polizza Sanitaria Integrativa',
                priorita: priorita,
                urgenza: priorita >= 80 ? 'ALTA' : 'MEDIA',
                titolo: eta > 50 ? '⚕️ ALTA PRIORITÀ: Età Critica per Salute' : '🏥 Integrazione SSN Consigliata',
                descrizione: eta > 50 ?
                    `Età ${eta} anni: rischi salute aumentano. Scopertura stimata malattia grave: €${scoperturaMalattia.toLocaleString()}.` :
                    `Tempi SSN lunghi, copertura limitata. Scopertura stimata: €${scoperturaMalattia.toLocaleString()}.`,
                azione: 'Sottoscrivere sanitaria integrativa',
                massimaleConsigliato: eta > 50 ? 100000 : 50000,
                costoStimato: eta > 50 ? Math.round(reddito * 0.025) : Math.round(reddito * 0.015), // 1.5-2.5% reddito
                benefici: [
                    'Visite specialistiche rapide',
                    'Ricoveri in strutture convenzionate',
                    'Pacchetto prevenzione incluso',
                    'Grande intervento chirurgico coperto',
                    'Detraibilità fiscale 19%'
                ],
                rischi: [
                    '⚠️ Tempi attesa SSN molto lunghi',
                    '⚠️ Spese out-of-pocket elevate',
                    '⚠️ Impossibilità cure tempestive'
                ]
            });
        }

        // ========================================
        // SUGGERIMENTO 4: LTC
        // ========================================

        if (!polizze.ltc && eta >= 40 && eta <= 70) {
            let priorita = 50;
            
            if (eta >= 55 && eta <= 65) priorita = 75; // Età ottimale
            if (eta > 65) priorita = 65; // Premi alti

            const scoperturaLTCAnno = scenari.non_autosufficienza?.scoperturaAnnua || 30000;

            suggerimenti.push({
                id: 'ltc',
                tipo: 'previdenza',
                prodotto: 'LTC (Long Term Care)',
                priorita: priorita,
                urgenza: eta >= 55 && eta <= 65 ? 'MEDIA-ALTA' : 'MEDIA',
                titolo: eta >= 55 && eta <= 65 ? '♿ ETÀ IDEALE: LTC Ora Conveniente' : '🛏️ Protezione Non Autosufficienza',
                descrizione: eta >= 55 && eta <= 65 ?
                    `Età ${eta}: momento ottimale per LTC. Premi ancora contenuti. Scopertura stimata: €${scoperturaLTCAnno.toLocaleString()}/anno.` :
                    `Rischio non autosufficienza aumenta con età. Scopertura: €${scoperturaLTCAnno.toLocaleString()}/anno.`,
                azione: 'Sottoscrivere LTC',
                renditaConsigliata: 1500,
                costoStimato: eta <= 50 ? Math.round(reddito * 0.008) : 
                             eta <= 60 ? Math.round(reddito * 0.015) : 
                             Math.round(reddito * 0.025), // Premi aumentano con età
                benefici: [
                    'Rendita mensile €1.500-2.500',
                    'Copertura assistenza domiciliare/RSA',
                    'Tutela patrimonio famiglia',
                    'Premi detraibili 19%',
                    eta >= 55 && eta <= 65 ? '✅ ETÀ OTTIMALE (premi convenienti)' : ''
                ],
                rischi: [
                    '⚠️ Costo assistenza €2.000-3.000/mese',
                    '⚠️ Erosione rapida risparmi',
                    '⚠️ Peso economico su famiglia'
                ]
            });
        }

        // ========================================
        // SUGGERIMENTO 5: PREVIDENZA COMPLEMENTARE
        // ========================================

        const anniPensione = Math.max(0, 67 - eta);
        const haPrevidenza = polizze.investimenti?.contributo > 0;

        if (!haPrevidenza && anniPensione > 0) {
            let priorita = 60;
            
            if (anniPensione <= 15) priorita = 95;
            else if (anniPensione <= 25) priorita = 80;

            const gapPensioneAnno = scenari ? (userData.redditoAnnuo * 0.80 - userData.redditoAnnuo * 0.55) : userData.redditoAnnuo * 0.25;

            suggerimenti.push({
                id: 'previdenza',
                tipo: 'previdenza',
                prodotto: 'Fondo Pensione Complementare',
                priorita: priorita,
                urgenza: anniPensione <= 15 ? 'CRITICA' : anniPensione <= 25 ? 'ALTA' : 'MEDIA',
                titolo: anniPensione <= 15 ? 
                    `🚨 URGENTE: Pensione tra ${anniPensione} anni` : 
                    `🏦 Previdenza: Prima Inizi, Meglio È`,
                descrizione: anniPensione <= 15 ?
                    `CRITICO: Solo ${anniPensione} anni a pensione senza integrazione. Gap stimato: €${gapPensioneAnno.toLocaleString()}/anno.` :
                    `Hai ${anniPensione} anni: interesse composto gioca a tuo favore. Gap pensione: €${gapPensioneAnno.toLocaleString()}/anno.`,
                azione: 'Aprire fondo pensione complementare',
                contributoConsigliato: Math.round(reddito * 0.10), // 10% reddito
                costoStimato: 0, // Netto: deduzione fiscale compensa
                benefici: [
                    'Deduzione fiscale TOTALE contributi (max €5.164/anno)',
                    'Interesse composto a lungo termine',
                    'Integrazione gap pensionistico',
                    'Tassazione agevolata rendite (15% → 9%)',
                    anniPensione > 20 ? `✅ HAI ${anniPensione} ANNI: massimo vantaggio` : ''
                ],
                rischi: [
                    '⚠️ Pensione INPS solo 50-60% ultimo reddito',
                    `⚠️ Perdita potenziale €${gapPensioneAnno.toLocaleString()}/anno`,
                    '⚠️ Tenore vita significativamente ridotto'
                ]
            });
        }

        // ========================================
        // SUGGERIMENTO 6: FONDO EMERGENZA
        // ========================================

        const fondoEmergenza = gaps.risparmio?.fondoReale || 0;
        const fondoConsigliato = gaps.risparmio?.fondoConsigliato || reddito * 0.35;

        if (fondoEmergenza < fondoConsigliato * 0.5) {
            let priorita = 85;

            suggerimenti.push({
                id: 'fondo_emergenza',
                tipo: 'risparmio',
                prodotto: 'Fondo di Emergenza',
                priorita: priorita,
                urgenza: 'ALTA',
                titolo: '💰 PRIORITÀ ASSOLUTA: Fondo Emergenza Insufficiente',
                descrizione: `Fondo attuale €${fondoEmergenza.toLocaleString()}, consigliato €${fondoConsigliato.toLocaleString()} (6 mesi spese). Gap: €${(fondoConsigliato - fondoEmergenza).toLocaleString()}.`,
                azione: 'Accumulare fondo emergenza',
                obiettivoFondo: fondoConsigliato,
                contributoMensile: Math.round((fondoConsigliato - fondoEmergenza) / 12),
                benefici: [
                    'Cuscinetto per imprevisti',
                    'Evita debiti in emergenze',
                    'Serenità finanziaria',
                    'Liquidità immediata disponibile'
                ],
                rischi: [
                    '⚠️ CRITICO: Nessuna protezione imprevisti',
                    '⚠️ Rischio indebitamento',
                    '⚠️ Impossibilità gestire emergenze'
                ]
            });
        }

        // ========================================
        // SUGGERIMENTO 7: INVESTIMENTI
        // ========================================

        const capacitaRisparmio = (answers.B2 || 3) / 5;
        const propensioneInvestimenti = answers.C7 || 3;

        if (capacitaRisparmio >= 0.6 && propensioneInvestimenti >= 4 && reddito > 30000) {
            const priorita = 55;

            suggerimenti.push({
                id: 'investimenti',
                tipo: 'investimenti',
                prodotto: 'Piano di Accumulo (PAC)',
                priorita: priorita,
                urgenza: 'MEDIA',
                titolo: '📈 Opportunità: Investi Risparmio Regolare',
                descrizione: `Alta capacità risparmio (${Math.round(capacitaRisparmio * 100)}%) e propensione investimenti. PAC permette crescita patrimonio graduale.`,
                azione: 'Avviare Piano Accumulo Capitale',
                contributoConsigliato: Math.round(reddito * capacitaRisparmio * 0.5),
                costoStimato: 0,
                benefici: [
                    'Crescita patrimonio nel tempo',
                    'Media costo acquisto (DCA)',
                    'Flessibilità importi/sospensioni',
                    'Diversificazione automatica'
                ],
                rischi: [
                    'Volatilità mercati (orizzonte lungo)',
                    'Nessuna garanzia capitale'
                ]
            });
        }

        // ========================================
        // SUGGERIMENTO 8: ABITAZIONE (zone sismiche)
        // ========================================

        const provincia = userData.provincia;
        const ZONE_SISMICHE = ['AQ', 'PG', 'RI', 'FR', 'IS', 'CB', 'BN', 'AV', 'SA', 'PZ', 'MT', 'CS', 'RC', 'ME', 'CT', 'SR', 'RG', 'CZ'];

        if (ZONE_SISMICHE.includes(provincia) && !polizze.abitazione) {
            const priorita = 90;

            suggerimenti.push({
                id: 'abitazione_sismica',
                tipo: 'protezione',
                prodotto: 'Polizza Abitazione con Sisma',
                priorita: priorita,
                urgenza: 'ALTA',
                titolo: '🏠 ALTA PRIORITÀ: Zona Sismica Alto Rischio',
                descrizione: `Provincia ${provincia}: ZONA SISMICA ALTA. Abitazione non assicurata contro terremoti/calamità naturali.`,
                azione: 'Sottoscrivere polizza abitazione con eventi sismici',
                capitaleConsigliato: 250000,
                costoStimato: Math.round(250000 * 0.005), // 0.5% valore
                benefici: [
                    'Ricostruzione totale in caso sisma',
                    'Copertura contenuti',
                    'Responsabilità civile inclusa',
                    'Assistenza emergenza 24/7'
                ],
                rischi: [
                    '⚠️ CRITICO: Zona alta sismicità',
                    '⚠️ Perdita totale patrimonio immobiliare',
                    '⚠️ Costi ricostruzione insostenibili'
                ]
            });
        }

        // ========================================
        // SUGGERIMENTO 9: REVISIONE COPERTURE
        // ========================================

        const anniDallaUltimaRevisione = 2; // Placeholder
        if (Object.keys(polizze).length > 0 && anniDallaUltimaRevisione >= 2) {
            const priorita = 40;

            suggerimenti.push({
                id: 'revisione_coperture',
                tipo: 'revisione',
                prodotto: 'Check-Up Polizze Esistenti',
                priorita: priorita,
                urgenza: 'BASSA',
                titolo: '🔍 Consigliato: Revisione Coperture',
                descrizione: `Hai ${Object.keys(polizze).length} polizze attive. Verifica capitali e coperture siano ancora adeguati.`,
                azione: 'Richiedere revisione con consulente',
                benefici: [
                    'Verifica adeguatezza capitali',
                    'Ottimizzazione premi',
                    'Eliminazione sovrapposizioni',
                    'Aggiornamento beneficiari'
                ]
            });
        }

        // ========================================
        // SUGGERIMENTO 10: EDUCAZIONE FINANZIARIA
        // ========================================

        const conoscenzaStrumenti = answers.C5 || 3;
        if (conoscenzaStrumenti <= 2) {
            const priorita = 30;

            suggerimenti.push({
                id: 'educazione',
                tipo: 'formazione',
                prodotto: 'Educazione Finanziaria',
                priorita: priorita,
                urgenza: 'BASSA',
                titolo: '📚 Migliora Conoscenza Strumenti Finanziari',
                descrizione: 'Bassa conoscenza strumenti finanziari. Formazione aiuta a prendere decisioni consapevoli.',
                azione: 'Partecipare a webinar/corsi',
                benefici: [
                    'Decisioni più consapevoli',
                    'Comprensione rischi/opportunità',
                    'Ottimizzazione patrimonio',
                    'Autonomia finanziaria'
                ]
            });
        }

        // ========================================
        // ORDINAMENTO PER PRIORITÀ
        // ========================================

        suggerimenti.sort((a, b) => b.priorita - a.priorita);

        return suggerimenti;
    }

    // ========================================
    // RENDERING SUGGERIMENTI
    // ========================================

    function renderSuggerimentiPrioritizzati(suggerimenti) {
        let html = '<div class="card" style="background: linear-gradient(135deg, #DBEAFE 0%, #BFDBFE 100%); border-left: 4px solid #3B82F6;">';
        html += '<h3 class="card-title" style="color: #1E40AF;">💡 Suggerimenti Intelligenti Prioritizzati</h3>';
        html += '<p style="color: #1E3A8A; margin-bottom: 20px;">Piano d\'azione personalizzato basato sulla tua situazione</p>';

        suggerimenti.forEach((sugg, index) => {
            html += renderSingoloSuggerimento(sugg, index + 1);
        });

        html += '</div>';

        return html;
    }

    function renderSingoloSuggerimento(sugg, numero) {
        const urgenzaColors = {
            'CRITICA': { bg: '#FEE2E2', border: '#DC2626', text: '#991B1B' },
            'ALTA': { bg: '#FED7AA', border: '#EA580C', text: '#9A3412' },
            'MEDIA-ALTA': { bg: '#FEF3C7', border: '#F59E0B', text: '#92400E' },
            'MEDIA': { bg: '#FEF3C7', border: '#F59E0B', text: '#92400E' },
            'BASSA': { bg: '#E0E7FF', border: '#6366F1', text: '#3730A3' }
        };

        const style = urgenzaColors[sugg.urgenza] || urgenzaColors['MEDIA'];

        let html = '<div style="background: white; padding: 25px; margin-bottom: 20px; border-radius: 8px; border-left: 4px solid ' + style.border + ';">';
        
        // Header
        html += '<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">';
        html += '<div style="flex: 1;">';
        html += '<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">';
        html += '<span style="background: var(--generali-blue); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px;">' + numero + '</span>';
        html += '<h4 style="color: var(--generali-blue); margin: 0; flex: 1;">' + sugg.titolo + '</h4>';
        html += '</div>';
        html += '<div style="font-size: 13px; color: var(--gray-600); margin-left: 42px;">📦 ' + sugg.prodotto + '</div>';
        html += '</div>';
        html += '<div style="text-align: right;">';
        html += '<div style="background: ' + style.bg + '; color: ' + style.text + '; padding: 6px 12px; border-radius: 20px; font-weight: 600; font-size: 12px; margin-bottom: 8px;">Urgenza: ' + sugg.urgenza + '</div>';
        html += '<div style="font-size: 24px; font-weight: bold; color: var(--generali-blue);">Priorità: ' + sugg.priorita + '</div>';
        html += '</div>';
        html += '</div>';

        // Descrizione
        html += '<p style="color: var(--gray-700); margin-bottom: 15px; line-height: 1.6;">' + sugg.descrizione + '</p>';

        // Azione
        html += '<div style="background: #DBEAFE; padding: 12px 15px; border-radius: 6px; margin-bottom: 15px; border-left: 3px solid #3B82F6;">';
        html += '<strong style="color: #1E40AF;">🎯 Azione Consigliata:</strong> ' + sugg.azione;
        html += '</div>';

        // Dati economici
        if (sugg.capitaleConsigliato || sugg.massimaleConsigliato || sugg.renditaConsigliata || sugg.contributoConsigliato || sugg.obiettivoFondo) {
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 15px;">';
            
            if (sugg.capitaleConsigliato) {
                html += '<div style="background: var(--gray-50); padding: 12px; border-radius: 6px;">';
                html += '<div style="font-size: 11px; color: var(--gray-600); margin-bottom: 4px;">Capitale Consigliato</div>';
                html += '<div style="font-size: 20px; font-weight: bold; color: var(--green);">€' + sugg.capitaleConsigliato.toLocaleString() + '</div>';
                html += '</div>';
            }
            
            if (sugg.massimaleConsigliato) {
                html += '<div style="background: var(--gray-50); padding: 12px; border-radius: 6px;">';
                html += '<div style="font-size: 11px; color: var(--gray-600); margin-bottom: 4px;">Massimale Consigliato</div>';
                html += '<div style="font-size: 20px; font-weight: bold; color: var(--green);">€' + sugg.massimaleConsigliato.toLocaleString() + '</div>';
                html += '</div>';
            }

            if (sugg.renditaConsigliata) {
                html += '<div style="background: var(--gray-50); padding: 12px; border-radius: 6px;">';
                html += '<div style="font-size: 11px; color: var(--gray-600); margin-bottom: 4px;">Rendita Mensile</div>';
                html += '<div style="font-size: 20px; font-weight: bold; color: var(--green);">€' + sugg.renditaConsigliata.toLocaleString() + '</div>';
                html += '</div>';
            }

            if (sugg.contributoConsigliato) {
                html += '<div style="background: var(--gray-50); padding: 12px; border-radius: 6px;">';
                html += '<div style="font-size: 11px; color: var(--gray-600); margin-bottom: 4px;">Contributo Annuo</div>';
                html += '<div style="font-size: 20px; font-weight: bold; color: var(--generali-blue);">€' + sugg.contributoConsigliato.toLocaleString() + '</div>';
                html += '</div>';
            }

            if (sugg.obiettivoFondo) {
                html += '<div style="background: var(--gray-50); padding: 12px; border-radius: 6px;">';
                html += '<div style="font-size: 11px; color: var(--gray-600); margin-bottom: 4px;">Obiettivo Fondo</div>';
                html += '<div style="font-size: 20px; font-weight: bold; color: var(--green);">€' + sugg.obiettivoFondo.toLocaleString() + '</div>';
                html += '</div>';
            }

            if (sugg.contributoMensile) {
                html += '<div style="background: var(--gray-50); padding: 12px; border-radius: 6px;">';
                html += '<div style="font-size: 11px; color: var(--gray-600); margin-bottom: 4px;">Versamento Mensile</div>';
                html += '<div style="font-size: 20px; font-weight: bold; color: var(--generali-blue);">€' + sugg.contributoMensile.toLocaleString() + '</div>';
                html += '</div>';
            }

            if (sugg.costoStimato !== undefined) {
                html += '<div style="background: var(--gray-50); padding: 12px; border-radius: 6px;">';
                html += '<div style="font-size: 11px; color: var(--gray-600); margin-bottom: 4px;">Costo Annuo Stimato</div>';
                html += '<div style="font-size: 20px; font-weight: bold; color: ' + (sugg.costoStimato === 0 ? 'var(--green)' : 'var(--yellow)') + ';">€' + sugg.costoStimato.toLocaleString() + '</div>';
                html += '</div>';
            }

            html += '</div>';
        }

        // Benefici
        if (sugg.benefici && sugg.benefici.length > 0) {
            html += '<div style="margin-bottom: 15px;">';
            html += '<strong style="color: var(--green); display: block; margin-bottom: 8px;">✅ Benefici:</strong>';
            html += '<ul style="margin: 0; padding-left: 20px; color: var(--gray-700);">';
            sugg.benefici.forEach(b => {
                if (b) html += '<li style="margin-bottom: 5px;">' + b + '</li>';
            });
            html += '</ul>';
            html += '</div>';
        }

        // Rischi
        if (sugg.rischi && sugg.rischi.length > 0) {
            html += '<div style="background: #FEE2E2; padding: 12px 15px; border-radius: 6px; border-left: 3px solid #DC2626;">';
            html += '<strong style="color: #991B1B; display: block; margin-bottom: 8px;">⚠️ Rischi Assenza Copertura:</strong>';
            html += '<ul style="margin: 0; padding-left: 20px; color: #7F1D1D;">';
            sugg.rischi.forEach(r => {
                html += '<li style="margin-bottom: 5px;">' + r + '</li>';
            });
            html += '</ul>';
            html += '</div>';
        }

        html += '</div>';

        return html;
    }

    // ========================================
    // INTEGRAZIONE CON GENERA RISULTATI
    // ========================================

    const originalGeneraRisultati = window.generaRisultati;

    window.generaRisultati = async function() {
        await originalGeneraRisultati.call(this);

        setTimeout(() => {
            const userData = appState.user.anagrafica;
            const answers = appState.answers;
            const normotipo = appState.results.normotipo;
            const semaforo = appState.results.semaforo;
            const gaps = appState.results.behavioralGaps || {};
            const scenari = appState.results.scenariStress || {};
            const polizze = appState.user.polizze || {};

            const suggerimenti = generaSuggerimentiPrioritizzati(userData, answers, normotipo, semaforo, gaps, scenari, polizze);

            appState.results.suggerimenti = suggerimenti;

            const container = document.getElementById('risultatiContent');
            const suggerimentiHTML = renderSuggerimentiPrioritizzati(suggerimenti);
            
            container.insertAdjacentHTML('beforeend', suggerimentiHTML);

            console.log(`✅ Generati ${suggerimenti.length} suggerimenti prioritizzati`);

        }, 2500);
    };

    console.log('✅ Suggerimenti Intelligenti: OPERATIVO');
    console.log('  ✓ 10 tipologie suggerimenti');
    console.log('  ✓ Scoring automatico priorità');
    console.log('  ✓ Calcolo costi/benefici/rischi');

})();
</script>
<script>
/* === NORMOTIPI COMPORTAMENTALI ESTESI V2.0 === */
(function() {
    'use strict';

    console.log('%c🧬 NORMOTIPI COMPORTAMENTALI ESTESI V2.0 - ATTIVO', 'color: #8B5CF6; font-weight: bold');

    // ========================================
    // DEFINIZIONE PROFILI ESTESI
    // ========================================

    const NORMOTIPI_ESTESI = {
        giovane_senza_figli_ambizioso: {
            nome: 'Giovane Ambizioso',
            descrizione: '25-35 anni, single o coppia senza figli, alta crescita carriera',
            criteri: (u, a) => u.age >= 25 && u.age <= 35 && u.numeroFigli === 0 && u.redditoAnnuo > 35000 && (a.C2 || 3) >= 4,
            priorita: { vita: 40, tcm: 35, infortuni: 80, sanitaria: 85, ltc: 30, previdenza: 95, investimenti: 90 },
            caratteristiche: [
                'Focus su crescita patrimonio',
                'Alta propensione rischio',
                'Mobilità lavorativa frequente',
                'Investimenti prioritari su protezione'
            ],
            prodottiConsigliati: ['Previdenza complementare', 'PAC azionari', 'Sanitaria top', 'Infortuni sport'],
            warnings: ['Non sottovalutare protezione infortuni', 'Inizia previdenza ORA (interesse composto)']
        },

        famiglia_giovane_monoreddito: {
            nome: 'Famiglia Giovane Monoreddito',
            descrizione: 'Coppia con figli piccoli, un solo reddito',
            criteri: (u, a) => u.numeroFigli > 0 && u.age <= 45 && u.redditoAnnuo < 40000,
            priorita: { vita: 100, tcm: 100, infortuni: 90, sanitaria: 80, ltc: 50, previdenza: 70, investimenti: 40 },
            caratteristiche: [
                'Protezione famiglia ASSOLUTA priorità',
                'Budget limitato: ottimizzare coperture',
                'Stop reddito = crisi immediata',
                'Figli piccoli = orizzonte lungo'
            ],
            prodottiConsigliati: ['TCM alto capitale', 'Infortuni con diaria', 'Fondo emergenza', 'Piano risparmio figli'],
            warnings: ['CRITICO: TCM non negoziabile', 'Fondo emergenza minimo 6 mesi', 'Evitare investimenti rischiosi']
        },

        famiglia_doppio_reddito_benestante: {
            nome: 'Famiglia Benestante Doppio Reddito',
            descrizione: 'Coppia con figli, entrambi lavorano, reddito alto',
            criteri: (u, a) => u.numeroFigli > 0 && u.redditoAnnuo > 60000 && u.statoFamiliare.includes('sposati'),
            priorita: { vita: 85, tcm: 80, infortuni: 85, sanitaria: 90, ltc: 75, previdenza: 85, investimenti: 80 },
            caratteristiche: [
                'Protezione completa accessibile',
                'Ottimizzazione fiscale importante',
                'Educazione figli prioritaria',
                'Pianificazione successoria rilevante'
            ],
            prodottiConsigliati: ['TCM doppia copertura', 'Sanitaria famiglia', 'LTC entrambi', 'Investimenti diversificati', 'Piano educazione figli'],
            warnings: ['Non trascurare LTC (età critica)', 'Massimizzare deduzioni fiscali', 'Testamento biologico']
        },

        autonomo_instabile: {
            nome: 'Autonomo Reddito Variabile',
            descrizione: 'Libero professionista/autonomo con reddito fluttuante',
            criteri: (u, a) => (u.tipoLavoratore === 'autonomo' || u.tipoLavoratore === 'imprenditore') && (a.B1 || 3) <= 2,
            priorita: { vita: 85, tcm: 80, infortuni: 100, sanitaria: 90, ltc: 70, previdenza: 100, investimenti: 65 },
            caratteristiche: [
                'ZERO tutele INPS',
                'Reddito variabile = imprevedibilità',
                'Infortuni = perdita totale reddito',
                'Previdenza complementare essenziale'
            ],
            prodottiConsigliati: ['Infortuni con diaria alta', 'Sanitaria completa', 'Fondo pensione', 'Fondo liquidità 12 mesi'],
            warnings: ['CRITICO: Infortuni priorità assoluta', 'Fondo emergenza 12 mesi minimo', 'Previdenza non rimandabile']
        },

        senior_pre_pensione: {
            nome: 'Senior Pre-Pensione',
            descrizione: '55-67 anni, vicino a pensionamento',
            criteri: (u, a) => u.age >= 55 && u.age < 67,
            priorita: { vita: 70, tcm: 60, infortuni: 65, sanitaria: 100, ltc: 95, previdenza: 90, investimenti: 60 },
            caratteristiche: [
                'Salute priorità assoluta',
                'LTC ultimo treno (premi ancora sostenibili)',
                'Consolidamento patrimonio',
                'Riduzione rischio investimenti'
            ],
            prodottiConsigliati: ['Sanitaria top gamma', 'LTC URGENTE', 'Completare previdenza', 'Investimenti prudenti'],
            warnings: ['LTC: ULTIMA POSSIBILITÀ età 55-65', 'Sanitaria: costi aumentano rapidamente', 'No investimenti rischiosi']
        },

        pensionato_attivo: {
            nome: 'Pensionato Attivo',
            descrizione: 'Oltre 67 anni, pensionato, ancora autonomo',
            criteri: (u, a) => u.age >= 67 || u.tipoLavoratore === 'pensionato',
            priorita: { vita: 60, tcm: 50, infortuni: 60, sanitaria: 100, ltc: 100, previdenza: 40, investimenti: 50 },
            caratteristiche: [
                'Salute e assistenza priorità',
                'Protezione patrimonio per eredi',
                'Rischio non autosufficienza alto',
                'Investimenti conservativi'
            ],
            prodottiConsigliati: ['Sanitaria senior', 'LTC (se sottoscrivibile)', 'Polizze esistenti: verifica adeguatezza'],
            warnings: ['LTC spesso non più sottoscrivibile', 'Massimali sanitaria: verificare adeguatezza', 'Beneficiari: aggiornare']
        },

        single_carrierista: {
            nome: 'Single Carrierista',
            descrizione: 'Single, reddito alto, focus carriera',
            criteri: (u, a) => u.statoFamiliare === 'single' && u.redditoAnnuo > 50000 && u.age >= 30 && u.age <= 50,
            priorita: { vita: 30, tcm: 20, infortuni: 85, sanitaria: 90, ltc: 70, previdenza: 95, investimenti: 95 },
            caratteristiche: [
                'Nessuna famiglia a carico',
                'Vita/TCM non prioritarie',
                'Focus su salute e patrimonio personale',
                'Alta capacità risparmio'
            ],
            prodottiConsigliati: ['Sanitaria premium', 'LTC precoce', 'Previdenza massimale', 'Investimenti aggressivi'],
            warnings: ['Non trascurare LTC (nessuno ti assisterà)', 'Massimizzare previdenza complementare']
        },

        genitore_single: {
            nome: 'Genitore Single',
            descrizione: 'Single con figli a carico',
            criteri: (u, a) => u.statoFamiliare === 'genitore_single' || (u.statoFamiliare.includes('separato') && u.numeroFigli > 0),
            priorita: { vita: 100, tcm: 100, infortuni: 100, sanitaria: 85, ltc: 60, previdenza: 75, investimenti: 50 },
            caratteristiche: [
                'SITUAZIONE AD ALTISSIMO RISCHIO',
                'Unico reddito per famiglia',
                'Stop lavoro = crisi immediata',
                'Protezione massima essenziale'
            ],
            prodottiConsigliati: ['TCM capitale alto', 'Infortuni diaria massima', 'Fondo emergenza prioritario', 'Tutore figli designato'],
            warnings: ['CRITICO: Protezione completa non negoziabile', 'Fondo emergenza 12 mesi obbligatorio', 'Testamento URGENTE']
        },

        studente_universitario: {
            nome: 'Studente Universitario',
            descrizione: 'Under 30, studente, reddito basso/zero',
            criteri: (u, a) => u.professione === 'Studente' && u.age <= 30,
            priorita: { vita: 20, tcm: 20, infortuni: 70, sanitaria: 80, ltc: 10, previdenza: 60, investimenti: 40 },
            caratteristiche: [
                'Budget molto limitato',
                'Protezione base sufficiente',
                'Focus su salute (età critica sport/incidenti)',
                'Pensare già a lungo termine'
            ],
            prodottiConsigliati: ['Sanitaria giovani', 'Infortuni economica', 'Piccolo PAC (anche €50/mese)'],
            warnings: ['Infortuni: età rischio incidenti stradali', 'Inizia previdenza appena possibile (anche piccole somme)']
        },

        lavoratore_rischio: {
            nome: 'Lavoratore Alto Rischio',
            descrizione: 'Lavoro/sport con rischi fisici elevati',
            criteri: (u, a) => (a.B5 || 3) >= 4 || (a.B8 || 3) >= 4,
            priorita: { vita: 80, tcm: 75, infortuni: 100, sanitaria: 95, ltc: 70, previdenza: 80, investimenti: 60 },
            caratteristiche: [
                'Rischio infortuni/invalidità ALTO',
                'Infortuni NON NEGOZIABILE',
                'Capitali elevati necessari',
                'Diaria ricovero essenziale'
            ],
            prodottiConsigliati: ['Infortuni professionali', 'Invalidità permanente', 'Diaria ospedaliera', 'Sanitaria immediata'],
            warnings: ['CRITICO: Senza infortuni = rischio bancarotta', 'Capitali minimi: 5x reddito annuo', 'Diaria minima €100/giorno']
        },

        imprenditore_startup: {
            nome: 'Imprenditore Startup',
            descrizione: 'Imprenditore giovane, azienda nuova',
            criteri: (u, a) => (u.professione === 'Imprenditore' || u.professione === 'Titolare azienda') && u.age <= 45 && u.redditoAnnuo < 50000,
            priorita: { vita: 90, tcm: 85, infortuni: 95, sanitaria: 85, ltc: 50, previdenza: 95, investimenti: 70 },
            caratteristiche: [
                'Tutto sul business = rischio personale',
                'Assenza tutele dipendenti',
                'Stop attività = stop reddito',
                'Volatilità reddito elevata'
            ],
            prodottiConsigliati: ['Key man insurance', 'Infortuni', 'Fondo liquidità 24 mesi', 'Previdenza separata da business'],
            warnings: ['Mai mescolare patrimonio personale e aziendale', 'Protezione personale separata da business', 'Fondo emergenza doppio (12 mesi personale + 12 azienda)']
        },

        imprenditore_consolidato: {
            nome: 'Imprenditore Consolidato',
            descrizione: 'Imprenditore maturo, azienda stabile',
            criteri: (u, a) => (u.professione === 'Imprenditore' || u.professione === 'Titolare azienda') && u.redditoAnnuo > 80000,
            priorita: { vita: 85, tcm: 80, infortuni: 85, sanitaria: 90, ltc: 85, previdenza: 95, investimenti: 85 },
            caratteristiche: [
                'Protezione patrimonio importante',
                'Pianificazione successione aziendale',
                'Ottimizzazione fiscale rilevante',
                'Diversificazione investimenti'
            ],
            prodottiConsigliati: ['Polizze liquidità successione', 'LTC', 'Previdenza massimale', 'Investimenti diversificati'],
            warnings: ['Pianificazione successoria non rimandabile', 'Protezione continuità aziendale', 'Segregazione patrimoni']
        },

        medico_libero_professionista: {
            nome: 'Medico Libero Professionista',
            descrizione: 'Medico, odontoiatra con studio',
            criteri: (u, a) => u.professione === 'Medico' || u.professione === 'Odontoiatra',
            priorita: { vita: 80, tcm: 75, infortuni: 100, sanitaria: 85, ltc: 75, previdenza: 95, investimenti: 75 },
            caratteristiche: [
                'RC professionale obbligatoria',
                'Mani = strumento lavoro (infortuni critici)',
                'Reddito alto ma INPS limitata',
                'Previdenza ENPAM + complementare'
            ],
            prodottiConsigliati: ['Infortuni mani/professionale', 'RC professionale alta', 'Previdenza integrativa', 'Tutela studio'],
            warnings: ['Infortuni mani: capitale minimo 10x reddito', 'RC: massimali adeguati (€5M+)', 'Previdenza ENPAM insufficiente']
        },

        avvocato_commercialista: {
            nome: 'Avvocato/Commercialista',
            descrizione: 'Professionista ordinistico',
            criteri: (u, a) => u.professione === 'Avvocato' || u.professione === 'Commercialista' || u.professione === 'Notaio',
            priorita: { vita: 75, tcm: 70, infortuni: 85, sanitaria: 85, ltc: 70, previdenza: 95, investimenti: 80 },
            caratteristiche: [
                'RC professionale obbligatoria',
                'Cassa previdenziale integrazione necessaria',
                'Reddito medio-alto',
                'Rischi professionali specifici'
            ],
            prodottiConsigliati: ['RC professionale', 'Previdenza integrativa', 'Tutela legale', 'Cyber risk'],
            warnings: ['RC: verificare massimali adeguati attività', 'Cassa professionale spesso insufficiente', 'Cyber risk crescente']
        },

        casalinga_dipendente: {
            nome: 'Casalinga/o con Famiglia',
            descrizione: 'Dedito alla casa, dipende da partner',
            criteri: (u, a) => u.professione === 'Casalinga/o',
            priorita: { vita: 60, tcm: 50, infortuni: 75, sanitaria: 80, ltc: 70, previdenza: 40, investimenti: 30 },
            caratteristiche: [
                'Nessun reddito proprio',
                'Dipendenza economica totale',
                'Contributo familiare invisibile ma essenziale',
                'Protezione salute importante'
            ],
            prodottiConsigliati: ['Sanitaria base', 'Infortuni domestici', 'Assegno mantenimento coniuge'],
            warnings: ['Infortuni domestici sottovalutati', 'Protezione partner critica', 'Pensione: contributi volontari valutare']
        },

        religioso: {
            nome: 'Religioso/a',
            descrizione: 'Vita consacrata',
            criteri: (u, a) => u.professione === 'Religioso/a' || u.statoFamiliare === 'religioso',
            priorita: { vita: 20, tcm: 20, infortuni: 60, sanitaria: 80, ltc: 70, previdenza: 30, investimenti: 20 },
            caratteristiche: [
                'Comunità di riferimento',
                'Reddito assente/minimo',
                'Salute prioritaria',
                'Protezione comunitaria'
            ],
            prodottiConsigliati: ['Sanitaria comunitaria', 'LTC'],
            warnings: ['Verificare coperture comunità', 'Salute: fondamentale per servizio']
        },

        disoccupato_temporaneo: {
            nome: 'Disoccupato Temporaneo',
            descrizione: 'Tra due lavori, disoccupazione temporanea',
            criteri: (u, a) => u.professione === 'Disoccupato',
            priorita: { vita: 50, tcm: 40, infortuni: 70, sanitaria: 85, ltc: 40, previdenza: 50, investimenti: 30 },
            caratteristiche: [
                'Situazione transitoria',
                'Budget limitato',
                'Priorità salute (perdita copertura aziendale)',
                'Fondo emergenza critico'
            ],
            prodottiConsigliati: ['Sanitaria base temporanea', 'Fondo emergenza'],
            warnings: ['Mantenere almeno sanitaria base', 'Fondo emergenza: priorità assoluta', 'Riprendere coperture appena rioccupato']
        },

        coppia_giovane_senza_figli: {
            nome: 'Coppia Giovane DINK',
            descrizione: 'Double Income No Kids - doppio reddito senza figli',
            criteri: (u, a) => (u.statoFamiliare.includes('sposati_senza_figli') || u.statoFamiliare.includes('conviventi_senza_figli')) && u.age <= 40,
            priorita: { vita: 50, tcm: 45, infortuni: 80, sanitaria: 85, ltc: 50, previdenza: 90, investimenti: 90 },
            caratteristiche: [
                'Alta capacità risparmio',
                'Flessibilità finanziaria',
                'Orizzonte lungo investimenti',
                'Protezione reciproca moderata'
            ],
            prodottiConsigliati: ['Previdenza aggressiva', 'Investimenti growth', 'Sanitaria coppia', 'Infortuni'],
            warnings: ['Approfittare periodo DINK per massimizzare risparmio', 'Previdenza: momento ideale', 'Valutare figli futuri']
        },

        vedovo_anziano: {
            nome: 'Vedovo/a Senior',
            descrizione: 'Vedovo oltre 65 anni',
            criteri: (u, a) => (u.statoFamiliare.includes('vedovo')) && u.age >= 65,
            priorita: { vita: 40, tcm: 30, infortuni: 55, sanitaria: 100, ltc: 100, previdenza: 30, investimenti: 40 },
            caratteristiche: [
                'Solitudine = rischio assistenza',
                'Salute priorità assoluta',
                'Protezione patrimonio per eredi',
                'LTC critica'
            ],
            prodottiConsigliati: ['Sanitaria senior', 'LTC (se possibile)', 'Teleassistenza'],
            warnings: ['LTC: spesso non più sottoscrivibile', 'Rete supporto essenziale', 'Testamento aggiornato']
        }
    };

    // ========================================
    // MATCHING NORMOTIPO
    // ========================================

    function identificaNormotipoEsteso(userData, answers) {
        const matches = [];

        Object.entries(NORMOTIPI_ESTESI).forEach(([key, profilo]) => {
            try {
                if (profilo.criteri(userData, answers)) {
                    matches.push({
                        key: key,
                        profilo: profilo,
                        score: 100 // Tutti i match hanno stesso peso
                    });
                }
            } catch(e) {
                console.warn(`Errore valutazione normotipo ${key}:`, e);
            }
        });

        // Se nessun match, usa profilo generico
        if (matches.length === 0) {
            return {
                key: 'equilibrato',
                nome: 'Equilibrato',
                descrizione: 'Profilo standard, situazione bilanciata',
                priorita: { vita: 70, tcm: 65, infortuni: 75, sanitaria: 75, ltc: 65, previdenza: 75, investimenti: 70 },
                caratteristiche: ['Situazione standard', 'Approccio bilanciato'],
                prodottiConsigliati: ['Mix protezione/risparmio'],
                warnings: []
            };
        }

        // Ritorna il primo match (potrebbero esserci sovrapposizioni)
        const bestMatch = matches[0];
        
        return {
            key: bestMatch.key,
            ...bestMatch.profilo
        };
    }

    // ========================================
    // RENDERING NORMOTIPO ESTESO
    // ========================================

    function renderNormotipoEsteso(normotipoEsteso) {
        let html = '<div class="card" style="background: linear-gradient(135deg, #F0F9FF 0%, #E0F2FE 100%); border-left: 4px solid var(--generali-blue);">';
        html += '<h3 class="card-title" style="color: #0C4A6E;">🧬 Profilo Comportamentale Dettagliato</h3>';
        
        html += '<div style="background: white; padding: 25px; border-radius: 8px; margin-top: 15px;">';
        
        // Nome e descrizione
        html += '<div style="margin-bottom: 20px;">';
        html += '<h2 style="color: var(--generali-blue); margin: 0 0 10px 0; font-size: 28px;">' + normotipoEsteso.nome + '</h2>';
        html += '<p style="color: var(--gray-600); font-size: 16px; margin: 0;">' + normotipoEsteso.descrizione + '</p>';
        html += '</div>';

        // Caratteristiche
        if (normotipoEsteso.caratteristiche && normotipoEsteso.caratteristiche.length > 0) {
            html += '<div style="margin-bottom: 20px;">';
            html += '<h4 style="color: var(--generali-blue); margin-bottom: 12px;">📋 Caratteristiche Profilo</h4>';
            html += '<ul style="margin: 0; padding-left: 20px; color: var(--gray-700);">';
            normotipoEsteso.caratteristiche.forEach(c => {
                html += '<li style="margin-bottom: 8px; line-height: 1.5;">' + c + '</li>';
            });
            html += '</ul>';
            html += '</div>';
        }

        // Prodotti consigliati
        if (normotipoEsteso.prodottiConsigliati && normotipoEsteso.prodottiConsigliati.length > 0) {
            html += '<div style="margin-bottom: 20px;">';
            html += '<h4 style="color: var(--green); margin-bottom: 12px;">✅ Prodotti Consigliati per Questo Profilo</h4>';
            html += '<div style="display: flex; flex-wrap: wrap; gap: 10px;">';
            normotipoEsteso.prodottiConsigliati.forEach(p => {
                html += '<span style="background: #D1FAE5; color: #065F46; padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 14px;">' + p + '</span>';
            });
            html += '</div>';
            html += '</div>';
        }

        // Warnings
        if (normotipoEsteso.warnings && normotipoEsteso.warnings.length > 0) {
            html += '<div style="background: #FEF3C7; padding: 15px; border-radius: 8px; border-left: 4px solid #F59E0B;">';
            html += '<h4 style="color: #92400E; margin: 0 0 12px 0;">⚠️ Attenzioni Specifiche</h4>';
            html += '<ul style="margin: 0; padding-left: 20px; color: #78350F;">';
            normotipoEsteso.warnings.forEach(w => {
                html += '<li style="margin-bottom: 8px;">' + w + '</li>';
            });
            html += '</ul>';
            html += '</div>';
        }

        // Priorità dettagliate
        html += '<div style="margin-top: 20px;">';
        html += '<h4 style="color: var(--generali-blue); margin-bottom: 15px;">📊 Priorità Prodotti (0-100)</h4>';
        html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">';
        
        const prodotti = [
            { key: 'vita', nome: 'Vita', icon: '🛡️' },
            { key: 'tcm', nome: 'TCM', icon: '⚰️' },
            { key: 'infortuni', nome: 'Infortuni', icon: '🏥' },
            { key: 'sanitaria', nome: 'Sanitaria', icon: '⚕️' },
            { key: 'ltc', nome: 'LTC', icon: '♿' },
            { key: 'previdenza', nome: 'Previdenza', icon: '🏦' },
            { key: 'investimenti', nome: 'Investimenti', icon: '📈' }
        ];

        prodotti.forEach(p => {
            const priorita = normotipoEsteso.priorita[p.key] || 50;
            const color = priorita >= 90 ? '#DC2626' : 
                         priorita >= 75 ? '#F59E0B' : 
                         priorita >= 60 ? '#3B82F6' : 
                         '#6B7280';

            html += '<div style="background: var(--gray-50); padding: 15px; border-radius: 8px; text-align: center;">';
            html += '<div style="font-size: 24px; margin-bottom: 5px;">' + p.icon + '</div>';
            html += '<div style="font-size: 12px; color: var(--gray-600); margin-bottom: 8px;">' + p.nome + '</div>';
            html += '<div style="font-size: 28px; font-weight: bold; color: ' + color + ';">' + priorita + '</div>';
            
            // Barra visuale
            html += '<div style="background: #E5E7EB; height: 6px; border-radius: 3px; margin-top: 10px; overflow: hidden;">';
            html += '<div style="background: ' + color + '; height: 100%; width: ' + priorita + '%; transition: width 0.3s;"></div>';
            html += '</div>';
            
            html += '</div>';
        });

        html += '</div>';
        html += '</div>';

        html += '</div>';
        html += '</div>';

        return html;
    }

    // ========================================
    // INTEGRAZIONE CON GENERA RISULTATI
    // ========================================

    const originalGeneraRisultati = window.generaRisultati;

    window.generaRisultati = async function() {
        await originalGeneraRisultati.call(this);

        setTimeout(() => {
            const userData = appState.user.anagrafica;
            const answers = appState.answers;

            const normotipoEsteso = identificaNormotipoEsteso(userData, answers);

            appState.results.normotipoEsteso = normotipoEsteso;

            // Sostituisci il vecchio normotipo con quello esteso
            const container = document.getElementById('risultatiContent');
            const oldNormotipoCard = container.querySelector('.card');
            
            if (oldNormotipoCard) {
                const normotipoHTML = renderNormotipoEsteso(normotipoEsteso);
                oldNormotipoCard.outerHTML = normotipoHTML;
            } else {
                const normotipoHTML = renderNormotipoEsteso(normotipoEsteso);
                container.insertAdjacentHTML('afterbegin', normotipoHTML);
            }

            console.log(`✅ Normotipo Esteso identificato: ${normotipoEsteso.nome}`);

        }, 500);
    };

    console.log('✅ Normotipi Comportamentali Estesi: OPERATIVO');
    console.log('  ✓ 20 profili dettagliati');
    console.log('  ✓ Matching automatico criteri');
    console.log('  ✓ Priorità personalizzate per profilo');

})();
</script>
<script>
/* === QUESTIONARIO DINAMICO CON BLOCCO OPZIONI INCOERENTI V2.0 === */
(function() {
    'use strict';

    console.log('%c🎮 QUESTIONARIO DINAMICO V2.0 - ATTIVO', 'color: #EC4899; font-weight: bold');

    // ========================================
    // REGOLE COERENZA DOMANDE
    // ========================================

    const REGOLE_COERENZA = {
        
        // Domanda A1: Protezione percepita
        'A1': {
            validazione: (userData, answers, selectedValue) => {
                const polizze = userData.polizze || {};
                const numPolizze = Object.keys(polizze).length;

                // Se hai 0 polizze, non puoi dire di essere molto protetto
                if (numPolizze === 0 && selectedValue >= 4) {
                    return {
                        valid: false,
                        messaggio: '⚠️ Incoerenza: Non hai polizze attive ma ti senti molto protetto?',
                        opzioniBloccate: [4, 5]
                    };
                }

                // Se hai 4+ polizze, difficile dire di essere per nulla protetto
                if (numPolizze >= 4 && selectedValue <= 2) {
                    return {
                        valid: false,
                        messaggio: '⚠️ Incoerenza: Hai ' + numPolizze + ' polizze ma ti senti poco protetto?',
                        opzioniBloccate: [1, 2]
                    };
                }

                return { valid: true };
            }
        },

        // Domanda A2: Copertura infortuni 6 mesi
        'A2': {
            validazione: (userData, answers, selectedValue) => {
                const polizze = userData.polizze || {};
                const tipoLavoratore = userData.tipoLavoratore || '';

                // Se hai polizza infortuni, non puoi dire "nessuna copertura"
                if (polizze.infortuni && selectedValue === 1) {
                    return {
                        valid: false,
                        messaggio: '⚠️ Hai dichiarato di avere polizza infortuni: non puoi dire "nessuna copertura"',
                        opzioniBloccate: [1]
                    };
                }

                // Se sei autonomo senza polizze, difficile avere copertura 90%+
                if ((tipoLavoratore === 'autonomo' || tipoLavoratore === 'imprenditore') && !polizze.infortuni && selectedValue >= 4) {
                    return {
                        valid: false,
                        messaggio: '⚠️ Autonomo senza polizza infortuni: copertura > 90% improbabile',
                        opzioniBloccate: [4, 5]
                    };
                }

                return { valid: true };
            }
        },

        // Domanda A3: Autonomia famiglia senza reddito
        'A3': {
            validazione: (userData, answers, selectedValue) => {
                const fondoEmergenza = answers.B3 || 3;
                const statoFamiliare = userData.statoFamiliare || '';

                const haFamiglia = !statoFamiliare.includes('single') && 
                                  !statoFamiliare.includes('vedovo_senza_figli') && 
                                  statoFamiliare !== 'religioso';

                // Se non hai famiglia, domanda diventa "tu" non "famiglia"
                // Già gestito nel rendering

                // Se fondo emergenza basso (B3 <= 2), non puoi dire oltre 12 mesi
                if (fondoEmergenza <= 2 && selectedValue >= 5) {
                    return {
                        valid: false,
                        messaggio: '⚠️ Incoerenza: Hai dichiarato fondo emergenza < 3 mesi (domanda B3) ma qui dici > 12 mesi',
                        opzioniBloccate: [5]
                    };
                }

                // Se fondo emergenza alto (B3 >= 4), difficile dire "nessuna autonomia"
                if (fondoEmergenza >= 4 && selectedValue <= 1) {
                    return {
                        valid: false,
                        messaggio: '⚠️ Incoerenza: Hai dichiarato fondo emergenza 6+ mesi ma qui dici "nessuna autonomia"',
                        opzioniBloccate: [1]
                    };
                }

                return { valid: true };
            }
        },

        // Domanda A5: Pianificazione decesso
        'A5': {
            validazione: (userData, answers, selectedValue) => {
                const polizze = userData.polizze || {};
                const haVitaTCM = polizze.vita || polizze.tcm;

                // Se hai vita/TCM, non puoi dire "mai pensato"
                if (haVitaTCM && selectedValue === 1) {
                    return {
                        valid: false,
                        messaggio: '⚠️ Hai polizza Vita/TCM ma dici di non aver mai pensato alla pianificazione?',
                        opzioniBloccate: [1]
                    };
                }

                // Se non hai vita/TCM, difficile dire "pianificato tutto"
                if (!haVitaTCM && selectedValue === 5) {
                    return {
                        valid: false,
                        messaggio: '⚠️ Senza polizza Vita/TCM, difficile aver "pianificato tutto accuratamente"',
                        opzioniBloccate: [5]
                    };
                }

                return { valid: true };
            }
        },

        // Domanda A6: Assicurazione figli
        'A6': {
            validazione: (userData, answers, selectedValue) => {
                const numeroFigli = userData.numeroFigli || 0;

                // Se non hai figli, solo "Non applicabile" ha senso
                if (numeroFigli === 0) {
                    return {
                        valid: true,
                        messaggio: 'ℹ️ Domanda non applicabile (nessun figlio)',
                        opzioniBloccate: [], // Non blocca ma messaggio info
                        skipDomanda: true
                    };
                }

                return { valid: true };
            }
        },

        // Domanda B2: Capacità risparmio
        'B2': {
            validazione: (userData, answers, selectedValue) => {
                const reddito = userData.redditoAnnuo || 0;
                const numeroFigli = userData.numeroFigli || 0;

                // Con reddito < 20k e 3+ figli, difficile risparmiare oltre 20%
                if (reddito < 20000 && numeroFigli >= 3 && selectedValue >= 5) {
                    return {
                        valid: false,
                        messaggio: '⚠️ Con reddito €' + reddito.toLocaleString() + ' e ' + numeroFigli + ' figli, risparmio > 20% improbabile',
                        opzioniBloccate: [5]
                    };
                }

                // Con reddito > 100k senza figli, "nulla" è incoerente
                if (reddito > 100000 && numeroFigli === 0 && selectedValue === 1) {
                    return {
                        valid: false,
                        messaggio: '⚠️ Con reddito €' + reddito.toLocaleString() + ' senza figli, "nulla" è incoerente',
                        opzioniBloccate: [1]
                    };
                }

                return { valid: true };
            }
        },

        // Domanda B3: Fondo emergenza
        'B3': {
            validazione: (userData, answers, selectedValue) => {
                const capacitaRisparmio = answers.B2 || 3;

                // Se risparmio = 0 (B2 = 1), difficile avere fondo 12+ mesi
                if (capacitaRisparmio === 1 && selectedValue >= 5) {
                    return {
                        valid: false,
                        messaggio: '⚠️ Hai detto di non risparmiare nulla (B2), come hai fondo > 12 mesi?',
                        opzioniBloccate: [5]
                    };
                }

                // Se risparmio alto (B2 >= 4), difficile non avere almeno qualcosa
                if (capacitaRisparmio >= 4 && selectedValue <= 1) {
                    return {
                        valid: false,
                        messaggio: '⚠️ Risparmi 10-20% ma nessun fondo emergenza? Dove vanno i soldi?',
                        opzioniBloccate: [1]
                    };
                }

                return { valid: true };
            }
        },

        // Domanda B6: Propensione rischio
        'B6': {
            validazione: (userData, answers, selectedValue) => {
                const eta = userData.age || 40;

                // Over 70 difficile essere aggressivi
                if (eta > 70 && selectedValue === 5) {
                    return {
                        valid: false,
                        messaggio: '⚠️ Età ' + eta + ' anni: propensione "aggressiva" sconsigliata',
                        opzioniBloccate: [5]
                    };
                }

                return { valid: true };
            }
        },

        // Domanda C1: Previdenza complementare
        'C1': {
            validazione: (userData, answers, selectedValue) => {
                const polizze = userData.polizze || {};
                const haPrevidenza = polizze.investimenti && polizze.investimenti.contributo > 0;

                // Se hai previdenza attiva, non puoi dire "non ci ho mai pensato"
                if (haPrevidenza && selectedValue === 1) {
                    return {
                        valid: false,
                        messaggio: '⚠️ Hai dichiarato previdenza/investimenti attivi ma dici "non ci ho mai pensato"?',
                        opzioniBloccate: [1]
                    };
                }

                // Se non hai previdenza, difficile dire "contributo significativo"
                if (!haPrevidenza && selectedValue === 5) {
                    return {
                        valid: false,
                        messaggio: '⚠️ Non hai dichiarato previdenza complementare attiva',
                        opzioniBloccate: [5]
                    };
                }

                return { valid: true };
            }
        },

        // Domanda C2: Evoluzione reddito
        'C2': {
            validazione: (userData, answers, selectedValue) => {
                const eta = userData.age || 40;
                const tipoLavoratore = userData.tipoLavoratore || '';

                // Pensionato: reddito stabile o diminuzione
                if (tipoLavoratore === 'pensionato' && selectedValue >= 4) {
                    return {
                        valid: false,
                        messaggio: '⚠️ Sei pensionato: difficile prevedere forte crescita reddito',
                        opzioniBloccate: [4, 5]
                    };
                }

                // Over 60 difficile "forte crescita"
                if (eta > 60 && selectedValue === 5) {
                    return {
                        valid: false,
                        messaggio: '⚠️ Età ' + eta + ' anni: "forte crescita" reddito improbabile',
                        opzioniBloccate: [5]
                    };
                }

                // Under 30 con carriera in crescita, "diminuzione" incoerente
                if (eta < 30 && userData.redditoAnnuo > 25000 && selectedValue === 1) {
                    return {
                        valid: false,
                        messaggio: '⚠️ Giovane con reddito buono: perché prevedi diminuzione?',
                        opzioniBloccate: [1]
                    };
                }

                return { valid: true };
            }
        },

        // Domanda C7: Propensione investimenti
        'C7': {
            validazione: (userData, answers, selectedValue) => {
                const capacitaRisparmio = answers.B2 || 3;
                const fondoEmergenza = answers.B3 || 3;

                // Se non risparmi (B2 = 1), non puoi essere "molto propenso"
                if (capacitaRisparmio === 1 && selectedValue >= 4) {
                    return {
                        valid: false,
                        messaggio: '⚠️ Non risparmi nulla (B2) ma sei propenso a investire? Prima accumula',
                        opzioniBloccate: [4, 5]
                    };
                }

                // Se fondo emergenza assente, meglio non investire
                if (fondoEmergenza <= 2 && selectedValue >= 4) {
                    return {
                        valid: false,
                        messaggio: '⚠️ Senza fondo emergenza (B3), investire è rischioso. Prima crea riserva',
                        opzioniBloccate: [4, 5]
                    };
                }

                return { valid: true };
            }
        },

        // Domanda C8: Debiti
        'C8': {
            validazione: (userData, answers, selectedValue) => {
                const propensioneInvest = answers.C7 || 3;

                // Se debiti alti (1-2) ma alta propensione investimenti, segnala
                if (selectedValue <= 2 && propensioneInvest >= 4) {
                    return {
                        valid: true, // Non blocca ma avvisa
                        messaggio: '⚠️ Debiti elevati + alta propensione investimenti = priorità sbagliate. Prima estingui debiti',
                        opzioniBloccate: []
                    };
                }

                return { valid: true };
            }
        }
    };

    // ========================================
    // APPLICAZIONE VALIDAZIONI
    // ========================================

    const originalSelectOption = window.selectOption;

    window.selectOption = function(questionId, value) {
        const userData = appState.user?.anagrafica || {};
        const answers = appState.answers || {};

        // Controlla se esiste validazione per questa domanda
        const regola = REGOLE_COERENZA[questionId];

        if (regola && regola.validazione) {
            const risultatoValidazione = regola.validazione(userData, answers, value);

            if (!risultatoValidazione.valid) {
                // BLOCCO: mostra messaggio e non permettere selezione
                if (typeof showWarningBadge === 'function') {
                    showWarningBadge(risultatoValidazione.messaggio);
                } else {
                    alert(risultatoValidazione.messaggio);
                }
                return; // NON permette selezione
            } else if (risultatoValidazione.messaggio) {
                // AVVISO: permette selezione ma mostra warning
                if (typeof showWarningBadge === 'function') {
                    showWarningBadge(risultatoValidazione.messaggio);
                }
            }
        }

        // Prosegui con selezione normale
        originalSelectOption.call(this, questionId, value);
    };

    // ========================================
    // BLOCCO VISUALE OPZIONI
    // ========================================

    const originalRenderQuestion = window.renderQuestion;

    window.renderQuestion = function() {
        // Chiama rendering originale
        if (originalRenderQuestion) {
            originalRenderQuestion.call(this);
        }

        // Applica blocchi visuali
        const question = questions[appState.currentQuestion];
        const userData = appState.user?.anagrafica || {};
        const answers = appState.answers || {};

        const regola = REGOLE_COERENZA[question.id];

        if (regola && regola.validazione) {
            // Testa ogni opzione
            question.options.forEach(opt => {
                const risultato = regola.validazione(userData, answers, opt.value);

                if (risultato.opzioniBloccate && risultato.opzioniBloccate.includes(opt.value)) {
                    // Blocca visivamente questa opzione
                    const optionElements = document.querySelectorAll('.option');
                    optionElements.forEach(el => {
                        if (el.textContent.includes(opt.label)) {
                            el.style.opacity = '0.4';
                            el.style.cursor = 'not-allowed';
                            el.style.background = '#F3F4F6';
                            el.style.borderColor = '#D1D5DB';
                            el.style.pointerEvents = 'none';
                            
                            // Aggiungi tooltip
                            el.title = '❌ Opzione incoerente con dati precedenti';
                        }
                    });
                }
            });

            // Se domanda da saltare
            if (risultato && risultato.skipDomanda) {
                const container = document.getElementById('questionContainer');
                const infoBox = document.createElement('div');
                infoBox.style.cssText = 'background: #DBEAFE; color: #1E40AF; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #3B82F6;';
                infoBox.innerHTML = '<strong>ℹ️ Domanda non applicabile</strong><br>' + risultato.messaggio;
                container.appendChild(infoBox);

                // Auto-seleziona valore neutro (3)
                if (!appState.answers[question.id]) {
                    setTimeout(() => {
                        window.selectOption(question.id, 3);
                    }, 500);
                }
            }
        }
    };

    // ========================================
    // RIEPILOGO INCOERENZE FINALI
    // ========================================

    const originalFinalizzaQuestionario = window.finalizzaQuestionario;

    window.finalizzaQuestionario = function() {
        const userData = appState.user?.anagrafica || {};
        const answers = appState.answers || {};

        const incoerenzeTrovate = [];

        // Controlla tutte le risposte date
        Object.entries(answers).forEach(([qId, value]) => {
            const regola = REGOLE_COERENZA[qId];
            if (regola && regola.validazione) {
                const risultato = regola.validazione(userData, answers, value);
                if (!risultato.valid) {
                    incoerenzeTrovate.push({
                        domanda: qId,
                        messaggio: risultato.messaggio
                    });
                }
            }
        });

        if (incoerenzeTrovate.length > 0) {
            let msg = '⚠️ ATTENZIONE: Rilevate ' + incoerenzeTrovate.length + ' incoerenze:\n\n';
            incoerenzeTrovate.forEach((inc, i) => {
                msg += (i + 1) + '. Domanda ' + inc.domanda + ': ' + inc.messaggio + '\n';
            });
            msg += '\nVuoi comunque procedere?';

            if (!confirm(msg)) {
                return; // Blocca finalizzazione
            }
        }

        // Prosegui con finalizzazione normale
        if (originalFinalizzaQuestionario) {
            originalFinalizzaQuestionario.call(this);
        }
    };

    console.log('✅ Questionario Dinamico: OPERATIVO');
    console.log('  ✓ 12 domande con validazione coerenza');
    console.log('  ✓ Blocco opzioni incoerenti in tempo reale');
    console.log('  ✓ Warning visuali e messaggi');
    console.log('  ✓ Riepilogo incoerenze finale');

})();
</script>
<script>
/* === TRACKING VARIAZIONI E CONFRONTO ANALISI PRECEDENTI V2.0 === */
(function() {
    'use strict';

    console.log('%c🔄 TRACKING VARIAZIONI V2.0 - ATTIVO', 'color: #0891B2; font-weight: bold');

    // ========================================
    // SNAPSHOT INIZIALE
    // ========================================

    window.analisiOriginale = null;

    function salvaSnapshotIniziale() {
        if (window.analisiOriginale) return; // Già salvato

        const userData = appState.user?.anagrafica;
        const polizze = appState.user?.polizze;
        const answers = appState.answers;

        if (!userData) return;

        window.analisiOriginale = {
            timestamp: new Date().toISOString(),
            userData: JSON.parse(JSON.stringify(userData)),
            polizze: JSON.parse(JSON.stringify(polizze || {})),
            answers: JSON.parse(JSON.stringify(answers || {}))
        };

        console.log('📸 Snapshot iniziale salvato:', window.analisiOriginale.timestamp);
    }

    // Hook su iniziaQuestionario
    const originalIniziaQuestionario = window.iniziaQuestionario;
    window.iniziaQuestionario = function() {
        salvaSnapshotIniziale();
        if (originalIniziaQuestionario) {
            originalIniziaQuestionario.call(this);
        }
    };

    // ========================================
    // CONFRONTO VARIAZIONI
    // ========================================

    function calcolaVariazioni() {
        if (!window.analisiOriginale) {
            return null;
        }

        const originale = window.analisiOriginale;
        const corrente = {
            userData: appState.user?.anagrafica || {},
            polizze: appState.user?.polizze || {},
            answers: appState.answers || {}
        };

        const variazioni = {
            anagrafica: [],
            polizze: [],
            risposte: []
        };

        // Confronto anagrafica
        const campiRilevanti = ['redditoAnnuo', 'numeroFigli', 'statoFamiliare', 'professione', 'tipoLavoratore', 'anniContributivi'];
        
        campiRilevanti.forEach(campo => {
            const valOrig = originale.userData[campo];
            const valCorr = corrente.userData[campo];

            if (valOrig !== valCorr) {
                variazioni.anagrafica.push({
                    campo: campo,
                    da: valOrig,
                    a: valCorr,
                    label: getLabelCampo(campo)
                });
            }
        });

        // Confronto polizze
        const tutteLePolizze = new Set([...Object.keys(originale.polizze), ...Object.keys(corrente.polizze)]);

        tutteLePolizze.forEach(tipo => {
            const aveva = !!originale.polizze[tipo];
            const ha = !!corrente.polizze[tipo];

            if (aveva !== ha) {
                variazioni.polizze.push({
                    tipo: tipo,
                    azione: ha ? 'aggiunta' : 'rimossa',
                    label: getLabelPolizza(tipo)
                });
            }
        });

        // Confronto risposte (solo quelle cambiate significativamente, delta >= 2)
        Object.keys(corrente.answers).forEach(qId => {
            const valOrig = originale.answers[qId];
            const valCorr = corrente.answers[qId];

            if (valOrig !== undefined && Math.abs(valOrig - valCorr) >= 2) {
                variazioni.risposte.push({
                    domanda: qId,
                    da: valOrig,
                    a: valCorr,
                    delta: valCorr - valOrig
                });
            }
        });

        return variazioni;
    }

    function getLabelCampo(campo) {
        const labels = {
            'redditoAnnuo': 'Reddito Annuo',
            'numeroFigli': 'Numero Figli',
            'statoFamiliare': 'Stato Familiare',
            'professione': 'Professione',
            'tipoLavoratore': 'Tipo Lavoratore',
            'anniContributivi': 'Anni Contributivi'
        };
        return labels[campo] || campo;
    }

    function getLabelPolizza(tipo) {
        const labels = {
            'vita': 'Polizza Vita',
            'tcm': 'TCM',
            'infortuni': 'Infortuni',
            'sanitaria': 'Sanitaria',
            'ltc': 'LTC',
            'abitazione': 'Abitazione',
            'rca': 'RCA',
            'investimenti': 'Investimenti',
            'accantonamento': 'Accantonamento'
        };
        return labels[tipo] || tipo;
    }

    // ========================================
    // RENDERING VARIAZIONI
    // ========================================

    function renderVariazioni(variazioni) {
        if (!variazioni || (variazioni.anagrafica.length === 0 && variazioni.polizze.length === 0 && variazioni.risposte.length === 0)) {
            return '';
        }

        let html = '<div class="card" style="background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%); border-left: 4px solid #F59E0B;">';
        html += '<h3 class="card-title" style="color: #92400E;">🔄 Variazioni Rispetto a Analisi Precedente</h3>';
        html += '<p style="color: #78350F; margin-bottom: 20px;">Confronto con snapshot iniziale del ' + new Date(window.analisiOriginale.timestamp).toLocaleString('it-IT') + '</p>';

        // Anagrafica
        if (variazioni.anagrafica.length > 0) {
            html += '<div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px;">';
            html += '<h4 style="color: var(--generali-blue); margin-bottom: 15px;">📋 Modifiche Anagrafiche</h4>';
            html += '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr><th style="text-align: left; padding: 10px; border-bottom: 2px solid var(--gray-200);">Campo</th><th style="text-align: left; padding: 10px; border-bottom: 2px solid var(--gray-200);">Da</th><th style="text-align: center; padding: 10px; border-bottom: 2px solid var(--gray-200);">→</th><th style="text-align: left; padding: 10px; border-bottom: 2px solid var(--gray-200);">A</th></tr></thead>';
            html += '<tbody>';

            variazioni.anagrafica.forEach(v => {
                html += '<tr>';
                html += '<td style="padding: 10px; border-bottom: 1px solid var(--gray-200); font-weight: 600;">' + v.label + '</td>';
                html += '<td style="padding: 10px; border-bottom: 1px solid var(--gray-200); color: var(--red);">' + formatValue(v.da) + '</td>';
                html += '<td style="padding: 10px; border-bottom: 1px solid var(--gray-200); text-align: center;">→</td>';
                html += '<td style="padding: 10px; border-bottom: 1px solid var(--gray-200); color: var(--green); font-weight: 600;">' + formatValue(v.a) + '</td>';
                html += '</tr>';
            });

            html += '</tbody></table>';
            html += '</div>';
        }

        // Polizze
        if (variazioni.polizze.length > 0) {
            html += '<div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px;">';
            html += '<h4 style="color: var(--generali-blue); margin-bottom: 15px;">🛡️ Modifiche Polizze</h4>';
            html += '<ul style="margin: 0; padding-left: 20px;">';

            variazioni.polizze.forEach(v => {
                const icon = v.azione === 'aggiunta' ? '✅' : '❌';
                const color = v.azione === 'aggiunta' ? 'var(--green)' : 'var(--red)';
                html += '<li style="margin-bottom: 10px; color: ' + color + '; font-weight: 600;">';
                html += icon + ' ' + v.label + ' ' + (v.azione === 'aggiunta' ? 'AGGIUNTA' : 'RIMOSSA');
                html += '</li>';
            });

            html += '</ul>';
            html += '</div>';
        }

        // Risposte significative
        if (variazioni.risposte.length > 0) {
            html += '<div style="background: white; padding: 20px; border-radius: 8px;">';
            html += '<h4 style="color: var(--generali-blue); margin-bottom: 15px;">💭 Cambiamenti Significativi Risposte (Δ ≥ 2)</h4>';
            html += '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr><th style="text-align: left; padding: 10px; border-bottom: 2px solid var(--gray-200);">Domanda</th><th style="text-align: center; padding: 10px; border-bottom: 2px solid var(--gray-200);">Prima</th><th style="text-align: center; padding: 10px; border-bottom: 2px solid var(--gray-200);">Dopo</th><th style="text-align: center; padding: 10px; border-bottom: 2px solid var(--gray-200);">Δ</th></tr></thead>';
            html += '<tbody>';

            variazioni.risposte.forEach(v => {
                const deltaColor = v.delta > 0 ? 'var(--green)' : 'var(--red)';
                const arrow = v.delta > 0 ? '↑' : '↓';

                html += '<tr>';
                html += '<td style="padding: 10px; border-bottom: 1px solid var(--gray-200); font-weight: 600;">' + v.domanda + '</td>';
                html += '<td style="padding: 10px; border-bottom: 1px solid var(--gray-200); text-align: center;">' + v.da + '/5</td>';
                html += '<td style="padding: 10px; border-bottom: 1px solid var(--gray-200); text-align: center; font-weight: 600;">' + v.a + '/5</td>';
                html += '<td style="padding: 10px; border-bottom: 1px solid var(--gray-200); text-align: center; color: ' + deltaColor + '; font-weight: 600;">' + arrow + ' ' + Math.abs(v.delta) + '</td>';
                html += '</tr>';
            });

            html += '</tbody></table>';
            html += '</div>';
        }

        html += '</div>';

        return html;
    }

    function formatValue(val) {
        if (typeof val === 'number' && val > 999) {
            return '€' + val.toLocaleString();
        }
        return val || 'N/A';
    }

    // ========================================
    // INTEGRAZIONE CON GENERA RISULTATI
    // ========================================

    const originalGeneraRisultati = window.generaRisultati;

    window.generaRisultati = async function() {
        await originalGeneraRisultati.call(this);

        setTimeout(() => {
            const variazioni = calcolaVariazioni();

            if (variazioni) {
                appState.results.variazioni = variazioni;

                const container = document.getElementById('risultatiContent');
                const variazioniHTML = renderVariazioni(variazioni);
                
                if (variazioniHTML) {
                    // Inserisci dopo il normotipo
                    const normotipoCard = container.querySelector('.card');
                    if (normotipoCard) {
                        normotipoCard.insertAdjacentHTML('afterend', variazioniHTML);
                    }
                }

                console.log('✅ Tracking variazioni completato');
            }

        }, 800);
    };

    console.log('✅ Tracking Variazioni: OPERATIVO');
    console.log('  ✓ Snapshot iniziale automatico');
    console.log('  ✓ Confronto anagrafica/polizze/risposte');
    console.log('  ✓ Rendering variazioni significative');

})();
</script>
<script>
/* === MODULO NEURO-VALIDATION CON PROFILO NEUROSCIENTIFICO V3.0 === */
(function() {
    'use strict';

    console.log('%c🧠 NEURO-VALIDATION V3.0 - ATTIVO', 'color: #7C3AED; font-weight: bold');

    // ========================================
    // CALCOLO PROFILO NEUROSCIENTIFICO
    // ========================================

    function calcolaProfiloNeuroscientifico(userData, answers) {
        const profilo = {
            cluster: 'Equilibrato',
            coerenzaRisposte: 75,
            profiloEmozionale: 'Razionale-Moderato',
            tendenzaDecisionale: 'Analitico',
            biasRilevati: [],
            insights: []
        };

        // ========================================
        // 1. CALCOLO COERENZA RISPOSTE
        // ========================================

        let incoerenze = 0;
        let contraddizioni = [];

        // Controllo 1: Protezione dichiarata vs Reale
        const percezioneSicurezza = answers.A1 || 3;
        const numPolizze = Object.keys(userData.polizze || {}).length;
        const protezioneTeorica = numPolizze * 20; // 20 punti per polizza

        if (Math.abs((percezioneSicurezza / 5 * 100) - protezioneTeorica) > 40) {
            incoerenze++;
            contraddizioni.push('Percezione protezione non allineata a coperture reali');
        }

        // Controllo 2: Risparmio dichiarato vs Fondo emergenza
        const capacitaRisparmio = answers.B2 || 3;
        const fondoEmergenza = answers.B3 || 3;

        if (capacitaRisparmio >= 4 && fondoEmergenza <= 2) {
            incoerenze++;
            contraddizioni.push('Alta capacità risparmio ma basso fondo emergenza');
        }

        if (capacitaRisparmio <= 2 && fondoEmergenza >= 4) {
            incoerenze++;
            contraddizioni.push('Bassa capacità risparmio ma alto fondo emergenza');
        }

        // Controllo 3: Propensione investimenti vs Capacità risparmio
        const propensioneInvest = answers.C7 || 3;
        
        if (propensioneInvest >= 4 && capacitaRisparmio <= 2) {
            incoerenze++;
            contraddizioni.push('Alta propensione investimenti senza capacità risparmio');
        }

        // Controllo 4: Pianificazione futuro vs Previdenza
        const pianificazioneFuturo = answers.C1 || 3;
        const obiettivi = answers.C4 || 3;
        
        if ((pianificazioneFuturo <= 2 && obiettivi >= 4) || (pianificazioneFuturo >= 4 && obiettivi <= 2)) {
            incoerenze++;
            contraddizioni.push('Incoerenza tra pianificazione previdenza e obiettivi generali');
        }

        // Controllo 5: SSN insoddisfacente vs Nessuna sanitaria
        const soddisfazioneSSN = answers.A4 || 3;
        const haSanitaria = !!(userData.polizze && userData.polizze.sanitaria);
        
        if (soddisfazioneSSN <= 2 && !haSanitaria) {
            incoerenze++;
            contraddizioni.push('Insoddisfatto SSN ma nessuna polizza sanitaria');
        }

        // Controllo 6: Sport/lavoro rischio vs Infortuni
        const sportRischio = answers.B5 || 3;
        const lavoroRischio = answers.B8 || 3;
        const haInfortuni = !!(userData.polizze && userData.polizze.infortuni);
        
        if ((sportRischio >= 4 || lavoroRischio >= 4) && !haInfortuni) {
            incoerenze++;
            contraddizioni.push('Alto rischio fisico senza copertura infortuni');
        }

        // Calcolo coerenza finale
        const penalita = incoerenze * 12;
        profilo.coerenzaRisposte = Math.max(20, 100 - penalita);
        profilo.contraddizioni = contraddizioni;

        // ========================================
        // 2. PROFILO EMOZIONALE
        // ========================================

        const impulsivita = calcolaImpulsivita(answers);
        const ansiaFuturo = calcolaAnsiaFuturo(answers);
        const avversioneRischio = calcolaAvversioneRischio(answers);

        if (impulsivita >= 70 && avversioneRischio <= 40) {
            profilo.profiloEmozionale = 'Impulsivo-Risk Seeking';
            profilo.insights.push('⚠️ Tendenza a decisioni impulsive con elevata tolleranza rischio');
        } else if (impulsivita <= 40 && avversioneRischio >= 70) {
            profilo.profiloEmozionale = 'Razionale-Conservativo';
            profilo.insights.push('✅ Approccio riflessivo e prudente alle decisioni finanziarie');
        } else if (ansiaFuturo >= 70) {
            profilo.profiloEmozionale = 'Ansioso-Preoccupato';
            profilo.insights.push('⚠️ Elevata ansia per il futuro: bilanciare protezione e serenità');
        } else if (impulsivita >= 60 && ansiaFuturo <= 40) {
            profilo.profiloEmozionale = 'Ottimista-Spontaneo';
            profilo.insights.push('⚠️ Ottimismo può portare a sottovalutare rischi');
        } else {
            profilo.profiloEmozionale = 'Razionale-Equilibrato';
            profilo.insights.push('✅ Equilibrio tra emozione e razionalità');
        }

        // ========================================
        // 3. TENDENZA DECISIONALE
        // ========================================

        const conoscenzaStrumenti = answers.C5 || 3;
        const strategiaPatrimoniale = answers.C3 || 3;
        const informazione = answers.C5 || 3;

        const scoreAnalitico = (conoscenzaStrumenti + strategiaPatrimoniale + informazione) / 15 * 100;

        if (scoreAnalitico >= 70) {
            profilo.tendenzaDecisionale = 'Analitico-Strategico';
            profilo.insights.push('✅ Approccio strutturato e informato alle decisioni');
        } else if (scoreAnalitico >= 50) {
            profilo.tendenzaDecisionale = 'Pragmatico-Moderato';
            profilo.insights.push('📊 Decisioni basate su esperienza pratica');
        } else if (impulsivita >= 60) {
            profilo.tendenzaDecisionale = 'Intuitivo-Emotivo';
            profilo.insights.push('⚠️ Decisioni guidate da intuito: valutare pro/contro razionalmente');
        } else {
            profilo.tendenzaDecisionale = 'Reattivo-Situazionale';
            profilo.insights.push('⚠️ Decisioni spesso reattive a situazioni: pianificare in anticipo');
        }

        // ========================================
        // 4. BIAS COGNITIVI RILEVATI
        // ========================================

        // Bias 1: Overconfidence (troppo sicuri)
        if (percezioneSicurezza >= 4 && protezioneTeorica < 50) {
            profilo.biasRilevati.push({
                tipo: 'Overconfidence Bias',
                descrizione: 'Ti senti più protetto di quanto sei realmente',
                gravita: 'alta',
                impatto: 'Sottovalutazione rischi reali'
            });
        }

        // Bias 2: Present Bias (focus presente)
        const speseTempo = answers.B4 || 3;
        if (speseTempo >= 4 && capacitaRisparmio <= 2 && pianificazioneFuturo <= 2) {
            profilo.biasRilevati.push({
                tipo: 'Present Bias',
                descrizione: 'Focus eccessivo su gratificazione immediata',
                gravita: 'media',
                impatto: 'Trascurare pianificazione lungo termine'
            });
        }

        // Bias 3: Status Quo Bias (resistenza al cambiamento)
        const evoluzioneSituazione = answers.C2 || 3;
        const strategia = answers.C3 || 3;
        if (strategia <= 2 && pianificazioneFuturo <= 2 && numPolizze === 0) {
            profilo.biasRilevati.push({
                tipo: 'Status Quo Bias',
                descrizione: 'Tendenza a mantenere situazione attuale anche se inadeguata',
                gravita: 'media',
                impatto: 'Inerzia decisionale pericolosa'
            });
        }

        // Bias 4: Optimism Bias (ottimismo irrealistico)
        if (percezioneSicurezza >= 4 && (sportRischio >= 4 || lavoroRischio >= 4) && !haInfortuni) {
            profilo.biasRilevati.push({
                tipo: 'Optimism Bias',
                descrizione: '"A me non capiterà": sottovalutazione probabilità eventi negativi',
                gravita: 'alta',
                impatto: 'Esposizione eccessiva a rischi non coperti'
            });
        }

        // Bias 5: Anchoring (ancoraggio a riferimenti sbagliati)
        const supportoSociale = answers.B7 || 3;
        if (supportoSociale >= 4 && numPolizze === 0) {
            profilo.biasRilevati.push({
                tipo: 'Anchoring Bias',
                descrizione: 'Affidamento eccessivo su rete supporto invece che su protezioni formali',
                gravita: 'media',
                impatto: 'Rete sociale non sostituisce coperture assicurative'
            });
        }

        // ========================================
        // 5. CLUSTER FINALE
        // ========================================

        if (profilo.coerenzaRisposte >= 80 && scoreAnalitico >= 70) {
            profilo.cluster = 'Analitico-Coerente';
        } else if (profilo.coerenzaRisposte >= 70 && impulsivita <= 40) {
            profilo.cluster = 'Riflessivo-Prudente';
        } else if (impulsivita >= 70 && profilo.coerenzaRisposte < 60) {
            profilo.cluster = 'Impulsivo-Incoerente';
        } else if (ansiaFuturo >= 70) {
            profilo.cluster = 'Ansioso-Pianificatore';
        } else {
            profilo.cluster = 'Equilibrato-Pragmatico';
        }

        return profilo;
    }

    // ========================================
    // FUNZIONI CALCOLO DIMENSIONI
    // ========================================

    function calcolaImpulsivita(answers) {
        // Domande che misurano impulsività: C4 (obiettivi), B4 (spese tempo libero), C7 (propensione investimenti)
        const obiettivi = 5 - (answers.C4 || 3); // Invertito: pochi obiettivi = alta impulsività
        const speseTempo = answers.B4 || 3;
        const decisioni = 5 - (answers.C5 || 3); // Invertito: poca conoscenza = più impulsivo

        return Math.round(((obiettivi + speseTempo + decisioni) / 15) * 100);
    }

    function calcolaAnsiaFuturo(answers) {
        // Domande che misurano ansia: A1 (percezione protezione invertita), A5 (pianificazione), C6 (eredità)
        const percezioneSicurezza = 5 - (answers.A1 || 3); // Invertito: bassa sicurezza = alta ansia
        const pianificazione = answers.A5 || 3; // Alta pianificazione può indicare preoccupazione
        const importanzaEredita = answers.C6 || 3;

        return Math.round(((percezioneSicurezza + pianificazione + importanzaEredita) / 15) * 100);
    }

    function calcolaAvversioneRischio(answers) {
        // Domande che misurano avversione: B6 (propensione rischio invertita), C7 (investimenti invertita)
        const propensioneRischio = 5 - (answers.B6 || 3); // Invertito: bassa propensione = alta avversione
        const investimenti = 5 - (answers.C7 || 3); // Invertito
        const attivitaRischiose = 5 - (Math.max(answers.B5 || 3, answers.B8 || 3)); // Invertito

        return Math.round(((propensioneRischio + investimenti + attivitaRischiose) / 15) * 100);
    }

    // ========================================
    // RENDERING PROFILO
    // ========================================

    function renderProfiloNeuroscientifico(profilo) {
        let html = '<div class="card" style="background: linear-gradient(135deg, #EDE9FE 0%, #DDD6FE 100%); border-left: 4px solid #7C3AED;">';
        html += '<h3 class="card-title" style="color: #5B21B6;">🧠 Profilo Neuroscientifico Comportamentale</h3>';
        html += '<p style="color: #6D28D9; margin-bottom: 20px;">Analisi avanzata pattern decisionali e bias cognitivi</p>';

        // Cluster principale
        html += '<div style="background: white; padding: 25px; border-radius: 8px; margin-bottom: 20px; text-align: center;">';
        html += '<div style="font-size: 14px; color: var(--gray-600); margin-bottom: 10px;">CLUSTER COMPORTAMENTALE</div>';
        html += '<div style="font-size: 32px; font-weight: bold; color: #7C3AED; margin-bottom: 15px;">' + profilo.cluster + '</div>';
        
        // Metriche principali
        html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">';
        
        // Coerenza
        const coerenzaColor = profilo.coerenzaRisposte >= 80 ? '#10B981' : 
                             profilo.coerenzaRisposte >= 60 ? '#F59E0B' : '#EF4444';
        html += '<div style="background: var(--gray-50); padding: 20px; border-radius: 8px;">';
        html += '<div style="font-size: 12px; color: var(--gray-600); margin-bottom: 8px;">Coerenza Risposte</div>';
        html += '<div style="font-size: 36px; font-weight: bold; color: ' + coerenzaColor + ';">' + profilo.coerenzaRisposte + '%</div>';
        html += '<div style="background: #E5E7EB; height: 8px; border-radius: 4px; margin-top: 12px; overflow: hidden;">';
        html += '<div style="background: ' + coerenzaColor + '; height: 100%; width: ' + profilo.coerenzaRisposte + '%;"></div>';
        html += '</div>';
        html += '</div>';

        // Profilo Emozionale
        html += '<div style="background: var(--gray-50); padding: 20px; border-radius: 8px;">';
        html += '<div style="font-size: 12px; color: var(--gray-600); margin-bottom: 8px;">Profilo Emozionale</div>';
        html += '<div style="font-size: 18px; font-weight: bold; color: #7C3AED; line-height: 1.3;">' + profilo.profiloEmozionale + '</div>';
        html += '</div>';

        // Tendenza Decisionale
        html += '<div style="background: var(--gray-50); padding: 20px; border-radius: 8px;">';
        html += '<div style="font-size: 12px; color: var(--gray-600); margin-bottom: 8px;">Tendenza Decisionale</div>';
        html += '<div style="font-size: 18px; font-weight: bold; color: #7C3AED; line-height: 1.3;">' + profilo.tendenzaDecisionale + '</div>';
        html += '</div>';

        html += '</div>';
        html += '</div>';

        // Insights
        if (profilo.insights && profilo.insights.length > 0) {
            html += '<div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">';
            html += '<h4 style="color: #7C3AED; margin-bottom: 15px;">💡 Insights Comportamentali</h4>';
            html += '<ul style="margin: 0; padding-left: 20px; color: var(--gray-700);">';
            profilo.insights.forEach(insight => {
                html += '<li style="margin-bottom: 10px; line-height: 1.5;">' + insight + '</li>';
            });
            html += '</ul>';
            html += '</div>';
        }

        // Contraddizioni
        if (profilo.contraddizioni && profilo.contraddizioni.length > 0) {
            html += '<div style="background: #FEE2E2; padding: 20px; border-radius: 8px; border-left: 4px solid #EF4444; margin-bottom: 20px;">';
            html += '<h4 style="color: #991B1B; margin-bottom: 15px;">⚠️ Contraddizioni Rilevate</h4>';
            html += '<ul style="margin: 0; padding-left: 20px; color: #7F1D1D;">';
            profilo.contraddizioni.forEach(contr => {
                html += '<li style="margin-bottom: 10px;">' + contr + '</li>';
            });
            html += '</ul>';
            html += '</div>';
        }

        // Bias Cognitivi
        if (profilo.biasRilevati && profilo.biasRilevati.length > 0) {
            html += '<div style="background: white; padding: 20px; border-radius: 8px;">';
            html += '<h4 style="color: #7C3AED; margin-bottom: 15px;">🎯 Bias Cognitivi Rilevati</h4>';
            
            profilo.biasRilevati.forEach(bias => {
                const gravitaColor = bias.gravita === 'alta' ? '#EF4444' : 
                                    bias.gravita === 'media' ? '#F59E0B' : '#3B82F6';
                
                html += '<div style="background: var(--gray-50); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid ' + gravitaColor + ';">';
                html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">';
                html += '<strong style="color: var(--generali-blue); font-size: 16px;">' + bias.tipo + '</strong>';
                html += '<span style="background: ' + gravitaColor + '; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase;">Gravità: ' + bias.gravita + '</span>';
                html += '</div>';
                html += '<p style="margin: 0 0 8px 0; color: var(--gray-700);">' + bias.descrizione + '</p>';
                html += '<p style="margin: 0; color: var(--gray-600); font-size: 13px;"><strong>Impatto:</strong> ' + bias.impatto + '</p>';
                html += '</div>';
            });

            html += '</div>';
        }

        html += '</div>';

        return html;
    }

    // ========================================
    // INTEGRAZIONE CON GENERA RISULTATI
    // ========================================

    const originalGeneraRisultati = window.generaRisultati;

    window.generaRisultati = async function() {
        await originalGeneraRisultati.call(this);

        setTimeout(() => {
            const userData = appState.user.anagrafica;
            const answers = appState.answers;

            // Assicurati che polizze sia definito
            if (!userData.polizze) {
                userData.polizze = appState.user.polizze || {};
            }

            const profiloNeuro = calcolaProfiloNeuroscientifico(userData, answers);

            appState.results.profiloNeuroscientifico = profiloNeuro;

            const container = document.getElementById('risultatiContent');
            const neuroHTML = renderProfiloNeuroscientifico(profiloNeuro);
            
            // Inserisci dopo coherence score
            const coherenceCard = Array.from(container.querySelectorAll('.card')).find(card => 
                card.textContent.includes('Coerenza Risposte') || card.textContent.includes('Coherence')
            );

            if (coherenceCard) {
                coherenceCard.insertAdjacentHTML('afterend', neuroHTML);
            } else {
                container.insertAdjacentHTML('beforeend', neuroHTML);
            }

            console.log('✅ Profilo Neuroscientifico completato');
            console.log('   Cluster:', profiloNeuro.cluster);
            console.log('   Coerenza:', profiloNeuro.coerenzaRisposte + '%');
            console.log('   Bias rilevati:', profiloNeuro.biasRilevati.length);

        }, 1200);
    };

    console.log('✅ Neuro-Validation: OPERATIVO');
    console.log('  ✓ Calcolo reale coerenza risposte');
    console.log('  ✓ Profilo emozionale e decisionale');
    console.log('  ✓ Rilevamento 5 bias cognitivi');
    console.log('  ✓ Insights comportamentali');

})();
</script>

</body>
</html>
